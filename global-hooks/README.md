# Общие вебхуки

Вебхуки в корневой директории `global-hooks` выполняют базовые функции инициализации, конфигурации и мониторинга для приложения Deckhouse. Они отвечают за определение версии Deckhouse, редакции продукта, состояния кластера, а также за включение и настройку ключевых компонентов, таких как облачные провайдеры и сетевые интерфейсы (CNI). Эти вебхуки обеспечивают корректную работу системы на начальном этапе и устанавливают глобальные параметры, используемые другими модулями.

## Список вебхуков

- вебхук 1
    - название: calculate_resources_requests.go
    - назначение: Вычисляет доступные ресурсы (CPU и память) на control-plane нодах и устанавливает лимиты для компонентов control-plane, предотвращая их перегрузку.
    - пример использования: Автоматически запускается при старте, анализирует allocatable ресурсы на мастер-нодах и рассчитывает, сколько ресурсов можно выделить под системные компоненты.
- вебхук 2
    - название: cluster_is_bootstrapped.go
    - назначение: Определяет, завершена ли процедура начальной настройки (bootstrap) кластера, создавая ConfigMap `d8-cluster-is-bootstraped` при наличии хотя бы одной готовой worker-ноды.
    - пример использования: Используется другими модулями для проверки готовности кластера к дальнейшим операциям.
- вебхук 3
    - название: control_plane_node_roles.go
    - назначение: Обеспечивает синхронизацию меток `node-role.kubernetes.io/master` и `node-role.kubernetes.io/control-plane` на всех control-plane нодах для совместимости.
    - пример использования: Автоматически добавляет обе метки на ноды, где установлена хотя бы одна из них.
- вебхук 4
    - название: deckhouse_edition.go
    - назначение: Определяет редакцию Deckhouse (например, CE, EE) путем чтения файла `/deckhouse/edition` и сохраняет это значение в глобальных переменных.
    - пример использования: Используется для включения функций, специфичных для определенной редакции продукта.
- вебхук 5
    - название: deckhouse_version.go
    - назначение: Определяет версию Deckhouse путем чтения файла `/deckhouse/version` и сохраняет это значение в глобальных переменных.
    - пример использования: Предоставляет информацию о версии для мониторинга и логирования.
- вебхук 6
    - название: deckhouse_metrics.go
    - назначение: Собирает и экспортирует метрики, связанные с работой Deckhouse, в систему мониторинга.
    - пример использования: Регистрирует метрики, такие как версия Deckhouse и состояние кластера, для визуализации в Grafana.
- вебхук 7
    - название: default_cluster_storage_class.go
    - назначение: Управляет настройкой хранилища по умолчанию в кластере, устанавливая или снимая аннотацию `is-default-class` с указанного StorageClass.
    - пример использования: Если в `global.defaultClusterStorageClass` задан `fast-ssd`, этот вебхук пометит StorageClass `fast-ssd` как хранилище по умолчанию, а все остальные снимет.
- вебхук 8
    - название: enable_cloud_provider.go
    - назначение: Определяет, какой облачный провайдер используется в кластере (на основе конфигурации), и включает соответствующий модуль (например, `cloudProviderAwsEnabled`).
    - пример использования: При установке кластера в AWS автоматически включает модуль `cloudProviderAws`.
- вебхук 9
    - название: enable_cni.go
    - назначение: Определяет, какой CNI (Container Network Interface) должен быть использован в кластере, и включает соответствующий модуль.
    - пример использования: На основе значения в секрете `d8-cni-configuration` включает модуль `cniFlannelEnabled` или `cniCiliumEnabled`.
- вебхук 10
    - название: generate_kube_rbac_proxy_ca.go
    - назначение: Генерирует или получает самоподписанный сертификат и закрытый ключ для CA (Certificate Authority), используемого компонентом `kube-rbac-proxy`.
    - пример использования: Создает секрет `kube-rbac-proxy-ca-key-pair` в namespace `d8-system`, если он не существует, и сохраняет данные сертификата в глобальных переменных.
- вебхук 11
    - название: set_deckhouse_leader_pod.go
    - назначение: Устанавливает метку `leader=true` на поде Deckhouse, который является лидером (имеет имя, указанное в переменной окружения `DECKHOUSE_POD`), для координации между репликами.
    - пример использования: Обеспечивает, что только один под Deckhouse выполняет определенные административные задачи.

