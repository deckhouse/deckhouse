# Вебхуки обнаружения

Вебхуки в поддиректории `discovery` отвечают за сбор и определение ключевых параметров и конфигураций кластера Kubernetes. Они активно мониторят состояние кластера, извлекают информацию из различных ресурсов (секретов, ConfigMap, нод) и устанавливают глобальные переменные, которые используются другими компонентами системы. Эти вебхуки являются основой для адаптации Deckhouse к конкретному окружению.

## Список вебхуков

- вебхук 1
    - название: cluster_configuration.go
    - назначение: Извлекает и парсит основную конфигурацию кластера из секрета `d8-cluster-configuration` и устанавливает ее как глобальные значения.
    - пример использования: Предоставляет другим модулям доступ к параметрам, таким как подсети для Pod и Service.
- вебхук 2
    - название: cluster_dns_address.go
    - назначение: Определяет ClusterIP сервиса DNS (CoreDNS/kube-dns) в кластере и сохраняет его в глобальных переменных.
    - пример использования: Используется для настройки сетевых политик или диагностики проблем с DNS.
- вебхук 3
    - название: cluster_domain.go
    - назначение: Определяет домен кластера (обычно `cluster.local`) путем анализа ConfigMap CoreDNS или аргументов запуска Pod'а DNS.
    - пример использования: Предоставляет информацию для настройки внутреннего разрешения имен.
- вебхук 4
    - название: cluster_ha.go
    - назначение: Определяет, является ли кластер высокодоступным (HA), подсчитывая количество control-plane нод.
    - пример использования: Устанавливает `global.discovery.clusterControlPlaneIsHighlyAvailable=true`, если нод больше одной.
- вебхук 5
    - название: cluster_ip_ranges.go
    - назначение: Определяет подсети для Pod'ов (`podSubnet`) и Service'ов (`serviceSubnet`) в кластере, анализируя аргументы запуска компонентов control-plane.
    - пример использования: Используется для настройки CNI или сетевых политик.
- вебхук 6
    - название: cluster_uuid.go
    - назначение: Генерирует или получает уникальный идентификатор (UUID) кластера и сохраняет его в ConfigMap `d8-cluster-uuid`.
    - пример использования: UUID используется для идентификации кластера в системах мониторинга и аналитики.
- вебхук 7
    - название: deckhouse_registry.go
    - назначение: Извлекает конфигурацию реестра образов (адрес, путь, схему, CA, dockerconfig) из секрета `deckhouse-registry` и устанавливает глобальные переменные для доступа к образам.
    - пример использования: Обеспечивает, что все модули Deckhouse знают, откуда скачивать свои образы.
- вебхук 8
    - название: default_storage_class.go
    - назначение: Определяет StorageClass, помеченный как `is-default-class`, и сохраняет его имя в `global.discovery.defaultStorageClass`.
    - пример использования: Предоставляет информацию для модулей, которым нужно знать хранилище по умолчанию.
- вебхук 9
    - название: extension_api_server_authentication.go
    - назначение: Извлекает CA-сертификат из ConfigMap `extension-apiserver-authentication` для аутентификации расширенных API-серверов.
    - пример использования: Используется для настройки безопасного соединения с пользовательскими API-серверами.
- вебхук 10
    - название: kubernetes_version.go
    - назначение: Определяет версию Kubernetes в кластере, отправляя запросы ко всем control-plane нодам и выбирая минимальную версию.
    - пример использования: Устанавливает `global.discovery.kubernetesVersion`, что позволяет модулям адаптироваться под конкретную версию Kubernetes.
- вебхук 11
    - название: modules_images_tags.go
    - назначение: Собирает и объединяет теги (digests) образов для всех модулей из центрального файла и локальных директорий модулей.
    - пример использования: Обеспечивает, что все модули используют согласованные и правильные версии образов.
- вебхук 12
    - название: prometheus_scrape_interval.go
    - назначение: Определяет интервал сбора метрик Prometheus из ConfigMap `prometheus-scrape-interval`.
    - пример использования: Устанавливает `global.discovery.prometheusScrapeInterval`, что позволяет другим компонентам адаптировать свою логику сбора метрик.
- вебхук 13
    - название: virtualization_level.go
    - назначение: Определяет уровень вложенности виртуализации (nesting level) для control-plane нод на основе метки `node.deckhouse.io/dvp-nesting-level`.
    - пример использования: Используется в сценариях DVP (Deep Virtualization Platform) для настройки параметров вложенных кластеров.