apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: deckhousereleases.deckhouse.io
  labels:
    heritage: deckhouse
    module: deckhouse
spec:
  group: deckhouse.io
  scope: Cluster
  names:
    plural: deckhousereleases
    singular: deckhouserelease
    kind: DeckhouseRelease
  preserveUnknownFields: false
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          description: |
            Determines the state and parameters for applying a specific release (version) of the Deckhouse Kubernetes Platform (DKP) in the cluster.

            DeckhouseRelease objects are automatically created by DKP upon the discovery of new DKP versions on the selected [release channel](/products/kubernetes-platform/documentation/latest/reference/release-channels.html). Modifying DeckhouseRelease enables the management of the process for applying the corresponding DKP version. More details about configuring DKP updates can be found in the [documentation](../../admin/configuration/update/configuration.html).

            The current versions of DKP and modules by release channels can be found at [releases.deckhouse.ru](https://releases.deckhouse.ru).
          required:
            - spec
          properties:
            approved:
              type: boolean
              default: false
              description: |
                Allows or disables manual updates.

                Used only if the [`deckhouse` module](/modules/deckhouse/) is configured for manual update mode ([update.mode](/modules/deckhouse/configuration.html#parameters-update-mode) parameter is set to `Manual`). Ignored if the update mode is set to `Auto` or `AutoPatch`.

                For more information on confirming manual updates, refer to the [documentation](../../admin/configuration/update/configuration.html#manual-update-approval).
            spec:
              type: object
              required:
                - version
              properties:
                version:
                  type: string
                  description: DKP version.
                  x-doc-examples: ['v1.73.2']
                applyAfter:
                  type: string
                  description: |
                    Marks release as a part of [canary-release](../../user/network/canary-deployment.html). This release will be delayed until the specified time. If the release is waiting to be applied, check [`.status.message`](../../admin/configuration/update/notifications.html#notification-format) for the reason.
                requirements:
                  type: object
                  additionalProperties:
                    type: string
                  description: |
                    A structure containing a list of requirements for installing the release. It is used by the DKP core. If the requirements are not met, the release may be skipped or blocked from installation.

                    Reports on unmet requirements can be found in the field [`.status.message`](../../admin/configuration/update/notifications.html#notification-format) of the DeckhouseRelease object.
                disruptions:
                  type: array
                  items:
                    type: string
                  x-doc-deprecated: true
                  description: Disruptive changes in the release.
                changelog:
                  type: object
                  description: |
                    A structure containing a list of DKP changes (and modules included in the DKP) of the release.

                    For more information about DKP release changelogs, refer to [Updating](../../architecture/updating.html#retrieving-the-changelog).
                  x-kubernetes-preserve-unknown-fields: true
                changelogLink:
                  type: string
                  description: Link to site with full changelog for this release.
            status:
              type: object
              properties:
                phase:
                  type: string
                  enum:
                    - Pending
                    - Deployed
                    - Outdated # deprecated
                    - Suspended
                    - Superseded
                    - Skipped
                  description: Current status of the release.
                message:
                  type: string
                  description: Detailed status or error message.
                transitionTime:
                  type: string
                  description: Time of release status change.
                approved:
                  type: boolean
                  description: |
                    The status of the release's readiness for deployment. It makes sense only for Manual updates (`update.mode: Manual`).
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: phase
          jsonPath: .status.phase
          type: string
          description: |
            Current release status.

            Typical values:

            - `Pending`: The release has been created but not applied yet (waiting for manual approval, update windows, canary release, or the minimal notification time).
            - `Deployed`: DKP has switched to the release version (module and component updates may continue asynchronously).
            - `Superseded`: The release is outdated and no longer used.
            - `Suspended`: The release has been canceled (typically before it was applied).
            - `Skipped`: The release was skipped because the requirements were not satisfied.

            For more information about DKP and modules release statuses, refer to the [`deckhouse` module documentation](/modules/deckhouse/#deckhouse-releases-update).
        - name: transitionTime
          jsonPath: .status.transitionTime
          type: date
          format: date-time
          description: 'When the release status was changed.'
        - name: message
          jsonPath: .status.message
          type: string
          description: 'Release status details.'
