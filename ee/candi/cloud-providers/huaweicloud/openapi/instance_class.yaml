apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: huaweicloudinstanceclasses.deckhouse.io
  labels:
    heritage: deckhouse
    module: cloud-provider-huaweicloud
spec:
  group: deckhouse.io
  preserveUnknownFields: false
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          description: |
            Huawei Cloud server group parameters used by `machine-controller-manager` (the [node-manager](https://deckhouse.io/modules/node-manager/) module).

            The CloudInstanceClass resource of the `node-manager` module refers to this resource.
          x-doc-examples:
            - apiVersion: deckhouse.io/v1
              kind: HuaweiCloudInstanceClass
              metadata:
                name: worker
              spec:
                imageName: alt-p11
                flavorName: s7n.xlarge.2
                rootDiskSize: 50
                rootDiskType: SSD
          required:
            - spec
          properties:
            spec:
              type: object
              required:
                - flavorName
              properties:
                flavorName:
                  description: |
                    Flavor of Huawei Cloud servers.

                    To get a list of all available flavors, run the following command: `cloud ECS ListFlavors`.

                    For all non-master nodes, it's recommended that you use a flavor that includes a local disk. If the cloud provider supports local disks, they're usually faster and cheaper. The disadvantage of using such a flavor is the inability to migrate nodes between hypervisors.
                  x-doc-examples: ['m1.medium']
                  type: string
                imageName:
                  description: |
                    Image to use while provisioning HuaweiCloud servers.

                    Use this command to get a list of available images: `cloud IMS ListImages`.

                    For the list of operating systems and specific versions supported by Deckhouse, refer to [Supported Kubernetes and OS versions](https://deckhouse.io/products/kubernetes-platform/documentation/v1/supported_versions.html) (take into account the Deckhouse version you use).

                    **By default**, either the `HuaweiCloudDiscoveryData` value or `instances.imageName` is used.
                  x-doc-required: false
                  x-doc-examples: ['ubuntu-18-04-cloud-amd64']
                  type: string
                rootDiskSize:
                  description: |
                    The size of a root disk in gigabytes.

                    This parameter also affects the type of a root disk.
                  x-doc-examples: [20]
                  type: integer
                  x-doc-required: false
                rootDiskType:
                  description: |
                    The type of a root disk.

                    The parameter is used to specify the type of a volume that will be used for the root disk.

                    **By default**, the value from `HuaweiCloudDiscoveryData` is used.
                  x-doc-examples: ['GPSSD']
                  type: string
                  x-doc-required: false
                mainNetwork:
                  type: string
                  x-doc-required: false
                  description: |
                    ID of the primary network for the VM's main NIC.

                    **By default**, the value from 'HuaweiCloudDiscoverData' is used.
                additionalNetworks:
                  type: array
                  items:
                    type: string
                  x-doc-required: false
                  description: |
                    List of networks IDs (subnets) for secondary NICs.
                subnets:
                  deprecated: true
                  description: |
                    > Use the [additionalNetworks](#huaweicloudinstanceclass-v1-spec-additionalnetworks) field instead.

                    Paths to networks that the secondary VirtualMachines NICs will connect to.
                  x-doc-examples:
                  - ['BGP-network-VLAN-3894', 'External-VLAN-3699']
                  type: array
                  items:
                    type: string
                  x-doc-required: false
                securityGroups:
                  description: |
                    Security groups that will be applied to VM's network ports in addition to security groups set in a cloud provider configuration.

                    These security groups allow you to set firewall rules for provisioned instances.

                    The `SecurityGroups` group may not be supported by the cloud provider.
                  x-doc-examples:
                    - ["security-group-1", "security-group-2"]
                  type: array
                  items:
                    type: string
                  x-doc-required: false
                serverGroupID:
                  description: The server group to assign the machine to.
                  type: string
                  x-doc-examples: ['server-group-1']
                  x-doc-required: false
                vipAddress:
                  description: |
                    If filled, enables Virtual IP for all nodes in this instance class. 
                    
                    `Auto` or IPv4 address are expected.
                  type: string
                  pattern: ^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$|^Auto$
                  x-doc-examples: ['Auto']
                  x-doc-required: false
              x-kubernetes-validations:
                - message: "Fields 'subnets' and 'mainNetwork'/'additionalNetworks' are exclusive. Specify only one."
                  rule: "!(has(self.subnets) && (has(self.mainNetwork) || has(self.additionalNetworks)))"
            status:
              type: object
              properties:
                nodeGroupConsumers:
                  type: array
                  items:
                    type: string
      additionalPrinterColumns:
        - name: "Node Groups"
          type: string
          description: NodeGroups that use this instance class.
          jsonPath: .status.nodeGroupConsumers
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
  scope: Cluster
  names:
    plural: huaweicloudinstanceclasses
    singular: huaweicloudinstanceclass
    kind: HuaweiCloudInstanceClass
    categories:
      - cloudinstanceclasses
