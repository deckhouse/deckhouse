kind: VCDClusterConfiguration
apiVersions:
  - apiVersion: deckhouse.io/v1
    openAPISpec:
      description: |
        Описывает конфигурацию облачного кластера в VCD.

        Используется облачным провайдером, если управляющий слой (control plane) кластера размещен в облаке.

        Выполните следующую команду, чтобы изменить конфигурацию в запущенном кластере:

        ```shell
        d8 system edit provider-cluster-configuration
        ```

        > После изменения параметров узлов необходимо выполнить команду [dhctl converge](/products/kubernetes-platform/documentation/v1/admin/configuration/platform-scaling/node/cloud-node.html), чтобы изменения вступили в силу.
      properties:
        masterNodeGroup:
          description: |
            Спецификация для описания NodeGroup master-узлов.

            > Чтобы изменения вступили в силу, после изменения параметров секции `masterNodeGroup` выполните команду `dhctl converge`.
          properties:
            replicas:
              description: |
                Количество создаваемых master-узлов. Для обеспечения кворума важно, чтобы оно было нечетным.
            instanceClass:
              description: |
                Частичное содержимое полей [VCDInstanceClass](cr.html#vcdinstanceclass).
              properties:
                rootDiskSizeGb:
                  description: |
                    Размер root-диска. Значение указывается в гигабайтах.
                etcdDiskSizeGb:
                  description: |
                    Размер диска etcd. Значение указывается в гигабайтах.
                placementPolicy:
                  description: |
                    PlacementPolicy, которая будет использоваться на данном компьютере.

                    Если PlacementPolicy не указана, для создания узлов будет использоваться PlacementPolicy по умолчанию.
                sizingPolicy:
                  description: |
                    SizingPolicy, которая будет использоваться на данном компьютере.

                    Если SizingPolicy не указана, для создания узлов будет использоваться SizingPolicy по умолчанию.
                storageProfile:
                  description: |
                    StorageProfile, который будет использоваться на данном компьютере.
                template:
                  description: |
                    Путь к шаблону OVA, который будет использоваться.

                    Состоит из организации (опционально), каталога и названия или идентификатора шаблона. Если используется общий каталог, имя организации указывать обязательно (оно может отличаться от значения `provider.organization`).

                    Если в нескольких каталогах с одинаковым названием есть шаблоны с одинаковым именем, следует указать идентификатор шаблона.

                    Идентификатор шаблона можно найти в URL-адресе при открытии шаблона в пользовательском интерфейсе vCD. Например, если URL-адрес `https://vcd.example.com/tenant/MyOrg/libraries/catalogs/1032506a-4555-43e1-8589-77b0c0522c75/catalog-vapp-templates/5438c9f2-7e59-4eb3-b37c-cbd7f3e710c7/general`, то идентификатор шаблона будет `5438c9f2-7e59-4eb3-b37c-cbd7f3e710c7`.
                mainNetworkIPAddresses:
                  description: |
                    Список статических IP-адресов (с префиксом CIDR), последовательно распределенных по узлам в `mainNetwork`.

                    По умолчанию DHCP-клиент включен.
                  items:
                    description: IP-адрес с префиксом CIDR.
                additionalMetadata:
                  description: |
                    Пользовательские строковые пары ключ-значение, которые будут добавлены в раздел метаданных (Metadata) каждой виртуальной машины master-узлов. Это позволяет более эффективно организовывать и классифицировать виртуальные машины в вашей системе виртуализации.

                    Свойства из этого поля будут объединены с уже существующими метаданными, хранящимися в поле `metadata` в корне спецификации.
                    В случае совпадения ключей значения из этого поля имеют приоритет.
                affinityRule:
                  description: |
                    Определяет правило размещения, применяемое к виртуальным машинам master-узлов внутри кластера.
                    Такие правила определяют, как узлы располагаются друг относительно друга на уровне гипервизоров,
                    что может повысить отказоустойчивость и контролировать распределение рабочих нагрузок.
                    Если не указано, правило размещения применяться не будет.
                  properties:
                    polarity:
                      description: |
                        Полярность правила размещения. Должно быть либо `Affinity`, либо `AntiAffinity`.
                        `Affinity` означает, что узлы должны быть размещены на одном хосте,
                        в то время как `AntiAffinity` означает, что они должны быть размещены на разных хостах.
                    required:
                      description: |
                        Указывает, является ли правило размещения обязательным (`true`) или предпочтительным (`false`).
                        Если установлено в `true`, правило должно быть соблюдено; если в `false`, правило применяется, если это возможно, но не является строго обязательным.
        nodeGroups:
          description: |
            Массив дополнительных NodeGroup для создания статических узлов (например, для выделенных frontend-узлов или шлюзов).
          items:
            properties:
              name:
                description: |
                  Имя NodeGroup, которое будет использоваться для генерации имен узлов.
              replicas:
                description: |
                  Количество узлов.
              nodeTemplate:
                description: |
                  Настройки Node-объектов в Kubernetes, которые будут добавлены после регистрации узлов.
                properties:
                  labels:
                    description: |
                      Список лейблов, которые будут прикреплены ко всем ресурсам кластера (если они это поддерживают).

                      Аналогично стандартному [полю](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.25/#objectmeta-v1-meta) `metadata.labels`.
                  annotations:
                    description: |
                      Аналогично стандартному [полю](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.25/#objectmeta-v1-meta) `metadata.annotations`.
                  taints:
                    description: |
                      Аналогично полю `.spec.taints` из объекта [Node](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.25/#taint-v1-core).

                      > Доступны только поля `effect`, `key`, `values`.
              instanceClass:
                description: |
                  Частичное содержимое полей [VCDInstanceClass](cr.html#vcdinstanceclass).
                properties:
                  rootDiskSizeGb:
                    description: |
                      Размер root-диска. Значение указывается в гигабайтах.
                  placementPolicy:
                    description: |
                      PlacementPolicy, которая будет использоваться на данном компьютере.

                      Если PlacementPolicy не указана, для создания узлов будет использоваться PlacementPolicy по умолчанию.
                  sizingPolicy:
                    description: |
                      SizingPolicy, которая будет использоваться на данном компьютере.

                      Если SizingPolicy не указана, для создания узлов будет использоваться SizingPolicy по умолчанию.
                  storageProfile:
                    description: |
                      StorageProfile, который будет использоваться на данном компьютере.
                  template:
                    description: |
                      Путь к шаблону OVA, который будет использоваться.

                      Состоит из организации (опционально), каталога и названия или идентификатора шаблона. Если используется общий каталог, имя организации указывать обязательно (оно может отличаться от значения `provider.organization`).

                      Если в нескольких каталогах с одинаковым названием есть шаблоны с одинаковым именем, следует указать идентификатор шаблона.

                      Идентификатор шаблона можно найти в URL-адресе при открытии шаблона в пользовательском интерфейсе vCD. Например, если URL-адрес `https://vcd.example.com/tenant/MyOrg/libraries/catalogs/1032506a-4555-43e1-8589-77b0c0522c75/catalog-vapp-templates/5438c9f2-7e59-4eb3-b37c-cbd7f3e710c7/general`, то идентификатор шаблона будет `5438c9f2-7e59-4eb3-b37c-cbd7f3e710c7`.
                  mainNetworkIPAddresses:
                    description: |
                      Список статических IP-адресов (с префиксом CIDR), последовательно распределенных по узлам в `mainNetwork`.

                      По умолчанию DHCP-клиент включен.
                    items:
                      description: IP-адрес с префиксом CIDR.
                  additionalMetadata:
                    type: object
                    description: |
                      Пользовательские строковые пары ключ-значение, которые будут добавлены в раздел метаданных (Metadata) каждой виртуальной машины master-узлов. Это позволяет более эффективно организовывать и классифицировать виртуальные машины в вашей системе виртуализации.

                      Свойства из этого поля будут объединены с уже существующими метаданными, хранящимися в поле `metadata` в корне спецификации.
                      В случае совпадения ключей значения из этого поля имеют приоритет.
                  affinityRule:
                    description: |
                      Определяет правило размещения, применяемое к виртуальным машинам узлов данной NodeGroup внутри кластера.
                      Такие правила определяют, как узлы располагаются друг относительно друга на уровне гипервизоров,
                      что может повысить отказоустойчивость и контролировать распределение рабочих нагрузок.
                      Если не указано, правило размещения применяться не будет.
                    properties:
                      polarity:
                        description: |
                          Полярность правила размещения. Должно быть либо `Affinity`, либо `AntiAffinity`.
                          `Affinity` означает, что узлы должны быть размещены на одном хосте,
                          в то время как `AntiAffinity` означает, что они должны быть размещены на разных хостах.
                      required:
                        description: |
                          Указывает, является ли правило размещения обязательным (`true`) или предпочтительным (`false`).
                          Если установлено в `true`, правило должно быть соблюдено; если в `false`, правило применяется, если это возможно, но не является строго обязательным.
        bastion:
          description: |
            Параметры конфигурации бастион-хоста, используемого для обеспечения административного доступа к узлам кластера.
          properties:
            instanceClass:
              description: |
                Частичное содержимое полей [VCDInstanceClass](cr.html#vcdinstanceclass).
              properties:
                rootDiskSizeGb:
                  description: |
                    Размер root-диска. Значение указывается в гигабайтах.
                placementPolicy:
                  description: |
                    Политика размещения (PlacementPolicy), которая будет применяться к данному хосту.

                    Если политика размещения не указана, будет использована политика размещения по умолчанию для создания хостов.
                sizingPolicy:
                  description: |
                    Политика масштабирования (SizingPolicy), которая будет использоваться на данном хосте.

                    Если политика масштабирования не указана, будет использована политика масштабирования по умолчанию для создания хостов.
                storageProfile:
                  description: |
                    Профиль хранения данных (StorageProfile), который будет использоваться на данном хосте.
                template:
                  description: |
                    Путь к шаблону OVA, который будет использоваться.

                    Путь состоит из имени организации (опционально), каталога и имени или идентификатора шаблона. Если используется общий каталог, имя организации указывать обязательно (оно может отличаться от значения `provider.organization`).

                    Если в нескольких каталогах с одинаковым названием есть шаблоны с одинаковыми именами, необходимо указать идентификатор шаблона.

                    Идентификатор шаблона можно найти в URL-адресе при открытии шаблона в пользовательском интерфейсе VCD. Например, если URL-адрес `https://vcd.example.com/tenant/MyOrg/libraries/catalogs/1032506a-4555-43e1-8589-77b0c0522c75/catalog-vapp-templates/5438c9f2-7e59-4eb3-b37c-cbd7f3e710c7/general`, то идентификатор шаблона будет `5438c9f2-7e59-4eb3-b37c-cbd7f3e710c7`.
                mainNetworkIPAddress:
                  description: |
                    IP-адрес бастион-хоста в `mainNetwork`.

                    По умолчанию DHCP-клиент включен.
                additionalMetadata:
                  description: |
                    Пользовательские строковые пары ключ-значение, которые будут добавлены в раздел метаданных (Metadata) каждой виртуальной машины master-узлов. Это позволяет более эффективно организовывать и классифицировать виртуальные машины в вашей системе виртуализации.

                    Свойства из этого поля будут объединены с уже существующими метаданными, хранящимися в поле `metadata` в корне спецификации.
                    В случае совпадения ключей значения из этого поля имеют приоритет.
        sshPublicKey:
          description: |
            Публичный ключ для доступа на узлы.
        organization:
          description: |
            Имя VMware Cloud Director Organization.
        virtualDataCenter:
          description: |
            Имя VMware Cloud Director Virtual Data Center (принадлежащее Organization).
        virtualApplicationName:
          description: |
            Имя VMware Cloud Director Virtual Application (принадлежащее Virtual Data Center).
        edgeGateway:
          description: |
            Свойства VMware Cloud Director Edge Gateway (принадлежащее Virtual Data Center).
          properties:
            name:
              description: |
                Имя VMware Cloud Director Edge Gateway.
            type:
              description: |
                Тип платформы сетевой виртуализации, обеспечивающей работу VMware Cloud Director Edge Gateway (один из "NSX-V" или "NSX-T").
                Тип платформы можно узнать у администратора.
            externalIP:
              description: |
                IP-адрес, доступный из внешних сетей, через который
                входящие SSH-соединения перенаправляются на мастер-узел с использованием DNAT.
            externalPort:
              description: |
                Внешний порт, сопоставленный правилом DNAT для перенаправления входящих SSH
                соединений на мастер-узел.
            NSX-V:
              description: |
                Дополнительные параметры, необходимые, если `type` равно NSX-V.
              properties:
                externalNetworkName:
                  description: |
                    Имя внешней сети для создания правила DNAT для мастер-узла.
                    Внешняя сеть — это сеть, подключённая к Edge Gateway в разделе `Gateway Interface` и имеющая внешний IP-адрес.
                externalNetworkType:
                  description: |
                    Тип внешней сети для создания правила DNAT для мастер-узла (один из "org" или "ext").
        createDefaultFirewallRules:
          description: |
            Если включено, настраивает следующие правила брандмауэра по умолчанию для основной сети кластера (mainNetwork):
              - Разрешает все исходящие соединения из mainNetwork.
              - Разрешает все входящие ICMP-пакеты в mainNetwork.
              - Разрешает все входящие TCP-соединения в mainNetwork на порт 22 (SSH).
              - Разрешает все входящие TCP и UDP-соединения в mainNetwork для NodePorts в диапазоне 30000–32767.

            **Внимание!** Использование этой опции совместно с Edge Gateway типа NSX-T подразумевает, что к одному Edge Gateway может быть привязан только один кластер, поскольку в этом случае все существующие правила брандмауэра будут перезаписаны.
          x-doc-default: false
        mainNetwork:
          description: |
            Путь до сети, которая будет подключена к виртуальной машине как основная (шлюз по умолчанию).
        internalNetworkCIDR:
          description: |
            Адресация для внутренней сети узлов кластера.
        internalNetworkDNSServers:
          description: |
            Список адресов рекурсивных DNS серверов.
        internalNetworkDHCPPoolStartAddress:
          description: |
            Задает номер адреса в внутренней сети, с которого начинается пул DHCP-адресов.
            Адреса с номерами ниже этого значения не будут выдаваться автоматически по DHCP и доступны для ручного назначения.
            Если значение не указано, по умолчанию используется 30.

            Например, в сети 192.168.100.128/27 значение 10 означает, что пул DHCP начнется с IP-адреса 192.168.100.138.
            Пул закончится на адресе, который непосредственно предшествует широковещательному (192.168.100.159), то есть на последнем пригодном для назначения адресе.
        layout:
          description: |
            Способ размещения ресурсов в облаке.

            [Подробнее](https://deckhouse.ru/modules/cloud-provider-vcd/layouts.html) о возможных вариантах размещения.
        provider:
          description: Параметры для подключения к VCD.
          properties:
            server:
              description: Хост или IP-адрес VCD-сервера.
            username:
              description: Имя пользователя с полными правами на проект.
            password:
              description: Пароль пользователя.
            apiToken:
              description: |
                Токен для аутентификации.

                > **Внимание!** При использовании `apiToken` необходимо оставить `username` и `password` пустыми.
            insecure:
              description:  Устанавливается в `true`, VCD имеет self-signed-сертификат.
        legacyMode:
          description: |
            Режим поддержки устаревших версий API VCD.

            Если задано значение `true`, будет использоваться версия API ниже `37.2`.

            Параметр имеет эффект только при установке кластера. В работающем кластере необходимость включения режима поддержки устаревших версий API определяется автоматически.
        metadata:
          description: |
            Пользовательские метаданные, которые будут сохранены в объектах кластера, таких как виртуальные машины, диски и сеть. Это позволяет более эффективно организовывать и классифицировать ресурсы в вашей системе виртуализации.

            Очистка полей `metadata` и `additionalMetadata` при наличии в них ключей приведет к прекращению отслеживания всех метаданных, за исключением узлов типа CloudEphemeral. В таком случае удаление метаданных возможно только вручную.

            > **Внимание.** Изменение метаданных приведет к пересозданию CloudEphemeral-узлов.
