{{- define "webhook_resources" }}
cpu: 25m
memory: 50Mi
{{- end }}

{{- if .Values.userAuthz.enableMultiTenancy }}
  {{- if (.Values.global.enabledModules | has "vertical-pod-autoscaler") }}
---
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: user-authz-webhook
  namespace: d8-{{ .Chart.Name }}
  {{- include "helm_lib_module_labels" (list . (dict "app" "user-authz-webhook")) | nindent 2 }}
spec:
  targetRef:
    apiVersion: "apps/v1"
    kind: DaemonSet
    name: user-authz-webhook
  updatePolicy:
    updateMode: "InPlaceOrRecreate"
  resourcePolicy:
    containerPolicies:
    - containerName: webhook
      minAllowed:
        {{- include "webhook_resources" . | nindent 8 }}
      maxAllowed:
        cpu: 50m
        memory: 50Mi
  {{- end }}

{{- if or (.Values.global.discovery.apiVersions | has "deckhouse.io/v1alpha1/SecurityPolicyException") (.Capabilities.APIVersions.Has "deckhouse.io/v1alpha1/SecurityPolicyException") }}
---
apiVersion: deckhouse.io/v1alpha1
kind: SecurityPolicyException
metadata:
  name: {{ $.Chart.Name }}-webhook
  namespace: d8-{{ $.Chart.Name }}
  {{- include "helm_lib_module_labels" (list . (dict "app" $.Chart.Name)) | nindent 2 }}
spec:
  network:
    hostNetwork:
      allowedValue: true
      metadata:
        description: |
          User Authz Webhook need to run on hostNetwork for fault tolerance. Architectural feature.
          The pod runs on the host network to ensure independence from the state of the "Service" object in k8s.
    hostPorts:
      # kube-apiserver calls the authorization webhook via node-local endpoint `https://127.0.0.1:40443`.
      # This port is not used for inter-node traffic, but it must be explicitly allowed for hostNetwork pods
      # to satisfy Admission Policy Engine / dmt validation rules.
      - port: 40443
        protocol: TCP
        metadata:
          description: Node-local authorization webhook listener.    
{{- end }}   
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: user-authz-webhook
  namespace: d8-{{ .Chart.Name }}
  {{- include "helm_lib_module_labels" (list . (dict "app" "user-authz-webhook")) | nindent 2 }}
spec:
  selector:
    matchLabels:
      app: user-authz-webhook
  template:
    metadata:
      labels:
        app: user-authz-webhook
        security.deckhouse.io/security-policy-exception: {{ $.Chart.Name }}-webhook
    spec:
      {{- include "helm_lib_priority_class" (tuple . "system-node-critical") | nindent 6 }}
      {{- include "helm_lib_node_selector" (tuple . "master") | nindent 6 }}
      {{- include "helm_lib_tolerations" (tuple . "any-node") | nindent 6 }}
      {{- include "helm_lib_module_pod_security_context_run_as_user_deckhouse" . | nindent 6 }}
      automountServiceAccountToken: true
      imagePullSecrets:
      - name: deckhouse-registry
      hostNetwork: true
      serviceAccountName: webhook
      dnsPolicy: ClusterFirstWithHostNet
      containers:
      - name: webhook
        {{- include "helm_lib_module_container_security_context_pss_restricted_flexible" dict | nindent 8 }}
        image: {{ include "helm_lib_module_image" (list $ "webhook") }}
        ports:
        - name: authz-webhook
          containerPort: 40443
          protocol: TCP
        # Use node-local kube-apiserver endpoint (hostNetwork) instead of ClusterIP "kubernetes" service.
        # Some environments may block access to ClusterIP from hostNetwork pods, which makes the webhook unstable.
        env:
        - name: KUBERNETES_SERVICE_HOST
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
        - name: KUBERNETES_SERVICE_PORT
          value: "6443"
        volumeMounts:
        - mountPath: /etc/user-authz-webhook/
          name: user-authz-webhook-config
          readOnly: true
        - mountPath: /etc/ssl/user-authz-webhook
          name: user-authz-webhook-secret
        - mountPath: /etc/ssl/apiserver-authentication-requestheader-client-ca
          name: apiserver-authentication-requestheader-client-ca
        livenessProbe:
          exec:
            command:
            - /healthcheck
          # Wait for one minute before restarting the container to avoid crashloopbackoofs in case if apiserver restarts
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          failureThreshold: 6
        resources:
          requests:
            {{- include "helm_lib_module_ephemeral_storage_only_logs" . | nindent 12 }}
{{- if not ( .Values.global.enabledModules | has "vertical-pod-autoscaler") }}
            {{- include "webhook_resources" . | nindent 12 }}
{{- end }}
      volumes:
      - name: user-authz-webhook-secret
        secret:
          secretName: user-authz-webhook
      - name: apiserver-authentication-requestheader-client-ca
        configMap:
          name: apiserver-authentication-requestheader-client-ca
      - name: user-authz-webhook-config
        configMap:
          name: user-authz-webhook
{{- end }}
