- name: d8.node-local-dns.forward
  rules:
    - alert: D8NodeLocalDNSForwardHealthcheckBrokenSpike
      expr: increase(coredns_forward_healthcheck_broken_total{job="node-local-dns"}[5m]) > 10
      for: 2m
      labels:
        severity_level: "5"
        tier: cluster
      annotations:
        summary: "Too many upstream healthcheck failures in 'forward' plugin"
        description: |
          The 'forward' plugin healthcheck system failed completely >10 times in 5 minutes on node `{{$labels.node}}`.
          This means all upstreams were considered unhealthy.

    - alert: D8NodeLocalDNSForwardMaxConcurrentRejects
      expr: increase(coredns_forward_max_concurrent_rejects_total{job="node-local-dns"}[5m]) > 20
      for: 1m
      labels:
        severity_level: "5"
        tier: cluster
      annotations:
        summary: "The 'forward' plugin is rejecting DNS queries due to max concurrency"
        description: |
          More than 20 queries were rejected in the last 5 minutes on node `{{$labels.node}}`
          because the max concurrent query limit was reached.
