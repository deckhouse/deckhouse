{{- define "stale_sockets_cleaner_resources" }}
cpu: 10m
memory: 50Mi
{{- end }}
---
{{- if (.Values.global.enabledModules | has "cni-cilium") }}
{{- if (.Values.global.enabledModules | has "vertical-pod-autoscaler-crd") }}
---
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: stale-sockets-cleaner
  namespace: kube-system
  {{- include "helm_lib_module_labels" (list . (dict "app" "stale-sockets-cleaner" "workload-resource-policy.deckhouse.io" "every-node")) | nindent 2 }}
spec:
  targetRef:
    apiVersion: apps/v1
    kind: DaemonSet
    name: stale-sockets-cleaner
  updatePolicy:
    updateMode: "Initial"
  resourcePolicy:
    containerPolicies:
    - containerName: stale-sockets-cleaner
      minAllowed:
        {{- include "stale_sockets_cleaner_resources" . | nindent 8 }}
      maxAllowed:
        cpu: 50m
        memory: 50Mi
{{- end }}
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: stale-sockets-cleaner
  namespace: kube-system
  {{- include "helm_lib_module_labels" (list . (dict "app" "stale-sockets-cleaner")) | nindent 2 }}
spec:
  selector:
    matchLabels:
      app: stale-sockets-cleaner
  template:
    metadata:
      labels:
        app: stale-sockets-cleaner
    spec:
      {{- include "helm_lib_priority_class" (tuple . "cluster-medium") | nindent 6 }}
      {{- include "helm_lib_tolerations" (tuple . "any-node") | nindent 6 }}
      {{- /*
      {{- include "helm_lib_module_pod_security_context_run_as_user_deckhouse" . | nindent 6 }}
      */}}
      {{- include "helm_lib_module_pod_security_context_run_as_user_root" . | nindent 6 }}
      hostNetwork: true
      imagePullSecrets:
      - name: deckhouse-registry
      serviceAccountName: stale-sockets-cleaner
      containers:
      - name: stale-sockets-cleaner
        {{- /*
          UID: 0 GID:0 using for privilege access for iptables because using hostNetwork
        */}}
        securityContext:
          allowPrivilegeEscalation: true
          capabilities:
            add:
            - DAC_OVERRIDE
            - NET_RAW
            - NET_ADMIN
            - NET_BIND_SERVICE
            drop:
            - ALL
          runAsGroup: 0
          runAsNonRoot: false
          runAsUser: 0
        image: {{ include "helm_lib_module_image" (list . "staleSocketsCleaner") }}
        command: ["/stale-sockets-cleaner"]
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: spec.nodeName
        resources:
          requests:
            {{- include "helm_lib_module_ephemeral_storage_only_logs" . | nindent 12 }}
{{- if not ( .Values.global.enabledModules | has "vertical-pod-autoscaler-crd") }}
            {{- include "stale_sockets_cleaner_resources" . | nindent 12 }}
{{- end }}
{{- end }}
