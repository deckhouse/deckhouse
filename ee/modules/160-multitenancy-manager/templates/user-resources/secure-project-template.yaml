---
apiVersion: deckhouse.io/v1alpha1
kind: ProjectTemplate
metadata:
  name: secure
spec:
  parametersSchema:
    openAPIV3Schema:
      requests:
        type: object
        properties:
          cpu:
            oneOf:
              - type: number
                format: int
              - type: string
            pattern: "^[0-9]+m?$"
          memory:
            oneOf:
              - type: number
                format: int
              - type: string
            pattern: '^[0-9]+(\.[0-9]+)?(E|P|T|G|M|k|Ei|Pi|Ti|Gi|Mi|Ki)?$'
          storage:
            type: string
            pattern: '^[0-9]+(\.[0-9]+)?(E|P|T|G|M|k|Ei|Pi|Ti|Gi|Mi|Ki)?$'
      limits:
        type: object
        properties:
          cpu:
            oneOf:
              - type: number
                format: int
              - type: string
            pattern: "^[0-9]+m?$"
          memory:
            oneOf:
              - type: number
                format: int
              - type: string
            pattern: '^[0-9]+(\.[0-9]+)?(E|P|T|G|M|k|Ei|Pi|Ti|Gi|Mi|Ki)?$'
      administrators:
        description: |
          Who has the access to the project
        type: array
        items:
          type: object
          required:
            - subject
            - name
          properties:
            subject:
              description: |
                Kind of the target resource to apply access to the
                environment (`Group` or `User`).
              enum:
                - User
                - Group
              type: string
            name:
              description: |
                The name of the target resource to apply access
                to the environment.
              minLength: 1
              type: string
      networkPolicy:
        description: |
          To create network policy or not.
        enum:
          - Isolated
          - NotRestricted
        type: string
        default: Isolated
      extendedMoniroting:
        description: |
          Extended monitoring (set the label extended-monitoring.deckhouse.io/enabled on the namespace or not).
        type: boolean
        default: true
      clusterLogDestnationName:
        description: |
          The value for the clusterlogdestination in the podloggingconfig.
        type: string
      enabledAudit:
        description: |
          Enable audit rules (create a falco audit rule to record some malicious activities of the pods in a given namespace).
        type: boolean
        default: false
      securityScanning:
        description: |
          Allows you to run periodic vulnerability scans. It is based on the Trivy project.
          Scanning is performed every 24 hours.
        type: boolean
        default: true
      allowedUIDs:
        description: |
          Range of IDs allowed for users.
        required:
          - min
          - max
        properties:
          max:
            type: number
          min:
            type: number
      allowedGIDs: 
        description: |
          Range of IDs allowed for groups.
        required:
          - min
          - max
        properties:
          max:
            type: number
          min:
            type: number
  resourcesTemplate: |
    ---
    apiVersion: v1
    kind: Namespace
    metadata:
      {{ with .projectName }}name: {{ . }}{{ end }}
      annotations:
        {{ if .parameters.extendedMoniroting }}extended-monitoring.deckhouse.io/enabled: ""{{ end }}
      labels:
        {{ if .parameters.securityScanning }}security-scanning.deckhouse.io/enabled: ""{{ end }}
    {{- range $administrator := .parameters.administrators }}
    ---
    apiVersion: deckhouse.io/v1alpha1
    kind: AuthorizationRule
    metadata:
      name: {{ $administrator.name }}
    spec:
      accessLevel: Admin
      subjects:
      - kind: {{ $administrator.subject }}
        name: {{ $administrator.name }}
    {{- end }}
    ---
    # Max requests and limits for resource and storage consumption for all pods in a namespace.
    # Refer to https://kubernetes.io/docs/concepts/policy/resource-quotas/
    apiVersion: v1
    kind: ResourceQuota
    metadata:
      name: all-pods
    spec:
      hard:
        {{ with .parameters.requests.cpu }}requests.cpu: {{ . }}{{ end }}
        {{ with .parameters.requests.memory }}requests.memory: {{ . }}{{ end }}
        {{ with .parameters.requests.storage }}requests.storage: {{ . }}{{ end }}
        {{ with .parameters.limits.cpu }}limits.cpu: {{ . }}{{ end }}
        {{ with .parameters.limits.memory }}limits.memory: {{ . }}{{ end }}
    ---
    # Deny all network traffic by default except namespaced traffic and dns.
    # Refer to https://kubernetes.io/docs/concepts/services-networking/network-policies/
    {{- if eq .parameters.networkPolicy "Isolated" }}
    kind: NetworkPolicy
    apiVersion: networking.k8s.io/v1
    metadata:
      name: deny-all-except-current-namespace
    spec:
      podSelector:
        matchLabels: {}
      policyTypes:
        - Ingress
        - Egress
      ingress:
        - from:
            - namespaceSelector:
                matchLabels:
                  kubernetes.io/metadata.name: "{{ .projectName }}"
            - namespaceSelector:
                matchLabels:
                  kubernetes.io/metadata.name: "d8-monitoring"
                podSelector:
                  matchLabels:
                    app: prometheus
      egress:
        - to:
            - namespaceSelector:
                matchLabels:
                  kubernetes.io/metadata.name: "{{ .projectName }}"
        - to:
            - namespaceSelector:
                matchLabels:
                  kubernetes.io/metadata.name: kube-system
          ports:
            - protocol: UDP
              port: 53
    {{- end }}
    ---
    # Refer to https://deckhouse.io/documentation/v1/modules/460-log-shipper/
    {{- with .parameters.clusterLogDestnationName }}
    apiVersion: deckhouse.io/v1alpha1
    kind: PodLoggingConfig
    metadata:
      name: default
    spec:
      clusterDestinationRefs:
        - {{ . }}
    {{- end }}
    ---
    # Enable audit rules (create a falco audit rule to record some malicious activities of the pods in a given namespace).
    # As example send notifications when a shell is run in a container.
    # Refer to https://deckhouse.io/documentation/v1/modules/650-runtime-audit-engine/examples.html
    {{- if .parameters.enabledAudit }}
    apiVersion: deckhouse.io/v1alpha1
    kind: FalcoAuditRules
    metadata:
      name: run-shell-in-container
    spec:
      rules:
      - macro: 
          name: container
          condition: container.id != host
      
      - macro: 
          name: spawned_process
          condition: evt.type = execve and evt.dir=<
      
      - rule: 
          name: run_shell_in_container
          desc: a shell was spawned by a non-shell program in a container. Container entrypoints are excluded.
          condition: container and proc.name = bash and spawned_process and proc.pname exists and not proc.pname in (bash, docker)
          output: "Shell spawned in a container other than entrypoint (user=%user.name container_id=%container.id container_name=%container.name shell=%proc.name parent=%proc.pname cmdline=%proc.cmdline)"
          priority: Warning
    {{ end }}
    ---
    # Allowed uids/guids with the SecurityPolicy
    # Refer to https://deckhouse.io/documentation/v1/modules/015-admission-policy-engine/cr.html#securitypolicy
    apiVersion: deckhouse.io/v1alpha1
    kind: SecurityPolicy
    metadata:
      name: mypolicy
    spec:
      enforcementAction: Deny
      policies:
        {{- with .parameters.allowedGIDs }}
        runAsGroup:
          ranges:
          - max: {{ .max }}
            min: {{ .min }}
          rule: MustRunAs
        {{- end }}
        {{- with .parameters.allowedUIDs }}
        runAsUser:
          ranges:
          - max: {{ .max }}
            min: {{ .min }}
          rule: MustRunAs
        {{- end }}
      match:
        namespaceSelector:
          labelSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .projectName }}
