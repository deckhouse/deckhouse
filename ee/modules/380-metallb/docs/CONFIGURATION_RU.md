---
title: "Модуль metallb: настройки"
---


Модуль по умолчанию **выключен**. Для включения добавьте в ConfigMap `deckhouse`:

```yaml
data:
  metallbEnabled: "true"
```

## Параметры

Для настройки модуля предусмотрены следующие параметры в ConfigMap `deckhouse`:

* `speaker` — настройки компонента `speaker`, который реализует протокол публикации (`bgp` или `layer2` (LVS)) и направляет на свой узел прикладной трафик сервисов.
  * `nodeSelector` — селектор узлов, на которых будет работать DaemonSet speaker.
    * Обязательный параметр.
  * `tolerations` — противоядие против `taints` на узлах.
    * Опциональный параметр.
* `bgpPeers` — список внешних BGP-роутеров, которые будут работать с этим модулем.
  * Формат — массив [как у оригинального MetalLB](https://metallb.universe.tf/configuration/#bgp-configuration). Основные параметры:
    * `peer-address` — IP внешнего BGP-роутера.
    * `peer-asn` — номер автономной системы на внешнем BGP-роутере.
    * `my-asn` — номер автономной системы на вашем кластере.
    * `source-address` - адрес для исходящих соединений.
    * `hold-time` — таймаут, после которого партнёрский BGP-пир считается утерянным. Это значение делится на три и получается интервал для keep-alive.
      * Рекомендуемое значение — `3s` (keep-alive раз в секунду), протокол BGP не поддерживает значения меньше.
      * По умолчанию — `90s` (keep-alive раз в 30 секунд).
    * `node-selector` — дополнительный псевдо-селектор, который реализуется приложением speaker-а. Говорит о том, с каких узлов стоит устанавливать связь с внешними BGP-роутерами. Не путать с `speaker.nodeSelector` и  `nodeSelector`.
      * Опциональный параметр.
      * Формат — [`matchLabels` или `matchExpressions`](https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#resources-that-support-set-based-requirements).
  * Если используется только протокол публикации сервисов `layer2`, то параметр — необязательный.
* `addressPools` — список диапазонов IP, которые будут выдаваться сервисам.
  * Формат — массив [как у оригинального MetalLB](https://metallb.universe.tf/configuration/#advanced-address-pool-configuration). Основные параметры:
    * `name` — имя пула, которое можно уточнять с помощью аннотации к сервису `metallb.universe.tf/address-pool: <name>`.
    * `protocol` — технология публикации сервисов, которую должен реализовать speaker. Варианты:
      * `bgp`.
      * `layer2` — использовать L2 LVS.
    * `addresses` — список диапазонов, где диапазон — это либо подсеть с маской, либо диапазон через "-".
* `nodeSelector` — селектор для основного контроллера. Как в Kubernetes в `spec.nodeSelector` у pod'ов.
  * Если ничего не указано или указано `false` — будет [использоваться автоматика](../../#выделение-узлов-под-определенный-вид-нагрузки).
* `tolerations` — толерейшны для основного контроллера. Как в Kubernetes в `spec.tolerations` у pod'ов.
  * Если ничего не указано или указано `false` — будет [использоваться автоматика](../../#выделение-узлов-под-определенный-вид-нагрузки).
