- name: d8.metallb
  rules:
  - alert: D8MetalLBStaleConfig
    expr: metallb_k8s_client_config_stale_bool == 1
    for: 5m
    labels:
      severity_level: "4"
      tier: cluster
    annotations:
      plk_markup_format: "markdown"
      plk_protocol_version: "1"
      plk_create_group_if_not_exists__d8_metallb_failed: D8MetalLBStaleConfig,tier=~tier,prometheus=deckhouse,kubernetes=~kubernetes
      plk_grouped_by__d8_metallb_failed: D8MetalLBStaleConfig,tier=~tier,prometheus=deckhouse,kubernetes=~kubernetes
      description: |
        {{ $labels.job }} - MetalLB {{ $labels.container }} on {{ $labels.pod}} has a stale config for > 5 minutes

  - alert: D8MetalLBConfigNotLoaded
    expr: metallb_k8s_client_config_loaded_bool == 0
    for: 5m
    labels:
      severity_level: "4"
      tier: cluster
    annotations:
      plk_markup_format: "markdown"
      plk_protocol_version: "1"
      plk_create_group_if_not_exists__d8_metallb_failed: D8MetalLBConfigNotLoaded,tier=~tier,prometheus=deckhouse,kubernetes=~kubernetes
      plk_grouped_by__d8_metallb_failed: D8MetalLBConfigNotLoaded,tier=~tier,prometheus=deckhouse,kubernetes=~kubernetes
      description: |
        {{ $labels.job }} - MetalLB {{ $labels.container }} on {{ $labels.pod}} has not loaded for > 5 minutes

  - alert: D8MetalLBAddressPoolExhausted
    expr: metallb_allocator_addresses_in_use_total >= on(pool) metallb_allocator_addresses_total
    for: 5m
    labels:
      severity_level: "4"
      tier: cluster
    annotations:
      plk_markup_format: "markdown"
      plk_protocol_version: "1"
      plk_create_group_if_not_exists__d8_metallb_failed: D8MetalLBAddressPoolExhausted,tier=~tier,prometheus=deckhouse,kubernetes=~kubernetes
      plk_grouped_by__d8_metallb_failed: D8MetalLBAddressPoolExhausted,tier=~tier,prometheus=deckhouse,kubernetes=~kubernetes
      description: |
        {{ $labels.job }} - MetalLB {{ $labels.container }} on {{ $labels.pod}} has exhausted address pool {{ $labels.pool }} for > 5 minutes

  - alert: D8MetalLBAddressPoolUsage80Percent
    expr: ( metallb_allocator_addresses_in_use_total / on(pool) metallb_allocator_addresses_total ) * 100 > 80
    for: 5m
    labels:
      severity_level: "4"
      tier: cluster
    annotations:
      plk_markup_format: "markdown"
      plk_protocol_version: "1"
      plk_create_group_if_not_exists__d8_metallb_failed: D8MetalLBAddressPoolUsage80Percent,tier=~tier,prometheus=deckhouse,kubernetes=~kubernetes
      plk_grouped_by__d8_metallb_failed: D8MetalLBAddressPoolUsage80Percent,tier=~tier,prometheus=deckhouse,kubernetes=~kubernetes
      description: |
        {{ $labels.job }} - MetalLB {{ $labels.container }} on {{ $labels.pod}} has address pool {{ $labels.pool }} past 80% usage for > 5 minutes

  - alert: D8MetalLBBGPSessionDown
    expr: metallb_bgp_session_up == 0
    for: 5m
    labels:
      severity_level: "4"
      tier: cluster
    annotations:
      plk_markup_format: "markdown"
      plk_protocol_version: "1"
      plk_create_group_if_not_exists__d8_metallb_failed: D8MetalLBBGPSessionDown,tier=~tier,prometheus=deckhouse,kubernetes=~kubernetes
      plk_grouped_by__d8_metallb_failed: D8MetalLBBGPSessionDown,tier=~tier,prometheus=deckhouse,kubernetes=~kubernetes
      description:|
        {{ $labels.job }} - MetalLB {{ $labels.container }} on {{ $labels.pod}} has BGP session {{ $labels.peer }} down for > 5 minutes
