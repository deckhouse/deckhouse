- name: d8.embedded-registry-manager.state
  rules:
    - alert: D8EmbeddedRegistryManagerPodIsNotReady
      expr: |-
        min by (pod, namespace, node, created_by_kind, created_by_name) (
            kube_pod_status_ready{condition="true",namespace="d8-system",pod=~"^(system|embedded)-registry.+"}
          * on (namespace, pod) group_left(node, created_by_kind, created_by_name)
            kube_pod_info{created_by_kind!="Node"}
        ) != 1
      for: 2m
      labels:
        severity_level: "8"
        d8_module: embedded-registry
        d8_component: manager
      annotations:
        plk_protocol_version: "1"
        plk_markup_format: "markdown"
        plk_labels_as_annotations: "pod"
        plk_create_group_if_not_exists__d8_embedded_registry_manager_health: "D8EmbeddedRegistryManagerHealth,tier=~tier,prometheus=deckhouse,kubernetes=~kubernetes"
        plk_grouped_by__d8_embedded_registry_manager_health: "D8EmbeddedRegistryManagerHealth,tier=~tier,prometheus=deckhouse,kubernetes=~kubernetes"
        summary: The {{ $labels.namespace }}/{{ $labels.pod }} Pod is NOT Ready.
        description: |
          The recommended course of action:
          1. Retrieve details of the {{ $labels.created_by_kind }}: `kubectl -n d8-system describe {{ $labels.created_by_kind }}/{{ $labels.created_by_name }}`
          2. View the status of the Pod and try to figure out why it is not running: `kubectl -n d8-system describe pod/{{ $labels.pod }}`

    - alert: D8EmbeddedRegistryManagerPodIsNotRunning
      expr: |-
        min by (pod, namespace, node, created_by_kind, created_by_name) (
            kube_pod_status_phase{phase="Running", pod=~"^(system|embedded)-registry.+"}
          * on (namespace, pod) group_left(node, created_by_kind, created_by_name)
            kube_pod_info{created_by_kind!="Node"}
        ) != 1
      for: 2m
      labels:
        severity_level: "8"
        d8_module: embedded-registry
        d8_component: manager
      annotations:
        plk_protocol_version: "1"
        plk_markup_format: "markdown"
        plk_labels_as_annotations: "pod"
        plk_create_group_if_not_exists__d8_embedded_registry_manager_health: "D8EmbeddedRegistryManagerHealth,tier=~tier,prometheus=deckhouse,kubernetes=~kubernetes"
        plk_grouped_by__d8_embedded_registry_manager_health: "D8EmbeddedRegistryManagerHealth,tier=~tier,prometheus=deckhouse,kubernetes=~kubernetes"
        summary: The {{ $labels.namespace }}/{{ $labels.pod }} Pod is NOT Running.
        description: |
          The recommended course of action:
          1. Retrieve details of the {{ $labels.created_by_kind }}: `kubectl -n d8-system describe {{ $labels.created_by_kind }}/{{ $labels.created_by_name }}`
          2. View the status of the Pod and try to figure out why it is not running: `kubectl -n d8-system describe pod/{{ $labels.pod }}`
