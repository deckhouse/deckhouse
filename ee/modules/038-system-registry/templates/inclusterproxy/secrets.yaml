{{- $ctx := .}}
{{- if (include "in_cluster_proxy_enable" $ctx ) }}

# Prepare cfg and pki
{{- $in_cluster_proxy_cfg_files_yaml_raw := (include "in_cluster_proxy_cfg_files" $ctx ) }}
{{- $in_cluster_proxy_pki_files_yaml_raw := (include "in_cluster_proxy_pki_files" $ctx ) }}

---
apiVersion: v1
kind: Secret
metadata:
  name: registry-incluster-proxy-cfg
  namespace: d8-system
  {{- include "helm_lib_module_labels" (list $ctx (dict "app" "registry" "name" "registry-incluster-proxy-cfg")) | nindent 2 }}
  annotations:
    registry.deckhouse.io/orchestrator-hash: {{ (include "orchestrator_hash" $ctx ) | quote }}
    registry.deckhouse.io/incluster-proxy-version: {{ (include "in_cluster_proxy_version" $ctx ) | quote }}
    registry.deckhouse.io/incluster-proxy-cfg-hash: {{ $in_cluster_proxy_cfg_files_yaml_raw | sha256sum | quote }}
type: registry/incluster-proxy-cfg
data:
  {{- $in_cluster_proxy_cfg_files_yaml_raw | nindent 2 }}
---
apiVersion: v1
kind: Secret
metadata:
  name: registry-incluster-proxy-pki
  namespace: d8-system
  {{- include "helm_lib_module_labels" (list $ctx (dict "app" "registry" "name" "registry-incluster-proxy-pki")) | nindent 2 }}
  annotations:
    registry.deckhouse.io/orchestrator-hash: {{ (include "orchestrator_hash" $ctx ) | quote }}
    registry.deckhouse.io/incluster-proxy-version: {{ (include "in_cluster_proxy_version" $ctx ) | quote }}
    registry.deckhouse.io/incluster-proxy-pki-hash: {{ $in_cluster_proxy_pki_files_yaml_raw | sha256sum | quote }}
type: registry/incluster-proxy-pki
data:
  {{- $in_cluster_proxy_pki_files_yaml_raw | nindent 2 }}

{{- end }}