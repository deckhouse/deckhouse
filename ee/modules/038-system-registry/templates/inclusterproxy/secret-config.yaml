{{ $ctx := .}}
{{- if (include "in_cluster_proxy_enable" $ctx ) }}

# Prepare configs
{{ $in_cluster_proxy_config_files_raw := (include "in_cluster_proxy_config_files" $ctx ) }}
{{ $in_cluster_proxy_config_files_yaml := $in_cluster_proxy_config_files_raw | fromYamlArray }}
---
apiVersion: v1
kind: Secret
metadata:
  name: registry-incluster-proxy-config
  namespace: d8-system
  {{- include "helm_lib_module_labels" (list $ctx (dict "app" "registry" "name" "registry-incluster-proxy-config")) | nindent 2 }}
  annotations:
    registry.deckhouse.io/config-hash: {{ $in_cluster_proxy_config_files_raw | sha256sum | quote }}
    registry.deckhouse.io/config-version: {{ (include "in_cluster_proxy_version" $ctx ) | quote }}
type: registry/incluster-proxy-config
data:
{{- range $file := $in_cluster_proxy_config_files_yaml }}
  {{ $file.name }}: {{ $file.b64content | quote }}
{{- end }}
{{- end }}