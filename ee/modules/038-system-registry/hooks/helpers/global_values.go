/*
Copyright 2025 Flant JSC
Licensed under the Deckhouse Platform Enterprise Edition (EE) license. See https://github.com/deckhouse/deckhouse/blob/main/ee/LICENSE
*/

package helpers

import (
	"crypto/x509"
	"fmt"

	"github.com/flant/addon-operator/pkg/module_manager/go_hook"

	registry_pki "github.com/deckhouse/deckhouse/go_lib/registry/pki"
)

const (
	// ingressClientCAPath is a constant path to the certificate for the Kube RBAC Proxy CA
	// This value is always expected to exist as it is generated by "global-hooks/generate_kube_rbac_proxy_ca.go"
	ingressClientCAPath = "global.internal.modules.kubeRBACProxyCA.cert"
)

func GetIngressClientCA(input *go_hook.HookInput) (*x509.Certificate, error) {
	certValue, exists := input.Values.GetOk(ingressClientCAPath)
	if !exists {
		return nil, fmt.Errorf("%s is not exist", ingressClientCAPath)
	}
	certStr := certValue.String()
	if certStr == "" {
		return nil, nil
	}
	return registry_pki.DecodeCertificate([]byte(certStr))
}
