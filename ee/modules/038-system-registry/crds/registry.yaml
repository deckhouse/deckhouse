---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: registries.deckhouse.io
  labels:
    heritage: deckhouse
    module: registry
spec:
  group: deckhouse.io
  scope: Cluster
  names:
    plural: registries
    singular: registry
    kind: Registry
    shortNames:
      - reg
  preserveUnknownFields: false
  versions:
  - name: v1alpha1
    served: true
    storage: true
    subresources:
      status: {}
    additionalPrinterColumns:
    - jsonPath: .spec.mode
      name: Mode
      type: string
    - jsonPath: .status.actualMode
      name: ActualMode
      type: string
    - jsonPath: .status.conditions[?(@.type=="Ready")].status
      name: Ready
      type: string
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    schema: &schema
      openAPIV3Schema:
        type: object
        description: |
          A resource describing the desired registry configuration.
        required:
        - spec
        properties:
          spec:
            type: object
            properties:
              mode:
                type: string
                description: |
                  Registry mode
                enum:
                - Direct
                - Proxy
                - Local
                default: Direct
              direct:
                type: object
                properties:
                  imagesRepo:
                    type: string
                    pattern: '^[0-9a-zA-Z\.\-]+(\:[0-9]{1,5})?(\/[0-9a-zA-Z\.\-\_\/]+)?$'
                    minLength: 1
                    description: |
                      Address of a upstream container registry.
                    x-example: registry.deckhouse.io/deckhouse/ee
                  username:
                    type: string
                    description: Username for accessing upstream container registry.
                    x-example:
                      - license-token
                      - user
                  password:
                    type: string
                    description: Password for accessing upstream container registry.
                    x-example:
                      - my-token-value
                      - password
                  insecure:
                    type: boolean
                  ca:
                    type: string
                    description: |
                      Root CA certificate to validate the container registry’s HTTPS certificate (if self-signed certificates are used).
                  scheme:
                    type: string
                    description: Registry access scheme (HTTP or HTTPS).
                    enum: [HTTP, HTTPS]
                    default: HTTPS
                    x-example:
                      - HTTPS
                      - HTTP
              proxy:
                description: Proxy mode properties.
                type: object
                properties:
                  imagesRepo:
                    type: string
                    pattern: '^[0-9a-zA-Z\.\-]+(\:[0-9]{1,5})?(\/[0-9a-zA-Z\.\-\_\/]+)?$'
                    minLength: 1
                    description: |
                      Address of a upstream container registry.
                    x-example: registry.deckhouse.io/deckhouse/ee
                  username:
                    type: string
                    description: Username for accessing upstream container registry.
                    x-example:
                      - license-token
                      - user
                  password:
                    type: string
                    description: Password for accessing upstream container registry.
                    x-example:
                      - my-token-value
                      - password
                  insecure:
                    type: boolean
                  ca:
                    type: string
                    description: |
                      Root CA certificate to validate the container registry’s HTTPS certificate (if self-signed certificates are used).
                  scheme:
                    type: string
                    description: Registry access scheme (HTTP or HTTPS).
                    enum: [HTTP, HTTPS]
                    default: HTTPS
                    x-example:
                      - HTTPS
                      - HTTP
                  ttl:
                    type: string
                    pattern: '(^(?:(\d+)h)?(?:(\d+)m)?(?:(\d+)s)?(?:(\d+)ms)?(?:(\d+)(µs|us))?(?:(\d+)ns)?$)|(^(0)$)'
                    description: |
                      TTL specifies the expiration time for cached content, after which it will be automatically cleaned up.
                      Default: If not set, the TTL defaults to 7 days (168 hours).
                      Persistent Cache: If set to 0, the cache will never expire.
                    x-example:
                      - "168h"
                      - "168h10m"
                      - "168h10m5s"
                    default: 168h
            oneOf:
              - required: [mode]
                properties:
                  mode:
                    enum: [Direct]
                  direct: {}
                not:
                  required: [proxy, local]
              - required: [mode]
                properties:
                  mode:
                    enum: [Proxy]
                  proxy: {}
                not:
                  required: [direct, local]
              - required: [mode]
                properties:
                  mode:
                    enum: [Local]
                not:
                  required: [direct, proxy]
          status:
            type: object
            required:
              - actualMode
            properties:
              actualMode:
                description: Actual mode of registry
                type: string
                enum:
                - Direct
                - Proxy
                - Local
              observedGeneration:
                description: ObservedGeneration is the latest generation observed
                  by the controller.
                format: int64
                type: integer
              conditions:
                type: array
                items:
                  type: object
                  required:
                    - type
                    - status
                    - reason
                  properties:
                    type:
                      description: Type of condition.
                      type: string
                    status:
                      description: Status of the condition, one of True, False or Unknown.
                      type: string
                      enum: ["True", "False", "Unknown"]
                    lastTransitionTime:
                      type: string
                      format: date-time
                      description: Last time the condition transit from one status to another.
                    reason:
                      description: The reason for the condition's last transition in CamelCase.
                      type: string
                    message:
                      description: Human readable message indicating details about last transition.
                      type: string

