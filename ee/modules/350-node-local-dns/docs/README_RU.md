---
title: "Модуль node-local-dns"
---

## Описание модуля

Разворачивает кэширующий DNS-сервер на каждом узле кластера, экспортирует данные в `Prometheus` для анализа работы DNS в кластере [на доске](#grafana-dashboard) Grafana.

Модуль состоит из оригинального `CoreDNS`, разворачиваемого в DaemonSet на все узлы, с добавлением алгоритма настройки сети и настройки правил iptables.

### Назначение

Существует ряд проблем в стандартной работе DNS в Kubernetes, которые могут привести к снижению показателей работы сервиса:

* Отсутствие кэширования запросов (в Linux из коробки нет кэша, поэтому в Подах его тоже нет).

* Когда контейнер делает DNS-запрос, он обращается к кластерному DNS. Если запрос касается ресурсов на том же узле, всё равно выполняется сетевой запрос.

* Поначалу запрос из Пода разрешается в кластерных DNS-зонах, а потом отправляется на внешние DNS-серверы. Например, запрос к `ya.ru` будет сначала обработан в кластерных зонах: `cluster.local`, `svc.cluster.local` `<namespace>.svc.cluster.local` и т. д. Только после того, как не будет найдено соответствие в этих зонах, произойдет обращение к полноценному домену `ya.ru`.

Из-за приведенных выше проблем качество сервиса может деградировать в случае сетевых задержек. Одним из решений является установка DNS-сервера на каждый узел. Описанный модуль `node-local-dns` предназначен для этого.

Внешние запросы также будут пытаться использовать внутренние зоны для разрешения имен, только если эти имена не находятся в кэше. Это может значительно улучшить разрешение DNS-имен, особенно при большой нагрузке на сервер (когда поступает много запросов на разрешение одних и тех же записей в секунду).

## Grafana dashboard

Дашборд `Kubernetes / DNS (node local)` отображает:

* общие графики (позволяют оценить работу DNS);

* графики по узлам (позволяют глубже изучить найденную на общем графике проблему узла);

* графики по upstream (позволяют оценить работу кластерного DNS и серверов узлов, указанных в `/etc/resolv.conf`).

## Как работает

На каждом узле модуль выполняет следующие настройки:

* Настраивает интерфейс с IP-адресом clusterIP сервиса `kube-dns`.

* Запускает CoreDNS в качестве кэширующего DNS-сервера на определенном адресе.

* Если сокет закрыт, трафик направляется на кластерный IP-адрес. Если сокет открыт, трафик перенаправляется на него. Это достигается путем добавления специального правила в iptables.

Правило для беспроблемного fallback представлено ниже:

```bash
-A PREROUTING -d <IP-адрес kube-dns> -m socket --nowildcard -j NOTRACK
```

### Особенности конфигурации CoreDNS

Основные характеристики конфигурации CoreDNS:

* кэширование всех запросов;

* перенаправление всех DNS-запросов в ClusterIP кластерного DNS.
