From 06d79e4d9c32e5a08ed3fcd9b3f727a4bb30c1ae Mon Sep 17 00:00:00 2001
From: Vladislav Denisov <vlad144denisov@gmail.com>
Date: Mon, 24 Nov 2025 17:22:02 +0300
Subject: [PATCH] Fix: add EnterpriseProjectID support for Cinder-based (<10Gi) volumes

---
 pkg/evs/services/volumes.go | 30 +++++++++++++++++++++++++++---
 1 file changed, 27 insertions(+), 3 deletions(-)

diff --git a/pkg/evs/services/volumes.go b/pkg/evs/services/volumes.go
index c653f77..fe7cca5 100644
--- a/pkg/evs/services/volumes.go
+++ b/pkg/evs/services/volumes.go
@@ -53,12 +53,36 @@ func CreateCinderCompleted(c *config.CloudCredentials, opts *cloudvolumes.Create
 		Throughput:       opts.Volume.Throughput,
 	}
 
-	cinderVol, err := cinder.Create(client, createOpts).Extract()
+	body, err := createOpts.ToVolumeCreateMap()
 	if err != nil {
-		return "", fmt.Errorf("error creating EVS volume, error: %s, createOpts: %#v", err, opts)
+		return "", fmt.Errorf("error building EVS volume create body: %s, createOpts: %#v", err, opts)
 	}
 
-	return cinderVol.ID, waitForCinderFinished(c, cinderVol.ID)
+	if ep := c.Global.EnterpriseProjectID; ep != "" {
+		if vol, ok := body["volume"].(map[string]interface{}); ok {
+			vol["enterprise_project_id"] = ep
+			body["volume"] = vol
+		}
+	}
+
+	type createResp struct {
+		Volume struct {
+			ID string `json:"id"`
+		} `json:"volume"`
+	}
+	var resp createResp
+
+	_, err = client.Post(
+		client.ServiceURL("volumes"),
+		body,
+		&resp,
+		&golangsdk.RequestOpts{OkCodes: []int{200, 201, 202}},
+	)
+	if err != nil {
+		return "", fmt.Errorf("error creating EVS volume (Cinder v2) with EP: %s, body: %#v", err, body)
+	}
+
+	return resp.Volume.ID, waitForCinderFinished(c, resp.Volume.ID)
 }
 
 func waitForCinderFinished(c *config.CloudCredentials, cinderID string) error {
-- 
2.48.1

