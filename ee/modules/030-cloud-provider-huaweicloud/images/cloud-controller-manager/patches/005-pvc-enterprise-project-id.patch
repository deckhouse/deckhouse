From e6585ee5895eece899533c789eccac317e350dc3 Mon Sep 17 00:00:00 2001
From: Vladislav Denisov <vlad144denisov@gmail.com>
Date: Sun, 23 Nov 2025 23:33:46 +0300
Subject: [PATCH] Add EnterpriseProjectID support for all EVS APIs

---
 pkg/config/cloud.go         | 17 +++++++++--------
 pkg/evs/controllerserver.go | 17 +++++++++--------
 pkg/evs/nodeserver.go       | 11 ++++++-----
 pkg/evs/services/volumes.go | 12 ++++++++++++
 4 files changed, 36 insertions(+), 21 deletions(-)

diff --git a/pkg/config/cloud.go b/pkg/config/cloud.go
index 9665375..7feae04 100644
--- a/pkg/config/cloud.go
+++ b/pkg/config/cloud.go
@@ -18,14 +18,15 @@ const (
 // CloudCredentials define
 type CloudCredentials struct {
 	Global struct {
-		Cloud     string `gcfg:"cloud"`
-		AuthURL   string `gcfg:"auth-url"`
-		Region    string `gcfg:"region"`
-		Insecure  bool   `gcfg:"insecure"`
-		AccessKey string `gcfg:"access-key"`
-		SecretKey string `gcfg:"secret-key"`
-		ProjectID string `gcfg:"project-id"`
-		Idc       bool   `gcfg:"idc"`
+		Cloud               string `gcfg:"cloud"`
+		AuthURL             string `gcfg:"auth-url"`
+		Region              string `gcfg:"region"`
+		Insecure            bool   `gcfg:"insecure"`
+		AccessKey           string `gcfg:"access-key"`
+		SecretKey           string `gcfg:"secret-key"`
+		ProjectID           string `gcfg:"project-id"`
+		EnterpriseProjectID string `gcfg:"enterprise-project-id"`
+		Idc                 bool   `gcfg:"idc"`
 	}
 
 	Vpc struct {
diff --git a/pkg/evs/controllerserver.go b/pkg/evs/controllerserver.go
index ef6b11d..6e09b4a 100644
--- a/pkg/evs/controllerserver.go
+++ b/pkg/evs/controllerserver.go
@@ -83,14 +83,15 @@ func (cs *ControllerServer) CreateVolume(_ context.Context, req *csi.CreateVolum
 	metadata := cs.parseMetadata(req, snapshotID)
 	createOpts := &cloudvolumes.CreateOpts{
 		Volume: cloudvolumes.VolumeOpts{
-			Name:             volName,
-			Size:             sizeGB,
-			VolumeType:       volumeType,
-			AvailabilityZone: volumeAz,
-			SnapshotID:       snapshotID,
-			Metadata:         metadata,
-			IOPS:             iops,
-			Throughput:       throughput,
+			Name:                volName,
+			Size:                sizeGB,
+			VolumeType:          volumeType,
+			AvailabilityZone:    volumeAz,
+			SnapshotID:          snapshotID,
+			Metadata:            metadata,
+			IOPS:                iops,
+			Throughput:          throughput,
+			EnterpriseProjectID: credentials.Global.EnterpriseProjectID,
 		},
 		Scheduler: &cloudvolumes.SchedulerOpts{
 			StorageID: dssID,
diff --git a/pkg/evs/nodeserver.go b/pkg/evs/nodeserver.go
index 2c99b51..277960a 100644
--- a/pkg/evs/nodeserver.go
+++ b/pkg/evs/nodeserver.go
@@ -517,11 +517,12 @@ func nodePublishEphemeral(req *csi.NodePublishVolumeRequest, ns *nodeServer) (*c
 
 	volumeID, err = services.CreateVolumeCompleted(cc, &cloudvolumes.CreateOpts{
 		Volume: cloudvolumes.VolumeOpts{
-			Name:             volumeName,
-			Size:             size,
-			VolumeType:       volumeType,
-			AvailabilityZone: volAvailability,
-			Metadata:         metadata,
+			Name:                volumeName,
+			Size:                size,
+			VolumeType:          volumeType,
+			AvailabilityZone:    volAvailability,
+			Metadata:            metadata,
+			EnterpriseProjectID: cc.Global.EnterpriseProjectID,
 		},
 		Scheduler: &cloudvolumes.SchedulerOpts{
 			StorageID: req.VolumeContext[DssIDKey],
diff --git a/pkg/evs/services/volumes.go b/pkg/evs/services/volumes.go
index c653f77..0b90c50 100644
--- a/pkg/evs/services/volumes.go
+++ b/pkg/evs/services/volumes.go
@@ -214,6 +214,12 @@ func getEvsV21Client(c *config.CloudCredentials) (*golangsdk.ServiceClient, erro
 		logMsg := fmt.Sprintf("Failed create EVS V2.1 client: %s", err)
 		return nil, status.Error(codes.Internal, logMsg)
 	}
+	if c.Global.EnterpriseProjectID != "" {
+		if client.MoreHeaders == nil {
+			client.MoreHeaders = map[string]string{}
+		}
+		client.MoreHeaders["X-Enterprise-Project-ID"] = c.Global.EnterpriseProjectID
+	}
 	return client, nil
 }
 
@@ -223,5 +229,11 @@ func getJobV1Client(c *config.CloudCredentials) (*golangsdk.ServiceClient, error
 		logMsg := fmt.Sprintf("Failed create JOB V1 client: %s", err)
 		return nil, status.Error(codes.Internal, logMsg)
 	}
+	if c.Global.EnterpriseProjectID != "" {
+		if client.MoreHeaders == nil {
+			client.MoreHeaders = map[string]string{}
+		}
+		client.MoreHeaders["X-Enterprise-Project-ID"] = c.Global.EnterpriseProjectID
+	}
 	return client, nil
 }
-- 
2.48.1

