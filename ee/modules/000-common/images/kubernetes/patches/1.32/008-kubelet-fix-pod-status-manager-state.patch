From: Backport for InPlacePodVerticalScaling fix
Subject: Extract pod allocation manager from status manager - backport for k8s 1.32

This patch backports the fix from kubernetes/kubernetes commit 84ec78ede717c4f0e3d07a4adf07228303ea1513
to fix issues with InPlacePodVerticalScaling feature in Kubernetes 1.32.

The main change is to add RemoveOrphanedPods() method to the state interface
and use it in RemoveOrphanedStatuses() instead of calling Delete() for each
orphaned pod individually. This fixes a performance issue and ensures proper
cleanup of orphaned pod state.

Changes:
- Add RemoveOrphanedPods() to state.Writer interface
- Implement RemoveOrphanedPods() in stateCheckpoint, noopStateCheckpoint, and stateMemory
- Update status manager to call RemoveOrphanedPods() instead of individual Delete() calls
- Update fake status manager to call RemoveOrphanedPods()

---

diff --git a/pkg/kubelet/status/fake_status_manager.go b/pkg/kubelet/status/fake_status_manager.go
index 6d2031419df..7f05b74de7b 100644
--- a/pkg/kubelet/status/fake_status_manager.go
+++ b/pkg/kubelet/status/fake_status_manager.go
@@ -60,6 +60,7 @@ func (m *fakeManager) TerminatePod(pod *v1.Pod) {
 
 func (m *fakeManager) RemoveOrphanedStatuses(podUIDs map[types.UID]bool) {
 	klog.InfoS("RemoveOrphanedStatuses()")
+	m.state.RemoveOrphanedPods(podUIDs)
 	return
 }
 
diff --git a/pkg/kubelet/status/state/state.go b/pkg/kubelet/status/state/state.go
index 10a66be46c3..7569668f9e3 100644
--- a/pkg/kubelet/status/state/state.go
+++ b/pkg/kubelet/status/state/state.go
@@ -18,6 +18,7 @@ package state
 
 import (
 	v1 "k8s.io/api/core/v1"
+	"k8s.io/apimachinery/pkg/types"
 )
 
 // PodResourceAllocation type is used in tracking resources allocated to pod's containers
@@ -50,6 +51,8 @@ type writer interface {
 	SetPodResourceAllocation(PodResourceAllocation) error
 	SetPodResizeStatus(podUID string, resizeStatus v1.PodResizeStatus)
 	Delete(podUID string, containerName string) error
+	// RemoveOrphanedPods removes the stored state for any pods not included in the list of remaining pod UIDs.
+	RemoveOrphanedPods(remainingPods map[types.UID]bool)
 	ClearState() error
 }
 
diff --git a/pkg/kubelet/status/state/state_checkpoint.go b/pkg/kubelet/status/state/state_checkpoint.go
index 2e1ca729100..100ffbfa156 100644
--- a/pkg/kubelet/status/state/state_checkpoint.go
+++ b/pkg/kubelet/status/state/state_checkpoint.go
@@ -22,6 +22,7 @@ import (
 	"sync"
 
 	v1 "k8s.io/api/core/v1"
+	"k8s.io/apimachinery/pkg/types"
 	"k8s.io/klog/v2"
 	"k8s.io/kubernetes/pkg/kubelet/checkpointmanager"
 	"k8s.io/kubernetes/pkg/kubelet/checkpointmanager/errors"
@@ -154,6 +155,12 @@ func (sc *stateCheckpoint) Delete(podUID string, containerName string) error {
 	return sc.storeState()
 }
 
+func (sc *stateCheckpoint) RemoveOrphanedPods(remainingPods map[types.UID]bool) {
+	sc.cache.RemoveOrphanedPods(remainingPods)
+	// Don't bother updating the stored state. If Kubelet is restarted before the cache is written,
+	// the orphaned pods will be removed the next time this method is called.
+}
+
 // ClearState clears the state and saves it in a checkpoint
 func (sc *stateCheckpoint) ClearState() error {
 	sc.mux.Lock()
@@ -195,6 +202,8 @@ func (sc *noopStateCheckpoint) Delete(_ string, _ string) error {
 	return nil
 }
 
+func (sc *noopStateCheckpoint) RemoveOrphanedPods(_ map[types.UID]bool) {}
+
 func (sc *noopStateCheckpoint) ClearState() error {
 	return nil
 }
diff --git a/pkg/kubelet/status/state/state_mem.go b/pkg/kubelet/status/state/state_mem.go
index c8107dacbe2..42e3fcbb935 100644
--- a/pkg/kubelet/status/state/state_mem.go
+++ b/pkg/kubelet/status/state/state_mem.go
@@ -20,6 +20,7 @@ import (
 	"sync"
 
 	v1 "k8s.io/api/core/v1"
+	"k8s.io/apimachinery/pkg/types"
 	"k8s.io/klog/v2"
 )
 
@@ -117,6 +118,18 @@ func (s *stateMemory) Delete(podUID string, containerName string) error {
 	return nil
 }
 
+func (s *stateMemory) RemoveOrphanedPods(remainingPods map[types.UID]bool) {
+	s.Lock()
+	defer s.Unlock()
+	for podUID := range s.podAllocation {
+		if _, ok := remainingPods[types.UID(podUID)]; !ok {
+			delete(s.podAllocation, podUID)
+			delete(s.podResizeStatus, podUID)
+			klog.V(3).InfoS("Deleted pod resource allocation for orphaned pod", "podUID", podUID)
+		}
+	}
+}
+
 func (s *stateMemory) ClearState() error {
 	s.Lock()
 	defer s.Unlock()
diff --git a/pkg/kubelet/status/status_manager.go b/pkg/kubelet/status/status_manager.go
index 3da131d5392..b7a72c595fc 100644
--- a/pkg/kubelet/status/status_manager.go
+++ b/pkg/kubelet/status/status_manager.go
@@ -791,11 +791,11 @@ func (m *manager) RemoveOrphanedStatuses(podUIDs map[types.UID]bool) {
 		if _, ok := podUIDs[key]; !ok {
 			klog.V(5).InfoS("Removing pod from status map.", "podUID", key)
 			delete(m.podStatuses, key)
-			if utilfeature.DefaultFeatureGate.Enabled(features.InPlacePodVerticalScaling) {
-				m.state.Delete(string(key), "")
-			}
 		}
 	}
+	if utilfeature.DefaultFeatureGate.Enabled(features.InPlacePodVerticalScaling) {
+		m.state.RemoveOrphanedPods(podUIDs)
+	}
 }
 
 // syncBatch syncs pods statuses with the apiserver. Returns the number of syncs
