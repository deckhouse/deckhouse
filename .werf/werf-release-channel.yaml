---
image: release-channel-version-prebuild
fromImage: builder/alpine
dependencies:
- image: dev
  before: setup
  imports:
  - type: ImageDigest
    targetEnv: deckhouseImageDigest
import:
- image: tools/yq
  add: /usr/bin/yq
  to: /usr/bin/yq
  before: install
shell:
  install:
  - |
    export version="{{ env "CI_COMMIT_REF_NAME" }}"
    if [[ "${version}" =~ release-([0-9]+\.[0-9]+) ]]; then
      export version="v${BASH_REMATCH[1]}.0"
    fi
    # update kubernetes auto version in the release file
    yq eval '.requirements.autoK8sVersion = "{{ .defaultKubernetesVersion }}"' -i /deckhouse/release.yaml
    yq eval '.requirements.k8s = "{{ .kubernetesVersions | first }}"' -i /deckhouse/release.yaml
    yq eval '.version = env(version)' -i /deckhouse/release.yaml
    yq eval -j /deckhouse/release.yaml > version.json
    # changelog exists only for tags, we have to skip it for branches
    {{- $changelog := index (.Files.Glob "CHANGELOG/CHANGELOG-*") (printf "CHANGELOG/CHANGELOG-%s.yml" (env "CI_COMMIT_REF_NAME")) }}
    {{ if $changelog }}
    cat <<"EOF" > /changelog.yaml
    {{ $changelog | nindent 6 }}
    EOF
    {{ else }}
    echo "  {}" > /changelog.yaml
    {{ end }}
git:
- add: /
  to: /deckhouse
  includePaths:
  - release.yaml
  stageDependencies:
    install:
      - '**/*'

---
image: release-channel-version
fromImage: builder/scratch
import:
- image: release-channel-version-prebuild
  add: /
  to: /
  after: install
  includePaths:
  - version.json
  - changelog.yaml
---
