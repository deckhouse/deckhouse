# put image with trivy mitigations to registry.
# Mitigations can be found in the .trivyignore.yaml file in the image directory
# input parameters:
# list of $ and image name.
# list ($ "common/kubernetes")
{{- define "trivy mitigation" }}
  {{- $context := index . 0 }}
  {{- $imageName := index . 1 }}
  {{- $trivyIgnorePath := "" }}
  {{- $trivyIgnorePath = (printf "/%smodules/%s-%s/images/%s/.trivyignore.yaml" $context.ModulePath $context.ModulePriority $context.ModuleName $context.ImageName) }}
  {{- $trivyIgnoreFile := false }}
  {{- if eq (len ($context.Files.Glob $trivyIgnorePath)) 1 }}
    {{- $trivyIgnoreFile = true }}
  {{- end }}
  {{- if $trivyIgnoreFile }}
---
image: {{ $imageName }}-trivy-ignore-artifact
fromCacheVersion: {{ div $context.Commit.Date.Unix (mul 60 60) }}v1
fromImage: base/vex
final: true
secrets:
- id: REGISTRY_USER
  env: REGISTRY_USER
- id: REGISTRY_PASSWORD
  env: REGISTRY_PASSWORD
- id: COSIGN_VAULT_ADDRESS
  env: COSIGN_VAULT_ADDRESS
- id: COSIGN_VAULT_KEY
  env: COSIGN_VAULT_KEY
- id: COSIGN_AUTH_ROLE
  env: COSIGN_AUTH_ROLE
- id: COSIGN_TRANSIT_SECRET_ENGINE_PATH
  env: COSIGN_TRANSIT_SECRET_ENGINE_PATH
- id: ACTIONS_ID_TOKEN_REQUEST_TOKEN
  env: ACTIONS_ID_TOKEN_REQUEST_TOKEN
- id: ACTIONS_ID_TOKEN_REQUEST_URL
  env: ACTIONS_ID_TOKEN_REQUEST_URL
git:
- add: {{ $trivyIgnorePath }}
  to: /.trivyignore.yaml
  stageDependencies:
    install:
    - "**/*"
dependencies:
- image: {{ $imageName }}
  before: install
  imports:
  - type: ImageDigest
    targetEnv: IMAGE_DIGEST
  - type: ImageRepo
    targetEnv: IMAGE_REPO
shell:
  install:
  - export REGISTRY_USER="$(cat /run/secrets/REGISTRY_USER)"
  - export REGISTRY_PASSWORD="$(cat /run/secrets/REGISTRY_PASSWORD)"
  - export VAULT_ADDR="$(cat /run/secrets/COSIGN_VAULT_ADDRESS)"
  - export COSIGN_VAULT_KEY="$(cat /run/secrets/COSIGN_VAULT_KEY)"
  - export COSIGN_AUTH_ROLE="$(cat /run/secrets/COSIGN_AUTH_ROLE)"
  - export TRANSIT_SECRET_ENGINE_PATH="$(cat /run/secrets/COSIGN_TRANSIT_SECRET_ENGINE_PATH)"
  - export ACTIONS_ID_TOKEN_REQUEST_TOKEN="$(cat /run/secrets/ACTIONS_ID_TOKEN_REQUEST_TOKEN)"
  - export ACTIONS_ID_TOKEN_REQUEST_URL="$(cat /run/secrets/ACTIONS_ID_TOKEN_REQUEST_URL)"
  - >
    export ACTIONS_ID_TOKEN=$(jq -r .value <<< $(curl -fsH "Authorization: bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=github-access-aud" ))
  - >
    if [ -n "${ACTIONS_ID_TOKEN}" ]; then
      echo "Received Actions token";
    else
      echo "Actions token empty";
    fi
  - >
    export VAULT_TOKEN="$(curl -fX POST "${VAULT_ADDR}/v1/auth/github/login" -d '{"role":"'${COSIGN_AUTH_ROLE}'","jwt":"'${ACTIONS_ID_TOKEN}'"}' | jq -r '.auth.client_token')"
  - >
    if [ -n "${VAULT_TOKEN}" ]; then
      echo "Received Vault token";
    else
      echo "Vault token empty";
    fi
  - echo "Using predicate .trivyignore.yaml"
  - |
    cosign attest \
      --replace \
      --registry-username="${REGISTRY_USER}" \
      --registry-password="${REGISTRY_PASSWORD}" \
      --predicate /.trivyignore.yaml \
      --type custom \
      --key hashivault://${COSIGN_VAULT_KEY} \
      --tlog-upload=false \
      -y -d \
      "${IMAGE_REPO}@${IMAGE_DIGEST}"
  {{- end }}
{{- end }}
