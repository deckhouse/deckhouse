# put image with vex mitigations to registry.
# Mitigations can be found in the known_vulnerabilities.vex file in the image directory
# input parameters:
# list of $ and image name.
# list ($ "common/kubernetes")
{{- define "vex mitigation" }}
  {{- $context := index . 0 }}
  {{- $imageName := index . 1 }}
  {{- $knownVulnPath := (printf "/%smodules/%s-%s/images/%s/known_vulnerabilities.vex" $context.ModulePath $context.ModulePriority $context.ModuleName $context.ImageName) }}
  {{- $vexFile := false }}
  {{- if eq (len ($context.Files.Glob $knownVulnPath)) 1 }}
    {{- $vexFile = true }}
  {{- end }}
  {{- if $vexFile }}
---
image: {{ $imageName }}-vex-artifact
fromImage: builder/alpine
final: true
secrets:
- id: REGISTRY_USER
  env: REGISTRY_USER
- id: REGISTRY_PASSWORD
  env: REGISTRY_PASSWORD
- id: COSIGN_VAULT_ADDRESS
  env: COSIGN_VAULT_ADDRESS
- id: COSIGN_VAULT_KEY
  env: COSIGN_VAULT_KEY
- id: COSIGN_TRANSIT_SECRET_ENGINE_PATH
  env: COSIGN_TRANSIT_SECRET_ENGINE_PATH
- id: ACTIONS_ID_TOKEN_REQUEST_TOKEN
  env: ACTIONS_ID_TOKEN_REQUEST_TOKEN
- id: ACTIONS_ID_TOKEN_REQUEST_URL
  env: ACTIONS_ID_TOKEN_REQUEST_URL
import:
- image: tools/cosign
  add: /usr/bin/cosign
  to: /usr/bin/cosign
  before: install
- image: tools/jq
  add: /usr/bin/jq
  to: /usr/bin/jq
  before: install
- image: tools/curl
  add: /usr/bin/curl
  to: /usr/bin/curl
  before: install
git:
- add: {{ $knownVulnPath }}
  to: /known_vulnerabilities.vex
  stageDependencies:
    setup:
    - 'known_vulnerabilities.vex'
dependencies:
- image: {{ $imageName }}
  before: install
  imports:
  - type: ImageDigest
    targetEnv: IMAGE_DIGEST
  - type: ImageRepo
    targetEnv: IMAGE_REPO
shell:
  beforeInstall:
  {{- include "alpine packages proxy" $context | nindent 2 }}
  install:
  - |
    ACTIONS_ID_TOKEN=$(jq -r .value <<< $(curl -fsH "Authorization: bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=github-access-aud" )) \
    export VAULT_TOKEN="$(curl -X POST "${COSIGN_VAULT_ADRESS}/v1/auth/github/login" -d '{"role":"'${AUTH_ROLE}'","jwt":"'${ACTIONS_ID_TOKEN}'"}' | jq -r '.auth.client_token')"
  - |
    VAULT_ADDR="$(cat /run/secrets/COSIGN_VAULT_ADDRESS)" \
    TRANSIT_SECRET_ENGINE_PATH="$(cat /run/secrets/COSIGN_TRANSIT_SECRET_ENGINE_PATH)" \
    cosign attest \
      --registry-username="$(cat /run/secrets/REGISTRY_USER)" \
      --registry-password="$(cat /run/secrets/REGISTRY_PASSWORD)" \
      --predicate /known_vulnerabilities.vex \
      --type openvex \
      --key hashivault://$(cat /run/secrets/COSIGN_VAULT_KEY) \
      --tlog-upload=false \
      -y \
      "${IMAGE_REPO}@${IMAGE_DIGEST}"
  {{- end }}
{{- end }}
