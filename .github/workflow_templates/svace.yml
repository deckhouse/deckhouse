# Copyright 2022 Flant JSC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

{!{- $workflowName              := "Svace analyze" -}!}
{!{- $enableWorkflowOnTestRepos := true -}!}

{!{- $ctx := . }!}

name: '{!{ $workflowName }!}'
on:
  schedule:
    - cron: '0 0 * * sun'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  pull-requests: read

env:
{!{ tmpl.Exec "werf_envs" | strings.Indent 2 }!}

concurrency:
  group: svace-analyze
  cancel-in-progress: true

jobs:
{!{ tmpl.Exec "git_info_job" $ctx | strings.Indent 2 }!}
  build_fe:
    name: Build FE
    needs:
      - git_info
    env:
      WERF_ENV: "FE"
      SVACE_ENABLED: True
      SVACE_ANALYZE_HOST: "${{ secrets.SVACE_ANALYZE_HOST }}"
      SVACE_ANALYZE_SSH_USER: "${{ secrets.SVACE_ANALYZE_SSH_USER }}"
{!{ tmpl.Exec "build_template" (slice $ctx "main") | strings.Indent 4 }!}
{!{ tmpl.Exec "send_fail_report" . | strings.Indent 6 }!}


  analyze_deckhouse:
    name: Deckhouse static analysis
    needs:
      - build_fe
    runs-on: [self-hosted, regular]
    steps:
{!{- $secrets := slice -}!}
{!{- $secrets = append ( slice "projects/data/24cb1d7c-717a-4f92-8547-26f632916a7a/Svace_CI" "SVACE_ANALYZE_HOST" "SVACE_ANALYZE_HOST" ) $secrets -}!}
{!{- $secrets = append ( slice "projects/data/24cb1d7c-717a-4f92-8547-26f632916a7a/Svace_CI" "SVACE_ANALYZE_SSH_USER" "SVACE_ANALYZE_SSH_USER" ) $secrets -}!}
{!{- $secrets = append ( slice "projects/data/24cb1d7c-717a-4f92-8547-26f632916a7a/Svace_CI" "SVACER_URL" "SVACER_URL" ) $secrets -}!}
{!{- $secrets = append ( slice "projects/data/24cb1d7c-717a-4f92-8547-26f632916a7a/Svace_CI" "SVACER_IMPORT_USER" "SVACER_IMPORT_USER" ) $secrets -}!}
{!{- $secrets = append ( slice "projects/data/24cb1d7c-717a-4f92-8547-26f632916a7a/Svace_CI" "SVACER_IMPORT_PASSWORD" "SVACER_IMPORT_PASSWORD" ) $secrets -}!}
{!{- $secrets = append ( slice "projects/data/24cb1d7c-717a-4f92-8547-26f632916a7a/Svace_CI" "SVACE_ANALYZE_SSH_PRIVATE_KEY" "SVACE_ANALYZE_SSH_PRIVATE_KEY" ) $secrets -}!}
{!{ tmpl.Exec "import_secrets" $secrets | strings.Indent 6 }!}
      - uses: deckhouse/modules-actions/svace_analyze@v7
        with:
          project_group: "DKP"
          ci_commit_ref_name: ${{ github.ref_name }}
          ci_commit_hash: ${{ github.sha }}
          svace_analyze_host: "${{ steps.secrets.outputs.SVACE_ANALYZE_HOST }}"
          svace_analyze_ssh_user: "${{ steps.secrets.outputs.SVACE_ANALYZE_SSH_USER }}"
          svacer_url: "${{ steps.secrets.outputs.SVACER_URL }}"
          svacer_import_user: "${{ steps.secrets.outputs.SVACER_IMPORT_USER }}"
          svacer_import_password: "${{ steps.secrets.outputs.SVACER_IMPORT_PASSWORD }}"
          svace_analyze_ssh_private_key: "${{ steps.secrets.outputs.SVACE_ANALYZE_SSH_PRIVATE_KEY }}"
{!{ tmpl.Exec "send_fail_report" . | strings.Indent 6 }!}