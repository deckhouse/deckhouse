{!{- $ctx := . -}!}
{!{- $enableWorkflowOnTestRepos := true -}!}
{!{- $workflowName := "Daily CVE tests" -}!}

name: '{!{ $workflowName }!}'
on:
  schedule:
  - cron: '0 23 * * 1-5'
  workflow_dispatch:

# Always run a single job at a time.
# Note: Concurrency is currently in beta and subject to change.
# https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#concurrency
concurrency:
  group: cve-daily

jobs:
  skip_tests_repos:
    name: Skip tests repos
    runs-on: ubuntu-latest
    if: ${{ {!{ $enableWorkflowOnTestRepos }!} || github.repository == 'deckhouse/deckhouse' }}
    steps:
    - name: Do nothing
      run: echo "Empty action to fulfil Github requirements."


# Note: git_info is needed for werf.yaml
{!{- $gitInfoJobCtx := coll.Merge . (dict "dependJobs" (slice "skip_tests_repos")) -}!}
{!{- $dependsJobsForAlert := slice "skip_tests_repos" "git_info" -}!}
{!{ tmpl.Exec "git_info_job" $gitInfoJobCtx | strings.Indent 2 }!}


  test_cve_base_images:
    name: Test base images for CVEs
    needs:
      - git_info
      - skip_tests_repos
{!{ tmpl.Exec "tests_before_build_template" (slice $ctx "cve_base_images") | strings.Indent 4 }!}


  test_cve_report:
    name: Test Deckhouse images for CVEs
    needs:
      - git_info
      - skip_tests_repos
{!{ tmpl.Exec "tests_before_build_template" (slice $ctx "cve_report") | strings.Indent 4 }!}
