{!{- $enableWorkflowOnTestRepos := true -}!}
{!{- $workflowName := "Daily CVE tests" -}!}
name: '{!{ $workflowName }!}'
on:
  schedule:
  - cron: '*/30 * * * 1-5'
  workflow_dispatch:

# Always run a single job at a time.
# Note: Concurrency is currently in beta and subject to change.
# https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#concurrency
concurrency:
  group: cve-daily

jobs:
  skip_tests_repos:
    name: Skip tests repos
    runs-on: ubuntu-latest
    if: ${{ {!{ $enableWorkflowOnTestRepos }!} || github.repository == 'deckhouse/deckhouse' }}
    steps:
    - name: Do nothing
      run: echo "Empty action to fulfil Github requirements."


# Note: git_info is needed for werf.yaml
{!{- $gitInfoJobCtx := coll.Merge . (dict "dependJobs" (slice "skip_tests_repos")) -}!}
{!{- $dependsJobsForAlert := slice "skip_tests_repos" "git_info" -}!}
{!{ tmpl.Exec "git_info_job" $gitInfoJobCtx | strings.Indent 2 }!}


  test_cve_base_images:
    name: Test base images for known vulnerabilities
    runs-on: ubuntu-latest
    needs:
      - git_info
      - skip_tests_repos
    steps:
      - name: Test base images
        id: test_base_images
        run: |
          pwd
          ls -lah
          make cve-base-images

