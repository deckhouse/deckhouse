{!{ define "security_scan_template" }!}
{!{- $ctx := index . 0 -}!}
{!{- $scanType := index . 1 -}!}
# <template: security_scan_template>
steps:
  {!{ tmpl.Exec "checkout_full_step" $ctx | strings.Indent 2 }!}
  {!{- $secrets := slice -}!}
  {!{- $secrets = append ( slice "projects/data/6db2f1ee-9b6f-4f4f-8381-2fb43060478a/github/registry_host" "DECKHOUSE_DEV_REGISTRY_HOST" "DECKHOUSE_DEV_REGISTRY_HOST" ) $secrets -}!}
  {!{- $secrets = append ( slice "projects/data/101ceaca-97cd-462f-aed5-070d9b9de175/dev-registry/writetoken" "login" "DECKHOUSE_DEV_REGISTRY_USER" ) $secrets -}!}
  {!{- $secrets = append ( slice "projects/data/101ceaca-97cd-462f-aed5-070d9b9de175/dev-registry/writetoken" "password" "DECKHOUSE_DEV_REGISTRY_PASSWORD" ) $secrets -}!}
  {!{ tmpl.Exec "import_secrets" $secrets | strings.Indent 2 }!}
  {!{ tmpl.Exec "login_dev_registry_step" $ctx | strings.Indent 2 }!}
  {!{ tmpl.Exec "link_bin_step"                     | strings.Indent 2 }!}
  - name: Running default user validation on ${{env.TAG}}
    env:
{!{- if (eq $scanType "pr") }!}
      TAG: ${{needs.pull_request_info.outputs.ref_slug}}
{!{- else }!}
      TAG: ${{needs.git_info.outputs.ci_commit_ref_slug}}
{!{- end }!}
      IMAGE: "${{ secrets.DECKHOUSE_DEV_REGISTRY_HOST }}/sys/deckhouse-oss"
      DECKHOUSE_PRIVATE_REPO: ${{secrets.DECKHOUSE_PRIVATE_REPO}}
    run: |
      echo "‚öìÔ∏è üèé Running default user validation on ${TAG}..."
      make cve-base-images-check-default-user
  {!{ tmpl.Exec "unlink_bin_step"                   | strings.Indent 2 }!}
# </template: security_scan_template>
{!{ end }!}
