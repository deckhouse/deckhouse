{!{ define "set_security_scan_requirement_status" }!}

# <template: set_security_scan_requirement_status>
set_security_scan_requirement_status:
  name: Set commit status after security scan run
  runs-on: "ubuntu-latest"
  needs: test_cve_report_main
  if: ${{ always() && github.event_name == 'workflow_dispatch' && !!github.event.inputs.issue_number }}
  steps:
{!{ tmpl.Exec "checkout_step" . | strings.Indent 4 }!}
    - name: Install GitHub CLI
      run: sudo apt-get install gh -y
    - name: Auth with GitHub CLI
      run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
    - name: Set PR Label
      env:
        PR_NUMBER: ${{ inputs.issue_number }}
      run: |
        echo "PR Number: $PR_NUMBER"
        if [ "${{ needs.test_cve_report_main.result }}" == "success" ]; then
          gh pr edit "$PR_NUMBER" --add-label "security/cve/success"
        else
          gh pr edit "$PR_NUMBER" --add-label "security/cve/failed"
        fi
# </template: set_security_scan_requirement_status>
{!{- end -}!}

{!{ define "remove_labels_job" }!}
{!{- $ctx := . -}!}
# <template: remove_labels_job>
remove_labels:
  name: Remove labels
  runs-on: "regular"
  if: ${{ always() && github.event_name == 'workflow_dispatch' && !!github.event.inputs.issue_number }}
  steps:
{!{ tmpl.Exec "checkout_step" . | strings.Indent 4 }!}
    - name: Remove labels
      id: remove
      uses: {!{ index (ds "actions") "actions/github-script" }!}
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const label = "security/cve";
          const ci = require('./.github/scripts/js/ci');
          const issue_number = context.payload.inputs.issue_number;
          console.log("Issue number is", issue_number);
          return await ci.removeLabel({github, context, core, issue_number, label});
# </template: remove_labels_job>
{!{- end -}!}

{!{ define "cve_scan_type_weekly" }!}
- name: Set scan target type
  id: scan_type
  run: |
    if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
      TAG="${{ github.event.inputs.tag_to_scan }}"
      SCAN_SEVERAL_LATEST_RELEASES="${{ github.event.inputs.scan_several_latest_releases }}"
      LATEST_RELEASES_AMOUNT="${{ github.event.inputs.latest_releases_amount }}"
      echo "TAG=${TAG}" >> $GITHUB_OUTPUT
      echo "SCAN_SEVERAL_LATEST_RELEASES=${SCAN_SEVERAL_LATEST_RELEASES}" >> $GITHUB_OUTPUT
      echo "LATEST_RELEASES_AMOUNT=${LATEST_RELEASES_AMOUNT}" >> $GITHUB_OUTPUT
    elif [ "${{ github.event_name }}" == "schedule" ]; then
      TAG="main"
      SCAN_SEVERAL_LATEST_RELEASES="True"
      LATEST_RELEASES_AMOUNT="3"
      echo "TAG=${TAG}" >> $GITHUB_OUTPUT
      echo "SCAN_SEVERAL_LATEST_RELEASES=${SCAN_SEVERAL_LATEST_RELEASES}" >> $GITHUB_OUTPUT
      echo "LATEST_RELEASES_AMOUNT=${LATEST_RELEASES_AMOUNT}" >> $GITHUB_OUTPUT
    else
      echo "Wrong input parameters"
      exit 1
    fi
{!{- end -}!}

{!{ define "cve_scan_type_pr" }!}
- name: Set scan target type
  id: scan_type
  run: |
    if [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref_name }}" == "main" ]; then
      echo "TAG=main" >> $GITHUB_OUTPUT
    elif [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.pull_request_ref }}" ]; then
      echo "REF=${{ github.event.inputs.pull_request_ref }}"
      PR_NUMBER=$(echo "${{ github.event.inputs.pull_request_ref }}" | sed -E 's#refs/pull/([0-9]+)/head#\1#')
      echo "PR_NUMBER=${PR_NUMBER}"
      REPO_SUFFIX=${GITHUB_REPOSITORY#deckhouse/deckhouse-}
      if [[ ${REPO_SUFFIX} == ${GITHUB_REPOSITORY} ]] ; then
        TAG="pr${PR_NUMBER}"
      else
        TAG="pr${PR_NUMBER}-${REPO_SUFFIX}"
      fi
      echo "TAG=${TAG}" >> $GITHUB_OUTPUT
    fi
    echo "SCAN_SEVERAL_LATEST_RELEASES=False" >> $GITHUB_OUTPUT
    echo "LATEST_RELEASES_AMOUNT=0" >> $GITHUB_OUTPUT
{!{- end -}!}

{!{ define "cve_scan_deckhouse_images" }!}
# <template: cve_scan_deckhouse_images>
{!{- $secrets := slice -}!}
{!{- $secrets = append ( slice "projects/data/6db2f1ee-9b6f-4f4f-8381-2fb43060478a/github/registry_host" "DECKHOUSE_DEV_REGISTRY_HOST" "DECKHOUSE_DEV_REGISTRY_HOST" ) $secrets -}!}
{!{- $secrets = append ( slice "projects/data/101ceaca-97cd-462f-aed5-070d9b9de175/dev-registry/writetoken" "login" "DECKHOUSE_DEV_REGISTRY_USER" ) $secrets -}!}
{!{- $secrets = append ( slice "projects/data/101ceaca-97cd-462f-aed5-070d9b9de175/dev-registry/writetoken" "password" "DECKHOUSE_DEV_REGISTRY_PASSWORD" ) $secrets -}!}
{!{- $secrets = append ( slice "projects/data/b050f3bd-733f-4746-9640-9df80d484074/DefectDojo/Dev/TrivyReporter" "token" "DEV_DD_TOKEN" ) $secrets -}!}
{!{- $secrets = append ( slice "projects/data/b050f3bd-733f-4746-9640-9df80d484074/DefectDojo/Dev/URL" "URL" "DEV_DD_URL" ) $secrets -}!}
{!{- $secrets = append ( slice "projects/data/24cb1d7c-717a-4f92-8547-26f632916a7a/Trivy_CVE_Scan_CI_Secrets" "DECKHOUSE_PRIVATE_REPO" "DECKHOUSE_PRIVATE_REPO" ) $secrets -}!}
{!{- $secrets = append ( slice "projects/data/24cb1d7c-717a-4f92-8547-26f632916a7a/Trivy_CVE_Scan_CI_Secrets" "CVE_TEST_REPO_GIT" "CVE_TEST_REPO_GIT" ) $secrets -}!}
{!{- $secrets = append ( slice "projects/data/24cb1d7c-717a-4f92-8547-26f632916a7a/Trivy_CVE_Scan_CI_Secrets" "CVE_TEST_SSH_PRIVATE_KEY" "CVE_SSH_PRIVATE_KEY" ) $secrets -}!}
{!{- $secrets = append ( slice "projects/data/b050f3bd-733f-4746-9640-9df80d484074/CODEOWNERS_REPO_TOKEN" "CODEOWNERS_REPO_TOKEN" "CODEOWNERS_REPO_TOKEN" ) $secrets -}!}
{!{ tmpl.Exec "import_secrets" $secrets }!}
- name: Set up cosign
  uses: {!{ index (ds "actions") "cosign" }!}
  with:
    cosign-release: "v3.0.4"

- name: Run Deckhouse images CVE tests on "${{ steps.scan_type.outputs.tag }}"
  uses: deckhouse/modules-actions/cve_scan@new_cve_scan
  with:
    prod_registry: ${{ secrets.DECKHOUSE_REGISTRY_READ_HOST }}
    prod_registry_user: ${{ secrets.DECKHOUSE_REGISTRY_READ_USER }}
    prod_registry_password: ${{ secrets.DECKHOUSE_REGISTRY_READ_PASSWORD }}
    dev_registry: ${{ steps.secrets.outputs.DECKHOUSE_DEV_REGISTRY_HOST }}
    dev_registry_user: "${{ steps.secrets.outputs.DECKHOUSE_DEV_REGISTRY_USER}}"
    dev_registry_password: "${{ steps.secrets.outputs.DECKHOUSE_DEV_REGISTRY_PASSWORD }}"
    codeowners_repo_token: "${{ steps.secrets.outputs.CODEOWNERS_REPO_TOKEN }}"
    deckhouse_private_repo: "${{ steps.secrets.outputs.DECKHOUSE_PRIVATE_REPO }}"
    dd_url: "${{ steps.secrets.outputs.DEV_DD_URL }}"
    dd_token: "${{ steps.secrets.outputs.DEV_DD_TOKEN }}"
    source_tag: "${{ steps.scan_type.outputs.tag }}"
    case: "deckhouse"
    cve_test_repo_git: "${{ steps.secrets.outputs.CVE_TEST_REPO_GIT }}"
    cve_ssh_private_key: "${{ steps.secrets.outputs.CVE_SSH_PRIVATE_KEY }}"
    trivy_reports_log_output: 2
    scan_several_latest_releases: "${{ steps.scan_type.outputs.scan_several_latest_releases }}"
    latest_releases_amount: "${{ steps.scan_type.outputs.latest_releases_amount }}"
# </template: cve_scan_deckhouse_images>
{!{- end -}!}

{!{ define "cve_tests_upload_reports_artifacts" }!}
# <template: cve_tests_upload_reports_artifacts>
- name: Archive report artifacts
  if: success()
  run: |
    tar -zcvf ${{ env.WORKDIR }}/artifacts/trivy_json_reports.tar.gz ${{ env.WORKDIR }}/deckhouse
- name: Create fail artifact
  if: failure()
  run: |
    echo "Trivy tests for ${{ steps.scan_type.outputs.tag }} have failed." > "${{ env.WORKDIR }}/artifacts/${{ steps.scan_type.outputs.tag }}_test-failed.txt"
    tar -zcvf ${{ env.WORKDIR }}/artifacts/trivy_json_reports.tar.gz ${{ env.WORKDIR }}/deckhouse
- name: Upload report artifacts
  if: success()
  uses: {!{ index (ds "actions") "actions/upload-artifact" }!}
  with:
    name: cve-reports
    path: |
      ${{ env.WORKDIR }}/artifacts/trivy_json_reports.tar.gz
- name: Upload fail artifact
  if: failure()
  uses: {!{ index (ds "actions") "actions/upload-artifact" }!}
  with:
    name: cve-reports
    path: |
      ${{ env.WORKDIR }}/artifacts/${{ steps.scan_type.outputs.tag }}_test-failed.txt
      ${{ env.WORKDIR }}/artifacts/trivy_json_reports.tar.gz
- name: Remove workdir
  run: |
    rm -r ${{ env.WORKDIR }}
# </template: cve_tests_upload_reports_artifacts>
{!{- end -}!}
