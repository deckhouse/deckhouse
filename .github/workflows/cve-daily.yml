#
# THIS FILE IS GENERATED, PLEASE DO NOT EDIT.
#

name: 'Daily CVE tests'
on:
  schedule:
  - cron: '0 23 * * 1-5'
  workflow_dispatch:

# Always run a single job at a time.
# Note: Concurrency is currently in beta and subject to change.
# https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#concurrency
concurrency:
  group: cve-daily

jobs:
  skip_tests_repos:
    name: Skip tests repos
    runs-on: ubuntu-latest
    if: ${{ true || github.repository == 'deckhouse/deckhouse' }}
    steps:
    - name: Do nothing
      run: echo "Empty action to fulfil Github requirements."

  fetch_tags_for_test:
    name: Fetch release channel tags
    runs-on: ubuntu-latest
    needs:
      - skip_tests_repos
    steps:
      # <template: checkout_full_step>
      - name: Checkout sources
        uses: actions/checkout@v2.4.0
        with:
          fetch-depth: 0
      # </template: checkout_full_step>
      - name: Generate tag to release channel map
        id: tag_map
        run: echo "tag_map=$(tools/cve/tag_map.sh)" >> $GITHUB_OUTPUT
      - name: Filter tag matrix
        id: tags_matrix
        run: echo 'tag_matrix=["v1.38.0","v1.37.6"]' >> $GITHUB_OUTPUT
    outputs:
      tag_map: ${{ steps.tag_map.outputs.tag_map }}
      tag_matrix: ${{ steps.tags_matrix.outputs.tag_matrix }}

  test_job_with_matrix_strategy:
    name: CVE test on ${{ matrix.tag }}
    runs-on: ubuntu-latest
    needs: fetch_tags_for_test
    strategy:
      matrix:
        tag: ${{ fromJson(needs.fetch_tags_for_test.outputs.tag_matrix) }}
    steps:
      - name: Test map
        run: |
          echo "Testing matrix strategy:"
          echo ${{ matrix.tag }}
          echo "Channels are: "
          echo ${{ needs.fetch_tags_for_test.outputs.tag_map }}| jq -c '. [] | select(.tag == "${{ matrix.tag }}") | .channels | join(", ")'
