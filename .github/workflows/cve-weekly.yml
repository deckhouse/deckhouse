#
# THIS FILE IS GENERATED, PLEASE DO NOT EDIT.
#

# Copyright 2022 Flant JSC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: 'Weekly CVE tests'
on:
  schedule:
    - cron: '0 02 * * *'
  workflow_dispatch:
    inputs:
      tag_to_scan:
        description: 'main or release version in semver minor format. Ex: 1.73'
        required: false
      scan_several_latest_releases:
        description: 'Scan the last few releases. Ex: True'
        required: false
        default: "False"
      latest_releases_amount:
        description: 'Number of recent scan releases. Ex: 3'
        required: false
        default: "3"

concurrency:
  group: cve-daily

jobs:

  # <template: skip_tests_repos>
  skip_tests_repos:
    name: Skip tests repos
    runs-on: "regular"
    if: ${{ false || github.repository == 'deckhouse/deckhouse' }}
    steps:
    - name: Do nothing
      run: echo "Empty action to fulfil Github requirements."
  # </template: skip_tests_repos>
  test_cve_report_main:
    name: Main
    needs:
      - skip_tests_repos
    runs-on: [self-hosted, large]
    permissions:
      contents: read
      id-token: write
    env:
      WORKDIR: "cve_scan"
      TAG: ${{ github.event.inputs.tag_to_scan|| 'main' }}
    steps:

      # <template: checkout_full_step>
      - name: Checkout sources
        uses: actions/checkout@v3.5.2
        with:
          fetch-depth: 0
      # </template: checkout_full_step>

      # <template: link_bin_step>
      - name: Link binary cache
        id: link_bin_step
        run: |
          ln -s ~/deckhouse-bin-cache bin
      # </template: link_bin_step>

      - name: Set scan target type
        id: scan_type
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag_to_scan }}"
            SCAN_SEVERAL_LATEST_RELEASES="${{ github.event.inputs.scan_several_latest_releases }}"
            LATEST_RELEASES_AMOUNT="${{ github.event.inputs.latest_releases_amount }}"
            echo "TAG=${TAG}" >> $GITHUB_OUTPUT
            echo "SCAN_SEVERAL_LATEST_RELEASES=${SCAN_SEVERAL_LATEST_RELEASES}" >> $GITHUB_OUTPUT
            echo "LATEST_RELEASES_AMOUNT=${LATEST_RELEASES_AMOUNT}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "schedule" ]; then
            TAG="main"
            SCAN_SEVERAL_LATEST_RELEASES="True"
            LATEST_RELEASES_AMOUNT="3"
            echo "TAG=${TAG}" >> $GITHUB_OUTPUT
            echo "SCAN_SEVERAL_LATEST_RELEASES=${SCAN_SEVERAL_LATEST_RELEASES}" >> $GITHUB_OUTPUT
            echo "LATEST_RELEASES_AMOUNT=${LATEST_RELEASES_AMOUNT}" >> $GITHUB_OUTPUT
          else
            echo "Wrong input parameters"
            exit 1
          fi

      # <template: cve_scan_deckhouse_images>
      # <template: import_secrets>
      - name: Split repository name
        id: split
        env:
          REPO: ${{ github.repository }}
        run: echo "name=${REPO##*/}" >> $GITHUB_OUTPUT
      - name: Import secrets
        id: secrets
        uses: hashicorp/vault-action@v2
        with:
          url: https://seguro.flant.com
          path: github
          role: "${{ steps.split.outputs.name }}"
          method: jwt
          jwtGithubAudience: github-access-aud
          secrets: |
            projects/data/6db2f1ee-9b6f-4f4f-8381-2fb43060478a/github/registry_host DECKHOUSE_DEV_REGISTRY_HOST | DECKHOUSE_DEV_REGISTRY_HOST ;
            projects/data/101ceaca-97cd-462f-aed5-070d9b9de175/dev-registry/writetoken login | DECKHOUSE_DEV_REGISTRY_USER ;
            projects/data/101ceaca-97cd-462f-aed5-070d9b9de175/dev-registry/writetoken password | DECKHOUSE_DEV_REGISTRY_PASSWORD ;
            projects/data/b050f3bd-733f-4746-9640-9df80d484074/DefectDojo/Dev/TrivyReporter token | DEV_DD_TOKEN ;
            projects/data/b050f3bd-733f-4746-9640-9df80d484074/DefectDojo/Dev/URL URL | DEV_DD_URL ;
            projects/data/24cb1d7c-717a-4f92-8547-26f632916a7a/Trivy_CVE_Scan_CI_Secrets DECKHOUSE_PRIVATE_REPO | DECKHOUSE_PRIVATE_REPO ;
            projects/data/24cb1d7c-717a-4f92-8547-26f632916a7a/Trivy_CVE_Scan_CI_Secrets CVE_TEST_REPO_GIT | CVE_TEST_REPO_GIT ;
            projects/data/24cb1d7c-717a-4f92-8547-26f632916a7a/Trivy_CVE_Scan_CI_Secrets CVE_TEST_SSH_PRIVATE_KEY | CVE_SSH_PRIVATE_KEY ;
            projects/data/b050f3bd-733f-4746-9640-9df80d484074/CODEOWNERS_REPO_TOKEN CODEOWNERS_REPO_TOKEN | CODEOWNERS_REPO_TOKEN ;

      # </template: import_secrets>
      - name: Set up cosign
        uses: sigstore/cosign-installer@main
        with:
          cosign-release: "v3.0.4"

      - name: Run Deckhouse images CVE tests on "${{ steps.scan_type.outputs.tag }}"
        uses: deckhouse/modules-actions/cve_scan@new_cve_scan
        with:
          prod_registry: ${{ secrets.DECKHOUSE_REGISTRY_READ_HOST }}
          prod_registry_user: ${{ secrets.DECKHOUSE_REGISTRY_READ_USER }}
          prod_registry_password: ${{ secrets.DECKHOUSE_REGISTRY_READ_PASSWORD }}
          dev_registry: ${{ steps.secrets.outputs.DECKHOUSE_DEV_REGISTRY_HOST }}
          dev_registry_user: "${{ steps.secrets.outputs.DECKHOUSE_DEV_REGISTRY_USER}}"
          dev_registry_password: "${{ steps.secrets.outputs.DECKHOUSE_DEV_REGISTRY_PASSWORD }}"
          codeowners_repo_token: "${{ steps.secrets.outputs.CODEOWNERS_REPO_TOKEN }}"
          deckhouse_private_repo: "${{ steps.secrets.outputs.DECKHOUSE_PRIVATE_REPO }}"
          dd_url: "${{ steps.secrets.outputs.DEV_DD_URL }}"
          dd_token: "${{ steps.secrets.outputs.DEV_DD_TOKEN }}"
          source_tag: "${{ steps.scan_type.outputs.tag }}"
          case: "deckhouse"
          cve_test_repo_git: "${{ steps.secrets.outputs.CVE_TEST_REPO_GIT }}"
          cve_ssh_private_key: "${{ steps.secrets.outputs.CVE_SSH_PRIVATE_KEY }}"
          trivy_reports_log_output: 2
          scan_several_latest_releases: "${{ steps.scan_type.outputs.scan_several_latest_releases }}"
          latest_releases_amount: "${{ steps.scan_type.outputs.latest_releases_amount }}"
      # </template: cve_scan_deckhouse_images>

      # <template: cve_tests_upload_reports_artifacts>
      - name: Archive report artifacts
        if: success()
        run: |
          tar -zcvf ${{ env.WORKDIR }}/artifacts/trivy_json_reports.tar.gz ${{ env.WORKDIR }}/deckhouse
      - name: Create fail artifact
        if: failure()
        run: |
          echo "Trivy tests for ${{ steps.scan_type.outputs.tag }} have failed." > "${{ env.WORKDIR }}/artifacts/${{ steps.scan_type.outputs.tag }}_test-failed.txt"
          tar -zcvf ${{ env.WORKDIR }}/artifacts/trivy_json_reports.tar.gz ${{ env.WORKDIR }}/deckhouse
      - name: Upload report artifacts
        if: success()
        uses: actions/upload-artifact@v4.4.0
        with:
          name: cve-reports
          path: |
            ${{ env.WORKDIR }}/artifacts/trivy_json_reports.tar.gz
      - name: Upload fail artifact
        if: failure()
        uses: actions/upload-artifact@v4.4.0
        with:
          name: cve-reports
          path: |
            ${{ env.WORKDIR }}/artifacts/${{ steps.scan_type.outputs.tag }}_test-failed.txt
            ${{ env.WORKDIR }}/artifacts/trivy_json_reports.tar.gz
      - name: Remove workdir
        run: |
          rm -r ${{ env.WORKDIR }}
      # </template: cve_tests_upload_reports_artifacts>

      # <template: unlink_bin_step>
      - name: Unlink binary cache
        id: unlink_bin_step
        if: always()
        run: |
          rm bin
      # </template: unlink_bin_step>

      # <template: send_fail_report>
      - name: Send fail report
        if: ${{ failure() && github.repository == 'deckhouse/deckhouse' }}
        env:
          LOOP_SERVICE_NOTIFICATIONS: ${{ secrets.LOOP_SERVICE_NOTIFICATIONS }}
          JOB_NAME: ${{ github.job }}
          WORKFLOW_NAME: ${{ github.workflow }}
          WORKFLOW_URL: ${{github.server_url}}/${{github.repository}}/actions/runs/${{github.run_id}}/
        run: |
          bash ./.github/scripts/send-report.sh --webhook "ci_fail"
      # </template: send_fail_report>
