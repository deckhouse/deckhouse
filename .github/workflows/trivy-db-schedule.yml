# Copyright 2023 Flant JSC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Trivy DB Download
on:
  schedule:
  - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  download-and-repush-images:
    name: Download and repush images
    runs-on: ubuntu-latest
    steps:
    - name: Check dev registry credentials
      id: check_dev_registry
      env:
        HOST: ${{secrets.DECKHOUSE_DEV_REGISTRY_HOST}}
      run: |
        if [[ -n $HOST ]]; then echo "::set-output name=has_credentials::true"; fi
    - name: Check rw registry credentials
      id: check_rw_registry
      env:
        HOST: ${{secrets.DECKHOUSE_REGISTRY_HOST}}
      run: |
        if [[ -n $HOST ]]; then echo "::set-output name=has_credentials::true"; fi
    - name: Login to rw registry
      uses: docker/login-action@v1.10.0
      if: ${{ steps.check_rw_registry.outputs.has_credentials == 'true' }}
      with:
        registry: ${{ secrets.DECKHOUSE_REGISTRY_HOST }}
        username: ${{ secrets.DECKHOUSE_REGISTRY_USER }}
        password: ${{ secrets.DECKHOUSE_REGISTRY_PASSWORD }}
        logout: false
    - name: Login to dev registry
      uses: docker/login-action@v1.10.0
      if: ${{ steps.check_dev_registry.outputs.has_credentials == 'true' }}
      with:
        registry: ${{ secrets.DECKHOUSE_DEV_REGISTRY_HOST }}
        username: ${{ secrets.DECKHOUSE_DEV_REGISTRY_USER }}
        password: ${{ secrets.DECKHOUSE_DEV_REGISTRY_PASSWORD }}
        logout: false
    - name: Download crane and copy image
      if: ${{ steps.check_rw_registry.outputs.has_credentials == 'true' }} && ${{ steps.check_dev_registry.outputs.has_credentials == 'true' }}
      run: |
        curl -sSfL https://github.com/google/go-containerregistry/releases/download/v0.13.0/go-containerregistry_Linux_x86_64.tar.gz | tar -xzf - && chmod +x crane
        ./crane copy ghcr.io/aquasecurity/trivy-db:2 ${{secrets.DECKHOUSE_REGISTRY_HOST}}/security/trivy-db:2
        ./crane copy ghcr.io/aquasecurity/trivy-db:2 ${{secrets.DECKHOUSE_DEV_REGISTRY_HOST}}/security/trivy-db:2
