## Ниже описаны два способы устранения уязвимости CVE-2025-1974 выявленной в Ingress-nginx:

### В случае, если обновления Deckhouse в Ваших кластерах происходят на регулярной основе.

Для версий Deckhouse v1.67 и v1.68 будут выпущены обновления v1.67.14 и v1.68.7 соответственно. Обновления включают фиксы как для v1.9, так и для v.10 версий Ingress-nginx.
При установе данных обновлений, поды Ingress-nginx будут перезапущены. 
Так же, немного изменится процесс валидации ingress ресурсов, осущевтляемый Ingress-nginx контроллером - не все конфигурации ingress могут быть провалидированны на стадии применения ресурса.
В результате, может быть применен невалидная конфигурация, НО, в процессе обновления конфигурации nginx-сервера, будет просигнализированна ошибка. Данную ошибку можно заметить как в логах контейнера Ingress-nginx,
так и по загоревшемуся алерту NginxIngressConfigTestFailed.

Так же, рекомендуется включить [annotationValidationEnabled](https://deckhouse.io/products/kubernetes-platform/documentation/v1/modules/ingress-nginx/cr.html#ingressnginxcontroller-v1-spec-annotationvalidationenabled) параметр в настройках IngressNginxController.

### В случае, если обновления Deckhouse в кластере устанавливаются нерегулярно (кластер v1.66- версии и обновление на v1.67+ не планируется).

В данном случае необходимо самостоятельно применить фиск для обхода уязвимости CVE-2025-1974:

* установить во всех объектах IngressNginxController параметр [validationEnabled](https://deckhouse.io/products/kubernetes-platform/documentation/v1/modules/ingress-nginx/cr.html#ingressnginxcontroller-v1-spec-validationenabled) в false;
* скачать [скрипт](https://fox.flant.com/deckhouse/ingress-nginx-validations-cve-fixer/-/blob/fixer/ingress-nginx-validations-cve-fixer.sh?ref_type=heads) установки фикса;
* запустить скрипт на хосте с доступом к кластеру с правами пользователя ClusterAdmin.

В результате, в кластере будет развернут дополнительный MutatingWebhook с именем d8-ingress-validation-cve-fixer в пространстве имен d8-system. 
После развертывания необходимо проверить, что поды MutatingWebhook запущены и находятся в статусе Running `kubectl  -n d8-system get pod -lapp=ingress-validation-cve-fixer`.
По-умолчанию, разворачивается два пода и, в случае, если в кластере только один узел master, нужно скорректировать колличество подов `kubectl scale deployment -n d8-system d8-ingress-validation-cve-fixer --replicas=1`.
Дополнительно, необходимо поочередно пересоздать все поды Ingress-nginx, обязательно проверяя, что новые поды создаются без каких-либо задержек и проблем, что бы MutatingWebhook смог скорректировать манифесты подов Ingress-nginx.

Убидеться, что подов с Ingress-nginx ValidationWebhook не запущенно можно с помощью команды `kubectl  get pod -n d8-ingress-nginx -o yaml | grep "\-\-validating-webhook=:8443"` - вывод должен быть пустым.

Данный webhook подписывается на события создания подов с меткой app=controller в пространствe имен d8-ingress-nginx и
вносит изменения в манифесты подов с целью предоотвратить запуск Ingress-nginx ValidationWebhook в контейнерах Ingress-nginx.

Нужно учитывать, что в случае, если поды d8-ingress-validation-cve-fixer будут недоступны, MutatingWebhook будет блокировать создание новых подов Ingress-controller, что может привести к простою в работе Ingress-nginx.

Для отключения фикса (в случае проблем в работе d8-ingress-validation-cve-fixer) необходимо удалить соответствующий MutatingWebhookConfiguration `kubectl  delete mutatingwebhookconfigurations.admissionregistration.k8s.io d8-ingress-validation-cve-fixer-hooks` и
deployment `kubectl delete deployment -n d8-system d8-ingress-validation-cve-fixer`, тем самым разблокировов создание подов Ingress-nginx.

