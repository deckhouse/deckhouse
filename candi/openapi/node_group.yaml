apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: nodegroups.deckhouse.io
  labels:
    heritage: deckhouse
    module: node-manager
spec:
  group: deckhouse.io
  scope: Cluster
  preserveUnknownFields: false
  names:
    plural: nodegroups
    singular: nodegroup
    kind: NodeGroup
    shortNames:
      - ng
  versions:
    - name: v1alpha1
      served: true
      storage: false
      additionalPrinterColumns: &additionalPrinterColumns
        - name: Type
          type: string
          description: "Type of nodes in group"
          jsonPath: .spec.nodeType
        - name: Ready
          type: integer
          description: "Number of ready Kubernetes nodes in the group."
          jsonPath: .status.ready
        - name: Nodes
          type: integer
          description: "Number of Kubernetes nodes (in any state) in the group."
          jsonPath: .status.nodes
        - name: UpToDate
          type: integer
          description: "Number of up-to-date nodes in the group."
          jsonPath: .status.upToDate
        - name: Instances
          type: integer
          description: "Number of instances (in any state) in the group."
          jsonPath: .status.instances
        - name: Desired
          type: integer
          description: "Number of desired instances in the group."
          jsonPath: .status.desired
        - name: Min
          type: integer
          description: "Minimal amount of instances in the group."
          jsonPath: .status.min
        - name: Max
          type: integer
          description: "Maximum amount of instances in the group."
          jsonPath: .status.max
        - name: Standby
          type: integer
          description: "Number of overprovisioned instances in the group."
          jsonPath: .status.standby
        - name: Status
          type: string
          description: "Status message about group handling."
          jsonPath: .status.conditionSummary.statusMessage
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
      subresources:
        status: {}
      schema:
        openAPIV3Schema:
          type: object
          description: |
            Defines the runtime parameters of a node group.
          required:
            - spec
          properties:
            status: &status
              type: object
              required: []
              properties:
                ready:
                  type: integer
                  description: "Number of ready Kubernetes nodes in the group."
                nodes:
                  type: integer
                  description: "Number of Kubernetes nodes (in any state) in the group."
                instances:
                  type: integer
                  description: "Number of instances (in any state) in the group."
                desired:
                  type: integer
                  description: "Number of desired machines in the group."
                min:
                  type: integer
                  description: "Minimal amount of instances in the group."
                max:
                  type: integer
                  description: "Maximum amount of instances in the group."
                upToDate:
                  type: integer
                  description: "Number of up-to-date nodes in the group."
                standby:
                  type: integer
                  description: "Number of overprovisioned instances in the group."
                error:
                  type: string
                  description: "Error message about possible problems with the group handling."
                lastMachineFailures:
                  type: array
                  items:
                    type: object
                    properties:
                      name:
                        type: string
                        description: "Machine's name."
                      providerID:
                        type: string
                        description: "Machine's ProviderID."
                      ownerRef:
                        type: string
                        description: "Machine owner's name."
                      lastOperation:
                        type: object
                        properties:
                          description:
                            type: string
                            description: "Last operation's description."
                          lastUpdateTime:
                            type: string
                            description: "Timestamp of last status update for operation."
                          state:
                            type: string
                            description: "Machine's operation state."
                          type:
                            type: string
                            description: "Type of operation."
                conditionSummary:
                  type: object
                  properties:
                    statusMessage:
                      description: "Status message about group handling."
                      type: string
                    ready:
                      description: "Status of the condition summary."
                      enum:
                        - "True"
                        - "False"
                      type: string
            spec:
              type: object
              required:
                - nodeType
              properties:
                nodeType: &nodeType
                  description: |
                    The type of nodes this group provides.
                    - `Cloud` — nodes for this group will be automatically created (and deleted) in the cloud of the specified cloud provider;
                    - `Static` — a static node hosted on a bare metal or virtual machine. The cloud-controller-manager does not manage the
                      node even of one of the cloud providers is enabled;
                    - `Hybrid` — a static node (created manually or using any external tools) hosted in the cloud integrated with
                      one of the cloud provider. This node has the CSI running, and it is managed by the
                      cloud-controller-manager: the Node object automatically gets the information about the zone and region
                      based on the cloud data; if a node gets deleted from the cloud, its corresponding Node object
                      will be deleted in Kubernetes.
                  type: string
                  enum:
                    - Cloud
                    - Static
                    - Hybrid
                kubernetesVersion:
                  description: |
                    The desired minor version of Kubernetes.

                    By default, it corresponds to the version selected for the cluster globally (see installation documentation) or to the current version of the control plane (if the global version is not defined).
                  type: string
                  example: '1.19'
                  enum:
                    - "1.19"
                    - "1.20"
                    - "1.21"
                    - "1.22"
                cri:
                  type: object
                  description: |
                    Container runtime parameters.
                  properties:
                    type: &criType
                      type: string
                      description: |
                        Container runtime type.

                        Value `defaultCRI` from the initial cluster configration (`cluster-configuration.yaml` parameter from the `d8-cluster-configuration` secret in the `kube-system` namespace) is used if not specified.
                      enum:
                        - "Docker"
                        - "Containerd"
                        - "NotManaged"
                    containerd: &criContainerd
                      type: object
                      description: |
                        Containerd runtime parameters.

                        If used, `cri.type` must be set to `Containerd`.
                      properties:
                        maxConcurrentDownloads:
                          type: integer
                          description: |
                            Set the max concurrent downloads for each pull.
                          x-doc-default: 3
                cloudInstances: &cloudInstances
                  description: |
                    Parameter for provisioning the cloud-based VMs.

                    > **Caution!** Can only be used together with `nodeType: CloudEphemeral`.
                  type: object
                  required:
                  - classReference
                  - minPerZone
                  - maxPerZone
                  properties:
                    zones:
                      description: |
                        List of availability zones to create instances in.

                        The default value depends on the cloud provider selected and usually corresponds to all zones of the region being used.
                      x-doc-example: [["Helsinki","Espoo","Tampere"]]
                      type: array
                      items:
                        type: string
                    minPerZone:
                      description: |
                        The minimum number of instances for the group in each zone.

                        This value is used in the MachineDeployment object and as a lower bound in cluster-autoscaler.
                      type: integer
                      minimum: 0
                    maxPerZone:
                      description: |
                        The maximum number of instances for the group in each zone.

                        This value is used as the upper bound in cluster-autoscaler.
                      type: integer
                      minimum: 0
                    maxUnavailablePerZone:
                      description: |
                        The maximum number of unavailable instances (during rollout) in the group in each zone.
                      type: integer
                      x-doc-default: 0
                      minimum: 0
                    maxSurgePerZone:
                      description: |
                        The maximum number of instances to rollout simultaneously in the group in each zone.
                      type: integer
                      x-doc-default: 1
                      minimum: 0
                    standby:
                      description: |
                        The summary number of overprovisioned Nodes for this NodeGroup in all zones.

                        The value can be an absolute number (for example, 2) or a percentage of desired Nodes (for example, 10%).
                        The absolute number is calculated from percentage of maximum Nodes amount by rounding down.
                      pattern: '^[0-9]+%?$'
                      x-kubernetes-int-or-string: true
                    standbyHolder:
                      description: |
                        Parameters of the "idle" process (resource consumer) for the prepared instances.
                      type: object
                      properties:
                        notHeldResources:
                          description: |
                            Describes the resources that will not be held (consumed) by the standby holder.
                          type: object
                          properties:
                            cpu:
                              description: |
                                Describes the amount of CPU that will not be held by standby holder on Nodes from this NodeGroup.

                                The value can be an absolute number of cpus (for example, 2) as well as a milli representation (for example, 1500m).
                              pattern: '^[0-9]+m?$'
                              x-kubernetes-int-or-string: true
                            memory:
                              description: |
                                Describes the amount of memory that will not be held by standby holder on Nodes from this NodeGroup.

                                The value can be an absolute number of bytes (for example, 128974848) as well as a fixed-point number using one of memory suffixes: G, Gi, M, Mi.
                              pattern: '^[0-9]+(E|P|T|G|M|K|Ei|Pi|Ti|Gi|Mi|Ki)?$'
                              x-kubernetes-int-or-string: true
                    classReference:
                      description: |
                        The reference to the `InstanceClass` object. It is unique for each `cloud-provider-*` module.
                      type: object
                      properties:
                        kind:
                          description: |
                            The object type (e.g., `OpenStackInstanceClass`). The object type is specified in the documentation of the corresponding `cloud-provider-` module.
                          type: string
                          enum:
                          - OpenStackInstanceClass
                          - GCPInstanceClass
                          - VsphereInstanceClass
                          - AWSInstanceClass
                          - YandexInstanceClass
                          - AzureInstanceClass
                        name:
                          description: |
                            The name of the required `InstanceClass` object (e.g., `finland-medium`).
                          type: string
                nodeTemplate: &nodeTemplate
                  description: |
                    Specification of some of the fields that will be maintained in all nodes of the group.
                  x-doc-example: |
                    ```yaml
                    labels:
                      environment: production
                      app: warp-drive-ai
                    annotations:
                      ai.fleet.com/discombobulate: "true"
                    taints:
                    - effect: NoExecute
                      key: ship-class
                      value: frigate
                    ```
                  type: object
                  properties:
                    labels:
                      type: object
                      additionalProperties:
                        type: string
                      x-kubernetes-preserve-unknown-fields: true
                      description: |
                        Similar to the standard `metadata.labels` [field](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#objectmeta-v1-meta).
                      x-doc-example: |
                        ```yaml
                        labels:
                          environment: production
                          app: warp-drive-ai
                        ```
                    annotations:
                      type: object
                      additionalProperties:
                        type: string
                      x-kubernetes-preserve-unknown-fields: true
                      description: |
                        Similar to the standard `metadata.annotations` [field](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#objectmeta-v1-meta).
                      x-doc-example: |
                        ```yaml
                        annotations:
                          ai.fleet.com/discombobulate: "true"
                        ```
                    taints:
                      type: array
                      description: |
                        Similar to the `.spec.taints` field of the [Node](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#taint-v1-core) object.

                        **Caution!** Only `effect`, `key`, `value` fields are available.
                      x-doc-example: |
                        ```yaml
                        taints:
                        - effect: NoExecute
                          key: ship-class
                          value: frigate
                        ```
                      items:
                        type: object
                        properties:
                          effect:
                            type: string
                            enum:
                              - NoSchedule
                              - PreferNoSchedule
                              - NoExecute
                          key:
                            type: string
                          value:
                            type: string
                static:
                  description: |
                    Static node parameters
                  type: object
                  properties:
                    internalNetworkCIDRs:
                      description: Subnet CIDR
                      type: array
                      items:
                        type: string
                chaos: &chaos
                  description: |
                    Chaos monkey settings.
                  x-doc-example: |
                    ```yaml
                    mode: DrainAndReboot
                    period: 24h
                    ```
                  type: object
                  properties:
                    mode:
                      type: string
                      description: |
                        The chaos monkey mode:
                        - `DrainAndDelete` — drains and deletes a node when triggered;
                        - `Disabled` — leaves this NodeGroup intact.
                      x-doc-default: 'Disabled'
                      enum:
                        - Disabled
                        - DrainAndDelete
                    period:
                      type: string
                      description: |
                        The time interval to use for the chaos monkey (can be specified in the [Go format](https://golang.org/pkg/time/#ParseDuration)).
                      pattern: '^[0-9]+[mh]{1}$'
                      x-doc-default: '6h'
                operatingSystem: &operatingSystem
                  type: object
                  description: |
                    Operating System settings for nodes.
                  properties:
                    manageKernel:
                      type: boolean
                      description: |
                        Enable kernel maintenance from bashible.
                      x-doc-default: true
                disruptions: &disruptions
                  type: object
                  description: |
                    Disruptions settings for nodes.
                  required:
                    - approvalMode
                  properties:
                    approvalMode:
                      type: string
                      description: |
                        The approval mode for disruptive updates:
                        - `Manual` — disable automatic disruption approval; the alert will be displayed if disruption is needed;
                        - `Automatic` —  automatically approve disruption-involving updates (the default value).
                      enum:
                        - Manual
                        - Automatic
                    automatic:
                      type: object
                      description: |
                        Additional parameters for the `Automatic` mode.
                      properties:
                        drainBeforeApproval:
                          type: boolean
                          x-doc-default: true
                          description: |
                            Drain pods from the nodes before approving disruption.
                        windows:
                          type: array
                          description: |
                            Time windows for node disruptive updates.
                          items:
                            type: object
                            required:
                              - from
                              - to
                            properties:
                              from:
                                type: string
                                pattern: '^(?:\d|[01]\d|2[0-3]):[0-5]\d$'
                                example: '13:00'
                                description: |
                                  Start time of disruptive update window (UTC timezone).
                              to:
                                type: string
                                pattern: '^(?:\d|[01]\d|2[0-3]):[0-5]\d$'
                                example: '18:30'
                                description: |
                                  End time of disruptive update window (UTC timezone).
                              days:
                                type: array
                                description: |
                                  Days of the week when node could be updated.
                                items:
                                  type: string
                                  enum:
                                    - Mon
                                    - Tue
                                    - Wed
                                    - Thu
                                    - Fri
                                    - Sat
                                    - Sun
                docker:
                  description: |
                    Docker settings for nodes.

                    If used, `cri.type` must be set to `Docker`.
                  type: object
                  properties:
                    maxConcurrentDownloads:
                      type: integer
                      description: |
                        Set the max concurrent downloads for each pull.
                      x-doc-default: 3
                    manage:
                      type: boolean
                      x-doc-default: true
                      description: |
                        Enable Docker maintenance from bashible.
                kubelet: &kubelet
                  type: object
                  description: |
                    Kubelet settings for nodes.
                  properties:
                    maxPods:
                      type: integer
                      description: |
                        Set the max count of pods per node.
                      x-doc-default: 110
                    rootDir:
                      type: string
                      x-doc-default: '/var/lib/kubelet'
                      description: |
                        Directory path for managing kubelet files (volume mounts,etc).
                    containerLogMaxSize:
                      type: string
                      default: 50Mi
                      pattern: '\d+[Ei|Pi|Ti|Gi|Mi|Ki|E|P|T|G|M|k|m]'
                      description: |
                        Maximum log file size before it is rotated.

                        > **WARNING!** This parameter does nothing if CRI type is `Docker`.
                    containerLogMaxFiles:
                      type: integer
                      minimum: 1
                      maximum: 20
                      default: 4
                      description: |
                        How many rotated log files to store before deleting them.

                        > **WARNING!** This parameter does nothing if CRI type is `Docker`.
    - name: v1alpha2
      served: true
      storage: true
      additionalPrinterColumns: *additionalPrinterColumns
      subresources:
        status: {}
      schema:
        openAPIV3Schema:
          type: object
          description: |
            Describes the runtime parameters of the node group.
          required:
            - spec
          properties:
            status: *status
            spec:
              type: object
              required:
                - nodeType
              properties:
                nodeType: *nodeType
                cri:
                  type: object
                  description: |
                    Container runtime parameters.
                  properties:
                    type: *criType
                    containerd: *criContainerd
                    docker:
                      type: object
                      description: |
                        Docker settings for nodes.
                      properties:
                        maxConcurrentDownloads:
                          type: integer
                          description: |
                            Set the max concurrent downloads for each pull.
                          x-doc-default: 3
                        manage:
                          type: boolean
                          x-doc-default: true
                          description: |
                            Enable Docker maintenance from bashible.
                    notManaged: &notManaged
                      type: object
                      description: |
                        Settings for not managed CRI for nodes.
                      properties:
                        criSocketPath:
                          type: string
                          description: |
                            Path to CRI socket.
                  oneOf:
                    - properties:
                        type:
                          enum: ["Docker"]
                        docker: {}
                    - properties:
                        type:
                          enum: ["Containerd"]
                        containerd: {}
                    - properties:
                        type:
                          enum: ["NotManaged"]
                cloudInstances: *cloudInstances
                nodeTemplate: *nodeTemplate
                chaos: *chaos
                operatingSystem: *operatingSystem
                disruptions: *disruptions
                kubelet: *kubelet
    - name: v1
      served: true
      storage: false
      additionalPrinterColumns: *additionalPrinterColumns
      subresources:
        status: {}
      schema:
        openAPIV3Schema:
          type: object
          description: |
            Describes the runtime parameters of the node group.
          required:
            - spec
          properties:
            status: *status
            spec:
              type: object
              required:
                - nodeType
              properties:
                nodeType:
                  description: |
                    The type of nodes this group provides:
                    - CloudEphemeral — nodes for this group will be automatically created (and deleted) in the cloud of the specified cloud provider;
                    - CloudPermanent — nodes from ProviderClusterConfiguration will be created via dhctl;
                    - CloudStatic — a static node (created manually or using any external tools) hosted in the cloud integrated with
                      one of the cloud providers. This node has the CSI running, and it is managed by the
                      cloud-controller-manager: the `Node` object automatically gets the information about the zone and region
                      based on the cloud data; if a node gets deleted from the cloud, its corresponding Node object
                      will be deleted in Kubernetes;
                    - Static — a static node hosted on a bare metal or virtual machine. The cloud-controller-manager does not manage the
                      node even if one of the cloud providers is enabled.
                  type: string
                  enum:
                    - CloudEphemeral
                    - CloudPermanent
                    - CloudStatic
                    - Static
                cri:
                  type: object
                  description: |
                    Container runtime parameters.
                  properties:
                    type: *criType
                    containerd: *criContainerd
                    docker:
                      type: object
                      description: |
                        Docker settings for nodes.
                      properties:
                        maxConcurrentDownloads:
                          type: integer
                          description: |
                            Set the max concurrent downloads for each pull.
                          x-doc-default: 3
                        manage:
                          type: boolean
                          x-doc-default: true
                          description: |
                            Enable Docker maintenance from bashible.
                    notManaged: *notManaged
                  oneOf:
                    - properties:
                        type:
                          enum: ["Docker"]
                        docker: {}
                    - properties:
                        type:
                          enum: ["Containerd"]
                        containerd: {}
                    - properties:
                        type:
                          enum: ["NotManaged"]
                cloudInstances: *cloudInstances
                nodeTemplate: *nodeTemplate
                chaos: *chaos
                operatingSystem: *operatingSystem
                disruptions: *disruptions
                kubelet: *kubelet
                update:
                  type: object
                  properties:
                    maxConcurrent:
                      x-kubernetes-int-or-string: true
                      anyOf:
                        - type: integer
                        - type: string
                      default: 1
                      pattern: "^[1-9][0-9]*%?$"
                      description: |
                        Maximum number of concurrently updating nodes. Can be set as absolute count or as a percent of total nodes.
              oneOf:
              - properties:
                  nodeType:
                    enum:
                    - CloudEphemeral
                required:
                - cloudInstances
              - properties:
                  nodeType:
                    enum:
                    - CloudPermanent
                    - CloudStatic
                    - Static
