## Развертывание тестового приложения

Для демонстрации возможностей Deckhouse Virtualization Platform развернём демо-приложение. Демо-приложение представляет собой набор виртуальных машин и контейнеров, работающих в классической трехзвенной архитектуре (Frontend → Backend → Database).

### Что демонстрирует приложение

Приложение демонстрирует следующие возможности платформы:

- **Декларативное развертывание и управление**: создание и управление ресурсами платформы, пользователями и рабочими нагрузками через YAML-манифесты;
- **Мультитенантность и ролевая модель**: изоляция ресурсов между проектами и настройка прав доступа для разных пользователей;
- **Совместная работа ВМ и контейнеров**: виртуальные машины и контейнерные приложения работают в единой среде кластера;
- **Микросегментация сети**: применение сетевых политик для контроля трафика между компонентами приложения;
- **Балансировка нагрузки**: использование Ingress-контроллера для распределения запросов между экземплярами приложения;
- **Интеграция с DEX**: пример настройки аутентификации через DEX-провайдер.

## Архитектура приложения

![Архитектура платформы](/images/virtualization-platform/dvp-gs-architecture-test-app.ru.png)

Приложение состоит из двух проектов:

**Project: `demo-db`**
- **Database**: виртуальная машина `db` с PostgreSQL

**Project: `demo-app`**
- **Frontend**: 
  - виртуальная машина `frontend` (Bootstrap-приложение)
  - под `frontend` (Bootstrap-приложение)
- **Backend**:
  - виртуальная машина `backend-a` (Flask + Gunicorn)
  - виртуальная машина `backend-b` (Flask + Gunicorn)

Взаимодействие компонентов ограничено сетевыми политиками. Доступ к приложению требует аутентификации через DEX.

## Требования

Перед установкой демо-приложения убедитесь, что выполнены следующие требования:

### Установленные пакеты

Убедитесь, что на вашей системе установлены следующие пакеты:

- `task` — утилита для автоматизации задач
- `yq` — утилита для работы с YAML-файлами  

## Установка приложения

Для установки демо-приложения выполните следующие шаги:

1. **Клонируйте репозиторий** с манифестами приложения:

   ```bash
   git clone https://github.com/fl64/dvp-demo-app.git
   cd dvp-demo-app
   ```

1. **Создайте файл `.env`** с настройками инфраструктуры:

   ```bash
   cat > .env <<EOF
   STORAGE_CLASS=nfs-storage-class
   PASSWORD=password
   FQDN=demo.example.com
   EOF
   ```

   Замените значения в файле `.env` на соответствующие вашей инфраструктуре:
   - `STORAGE_CLASS` — имя StorageClass, используемого в вашем кластере
   - `PASSWORD` — пароль для пользователей приложения
   - `FQDN` — полное доменное имя для доступа к приложению

1. Сгенерируйте SSH-ключ для доступа к виртуальным машинам:

   ```bash
   task ssh-gen
   ```

1. Установите приложение:

   ```bash
   task deploy
   ```

1. Дождитесь готовности всех компонентов. Проверьте статус виртуальных машин:

   ```bash
   sudo -i d8 k get vm -A
   ```

   Проверьте статус подов:

   ```bash
   sudo -i d8 k get po -A | grep demo
   ```

### Удаление приложения

Для удаления демо-приложения выполните команду:

```bash
task undeploy
```

## Подключение к виртуальным машинам

После развертывания приложения вы можете подключиться к виртуальным машинам следующими способами:

### Подключение по SSH

Для подключения к виртуальной машине по SSH используйте команду:

```bash
sudo -i d8 v ssh -n demo-app cloud@<vmname> -i ./tmp/demo --local-ssh
```

Замените `<vmname>` на имя виртуальной машины (например, `frontend`, `backend-a`, `backend-b`, `db`).

### Подключение через консоль

Для подключения к консоли виртуальной машины используйте команду:

```bash
sudo -i d8 v console -n demo-app <vmname>
```

Замените `<vmname>` на имя виртуальной машины.

## Сценарий работы с приложением

После успешного развертывания выполните следующие действия для демонстрации возможностей платформы:

1. **Откройте веб-интерфейс приложения** в браузере по адресу, указанному в Ingress-ресурсе.

1. **Авторизуйтесь через DEX**:
   - Используйте учетные данные, созданные при настройке приложения;
   - Убедитесь, что аутентификация работает корректно.

1. **Проверьте балансировку нагрузки**:
   - Обновите страницу несколько раз;
   - Убедитесь, что запросы распределяются между виртуальной машиной `frontend` и подом `frontend`.

1. **Протестируйте трехзвенную архитектуру**:
   - Добавьте новое поле через веб-интерфейс;
   - Удалите поле;
   - Убедитесь, что изменения сохраняются в базе данных.

1. **Изучите ресурсы в веб-интерфейсе консоли**:
   - Войдите в веб-интерфейс консоли Deckhouse;
   - Просмотрите созданные проекты (`demo-db` и `demo-app`);
   - Изучите виртуальные машины в каждом проекте;
   - Просмотрите поды приложения;
   - Изучите конфигурацию балансировщика нагрузки;
   - Просмотрите сетевые политики, ограничивающие взаимодействие компонентов.

Вы успешно развернули демо-приложение и ознакомились с основными возможностями Deckhouse Virtualization Platform.
