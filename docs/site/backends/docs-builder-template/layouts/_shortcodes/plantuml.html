<div class="plantuml-diagram">
    <textarea class="plantuml-code" style="display:none;">
    {{ .Inner }}
    </textarea>
    <img class="plantuml-image" src="" alt="PlantUML Diagram"/>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    function encodePlantUML(text) {
        // Encode text to UTF-8, then to hex
        const utf8Bytes = new TextEncoder().encode(text);
        let hex = '';
        for (const byte of utf8Bytes) {
            hex += byte.toString(16).padStart(2, '0');
        }
        return hex;
    }

    function compressToPlantUML(hex) {
        // Rendering using remote server
        // return "http://www.plantuml.com/plantuml/img/" + "~h" + hex;
        // Rendering using local server
        return "http://localhost:8080/png/" + "~h" + hex;
    }

    document.querySelectorAll('.plantuml-diagram').forEach(function (container, index) {
        const textarea = container.querySelector('.plantuml-code');
        const img = container.querySelector('.plantuml-image');

        if (textarea && img) {
            const code = textarea.value;
            console.log("PlantUML Code:", code);
            
            try {
                const hex = encodePlantUML(code);
                console.log("Encoded Hex:", hex);
                img.src = compressToPlantUML(hex);
            } catch (error) {
                console.error("Error encoding PlantUML:", error);
            }
        }
    });
});
</script>