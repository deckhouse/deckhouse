{{- $modulesList := .Site.Data.modules.channels }}
{{- $channelsInfo := .Site.Data.channels.info }}
{{- $sidebarRootMenu := slice }}
{{- $pages := (where $.Site.Pages ".Section" "modules").ByWeight }}
{{- $ctx := $ }}

{{- $_pathElements := index ( findRESubmatch  `^modules/([a-zA-Z0-9-]+)/([a-zA-Z0-9-]+)/.*$` .File.Dir 1 ) 0 }}
{{- $currentModuleName := index $_pathElements 1 }}
{{- $currentModuleChannel := index $_pathElements 2 }}
<!-- {{- range $ctx.Site.RegularPages.ByWeight }}
  {{/* if ne .Section "modules" }}{{ continue }}{{ end */}}
  {{/* $pages = $pages | sort "Weight" "asc" */}}
  {{/* $pages = $pages | sort "Title" "asc" */}}
  {{/* $pages = $pages | sort "File.Dir" "asc" */}}
  section: {{ .Section }}<br>
  Section {{ .File.Section }}<br>
  sections: <b>{{ range .Sections }}{{ .Title }} ({{ .File.Path }})|{{ end }}</b><br>
  File - <b>{{ .File.Dir }}</b>, {{ .File.Path }}<br>
  subpages: <br>{{ range .Pages }}<pre>   {{ .File.Path }} ({{ .IsSection}})</pre>{{ end }}
  <hr />
{{- end }} //-->


{{- range $module, $data := $modulesList }}
  {{- $moduleTitle := "" }}
  {{- $moduleChannel := "" }}
  {{- $isActiveItem := false }}
  {{- $d8Edition := "" }}
  {{- $moduleStatus := "" }}

  {{- if eq $currentModuleName $module }}
    {{- $moduleChannel = $currentModuleChannel }}
    {{- $isActiveItem = true }}
  {{- end }}

  {{- range sort $channelsInfo "stability" "desc" }}
    {{- $code := .code }}
    {{- if eq $code "rock-solid" }}{{ continue }}{{ end }}
    {{- with $.GetPage ( printf "modules/%s/%s/README.md" $module $code  ) }}
      {{- if and .Params.menuTitle (not $moduleTitle ) }}{{ $moduleTitle = .Params.menuTitle }}{{ end }}
      {{- if and .Params.d8Edition ( not $d8Edition ) }}{{ $d8Edition = .Params.d8Edition }}{{ end }}
      {{- if and .Params.moduleStatus ( not $moduleStatus ) }}{{ $moduleStatus = .Params.moduleStatus }}{{ end }}
      {{- if not $moduleChannel }}{{ $moduleChannel = $code }}{{ end }}
    {{- end }}
  {{- end }}
  {{- if not $moduleTitle }}{{ $moduleTitle = $module }}{{ end }}
  {{- if not $d8Edition }}{{ $d8Edition = "ce" }}{{ end }}
  {{- if $moduleChannel }}
    {{- $sidebarRootMenu = $sidebarRootMenu | append (dict "module" $module "title" $moduleTitle "channel" $moduleChannel "isActive" $isActiveItem "d8Edition" $d8Edition "moduleStatus" $moduleStatus) }}
  {{- end }}
{{- end}}

{{- $sidebarRootMenu = sort $sidebarRootMenu "title" "asc" }}

  <div style="display: flex; justify-content: start; padding-top: 12px; padding-bottom: 35px; gap: 25px;">
    <div class="channel-menu submenu-parent">
      {{- partial "documentation-section-badge" }}
    </div>

    <div id="doc-versions-menu" class="channel-menu submenu-parent">
      {{- if $.IsPage }}
      {{- if and $currentModuleName $currentModuleChannel }}
        {{- partial "module-version-badge" (dict "ctx" $ "module" $currentModuleName "channel" $currentModuleChannel ) }}
      {{- end }}
      {{- end }}
    </div>

  </div>

  <div class="sidebar__wrapper-inner">
    <nav class="sidebar__container">

      <ul class="sidebar" id="mysidebar">

          {{- $overviewItem := $.GetPage "modules/" }}

          <li class="sidebar__item {{ if eq $overviewItem $.Page }}active{{ end }}">
              <a href='{{ relURL "" }}modules/'>{{ $overviewItem.LinkTitle }}</a>
          </li>

        {{- range $sidebarItem := $sidebarRootMenu }}
            <li class="sidebar__item sidebar__item_parent{{ if $sidebarItem.isActive }} active{{ end }}">
                <a href='#'>
                  {{- $sidebarItem.title }}
                  {{- if ne $sidebarItem.d8Edition "ce" }}<span class="sidebar__badge sidebar__badge_{{ lower $sidebarItem.d8Edition }}">EEÂ Only</span>{{ end }}
                  {{- if eq $sidebarItem.moduleStatus "experimental" }}<span class="sidebar__badge sidebar__badge_{{ lower $sidebarItem.moduleStatus }}">Experimental</span>{{ end }}
                  {{- template "subpages" (dict "parent" $sidebarItem  "ctx" $ctx) }}
            </li>
        {{- end }}
      </ul>
    </nav>
  </div>

{{- define "nested-subpages" }}
{{- $sidebarItem := .parent }}
{{- $pages := .pages }}
{{- $ctx := .ctx }}
<ul class="sidebar__submenu" style="display: block;">
    <!-- <a href="./modules/110-istio/configuration.html">Configuration</a> -->
    {{ range $pages }}
    <li class="sidebar__submenu-item {{ if or ($ctx.Page.IsAncestor .) (eq $ctx.Page .) }}active{{ end }}">
      <!-- {{- $_pathElements := index ( findRESubmatch  `^modules/([a-zA-Z0-9-]+)/([a-zA-Z0-9-]+)/$` .File.Dir 1 ) 0 }}
      {{- $moduleName := index $_pathElements 1 }}
      {{- $moduleChannel := index $_pathElements 2 }} //-->
      {{- $_pathElements := index ( findRESubmatch  `^modules/([a-zA-Z0-9-]+)/([a-zA-Z0-9-]+)/$` .File.Dir 1 ) 0 }}
      {{- if not .IsSection }}
        <a href="{{ .RelPermalink }}">{{ .Title }}</a>
      {{ end }}
    </li>
    {{ end }}
</ul>
{{- end }}

{{/* --- subpages --- */}}
{{- define "subpages" }}

{{- $sidebarItem := .parent }}
{{- $ctx := .ctx }}

<ul class="sidebar__submenu">

 {{- with $ctx.GetPage ( printf "modules/%s/%s/README.md" $sidebarItem.module $sidebarItem.channel  ) }}
  <li class="sidebar__submenu-item {{ if or ($ctx.Page.IsAncestor .) (eq $ctx.Page .) }}active{{ end }}">
     <a href="{{ replaceRE "/readme.html$" "/" .RelPermalink }}">
     {{- if in .Site.Data.helpers.knownPageNames .File.TranslationBaseName }}
       {{- T (printf "moduleLinkTitle%s" .File.TranslationBaseName) }}
     {{- else if .LinkTitle }}
       {{- .LinkTitle }}
     {{- else if .Title }}
       {{- .Title }}
     {{- end }}
     </a>
 </li>
 {{- end }}


{{- range (where $ctx.Site.Pages ".Section" "modules").ByWeight }}
  {{- $_pathElements := index ( findRESubmatch  `^modules/([a-zA-Z0-9-]+)/([a-zA-Z0-9-]+)/$` .File.Dir 1 ) 0 }}
  {{- $moduleName := index $_pathElements 1 }}
  {{- $moduleChannel := index $_pathElements 2 }}

  {{- if or ( ne $moduleName $sidebarItem.module ) ( ne $moduleChannel $sidebarItem.channel ) ( eq .File.TranslationBaseName "README" ) }}{{ continue }}{{ end }}
  <!--File - <b>{{ .File.Dir }}</b>, {{ .File.Path }} ({{ .IsSection}})<br>
  moduleName: {{- $moduleName }}<br>
  sidebarItem.module: {{ $sidebarItem.module }}<br>
  $sidebarItem.channel: {{ $sidebarItem.channel }}<br>
  moduleChannel: {{- $moduleChannel }}<br>
  subpages: <br>{{ range .Pages }}<pre>   {{ .File.Path }} ({{ .IsSection}})</pre>{{ end }}
  sections: {{ .Sections }}<br><hr>//-->
  {{ if .IsSection }}
     {{ $rootSectionPage := . }}
     {{ range .Pages }}
     {{ if not .IsSection }}{{ continue }}{{ end }}
       <!-- path-{{ .File.Path }}, parent - {{ $sidebarItem }}<br> -->
       <li class="sidebar__submenu-item sidebar__submenu-item_parent {{ if or ($rootSectionPage.IsAncestor .) (eq $ctx.Page .) }}active{{ end }}">
         <a href="#"><span></span>{{ .Title }}</a>
           {{- template "nested-subpages" (dict "parent" $sidebarItem "pages" .Pages "ctx" $ctx) }}
       </li>
        <!--section item: <b>{{ .Title }} ({{ .File.Path }})</b><br> -->
     {{ end }}
  {{ else }}
       <li class="sidebar__submenu-item {{ if or (.IsAncestor page) (eq . page) }}active{{ end }}">
          <a href="{{ if .IsPage }}{{ replaceRE "/readme.html$" "/" .RelPermalink }}{{ else }}#{{ end }}">
          {{- if in .Site.Data.helpers.knownPageNames .File.TranslationBaseName }}
            {{- T (printf "moduleLinkTitle%s" .File.TranslationBaseName) }}
          {{- else if .LinkTitle }}
            {{- .LinkTitle }}
          {{- else if .Title }}
            {{- .Title }}
          {{- end }}
          </a>
      </li>
  {{ end }}
  {{- end }}
  </ul>
{{- end }}
{{/* END --- subpages --- */}}
