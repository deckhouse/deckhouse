{{- $modulesData := .Site.Data.modules_all -}}
{{- $currentLang := .Site.Language.Lang -}}
{
  "documents": [
    {{- $first := true -}}
    {{- range .Site.Pages -}}
      {{- if and (eq .Section "modules") (ne .Kind "section") (ne .Kind "home") -}}
        {{- $moduleName := .File.Dir | replaceRE "^modules/([^/]+)/.*" "$1" -}}
        {{- $moduleData := index $modulesData $moduleName -}}
        {{- if $moduleData -}}
          {{- $isExternal := eq $moduleData.external "true" -}}
          {{- if $isExternal -}}
            {{- if not $first -}},{{- end -}}
            {{- $first = false -}}
            {
              "title": {{ .Title | jsonify }},
              "url": {{ .RelPermalink | jsonify }},
              {{- $keywords := slice -}}
              {{- if $moduleData.tags -}}
                {{- $keywords = $keywords | append $moduleData.tags -}}
              {{- end -}}
              {{- if .Params.search -}}
                {{- $keywords = $keywords | append (split .Params.search ",") -}}
              {{- end -}}
              {{- if gt (len $keywords) 0 -}}
              "keywords": {{ $keywords | jsonify }},
              {{- end -}}
              "module": {{ $moduleName | jsonify }},
              "moduletype": "source",
              "summary": {{ if .Summary }}{{ .Summary | plainify | jsonify }}{{ else if .Description }}{{ .Description | plainify | jsonify }}{{ else }}""{{ end }},
              "content": {{ .Content | plainify | jsonify }}
            }
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  ],
  "parameters": [
    {{- $first := true -}}
    {{- range $moduleName, $moduleData := $modulesData -}}
        {{- $modulePath := printf "data/modules/%s" $moduleName -}}
        {{- $moduleFiles := .Site.Data.modules -}}
        {{- range $channel, $channelData := index $moduleFiles $moduleName -}}
          {{- range $file, $fileData := $channelData -}}
            {{- if and (ne $file "channels") (ne $file "editions") -}}
              {{- if not $first -}},{{- end -}}
              {{- $first = false -}}
              {
                "name": {{ $fileData.name | default $file | jsonify }},
                "module": {{ $moduleName | jsonify }},
                "moduletype": "source",
                "url": {{ printf "/modules/%s/%s/%s/" $moduleName $channel $file | jsonify }},
                {{- if $fileData.resourceName -}}
                "resName": {{ $fileData.resourceName | jsonify }},
                {{- end -}}
                {{- if $fileData.isResource -}}
                "isResource": "true",
                {{- end -}}
                {{- if $fileData.deprecated -}}
                "deprecated": "true",
                {{- end -}}
                {{- $keywords := slice -}}
                {{- if $moduleData.tags -}}
                  {{- $keywords = $keywords | append $moduleData.tags -}}
                {{- end -}}
                {{- if $fileData.search -}}
                  {{- $keywords = $keywords | append (split $fileData.search ",") -}}
                {{- end -}}
                {{- if gt (len $keywords) 0 -}}
                "keywords": {{ $keywords | jsonify }},
                {{- end -}}
                "path": {{ printf "%s.%s.%s" $moduleName $channel $file | jsonify }},
                "content": {{ $fileData.content | default "" | jsonify }}
              }
            {{- end -}}
          {{- end -}}
        {{- end -}}
    {{- end -}}
  ]
}
---
{{ $modulesStablestList := partial "get-stablest-modules-list.html" . }}
  {{- range $modulesStablestList }}
    {{- $moduleChannel := index . "channel" }}
    {{- $moduleName := index . "name" }}
    {{- $moduleData := index (index $.Site.Data.modules $moduleName) $moduleChannel }}
    {{- if not $moduleData }}
      {{- continue -}}
    {{- end }}
    {{- partial "openapi/module-search-index.json" (dict "name" $moduleName "channel" $moduleChannel "data" $moduleData "lang" $.Lang) }}
  {{- end }}
