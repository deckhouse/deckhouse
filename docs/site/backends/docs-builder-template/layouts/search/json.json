{{- $modulesData := .Site.Data.modules_all -}}
{{- $currentLang := .Site.Language.Lang -}}
{
  "documents": [
    {{- $first := true -}}
    {{- range .Site.Pages -}}
      {{- if and (eq .Section "modules") (ne .Kind "section") (ne .Kind "home") (not (hasSuffix .RelPermalink "/configuration.html")) (not (hasSuffix .RelPermalink "/cr.html")) -}}
        {{- $moduleName := .File.Dir | replaceRE "^modules/([^/]+)/.*" "$1" -}}
        {{- $moduleData := index $modulesData $moduleName -}}
        {{- if $moduleData -}}
          {{- $isExternal := eq $moduleData.external "true" -}}
          {{- if $isExternal -}}
            {{- if not $first -}},{{- end -}}
            {{- $first = false -}}
            {
              "title": {{ .Title | jsonify }},
              "url": {{ .RelPermalink | jsonify }},
              {{- $keywords := slice -}}
              {{- if $moduleData.tags -}}
                {{- $keywords = $keywords | append $moduleData.tags -}}
              {{- end -}}
              {{- if .Params.search -}}
                {{- $keywords = $keywords | append (split .Params.search ",") -}}
              {{- end -}}
              {{- if gt (len $keywords) 0 -}}
              "keywords": {{ $keywords | jsonify }},
              {{- end -}}
              "module": {{ $moduleName | jsonify }},
              "moduletype": "source",
              "summary": {{ if .Summary }}{{ .Summary | plainify | jsonify }}{{ else if .Description }}{{ .Description | plainify | jsonify }}{{ else }}""{{ end }},
              "content": {{ .Content | plainify | jsonify }}
            }
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  ],
  "parameters": [
  {{- $modulesStablestList := partial "get-stablest-modules-list.html" . }}
  {{- $firstModule := true }}
  {{- range $modulesStablestList }}
    {{- $moduleChannel := index . "channel" }}
    {{- $moduleName := index . "name" }}
    {{- $moduleData := index (index $.Site.Data.modules $moduleName) $moduleChannel }}
    {{- if not $moduleData }}
      {{- continue -}}
    {{- end }}
    {{- if ne $moduleName "virtualization" }}
      {{- continue -}}
    {{- end }}
    {{- if not $firstModule }},{{- end }}
    {{- partial "openapi/module-search-index.json" (dict "name" $moduleName "channel" $moduleChannel "data" $moduleData "lang" $.Lang "firstModule" $firstModule) }}
    {{- $firstModule = false }}
  {{- end -}}
]}
