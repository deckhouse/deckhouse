{{- define "main" }}
<div class="navigation__container">
  <div class="breadcrumbs__left">
    <ol class="breadcrumbs">
      <li class="breadcrumbs__item">{{ T "modules_documentation" | humanize }}</li>
    </ol>
  </div>
  {{ "<!--noindex-->" | safeHTML }}
  <div class="breadcrumbs__right">
    <ol class="breadcrumbs">
      {{- partial "breadcrumbs" . }}
    </ol>
  </div>
  {{ "<!--/noindex-->" | safeHTML }}

  <!--start search-->
  {{- $cachingTime := "240" }}
  {{- if eq site.Params.mode "module" }}
    {{- $cachingTime = "60" }}
  {{- end -}}
  <div class="searchV3">
    <div class="container">
      <div class="input-wrapper">
        <input type="text" id="search-input" placeholder='{{ T "search_placeholder_text" }}' class="input"
        data-search-index-path="/products/kubernetes-platform/documentation/v1/search.json:2.0:{{ $cachingTime }},/modules/search-embedded-modules-index.json:1.0:{{ $cachingTime }},/modules/search-external-modules-index.json:1.0:{{$cachingTime}}"
        data-search-context='{{ T "search_context_dkpdocs_and_modules" }}'
        >
        <div id="search-results" class="results" style="display: none"></div>
      </div>
    </div>
  </div>
  <!--end search-->
  <!--loading search JS-->
  <script type="text/javascript" src='/assets/js/fuse.min.js?v={{ .Site.Lastmod | time.Format ":date_long" | hash.FNV32a }}' ></script>
  <script type="text/javascript" src='/assets/js/search-v3.js?v={{ .Site.Lastmod | time.Format ":date_long" | hash.FNV32a }}' ></script>
  <!--end loading search JS-->

</div>

<div class="layout-sidebar layout-sidebar__tile">
  <div class="layout-sidebar__sidebar layout-sidebar__sidebar--tile">
    {{- partial "sidebar-filter" . }}
  </div>
  <div class="layout-sidebar__content layout-sidebar__content--tile">
    <div class="selected__filters">
      <div class="selected__filters--list"></div>
    </div>
    <h1 class="tile__title">{{ .Title }}</h1>

    {{.Content}}

{{- $lang := .Site.Language.Lang }}
{{- $editionsSortedList := sort .Site.Data.helpers.editions "weight" }}
{{- $modulesChannelsData := .Site.Data.modules.channels }}
{{- $channelsInfo := .Site.Data.channels.info }}
{{- $modulesList := slice }}
{{- $embeddedModulesList := .Site.Data.dkp.embedded_modules.entries }}
{{- $embeddedModulesEditionsGlobal := .Site.Data.dkp.editions }}
{{- $modulesEditions := .Site.Data.modules_all }}
{{- $pages := (where $.Site.RegularPages ".Section" "modules").ByWeight }}
{{- $ctx := $ }}

{{- $_pathElements := index ( findRESubmatch  `^modules/([a-zA-Z0-9-]+)/([a-zA-Z0-9-]+)/*$` .File.Dir 1 ) 0 }}
{{- $currentModuleName := index $_pathElements 1 }}
{{- $currentModuleChannel := index $_pathElements 2 }}

{{- range $module, $data := $modulesChannelsData }}
  {{- $moduleTitle := "" }}
  {{- $moduleChannel := "" }}
  {{- $moduleDescription := "" }}
  {{- $moduleTags := slice }}

  {{/* Skip the embedded module if there is external module with the same name */}}
  {{- $embeddedModuleWithTheSameName := (where $embeddedModulesList "module" $module) }}
  {{- if gt ($embeddedModuleWithTheSameName | len) 0 }}
    {{- warnf "Found embedded module %s and external modules with the same name. Use only external module." $module }}
  {{- end }}

  {{- $moduleTags = index (index $modulesEditions $module) "tags" }}

  {{- range sort $channelsInfo "stability" "desc" }}
    {{/* Skip rock-solid channel */}}
    {{- if eq .code "rock-solid"  }}{{ continue }}{{ end }}

    {{/* The condition to select the data from the available stablest module channel */}}
    {{- if gt ( $moduleTitle | len ) 0  }}{{ continue }}{{ end }}

    {{- $channel := .code }}
    {{- with $.GetPage ( printf "modules/%s/%s/README.md" $module $channel ) }}
      {{- if .Params.menuTitle }}{{ $moduleTitle = .Params.menuTitle }}
      {{- else if .LinkTitle }}{{ $moduleTitle = .LinkTitle }}
      {{- end }}
      {{- if not $moduleChannel }}{{ $moduleChannel = $channel }}{{ end }}
      {{- if not $moduleDescription }}{{ $moduleDescription = .Description }}{{ end }}
    {{- end}}
  {{- end}}

  {{- $moduleData := index (index $ctx.Site.Data.modules $module) $moduleChannel }}
  {{- $moduleMetadata := index $moduleData "module" }}
  {{- $moduleOss := index $moduleData "oss" }}
  {{- if and $moduleMetadata $moduleOss }}
    {{- $moduleMetadata = merge $moduleMetadata (dict "oss" $moduleOss) }}
  {{- end }}

  {{- if not $moduleTitle }}{{ $moduleTitle = $module }}{{ end }}
  {{- if (not $moduleChannel ) }}{{ continue }}{{ end }}
  {{- $modulesList = $modulesList | append (dict "module" $module "title" $moduleTitle "channel" $moduleChannel "description" $moduleDescription "metadata" $moduleMetadata "tags" $moduleTags "url" (printf "%s/%s/" $module $moduleChannel ) ) }}
{{- end}}

{{- warnf "Found %d modules from sources." ($modulesList | len) }}

{{- if $embeddedModulesList }}
  {{- warnf "Found %d embedded modules." ( $embeddedModulesList | len) }}
  {{- $filteredEmbeddedModules := slice }}
  {{- range $embeddedModulesList }}
    {{- $externalModuleWithSameName := (where $modulesList "module" .module) }}
    {{- if eq ($externalModuleWithSameName | len) 0 }}
      {{- $filteredEmbeddedModules = $filteredEmbeddedModules | append . }}
    {{- else }}
      {{- warnf "Skipping embedded module %s because external module with same name exists." .module }}
    {{- end }}
  {{- end }}
  {{- $modulesList = $modulesList | append $filteredEmbeddedModules }}
{{- else }}
  {{- warnf "No embedded modules found!" }}
{{- end }}

      <div class="block__tile">
      {{- range (sort $modulesList "module" "asc") }}
        {{- $moduleStage := "" }}
        {{- $moduleName := .module }}
        {{- $moduleDescription := default "" .description }}

        {{- if .metadata }}
          {{- $moduleStage = .metadata.stage }}

          {{/* Try to get description from module metadata (module.yaml) */}}
          {{- $moduleMetadataDescriptions := index .metadata "descriptions" }}
          {{- if and $moduleMetadataDescriptions (index $moduleMetadataDescriptions $lang) (gt (index $moduleMetadataDescriptions $lang | len ) 0) }}
            {{- $moduleDescription = index $moduleMetadataDescriptions $lang }}
          {{- end }}
        {{- end }}

        {{- $tags := .tags }}

        {{- $moduleEditionsData := slice }}
        {{- $moduleEditionsString := "" }}

        {{- if .embedded }}
          {{/* make edition list for an embedded module */}}
          {{- $embeddedModuleMetadata := index (where $embeddedModulesList "module" .module ) 0 }}

          {{- if index $embeddedModuleMetadata "editionMinimumAvailable" }}
            {{- $moduleEditionMinimumAvailable := index $embeddedModuleMetadata "editionMinimumAvailable" }}
            {{- $moduleEditionMinimumAvailableWeight := default 100 (index (where $editionsSortedList "id" $moduleEditionMinimumAvailable | first 1) 0 "weight") }}
            {{- range $editionsSortedList }}
              {{- if and (ge .weight $moduleEditionMinimumAvailableWeight) (ne .id "cse-lite") (ne .id "cse-pro") }}
                {{- $moduleEditionsData = $moduleEditionsData | append .id }}
              {{- end }}
            {{- end }}
          {{- else if index $embeddedModuleMetadata "editions" }}
            {{- $moduleEditionsData = index $embeddedModuleMetadata "editions" }}
          {{ end }}

          {{/* remove or add edition if the embedded module is in the excludeModules in the $embeddedModulesEditionsGlobal list */}}
          {{ range $key, $val := $embeddedModulesEditionsGlobal }}
            {{ if and $val.excludeModules (in $val.excludeModules $moduleName) }}
                {{ $filtered := slice }}

                {{ range $moduleEditionsData }}
                  {{ if ne . $key }}
                    {{ $filtered = $filtered | append . }}
                  {{ end }}
                {{ end }}
                {{ $moduleEditionsData = $filtered }}

            {{ end }}
            {{ if and $val.includeModules (in $val.includeModules $moduleName) }}
                {{ if not (in $moduleEditionsData $key) }}
                  {{ $moduleEditionsData = $moduleEditionsData | append $key }}
                {{ end }}
            {{ end }}
          {{ end }}

          {{- $moduleEditionsString = delimit $moduleEditionsData "," }}

        {{- else if isset $modulesEditions .module }}
          {{/* make edition list for a module from source */}}
          {{- $moduleEditionsData = index $modulesEditions .module }}
          {{- $_editions := default slice (index $moduleEditionsData "editions") | append (index $moduleEditionsData "editionsWithRestrictions") |uniq }}
          {{- $moduleEditionsString = delimit $_editions "," }}
        {{- end }}

        <a class="button-tile" data-editions="{{ $moduleEditionsString }}" href="{{ .url }}">editions-{{ $moduleEditionsString }}

        {{- if and $moduleStage (in (slice "Preview" "Experimental" "General Availability" "Deprecated" ) $moduleStage) }}
          {{- $stageKey := lower $moduleStage }}
          {{- $stageIcon := $stageKey }}
          {{- if eq $moduleStage "General Availability" }}
            {{- $stageKey = "generalAvailability" }}
            {{- $stageIcon = "general_availability" }}
          {{- end }}
          <span class='button-tile__stage button-tile__stage-{{ $stageKey }}'>
            <img src="/images/{{ $stageIcon }}.svg" alt="{{- $moduleStage }}">
          </span>
        {{- end }}
        <h2 class="button-tile__title">{{ .module }}</h2>

          <p class="button-tile__descr">
            {{ $moduleDescription }}
          </p>
          <div class="button-tile__bottom">
            <div class="button-tile__tags">

              {{- range $tags }}
                {{ if eq . "embedded" }}
                  {{ continue }}
                {{ end }}
                <span class="sidebar__badge--container"><span class="sidebar__badge_v2">{{ . }}</span></span>
              {{- end }}

            </div>
            {{/* <div class="button-tile__time">
              <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="6" cy="6" r="5.25" stroke="#5E6697" stroke-width="1.5"/>
                <path d="M4.25 6H6V3.375" stroke="#5E6697" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
               <p class="button-tile__descr tile__descr--time">{{ .WordCount }} words</p>
            </div> */}}
          </div>
        </a>
      {{- end }}

      </div>

    <script type="text/javascript" src='/assets/js/tile.js?v={{ .Site.Lastmod | time.Format ":date_long" | hash.FNV32a }}'></script>
    <script>
      function getHeaderHeight() {
        const header = $('header');
        return header.outerHeight(true);
      }
      const headerHeight = getHeaderHeight();
      const $navigationContainer = $('.navigation__container');
      $navigationContainer.css("top", headerHeight);
    </script>
    {{- if ne site.Params.mode "module" }}
      {{ "<!--noindex-->" | safeHTML }}
      {{- "<!--#include virtual=\"/includes/feedback.html\" -->"  | safeHTML }}
      {{ "<!--/noindex-->" | safeHTML }}
    {{- end }}

  </div>
</div>
{{- end }}
