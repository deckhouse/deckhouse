{{/* Extracts search parameters from CRD schema */}}

{{- $crdData := .crdData }}
{{- $langData := .langData }}
{{- $moduleName := .moduleName }}
{{- $moduleChannel := .moduleChannel }}
{{- $crdName := .crdName }}
{{- $searchParams := slice }}

{{- $kind := $crdData.spec.names.kind }}

{{- if $crdData.spec.versions }}
  {{- range $version := $crdData.spec.versions }}
    {{- $versionName := $version.name }}
    {{- $versionSchema := $version.schema.openAPIV3Schema }}
    {{- $langVersionData := dict }}

    {{- if $langData.spec.versions }}
      {{- $langVersionData = index (where $langData.spec.versions "name" "eq" $versionName) 0 }}
    {{- end }}

    {{- $description := $versionSchema.description }}
    {{- if $langVersionData.schema.openAPIV3Schema.description }}
      {{- $description = $langVersionData.schema.openAPIV3Schema.description }}
    {{- end }}

    {{- /* Add CRD resource itself as a searchable item */}}
    {{- $crdParam := dict
      "name" $kind
      "module" $moduleName
      "moduletype" "source"
      "url" (printf "/modules/%s/%s/crds/%s/" $moduleName $moduleChannel $crdName)
      "path" (printf "%s.%s.crds.%s" $moduleName $moduleChannel $crdName)
      "content" $description
      "resName" $kind
      "isResource" "true" }}

    {{- $searchParams = $searchParams | append $crdParam }}

    {{- /* Extract properties from the CRD schema */}}
    {{- if $versionSchema.properties }}
      {{- $nestedParams := partial "openapi/extract-configuration-search-params" (dict "data" $versionSchema "langData" $langVersionData.schema.openAPIV3Schema "moduleName" $moduleName "moduleChannel" $moduleChannel "ancestors" slice "resourceName" $kind) }}
      {{- $searchParams = $searchParams | append $nestedParams }}
    {{- end }}
  {{- end }}
{{- end }}

{{- return $searchParams }}
