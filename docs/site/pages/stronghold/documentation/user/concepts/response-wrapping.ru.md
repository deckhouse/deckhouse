---
title: "Обертывание ответа"
permalink: ru/stronghold/documentation/user/concepts/response-wrapping.html
lang: ru
description: Обертывание ответа в cubbyhole хранилище для безопасного распространения.
---

# Обертывание ответа

## Обзор

Во многих развертываниях Stronghold клиенты могут напрямую обращаться к Stronghold и использовать возвращаемые секреты. В некоторых ситуациях может быть целесообразнее разделить привилегии таким образом, чтобы одна доверенная организация отвечала за взаимодействие с большей частью API Stronghold и прямую передачу секретов конечному потребителю.

Однако чем больше ретрансляторов проходит секрет, тем выше вероятность случайного раскрытия, особенно если секрет передается в открытом виде. Но, например, если вам нужно доставить закрытый ключ TLS на машину, в котором по политике безопасности нельзя хранить ключ дешифрования в постоянном хранилище, то вы не можете зашифровать этот ключ при передаче.

Чтобы помочь решить эту проблему, Stronghold имеет функцию, называемую _обертывание ответа_(_response wrapping_). По запросу Stronghold берет ответ, который он отправил бы HTTP-клиенту, и вместо этого кладет его[ответ на запрос] в [`cubbyhole`](../secrets-engines/cubbyhole.html), доступ которому есть только у одноразового токена, после чего возвращает этот одноразовый токен HTTP-клиенту.

С логической точки зрения, **ответ** обернут токеном, и для его извлечения требуется операция распаковки этим токеном. С функциональной точки зрения, токен предоставляет авторизацию на использование ключа шифрования из ключницы Stronghold для расшифровки данных.

Этот метод обеспечивает надёжный механизм для обмена информацией во многих средах. В описанных выше сценариях зачастую существуют требования к обеспечению _прикрытия_ секретной информации, возможности _обнаружения злоупотреблений_ (перехват, либо подделка) и ограничению _срока действия_ раскрываемости(unwrap) секрета (Далее – распаковка/распаковываемость). Обертывание ответа удовлетворяет всем трем этим задачам:

- Обеспечивает _прикрытие_, гарантируя, что значение, передаваемое по сети,
  не является секретом, а является доступом к такому секрету, а именно токеном обернутого ответа. Информация, хранящаяся в журналах или захваченная по пути, не содержит прямой ссылки на конфиденциальную информацию.
- Обеспечивает _обнаружение злоупотреблений_, гарантируя, что только одна
  сторона может распаковать токен и увидеть его содержимое. Клиент, получивший токен, которым невозможно распаковать, может немедленно инициировать инцидент безопасности. Кроме того, запросом в Stronghold клиент может проверить данный токен перед распаковкой, чтобы убедиться, что его происхождение соответствует ожидаемому местоположению в Stronghold.
- Он _ограничивает срок_ распаковываемости секрета, поскольку токен,
  обертывающий ответ, имеет срок действия, отдельный от обернутого секрета (и часто может быть гораздо короче), поэтому, если клиент вовремя не распакует обернутый ответ, токен может просто истечь.

## Токены, обертывающие ответ

Когда ответ с секретом обертывается, ответ на API запрос к Stronghold не содержит
исходную секретную информацию, а лишь набор данных, связанных с
токеном обертывания ответа:

- TTL: время жизни самого токена обертывания ответа
- Токен: Значение токена
- Время создания: Время, когда был создан токен обертывания ответа
- Путь создания: Путь API, который был вызван в исходном запросе
- Идентификатор обернутого токена: Если вы решите обернуть ответ операции аутентификации, либо создания токена, то этот идентификатор будет указывать на обернутый токен (тот токен, который бы вернулся при аутентификации или создании токена в явном виде). Это полезно, например, для систем оркестрации (таких как Nomad), так как можно управлять сроком действия обернутого токена (выполнить отзыв, либо продление), основываясь на сроке действия задания, без необходимости рассекречивания обернутого токена.

В настоящее время Stronghold не позволяет подписывать токены обернутого ответа, поскольку это не
обеспечивает значительной дополнительной защиты. Если ваш конечный адрес сервера Stronghold правильный,
то проверка токена выполнится путем взаимодействия с самим сервером; подписанный же токен не уберет
необходимость сверки токена с сервером, поскольку токен не содержит сами засекреченные данные, а
является лишь механизмом доступа. И Stronghold не вернет засекреченные данные, без подтверждения
правильности токена. Даже если вы подверглись атаке и вас отправили на сервер Stronghold злоумышленника,
тот же самый злоумышленник может легко передать вам неправильный открытый ключ подписи, соответствующий
неправильному серверу Stronghold. В ответ вы могли бы кэшировать ранее действительный ключ, но тогда нужно
кэшировать и ранее действительный адрес (и в большинстве случаев адрес Stronghold не изменится или будет
установлен с помощью механизма обнаружения сервисов). В конечном итоге, мы полагаемся на то, что сам токен не несет чувствительные данные, и не подписываем его.

## Операции с токенами обертывания ответов

Через путь `sys/wrapping` можно выполнить следующие операций с токенами обертывания:

- **Поиск** (`sys/wrapping/lookup`)**:** позволяет получить время создания
  токена обертывания ответа, путь создания и время жизни. Этот путь не требует аутентификации и доступен для токенов обертывания ответа. Другими словами, держатель токена обертывания ответа, при желании всегда может запросить свойства токена по этому пути.
- **Распаковка** (`sys/wrapping/unwrap`)**:** Распаковывает токен, возвращая
  ответ, находящийся внутри. Возвращаемый ответ будет иметь исходный API формат ответа на запрос; его можно использовать напрямую с API клиентами.
- **Rewrap** (`sys/wrapping/rewrap`)**:** позволяет заново обернуть уже обернутые
  данные в новый токен, обертывающий ответ. Это полезно для секретных данных с длительным сроком жизни. Например, организация хочет (или обязана в случае требований безопасности), чтобы ключ корневого центра сертификации бэкэнда `pki` возвращался в долгоживущем токене обертывания ответа гарантируя, что никто не видел ключ (что легко проверить, выполнив поиск по токену обертывания ответа), но так же хочет иметь доступ к ключу для подписи CRL на случай, если они случайно изменят или потеряют `pki` монтирование. Часто требования безопасности обязывают выполнять периодическую ротацию секретов, поэтому эта операция помогает достичь эту цель, не подвергая сами данные раскрытию в процессе.
- **Wrap** (`sys/wrapping/wrap`)**:** вспомогательный путь, которая
  возвращает данные, отправленные ей в виде токена обертывания ответа. Обратите внимание, что блокировка доступа к этому пути не убирает возможность обертывания произвольных данных, так как это можно сделать через другие методы в Stronghold.

## Создание токена обертывания ответа

Обертывание ответа выполняется для каждого запроса отдельно и запускается путем
указания желаемого времени жизни токена обертывания ответа. Оно устанавливается
клиентом с помощью заголовка `X-Vault-Wrap-TTL` и может быть либо целым числом в
секундах, либо строкой, обозначающей продолжительность в секундах (`15s`),
минутах (`20m`) или часах (`25h`). При использовании Stronghold CLI вы можете
установить это значение с помощью параметра `-wrap-ttl`. При использовании Go API
обертывание запускается [установкой вспомогательной функции](https://godoc.org/github.com/hashicorp/vault/api#Client.SetWrappingLookupFunc), которая сообщает API условия, при которых следует запрашивать обертывание, путем сопоставления операции и пути с желаемым TTL.

Если клиент запрашивает обертывание:

1. Исходный HTTP-ответ сериализуется
2. Генерируется новый одноразовый токен с временем жизни, предоставленное клиентом
3. Исходный сериализованный ответ сохраняется в `cubbyhole` одноразового
   токена
4. Генерируется новый ответ с дополнительным полем, содержащим в себе информацию об обернутом ответе в виде: ID токена, время жизни и путь
5. Новый ответ возвращается клиенту

Обратите внимание, что политики могут контролировать минимальное и максимальное время жизни токенов обертывания; см. [страницу концепций политик](policy.html) для получения дополнительной информации.

## Проверка токена обертывания ответа

Нужно уметь правильно и своевременно проводить проверку токенов обертывания ответа, для обеспечения контроля и минимизации злоупотреблений.

Проверку лучше всего выполнять следующим образом:

1. Если клиент ожидал получение токена обертывания ответа, но он не поступил,
  это может быть связано с тем, что злоумышленник перехватил токен и помешал его дальнейшей передаче. Нужно вызвать тревогу и немедленное расследование инцидента.
2. Выполните поиск токена обертывания ответа. Это сразу покажет вам, был ли
  токен уже распакован или его срок действия истек (или был отозван). Если поиск показывает, что токен недействителен, это не обязательно означает, что данные были перехвачены: например, возможно, клиент долго запускался и срок жизни токена истек. Но необходимо так же вызвать тревогу для немедленного расследования, и, с помощью журнала аудита Stronghold, проверить, действительно ли токен был распакован.
3. Имея информацию о токене, проверьте, соответствует ли путь создания
  ожидаемому. Если вы ожидали после распаковки получить ключ/сертификат TLS, скорее всего, путь должен быть примерно таким: `pki/issue/...`. Если путь не соответствует ожиданиям, возможно, содержащиеся внутри данные были прочитаны, а затем помещены в новый токен обертывания ответа. (Это наиболее вероятно, когда путь начинается с `cubbyhole` или `sys/wrapping/wrap`.) Особое внимание следует уделять механизму секретов `kv`: тут лучше всего подходят точные совпадения значения пути. Например, если вы ожидаете, что секрет будет поступать из `secret/foo`, а злоумышленник передает токен с путем `secret/bar`, простой проверки префикса `secret/` будет недостаточно.
4. После проверки префикса распакуйте токен. Если распаковка не удалась,
  действием будет аналогичное случаю, когда первоначальный поиск не удался: бьем тревогу для немедленного расследования инцидента.

Выполнение этих простых шагов даст максимальную уверенность в том, что данные, содержащиеся
в токене, обертывающем ответ, никто кроме целевого клиента никогда не видел. И что перехват или подмена данных успешно привели к предупреждению об угрозе безопасности.
