---
title: Обновление
permalink: ru/guides/production.html
lang: ru
---

<!-- ## Доступ -->

## Обновление

Deckhouse Kubernetes Platform предоставляет возможноси управления запуском обновлений: от автоматического запуска при поступлении обновления в канал (early-access, stable, lts), включая такие инструменты как ""окна обновлений"", до полностью контролируемого режима, где обновления утверждаются вручную. Сам процесс обновления осуществляется полностью автоматически, включая как инфраструктурные компоненты и ПО на узлах, так и всю высокоуровневую функциональность (платформа Kubernetes, аутентификация, мониторинг, журналирование, управление сертификатами, балансировка трафика, безопасность, виртуализация и др.). Deckhouse обеспечивает стабильность работы платформы и приложений при обновлениях, при условии соблюдения последними рекомендаций отказаустойчевости: наличие более чем одной реплики и указания максимального количества недоступных реплик (PDB). Для обеспечения обратной совместимости Deckhouse применяет трёхкомпонентный подход: сохранение обратной совместимости между версиями, правила устаревания (deprecation policy) и автоматическую блокировку запуска обновлений при возникновении проблем. Всегда поддерживается не менее 4 версий Kubernetes. Платформа поддерживает обновления в изолированных средах и при помощи твердых носителей. Все эти возможности гарантируют предсказуемость обновления, обеспечивая баланс между свежестью и стабильностью.

### Быстростарт

#### Гарантия совместимости при обновлении

TODO: Платформа гарантирует совместимость при обновлениях — все старые версии API платформы продолжают оставаться рабочими продолжительное время (обычно не мене 1 года с момента deprecation). Кроме этого, платформа поддерживает не менее 4-х версий Kubernetes и предоставляет администраторам возможности для проверки совместимости приложений запущенных в Kubernetes до обновления самого kubernetes (по данным helm релизов).

#### Единые обновления и "фундамента" и "узлов" и "решений"

TODO: Платформа обновляется целиком — включая как весь инфраструктурно-агностический фундамент (в том числе программное обеспечение на узлах), так и все высокоуровневые решения.

Как обновить версию Kubernetes в кластере?

Чтобы обновить версию Kubernetes в кластере, измените параметр [kubernetesVersion](installing/configuration.html#clusterconfiguration-kubernetesversion) в структуре [ClusterConfiguration](installing/configuration.html#clusterconfiguration) выполнив следующие шаги:
1. Выполните команду:
   ```shell
   kubectl -n d8-system exec -ti deploy/deckhouse -- deckhouse-controller edit cluster-configuration
   ```
1. Измените параметр `kubernetesVersion`.
1. Сохраните изменения. Узлы кластера начнут последовательно обновляться.
1. Дождитесь окончания обновления.  Отслеживать ход обновления можно с помощью команды `kubectl get no`. Обновление можно считать завершенным, когда в выводе команды у каждого узла кластера в колонке `VERSION` появится обновленная версия.

#### Полностью автоматический процесс обновления (и четкий контракт с разработчиками)

TODO: Сам процесс обновления выполняется полностью автоматически (пользователю достаточно разрешить обновление) и полностью онлайн: большинство обновлений вообще не трогают приложения (даже обновление ПО на узлах происходит без прерывания работы приложений), но те которые требуют — делают это корректно, акуратно “сливая” (drain) узлы и дожидаясь запуска приложений на других узлах. Разработчикам легко обеспечить следование простому контракту (N+1 реплик и настроенный соответствующим образом PodDisruptionsBudget), чтобы любые обновления проходили без простоя.

### Каналы и окна обновлений

#### Каналы обновлений

Существует несколько каналов обновления для кластера. К кластерам, как элементам инфраструктуры, обычно предъявляются различные требования.

Например, production-кластер, в отличие от кластера разработки, более требователен к надежности: в нем нежелательно часто обновлять или изменять какие-либо компоненты без особой необходимости, при этом сами компоненты должны быть тщательно протестированы.
По возможности используйте разные каналы обновлений для кластеров. Для кластера разработки используйте менее стабильный канал обновлений, нежели для тестового или stage-кластера (pre-production-кластер).

Мы рекомендуем использовать канал обновлений `Early Access` или `Stable` для production-кластеров. Если в production-окружении более одного кластера, предпочтительно использовать для них разные каналы обновлений. Например, `Early Access` для одного, а `Stable` — для другого. Если использовать разные каналы обновлений по каким-либо причинам невозможно, рекомендуется устанавливать разные окна обновлений.

Deckhouse Kubernetes Platform использует пять каналов обновлений. Между ними можно переключаться с помощью модуля *deckhouse*: достаточно указать желаемый канал обновлений в конфигурации модуля:

1. **Rock Solid**. Наиболее стабильный канал обновлений. Подойдет для кластеров, которым необходимо обеспечить повышенный уровень стабильности. Обновления функционала до этого канала доходят не ранее чем через месяц после их появления в релизе.
2. **Stable**. Стабильный канал обновлений для кластеров, в которых закончена активная работа и преимущественно осуществляется эксплуатация. Обновления функционала до этого канала обновлений доходят не ранее чем через две недели после их появления в релизе.
3. **Early Access**. Рекомендуемый канал обновлений, если вы не уверены в выборе. Подойдет для кластеров, в которых идет активная работа (запускаются, дорабатываются новые приложения и т. п.). Обновления функционала до этого канала обновлений доходят не ранее чем через одну неделю после их появления в релизе.
4. **Beta**. Ориентирован на кластеры разработки, как и канал обновлений Alpha. Получает версии, предварительно опробованные на канале обновлений Alpha.
5. **Alpha**. Наименее стабильный канал обновлений с наиболее частым появлением новых версий. Ориентирован на кластеры разработки с небольшим количеством разработчиков.

{% alert %}
Используйте канал обновлений `Early Access` или `Stable`. Установите [окно автоматических обновлений](/documentation/v1/modules/002-deckhouse/usage.html#конфигурация-окон-обновлений) или [ручной режим](/documentation/v1/modules/002-deckhouse/usage.html#ручное-подтверждение-обновлений).
{% endalert %}

Выберите необходимый канал обновлений и [режим обновлений](/documentation/v1/modules/002-deckhouse/configuration.html#parameters-releasechannel -дать ссылку на раздел этой доки), который соответствует вашим ожиданиям. Чем стабильнее канал обновлений, тем позже до него доходит новая функциональность.

{% alert level="warning" %}
Даже в очень нагруженных и критичных кластерах не стоит отключать использование канала обновлений. Лучшая стратегия — плановое обновление. В инсталляциях Deckhouse, которые не обновлялись полгода или более, могут присутствовать ошибки. Как правило, эти ошибки давно устранены в новых версиях. В этом случае оперативно решить возникшую проблему будет непросто.
{% endalert %}

#### Выбор окон для обновлений

Управление [окнами обновлений](/documentation/v1/modules/002-deckhouse/configuration.html#parameters-update-windows) позволяет планово обновлять релизы Deckhouse в автоматическом режиме в периоды «затишья», когда нагрузка на кластер далека от пиковой.

  В Deckhouse реализован механизм автоматического обновления. Этот механизм использует [5 каналов обновлений](../../deckhouse-release-channels.html), различающиеся стабильностью и частотой выхода версий. Ознакомьтесь подробнее с тем, [как работает механизм автоматического обновления](../../deckhouse-faq.html#как-работает-автоматическое-обновление-deckhouse) и [как установить желаемый канал обновлений](../../deckhouse-faq.html#как-установить-желаемый-канал-обновлений).
- **[Режим обновлений](configuration.html#parameters-update-mode)** и **[окна обновлений](configuration.html#parameters-update-windows)**

##### Конфигурация окон обновлений

Настроить время, когда Deckhouse будет устанавливать обновления, можно в параметре [update.windows](configuration.html#parameters-update-windows) конфигурации модуля.

Пример настройки двух ежедневных окон обновлений: с 8:00 до 10:00 и c 20:00 до 22:00 (UTC):

```yaml
apiVersion: deckhouse.io/v1alpha1
kind: ModuleConfig
metadata:
  name: deckhouse
spec:
  version: 1
  settings:
    releaseChannel: EarlyAccess
    update:
      windows: 
        - from: "8:00"
          to: "10:00"
        - from: "20:00"
          to: "22:00"
```

Также можно настроить обновления в определенные дни, например по вторникам и субботам с 18:00 до 19:30 (UTC):

```yaml
apiVersion: deckhouse.io/v1alpha1
kind: ModuleConfig
metadata:
  name: deckhouse
spec:
  version: 1
  settings:
    releaseChannel: Stable
    update:
      windows: 
        - from: "18:00"
          to: "19:30"
          days:
            - Tue
            - Sat
```
### Закрытый контур

#### Обновление в закрытом контуре

Deckhouse Kubernetes Platform отвечает за то, чтобы кластер одинаково работал на любой поддерживаемой инфраструктуре:

* в облаках (смотри информацию по соответствующему cloud провайдеру - добавить ссылку);
* на виртуальных машинах или железе (включая on-premises);
* в гибридной инфраструктуре.

Образы всех компонентов Deckhouse Kubernetes Platform, включая control plane, хранятся в высокодоступном и геораспределенном container registry. Для организации доступа из изолированных контуров container registry доступен с фиксированного набора IP-адресов.

При установке Deckhouse можно настроить на работу со сторонним registry (например, проксирующий registry внутри закрытого контура).

Установите следующие параметры в ресурсе `InitConfiguration`:

* `imagesRepo: <PROXY_REGISTRY>/<DECKHOUSE_REPO_PATH>/ee` — адрес образа Deckhouse EE в стороннем registry. Пример: `imagesRepo: registry.deckhouse.ru/deckhouse/ee`;
* `registryDockerCfg: <BASE64>` — права доступа к стороннему registry, зашифрованные в Base64.

Если разрешен анонимный доступ к образам Deckhouse в стороннем registry, `registryDockerCfg` должен выглядеть следующим образом:

```json
{"auths": { "<PROXY_REGISTRY>": {}}}
```

Приведенное значение должно быть закодировано в Base64.

Если для доступа к образам Deckhouse в стороннем registry необходима аутентификация, `registryDockerCfg` должен выглядеть следующим образом:

```json
{"auths": { "<PROXY_REGISTRY>": {"username":"<PROXY_USERNAME>","password":"<PROXY_PASSWORD>","auth":"<AUTH_BASE64>"}}}
```

где:

* `<PROXY_USERNAME>` — имя пользователя для аутентификации на `<PROXY_REGISTRY>`;
* `<PROXY_PASSWORD>` — пароль пользователя для аутентификации на `<PROXY_REGISTRY>`;
* `<PROXY_REGISTRY>` — адрес стороннего registry в виде `<HOSTNAME>[:PORT]`;
* `<AUTH_BASE64>` — строка вида `<PROXY_USERNAME>:<PROXY_PASSWORD>`, закодированная в Base64.

Итоговое значение для `registryDockerCfg` должно быть также закодировано в Base64.

Для настройки нестандартных конфигураций сторонних registry в ресурсе `InitConfiguration` предусмотрены еще два параметра:

* `registryCA` — корневой сертификат, которым можно проверить сертификат registry (если registry использует самоподписанные сертификаты);
* `registryScheme` — протокол доступа к registry (`HTTP` или `HTTPS`). По умолчанию — `HTTPS`.

<div markdown="0" style="height: 0;" id="особенности-настройки-сторонних-registry"></div>

#### Предоставление LTS обновлений на твёрдых носителях

При невозможности выдачи ограниченного доступа в закрытый контур для настройки проксирующего registry.

Долгосрочная поддержка (LTS) — это период времени, в течение которого поставщик программного обеспечения предоставляет регулярные обновления безопасности и функциональности для операционной системы или приложения. Предоставление LTS обновлений на твёрдых носителях обычно означает физическую доставку обновлений на CD, DVD или USB-накопителе.
Преимущества получения LTS обновлений на твёрдых носителях включают следующее:
* Безопасность: Получение обновлений на физических носителях позволяет убедиться, что они не были изменены или повреждены при передаче через интернет.
* Доступность: В некоторых регионах или организациях может отсутствовать стабильное интернет-соединение, поэтому получение обновлений на твёрдых носителях является единственным способом получить последние версии ПО.
* Контроль: Физическое владение обновлением даёт возможность контролировать процесс его установки и тестирования перед внедрением в производственную среду.
* Поддержка: Некоторые поставщики программного обеспечения предлагают дополнительную поддержку клиентам, которые получают LTS обновления на твёрдых носителях.
При невозможности выдачи ограниченного доступа в закрытый контур для настройки проксирующего registry.	

### Отправка уведомлений об обновлениях

Возможность гибко настроить уведомления о доступности обновлений на соответствующем канале, а также уведомления о запланированных и примененных обновлениях.

### Одобрение обновлений

#### Автоматические обновления

Получение минорных и патч обновлений всех компонентов, включая Deckhouse, Kubernetes и все модули.

#### Ручное одобрение обновлений

Возможность проверять каждое обновление и вручную помечать новые версии как разрешенные.

### Поддержка более 2-ух последних версий Kubernetes

{% alert %}
Используйте автоматический [выбор версии Kubernetes](/documentation/v1/installing/configuration.html#clusterconfiguration-kubernetesversion) либо установите версию явно.
{% endalert %}

В большинстве случаев предпочтительно использовать автоматический выбор версии Kubernetes. В Deckhouse такое поведение установлено по умолчанию, но его можно изменить с помощью параметра [kubernetesVersion](/documentation/v1/installing/configuration.html#clusterconfiguration-kubernetesversion). Обновление версии Kubernetes в кластере не оказывает влияния на приложения и проходит [последовательно и безопасно](/documentation/v1/modules/040-control-plane-manager/#управление-версиями).

Если указан автоматический выбор версии Kubernetes, Deckhouse может обновить версию Kubernetes в кластере при обновлении релиза Deckhouse (при обновлении минорной версии). Когда версия Kubernetes явно прописана в параметре [kubernetesVersion](/documentation/v1/installing/configuration.html#clusterconfiguration-kubernetesversion), очередное обновление Deckhouse может завершиться неудачей, если окажется, что используемая в кластере версия Kubernetes более не поддерживается.

Если приложение использует устаревшие версии ресурсов или требует конкретной версии Kubernetes по какой-либо другой причине, проверьте, что эта версия [поддерживается](/documentation/v1/supported_versions.html), и [установите ее явно](/documentation/v1/deckhouse-faq.html#как-обновить-версию-kubernetes-в-кластере). 

#### Поддержка LTS (CE)

В базовых редакциях поддерживается только две последних версии Kubernetes, в более продвинутых поддерживается 4 последние вышедшие версии Kubernetes.

#### Поддержка LTS (EE)

Возможность использования LTS версии: выпускается два раза в год, поддерживаются последние четыре версии Deckhouse, и все версии Kuberenetes, вышедшие в последние 3 года.

Информацию о всех версиях Deckhouse можно найти в [списке релизов](https://github.com/deckhouse/deckhouse/releases) Deckhouse.
Сводную информацию о важных изменениях, об обновлении версий компонентов, а также о том, какие компоненты в кластере буду перезапущены в процессе обновления, можно найти в описании нулевой patch-версии релиза. Например, [v1.46.0](https://github.com/deckhouse/deckhouse/releases/tag/v1.46.0) для релиза v1.46 Deckhouse.
Подробный список изменений можно найти в Changelog, ссылка на который есть в каждом [релизе](https://github.com/deckhouse/deckhouse/releases).

### История применения релизов в кластере

Просмотр списка последних релизов в кластере со статусами.

<!-- Приведенные ниже рекомендации могут быть неактуальны для тестового кластера или кластера разработки, но важны для production-кластера.

Канал и режим обновлений

{% alert %}
Используйте канал обновлений `Early Access` или `Stable`. Установите [окно автоматических обновлений](/documentation/v1/modules/002-deckhouse/usage.html#конфигурация-окон-обновлений) или [ручной режим](/documentation/v1/modules/002-deckhouse/usage.html#ручное-подтверждение-обновлений).
{% endalert %}

Выберите [канал обновлений]( /documentation/v1/deckhouse-release-channels.html) и [режим обновлений](/documentation/v1/modules/002-deckhouse/configuration.html#parameters-releasechannel), который соответствует вашим ожиданиям. Чем стабильнее канал обновлений, тем позже до него доходит новая функциональность.

По возможности используйте разные каналы обновлений для кластеров. Для кластера разработки используйте менее стабильный канал обновлений, нежели для тестового или stage-кластера (pre-production-кластер).

Мы рекомендуем использовать канал обновлений `Early Access` или `Stable` для production-кластеров. Если в production-окружении более одного кластера, предпочтительно использовать для них разные каналы обновлений. Например, `Early Access` для одного, а `Stable` — для другого. Если использовать разные каналы обновлений по каким-либо причинам невозможно, рекомендуется устанавливать разные окна обновлений.

{% alert level="warning" %}
Даже в очень нагруженных и критичных кластерах не стоит отключать использование канала обновлений. Лучшая стратегия — плановое обновление. В инсталляциях Deckhouse, которые не обновлялись полгода или более, могут присутствовать ошибки. Как правило, эти ошибки давно устранены в новых версиях. В этом случае оперативно решить возникшую проблему будет непросто.
{% endalert %}

Управление [окнами обновлений](/documentation/v1/modules/002-deckhouse/configuration.html#parameters-update-windows) позволяет планово обновлять релизы Deckhouse в автоматическом режиме в периоды «затишья», когда нагрузка на кластер далека от пиковой. -->
