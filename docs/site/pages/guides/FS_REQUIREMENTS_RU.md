---
title: Разметка и объем дисков
permalink: ru/guides/fs-requirements.html
description: Руководство по выбору объема дисков и разметке файловой системы перед установкой Deckhouse Kubernetes Platform
lang: ru
layout: sidebar-guides
---

В [гайде по выбору минимально требуемого дискового пространства](hardware-requirements.html#выбор-ресурсов-для-узлов) для различных типов узлов Deckhouse Kubernetes Platform (DKP) указаны объемы дисков, которые необходимо выделить для успешной установки и работы DKP. Но также следует уделить внимание и правильной конфигурации файловой системы, чтобы место на диске внезапно не «закончилось» несмотря на правильно выбранный объем на стадии установки.

{% alert level="info" %}
Проблемы могут возникнуть не по вине администратора, а в силу особенностей работы установщика выбранного дистрибутива Linux. Например, Astra Linux при установке может выделить 15 Гб под корень файловой системы (`/`), 15 Гб под домашний каталог пользователя (`/home`), а остальное оставить неразмеченным, несмотря на подключённый диск общим объемом в 60 Гб, рекомендуемых в гайде. При такой конффигурации установка DKP не произойдёт с ошибкой об отсутствии необходимого дискового пространства.
{% endalert %}

Чтобы избежать проблем в будущем перед установкой лучше убедиться, что разделы файловой системы выделенного для машины диска соответствуют требованиям DKP по объему.

## Где и что хранит DKP?

DKP хранит различные типа данных в определённых каталогах файловой системы. Рассмотрим основные из них подробнее:

* `/etc/kubernetes/`, `/etc/containerd` и т.д. — каталоги с конфигурацией компонентов Kubernetes;
* `/var/lib/containerd` – слои образов компонентов DKP и протчих контейнеров, запущенных на узле. Чем больше компонентов DKP устанавливается на узел или запускается на нём контейнеров пользовательской нагрузки, тем больше свободного пространства в этом каталоге будет затребовано.
* `/var/lib/kubelet` – в этом каталоге хранится два типа информации:
  * данные о запущенных в кластере подах;
  * данные `ephemeral-storage` — например, если на master-узле запрашивается 7 Гб под `ephemeral-storage`, и в этом каталоге места будет недостаточно, поды не будут запланированы на этот узел.
* `/var/lib/etcd` – база данных etcd, в которой хранится необходимая для работы кластера Kubernetes информация;
* `/var/lib/deckhouse/downloaded/` — хранилище конфигураций релизов модулей Deckhouse DKP ([ModuleRelease](../documentation/v1/reference/api/cr.html#modulerelease));
* `/var/lib/deckhouse/stronghold/` – хранилище данных [Stronghold](../../stronghold/) (если включён соответствующий модуль);
* `/var/log/pods/` – хранилище логов подов;
* `/opt/deckhouse/` — служебные компоненты DKP, такие как kubelet, containerd, статические утилиты (например, lsblk) и т.д.;
* `/opt/local-path-provisioner/` – каталог для хранения данных при использовании [локального хранилища Local Path Provisioner](../documentation/v1/admin/configuration/storage/sds/local-path-provisioner.html) (может быть переопредён [в конфигурации](../documentation/v1/admin/configuration/storage/sds/local-path-provisioner.html#примеры-ресурсов-localpathprovisioner)).

## Рекомендуемые объемы дискового пространства для соответствющих каталогов

В разделах ниже приведены объемы диска, занимаемые различными компонентами кластера.

{% alert level="info" %}
Суммарный объем пространства, указанный в таблицах, может превышать минимальный рекомендуемый объем диска для узла кластера, указанный в «Быстром старте» или [«Требованиях к кластеру на bare metal»](./hardware-requirements.html). Так получается из-за того, что в таблице указаны максимальные требуемые значения для компонентов, а в минимальных требованиях к узлу указано усреднённое значение.
{% endalert %}

### На master-узле

В таблице ниже представлены рекомендуемые объемы пространства для каталогов, используемых DKP на master-узлах кластера.

| Каталог                   | Объем диска |
|---------------------------|-------------|
| `/etc/cni`                | 1 GB        |
| `/etc/containerd`         | 1 GB        |
| `/etc/kubernetes`         | 1 GB        |
| `/mnt/vector-data`        | 1 GB        |
| `/opt/cni/bin`            | 1 GB        |
| `/opt/deckhouse/bin`      | 1 GB        |
| `/root/.kube`             | 1 GB        |
| `/run/containerd`         | 1 GB        |
| `/tmp`                    | 1 GB        |
| `/var/lib/bashible`       | 1 GB        |
| `/var/lib/cni`            | 1 GB        |
| `/var/lib/containerd`     | 30 GB       |
| `/var/lib/deckhouse`      | 5 GB        |
| `/var/lib/etcd`           | 10 GB       |
| `/var/lib/kubelet`        | 10 GB       |
| `/var/lib/upmeter`        | 2 GB        |
| `/var/log/containers`     | 1 GB        |
| `/var/log/kube-audit`     | 2 GB        |
| `/var/log/pods`           | 2 GB        |

### На worker-узлах

В таблице ниже представлены рекомендуемые объемы пространства для каталогов, используемых DKP на worker-узлах кластера.

| Каталог                           | Объем диска |
|-----------------------------------|-------------|
| `/etc/cni`                        | 1 GB        |
| `/etc/containerd`                 | 1 GB        |
| `/etc/kubernetes`                 | 1 GB        |
| `/mnt/vector-data`                | 1 GB        |
| `/opt/cni/bin`                    | 1 GB        |
| `/opt/deckhouse/bin`              | 1 GB        |
| `/opt/local-path-provisioner`     | 100 GB*     |
| `/run/containerd`                 | 1 GB        |
| `/tmp`                            | 1 GB        |
| `/var/lib/bashible`               | 1 GB        |
| `/var/lib/cni`                    | 1 GB        |
| `/var/lib/containerd`             | 30 GB       |
| `/var/lib/kubelet`                | 10 GB       |
| `/var/log/containers`             | 1 GB        |
| `/var/log/pods`                   | 2 GB        |

{% alert level="info" %}
\* Зависит от настроек хранилища, заданных пользователем.
{% endalert %}

### Как расчитать объем для хранилища логов подов?

Логи подов хранятся в каталоге `/var/log/pods/`. Объем, занимаемый логами, зависит от количества контейнеров и настроек DKP. В среднем на master-узле при использовании [набора модулей Default](../documentation/v1/admin/configuration/#наборы-модулей) работает около 90 контейнеров, на логи каждого из которых по умолчанию выделяется около 50 Мб места. То есть в каталоге `/var/log/pods/` должно быть доступно как минмум `90 * 50 Мб = 4,5 Гб` места.

Параметры храненения логов также могут быть переопределены в параметре `containerLogMaxSize` [группы узлов](../documentation/v1/admin/configuration/platform-scaling/node/node-customization.html):

```yaml
containerLogMaxSize: 50Mi
containerLogMaxFiles: 4
```

### Требование к системным узлам

Системные узлы (system-узел), это узлы, предназначенные для запуска компонентов DKP. При добавлении в кластер таких узлов нужно понимать, что на них будет запускаться нагрузка, связанная с мониторингом кластера, и включающая в себя [Prometheus](../../../modules/prometheus/), [loki](../../../modules/loki/), [upmeter](../../../modules/upmeter/) и т.д. В случае локального хранения данных мониторинга на узлах для таких узлов нужно выделять дополнительно >=100ГБ свободного места.

{% alert level="info" %}
В случае использования конфигурации кластера без выделенных системных узлов, указанная выше нагрузка будет рапсределяться по другим узлам, и нужно учесть рекомендуемый объем дискового хранилища при выборе их конфигурации.
{% endalert %}

### Хранилище баз уязвимостей Trivy

DKP имеет встроенную [систему сканирования образов на уязвимости](../documentation/v1/admin/configuration/security/scanning.html) на базе [Trivy](https://github.com/aquasecurity/trivy), которая сканирует все контейнерные образы, используемые в подах кластера. Для сканирования используются как публичные базы уязвимостей, так и обогащённые данные из Astra Linux, ALT Linux и РЕД ОС. Суммарный объем занимаемого базами дискового пространства составляет 5 ГБ, поэтому его необходимо учитывать при выборе конфигурации разделов диска.

Базы данных хранятся на системных узлах кластера, а в случае, если такие узлы в кластере отсутствуют, базы будут расположены на worker-узле.

## Если настроены лимиты по ресурсам

Если для сущностей кластера настроены лимиты ресурсов в части дискового пространства, то необходимое свободное дисковое пространство на узле должно быть в любом случае доступно, иначе произойдёт вытеснение нагрузки с этих узла.

## Локальное хранилище на основе LVM

В кластере под управлением DKP есть возможность настроить [локальное хранилище на узлах](../documentation/v1/admin/configuration/storage/sds/lvm-local.html), использующее LVM. Для этого на узле должны быть доступны свободные блочные устройства (разделы диска), которые будут использованы модулем [sds-local-volume](../../../modules/sds-local-volume/) при создании StorageClass для последующего использования. Объем доступного свободного пространства на блочном устройстве должен быть таким же, какой необходимо подключить в виде SC.
