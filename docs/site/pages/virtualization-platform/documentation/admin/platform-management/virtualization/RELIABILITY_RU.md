---
title: "Механизмы обеспечения надежности"
permalink: ru/virtualization-platform/documentation/admin/platform-management/virtualization/reliability.html
lang: ru
---

## Миграция / Режим обслуживания

Миграция виртуальных машин является важной функцией в управлении виртуализованной инфраструктурой. Она позволяет перемещать работающие виртуальные машины с одного физического узла на другой без их отключения. Миграция виртуальных машин необходима для ряда задач и сценариев:

- Балансировка нагрузки: Перемещение виртуальных машин между узлами позволяет равномерно распределять нагрузку на серверы, обеспечивая использование ресурсов наилучшим образом.
- Перевод узла в режим обслуживания: Виртуальные машины могут быть перемещены с узлов, которые нужно вывести из эксплуатации для выполнения планового обслуживания или обновления программного обеспечения.
- Обновление "прошивки" виртуальных машин: Миграция позволяет обновить "прошивку" виртуальных машин не прерывая их работу.

### Запуск миграции произвольной машины

Далее будет рассмотрен пример миграции выбранной виртуальной машины:

Перед запуском миграции посмотрите текущий статус виртуальной машины:

```bash
d8 k get vm
# NAME                                   PHASE     NODE           IPADDRESS     AGE
# linux-vm                              Running   virtlab-pt-1   10.66.10.14   79m
```

Мы видим что на данный момент она запущена на узле `virtlab-pt-1`.

Для осуществления миграции виртуальной машины с одного узла на другой, с учетом требований к размещению виртуальной машины используется ресурс [VirtualMachineOperations](../../../../reference/cr.html#virtualmachineoperations) (`vmop`) с типом `Evict`.

```yaml
d8 k apply -f - <<EOF
apiVersion: virtualization.deckhouse.io/v1alpha2
kind: VirtualMachineOperation
metadata:
  name: migrate-linux-vm-$(date +%s)
spec:
  # имя виртуальной машины
  virtualMachineName: linux-vm
  # операция для миграции
  type: Evict
EOF
```

Сразу после создания ресурса `vmop`, выполните команду:

```bash
d8 k get vm -w
# NAME                                   PHASE       NODE           IPADDRESS     AGE
# linux-vm                              Running     virtlab-pt-1   10.66.10.14   79m
# linux-vm                              Migrating   virtlab-pt-1   10.66.10.14   79m
# linux-vm                              Migrating   virtlab-pt-1   10.66.10.14   79m
# linux-vm                              Running     virtlab-pt-2   10.66.10.14   79m
```

### Режим обслуживания

При выполнении работ на узлах с запущенными виртуальными машинами существует риск нарушения их работоспособности. Чтобы этого избежать, узел можно перевести в режим обслуживания и мигрировать виртуальные машины на другие свободные узлы.

Для этого необходимо выполнить следующую команду:

```bash
d8 k drain <nodename> --ignore-daemonsets --delete-emptydir-data
```

где `<nodename>` - узел, на котором предполагается выполнить работы и который должен быть освобожден от всех ресурсов (в том числе и от системных).

Если есть необходимость вытеснить с узла только виртуальные машины, выполните следующую команду:

```bash
d8 k drain <nodename> --pod-selector vm.kubevirt.internal.virtualization.deckhouse.io/name --delete-emptydir-data
```

После выполнения конмад `d8 k drain` - узле перейдет в режим обслуживания и виртуальные машины на нем запускаться не смогут. Чтобы вывести его из режима обслуживания выполните следующую команду:

```bash
d8 k uncordon <nodename>
```

![](/images/virtualization-platform/drain.ru.png)

### Восстановление после сбоя

Fencing обеспечивает механизм восстановления работы виртуальной машины после сбоя на узле, на котором она была запущена.

Для работы данного механизма необходимо выполнить следующие требования:

- Политика запуска виртуальной машины (`.spec.runPolicy`) должна быть одна из: `AlwaysOnUnlessStoppedManually`, `AlwaysOn`.
- На узлах, где запущены виртуальные машины, должен быть включен механизм [fencing](../../../../reference/cr.html#nodegroup-v1-spec-fencing-mode).

Рассмотрим как это работает на примере:

- Кластер состоит из трех узлов: `master`, `workerA` и `workerB`. На worker-узлах включен механизм Fencing.
- Виртуальная машина `linux-vm` запущена на узле workerA.
- На узле с именем `workerA` возникает проблема (выключилось питание, пропала сеть, итд)
- Контроллер проверяет доступность узлов и обнаруживает, что `workerA` недоступен.
- Контроллер удаляет узел `workerA` из кластера.
- Виртуальная машина `linux-vm` запускается на другом подходящем узле (`workerB`).

![](/images/virtualization-platform/coldstandby.ru.png)
