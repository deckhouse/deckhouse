---
title: "NFS data storage"
permalink: en/virtualization-platform/documentation/admin/platform-management/storage/external/nfs.html
---

Deckhouse Virtualization Platform (DVP) supports Network File System (NFS), enabling the connection and management of network file storage in Kubernetes. This helps organize centralized data storage and shared file usage between containers.

This page provides instructions for connecting NFS storage in DVP, configuring the connection, creating a StorageClass, and verifying system operability.

## Enabling the module

The `csi-nfs` module manages volumes based on the NFS protocol and supports StorageClass creation through custom [NFSStorageClass](/products/kubernetes-platform/documentation/v1/modules/csi-nfs/cr.html#nfsstorageclass) resources. To enable the module, execute the command:

```shell
d8 k apply -f - <<EOF
apiVersion: deckhouse.io/v1alpha1
kind: ModuleConfig
metadata:
  name: csi-nfs
spec:
  enabled: true
  version: 1
EOF
```

Wait until the `csi-nfs` module transitions to the `Ready` status. To check the status, run the following command:

```shell
d8 k get module csi-nfs -w
```

In the output, you should see information about the `csi-nfs` module:

```console
NAME      STAGE   SOURCE    PHASE       ENABLED    READY
csi-nfs           Embedded  Available   True       True
```

## Creating a StorageClass

To create a StorageClass, use the [NFSStorageClass](/products/kubernetes-platform/documentation/v1/modules/csi-nfs/cr.html#nfsstorageclass) resource. Creating a StorageClass manually without using [NFSStorageClass](/products/kubernetes-platform/documentation/v1/modules/csi-nfs/cr.html#nfsstorageclass) can lead to errors.

The NFS server address and mount point path must be explicitly specified. You must also specify the NFS server version (for example, `"4.1"`).

Example command to create an NFS-based StorageClass:

```shell
d8 k apply -f - <<EOF
apiVersion: storage.deckhouse.io/v1alpha1
kind: NFSStorageClass
metadata:
  name: nfs-storage-class
spec:
  connection:
    host: 10.223.187.3
    share: /
    nfsVersion: "4.1"
  reclaimPolicy: Delete
  volumeBindingMode: WaitForFirstConsumer
EOF
```

Check that the created [NFSStorageClass](/products/kubernetes-platform/documentation/v1/modules/csi-nfs/cr.html#nfsstorageclass) resource has transitioned to the `Created` phase by running the following command:

```shell
d8 k get NFSStorageClass nfs-storage-class -w
```

In the output, you should see information about the created [NFSStorageClass](/products/kubernetes-platform/documentation/v1/modules/csi-nfs/cr.html#nfsstorageclass) resource:

```console
NAME                PHASE     AGE
nfs-storage-class   Created   1h
```

Check that the corresponding StorageClass has been generated by running the following command:

```shell
d8 k get sc nfs-storage-class
```

In the output, you should see information about the generated StorageClass:

```console
NAME                PROVISIONER      RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
nfs-storage-class   nfs.csi.k8s.io   Delete          WaitForFirstConsumer   true                   1h
```

If the StorageClass named `nfs-storage-class` appears, it means the `csi-nfs` module has been configured successfully. Users can now create PersistentVolumes by specifying the `nfs-storage-class` StorageClass. For each PersistentVolume resource, a directory `<share-directory>/<PersistentVolume-name>` will be created.

## Module health check

To verify the health of the module, ensure that all pods in the `d8-csi-nfs` namespace are in the `Running` or `Completed` state and are running on every node in the cluster:

```shell
d8 k -n d8-csi-nfs get pod -owide -w
```

As a result, the list of all pods in the `d8-csi-nfs` namespace will be displayed:

```console
NAME                             READY   STATUS    RESTARTS   AGE   IP             NODE       NOMINATED NODE   READINESS GATES
controller-547979bdc7-5frcl      1/1     Running   0          1h    10.111.2.84    master     <none>           <none>
csi-controller-5c6bd5c85-wzwmk   6/6     Running   0          1h    172.18.18.50   master     <none>           <none>
webhooks-7b5bf9dbdb-m5wxb        1/1     Running   0          1h    10.111.0.16    master     <none>           <none>
csi-nfs-8mpcd                    2/2     Running   0          1h    172.18.18.50   master     <none>           <none>
csi-nfs-n6sks                    2/2     Running   0          1h    172.18.18.51   worker-1   <none>           <none>
```

## Changing NFS server parameters for existing PVs

It is not possible to change NFS server connection parameters for already created PersistentVolumes. These parameters are stored directly in the PV manifest and cannot be modified. Changing the StorageClass will not update connection settings in existing PVs.

## Creating volume snapshots

In DVP, snapshots are created by archiving the volumeâ€™s folder. The archive is saved in the root directory of the NFS server specified in the `spec.connection.share` parameter. To create snapshots:

1. Enable the `snapshot-controller` module:

   ```shell
   d8 k apply -f -<<EOF
   apiVersion: deckhouse.io/v1alpha1
   kind: ModuleConfig
   metadata:
     name: snapshot-controller
   spec:
     enabled: true
     version: 1
   EOF
   ```

1. Create a volume snapshot by specifying the required parameters:

   ```shell
   d8 k apply -f -<<EOF
   apiVersion: snapshot.storage.k8s.io/v1
   kind: VolumeSnapshot
   metadata:
     name: my-snapshot
     namespace: <the namespace in which the PVC is located>
   spec:
     volumeSnapshotClassName: csi-nfs-snapshot-class
     source:
       persistentVolumeClaimName: <the namespace for which the snapshot needs to be created>
   EOF
   ```

1. Check the snapshot status using the following command:

   ```shell
   d8 k get volumesnapshot
   ```

This command will display a list of all snapshots and their current statuses.

## Requirements for a Linux distribution to deploy an NFS server with RPC-with-TLS support

- The kernel must be built with the `CONFIG_TLS` and `CONFIG_NET_HANDSHAKE` options enabled.
- The version of the `nfs-utils` package (called `nfs-common` in Debian-based distributions) must be >= 2.6.3.

## Deleting PVs with RPC-with-TLS enabled

If the [NFSStorageClass](/products/kubernetes-platform/documentation/v1/modules/csi-nfs/cr.html#nfsstorageclass) is configured with RPC-with-TLS support, it may be impossible to delete PVs. This can happen if the secret storing mount parameters is deleted (for example, after deleting the [NFSStorageClass](/products/kubernetes-platform/documentation/v1/modules/csi-nfs/cr.html#nfsstorageclass)). As a result, the controller is unable to mount the NFS path to delete the `<PV name>` directory.

## Adding multiple CAs to tlsParameters.ca in ModuleConfig

To add multiple CA certificates to the `tlsParameters.ca` parameter, concatenate them into a single file and encode it using Base64:

- For two CAs:

```shell
cat CA1.crt CA2.crt | base64 -w0
```

- For three CAs:

```shell
cat CA1.crt CA2.crt CA3.crt | base64 -w0
```

- And so on.
