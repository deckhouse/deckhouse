---
title: "Ролевая модель"
permalink: ru/test/architecture/multitenancy/rbac.html
lang: ru
---

Ролевая модель в платформе Deckhouse построена на принципе агрегации: мелкие роли объединяются в более крупные, что облегчает расширение за счёт собственных ролей.

В платформе Deckhouse ресурсы `ClusterAuthorizationRule` и `AuthorizationRule` не используются. Настройка прав доступа осуществляется стандартными средствами RBAC Kubernetes путём создания ресурсов `RoleBinding`, `ProjectRoleBinding` или `ClusterProjectRoleBinding` с указанием подготовленных ролей.

## Общая структура ролей

Роли, предоставляемые модулем, разделяются на две основные группы:

- **Роль администратора пространства имён (d8:namespace:*)** — предоставляет права на управление одним конкретным пространством имён, включая назначение пользователей и настройку их разрешений (например, для разработчиков приложений).
- **Роль администратора проекта (d8:project:*)** — объединяет в себе все возможности администратора пространства имён и дополнительно позволяет управлять проектными ресурсами — `ProjectNamespace` и `ProjectRoleBinding`.

Список всех ролей выглядит следующим образом:

```text
Роли платформы Deckhouse
└── d8:project:*
    └── d8:namespace:*
        ├── viewer
        ├── user
        ├── manager
        ├── admin
        └── superadmin
```

- `viewer` — позволяет в конкретном пространстве имён просматривать стандартные ресурсы Kubernetes, кроме секретов и ресурсов RBAC, а также выполнять аутентификацию в кластере;
- `user` — дополнительно к роли `viewer` позволяет в конкретном пространстве имён просматривать секреты и ресурсы RBAC, подключаться к подам, удалять поды (но не создавать или изменять их), выполнять `kubectl port-forward` и `kubectl proxy`, изменять количество реплик контроллеров;
- `manager` — дополнительно к роли `user` позволяет в конкретном пространстве имён управлять ресурсами модулей (например, `Certificate`, `PodLoggingConfig` и т. п.) и стандартными namespaced-ресурсами Kubernetes (`Pod`, `ConfigMap`, `CronJob` и т. п.);
- `admin` — дополнительно к роли `manager` позволяет в конкретном пространстве имён управлять ресурсами `ResourceQuota`, `ServiceAccount`, `Role`, `RoleBinding`, `NetworkPolicy`;
- `superadmin` — предназначена для внештатных ситуаций, когда необходимо предоставить максимально возможные права.

## Назначение ролей

Назначение ролей осуществляется с помощью стандартных механизмов Kubernetes: ресурсов `RoleBinding`, `ProjectRoleBinding` и `ClusterProjectRoleBinding`. Каждый тип ресурса предназначен для своей области применения и имеет свой набор допустимых ролей.

### RoleBinding

`RoleBinding` создаётся в конкретном пространстве имён и выдаёт права исключительно в этом пространстве имён. Подходит для назначения прав разработчикам и пользователям в конкретном пространстве имён.

Доступные роли:

- `d8:namespace:*`
- `d8:namespace-capability:*`
- `d8:custom:namespace:*`
- `d8:custom:namespace-capability:*`
- Локальные роли, определённые в конкретном пространстве имён

### ProjectRoleBinding

`ProjectRoleBinding` создаётся только в основном пространстве имён проекта и выдаёт роли сразу на все пространства имён проекта. Используется для назначения прав пользователям, которым требуется управлять ресурсами сразу нескольких пространств имён в рамках проекта.

Доступные роли:

- Проектные роли:

  - `d8:project:*`
  - `d8:project-capability:*`
  - `d8:custom:project:*`
  - `d8:custom:project-capability:*`

- Роли для пространства имён, назначаемые сразу на все пространства имён проекта:

  - `d8:namespace:*`
  - `d8:namespace-capability:*`
  - `d8:custom:namespace:*`
  - `d8:custom:namespace-capability:*`

### ClusterProjectRoleBinding

`ClusterProjectRoleBinding` применяется на уровне всего кластера и назначает права на все существующие проекты и пространства имён. Используется в случаях, когда администратору нужно предоставить права глобального уровня для нескольких проектов или всех проектов сразу.

Доступные роли:

- Роли для пространства имён:

  - `d8:namespace:*`
  - `d8:namespace-capability:*`
  - `d8:custom:namespace:*`
  - `d8:custom:namespace-capability:*`

- Проектные роли:

  - `d8:project:*`
  - `d8:project-capability:*`
  - `d8:custom:project:*`
  - `d8:custom:project-capability:*`

## Привилегии

Привилегии (capabilities) позволяют предоставить доступ к определённым возможностям и разделяются на два вида:

- **Привилегии пространства имён (`namespace capability`)** — дополнительные привилегии для конкретного пространства имён.
- **Привилегии проекта (`project capability`)** — дополнительные привилегии, применяемые ко всему проекту.

Возможности могут агрегироваться в существующие роли или создаваться отдельно:

- `d8:custom:namespace-capability:*`
- `d8:custom:project-capability:*`

### Расширение и отключение ролей

Встроенные роли можно расширять (добавляя права) или запрещать к прямой выдаче при помощи аннотации:

```yaml
rbac.deckhouse.io/disabled-for-direct-use-in-projects: ""
```

Существующие `RoleBinding`, `ProjectRoleBinding` и `ClusterProjectRoleBinding` продолжают работать, но изменять их невозможно — только удалить и создать заново.

Если в `ProjectTemplate` есть `RoleBinding` или `ProjectRoleBinding` с запрещённой ролью, объект `Project` перейдёт в статус `Error`.

Пользовательская роль может агрегировать любую встроенную роль, даже помеченную аннотацией. Это позволяет расширять функциональность без раскрытия системных деталей.

Урезать существующие разрешения через привилегии невозможно: используйте аннотацию для полного запрета.

Роль пространства имён можно выдать на одно пространство имён (`RoleBinding`) или все пространства имён проекта (`ProjectRoleBinding`).

Проектная роль охватывает только все пространства имён проекта и не может быть ограничена одним пространством.

### Локализация и аннотации

Для удобства использования и управления ролями поддерживается мультиязычная локализация названий и описаний с помощью следующих аннотаций:

* `ru.meta.deckhouse.io/title`, `en.meta.deckhouse.io/title`, `custom.meta.deckhouse.io/title`
* `ru.meta.deckhouse.io/description`, `en.meta.deckhouse.io/description`, `custom.meta.deckhouse.io/description`

По умолчанию платформа использует заполнение русскоязычных (`ru.meta`) и англоязычных (`en.meta`) аннотаций.

## Рекомендации по созданию ролей

По умолчанию рекомендуется создавать роли и привилегии для пространства имён (`d8:custom:namespace:*` и `d8:custom:namespace-capability:*`), так как это наиболее распространённые и востребованные роли в типовых сценариях.

Проектные роли и привилегии (`d8:custom:project:*`, `d8:custom:project-capability:*`) создаются только при необходимости назначения прав управления всеми пространствами имён проекта одновременно.

{% alert level="info" %}
Роли пространства имён могут быть назначены на отдельное пространство имён или сразу на все пространства имён проекта.
Проектные роли назначаются только на все пространства имён проекта и не могут быть применены к отдельным пространствам имён.
{% endalert %}
