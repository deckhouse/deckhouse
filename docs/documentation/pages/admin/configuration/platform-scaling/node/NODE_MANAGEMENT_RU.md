---
title: "Основы управления узлами в Deckhouse"
permalink: ru/admin/configuration/platform-scaling/node/node-management.html
lang: ru
---

Deckhouse Kubernetes Platform (DKP) поддерживает полный цикл управления узлами:

- Автоматическое масштабирование количества узлов в зависимости от нагрузки;
- Обновление узлов и поддержание их в актуальном состоянии;
- Централизованное управление конфигурацией групп узлов через CRD NodeGroup;
- Использование различных типов узлов: постоянные, временные, облачные или bare-metal.

> DKP может работать как с bare-metal, так и с облачными кластерами, обеспечивая гибкость и расширяемость.

Группы узлов позволяют логически сегментировать инфраструктуру кластера. В Deckhouse часто используются следующие типы NodeGroup по назначению:

- `master` — управляющие узлы (Control Plane);
- `front` — узлы для маршрутизации HTTP(S)-трафика;
- `monitoring` — узлы для размещения компонентов мониторинга;
- `worker` — узлы для пользовательских приложений;
- `system` — выделенные узлы для системных компонентов.

В каждой группе можно централизованно задавать настройки узлов, включая версию Kubernetes, ресурсы, taint'ы, лейблы, параметры kubelet и прочее.

## Включение механизма управления узлами

Управление узлами реализовано с помощью модуля `node-manager`, который можно включить или выключить несколькими способами:

1. Через ресурс ModuleConfig/node-manager:

   ```yaml
   apiVersion: deckhouse.io/v1alpha1
   kind: ModuleConfig
   metadata:
     name: node-manager
   spec:
     version: 2
     enabled: true
     settings:
       earlyOomEnabled: true
       instancePrefix: kube
       mcmEmergencyBrake: false
   ```

1. Командой:

   ```console
   d8 platform module enable node-manager
   # или disable
   ```

1. Через [веб-интерфейс Deckhouse](https://deckhouse.ru/products/kubernetes-platform/modules/console/stable/):

   - Перейдите в раздел «Deckhouse - «Модули»;
   - Найдите модуль `node-manager` и нажмите на него;
   - Включите тумблер «Модуль включен».

## Автоматическое развёртывание и обновление

В Deckhouse Kubernetes Platform (DKP) реализован автоматизированный механизм управления жизненным циклом узлов на основе объектов NodeGroup. DKP обеспечивает как начальное развёртывание узлов, так и их обновление при изменении конфигурации, поддерживая как облачные, так и bare-metal кластеры (при наличии интеграции с модулем `node-manager`).

Как это работает:

1. NodeGroup — основной объект управления группами узлов. Он определяет тип узлов, их количество, шаблоны ресурсов и ключевые параметры (например, настройки kubelet, taint'ов и др.).
1. При создании или изменении NodeGroup, модуль `node-manager` автоматически приводит состояние узлов в соответствие с заданной конфигурацией.
1. Обновление происходит без вмешательства пользователя — устаревшие узлы удаляются, новые создаются автоматически.

Пример: автоматическое обновление версии kubelet.

1. Пользователь изменяет параметры в секции kubelet объекта NodeGroup.
1. DKP определяет, что текущие узлы не соответствуют новой конфигурации.
1. Последовательно создаются новые узлы с обновлёнными настройками.
1. Старые узлы постепенно удаляются из кластера.

   ```yaml
   apiVersion: deckhouse.io/v1
   kind: NodeGroup
   metadata:
     name: worker-cloud
   spec:
     nodeType: CloudEphemeral
     cloudInstances:
       classReference:
         kind: AnotherCloudInstanceClass
         name: my-class
   ```

## Базовая настройка узлов и операционной системы

При создании и подключении узлов Deckhouse автоматически выполняет ряд действий, необходимых для корректной работы кластера:

- установка и настройка поддерживаемой операционной системы;
- отключение автоматических обновлений пакетов;
- настройка журналирования и системных параметров;
- установка необходимых пакетов и утилит;
- настройка компонента `nginx` для балансировки трафика от `kubelet` к API-серверам;
- установка и конфигурация компонентов container runtime (`containerd`) и `kubelet`;
- включение узла в состав кластера Kubernetes.

Эти операции выполняются автоматически при использовании `bootstrap.sh` или при подключении узлов через ресурсы StaticInstance и SSHCredentials.

### Обновления, требующие прерывания работы узла

Некоторые обновления, например, обновление версии `containerd` или обновление kubelet на несколько версий вперед,
требуют прерывания работы узла
и могут привести к кратковременному простою системных компонентов (*disruptive-обновления*).
Режим применения таких обновлений настраивается с помощью [параметра `disruptions.approvalMode`](../../../reference/cr/nodegroup/#nodegroup-v1-spec-disruptions-approvalmode):

- `Manual` — режим ручного подтверждения disruptive-обновлений.
  При появлении доступного disruptive-обновления отображается специальный алерт.
  
  Чтобы подтвердить disruptive-обновление,
  установите аннотацию `update.node.deckhouse.io/disruption-approved=` на каждый узел в группе, следуя примеру:

  ```shell
  sudo -i d8 k annotate node ${NODE_1} update.node.deckhouse.io/disruption-approved=
  ```

  > **Важно**. В этом режиме не выполняется автоматический drain узла.
  > При необходимости выполните drain вручную перед установкой аннотации.
  >
  > Чтобы избежать проблем при выполнении drain,
  > всегда устанавливайте режим `Manual` для группы master-узлов.

- `Automatic` — режим автоматического разрешения disruptive-обновлений.
  
  В этом режиме по умолчанию выполняется автоматический drain узла перед применением обновления.
  Поведение можно изменить с помощью [параметра `disruptions.automatic.drainBeforeApproval`](../../../reference/cr/nodegroup/#nodegroup-v1-spec-disruptions-automatic-drainbeforeapproval) в настройках узла.

- `RollingUpdate` — режим, при котором будет создан новый узел с обновлёнными настройками, а старый будет удалён.
  Применим только к облачным узлам.

  В этом режиме на время обновления в кластере создаётся дополнительный узел.
  Это может быть удобно, если в кластере нет ресурсов для временного размещения нагрузки с обновляемого узла.
