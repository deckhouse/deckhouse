---
title: "Мониторинг в Deckhouse Kubernetes Platform"
permalink: ru/admin/configuration/monitoring/
description: "Настройка комплексного мониторинга для платформы Deckhouse Kubernetes Platform с Prometheus и Grafana. Сбор метрик, алертинг, дашборды и мониторинг SLA для здоровья кластера."
lang: ru
---

Deckhouse Kubernetes Platform (DKP) предоставляет решение для мониторинга Kubernetes на базе **Prometheus** и **Grafana**.
Модуль автоматически настраивает сбор метрик с узлов, подов и ключевых компонентов кластера (etcd, kube-apiserver, CoreDNS), а также предлагает предустановленные дашборды для анализа использования CPU, памяти, дисков и сети.

Все компоненты работают в отказоустойчивом режиме, включая Prometheus и Alertmanager и адаптированы под облака и bare metal.

Принцип работы и настройки Prometheus рассмотрены [в статье](./prometheus.html).

Реализовано несколько видов мониторинга:

- [Мониторинг аппаратных ресурсов](#мониторинг-аппаратных-ресурсов);
- [Мониторинг Kubernetes](#мониторинг-kubernetes);
- [Мониторинг Ingress](#мониторинг-ingress);
- [Мониторинг сетевого взаимодействия](./configuring/network-and-nodes.html);
- [Расширенный мониторинг](#режим-расширенного-мониторинга);
- [Мониторинг SLA кластера](#мониторинг-sla-кластера).

Предусмотрены [режим расширенного мониторинга](#режим-расширенного-мониторинга) и [алертинг](#алерты), в том числе [во внешние системы](#отправка-алертов-во-внешние-системы). Доступен мониторинг с помощью дашбордов, есть мониторинг SLA кластера.

## Мониторинг аппаратных ресурсов

Предусмотрено отслеживание загрузки аппаратных ресурсов кластера с графиками по утилизации:

- процессора;
- памяти;
- диска;
- сети.

Графики доступны с агрегацией:

- по подам;
- контроллерам;
- пространствам имен;
- узлам.

## Мониторинг Kubernetes

Модуль предназначен для базового мониторинга узлов кластера.

Обеспечивает безопасный сбор метрик и предоставляет базовый набор правил для мониторинга:
- текущей версии container runtime (docker, containerd) на узле и ее соответствия версиям, разрешенным для использования;
- общей работоспособности подсистемы мониторинга кластера (Dead man's switch);
- доступных файловых дескрипторов, сокетов, свободного места и inode;
- работы `kube-state-metrics`, `node-exporter`, `kube-dns`;
- состояния узлов кластера (NotReady, drain, cordon);
- состояния синхронизации времени на узлах;
- случаев продолжительного превышения CPU steal;
- состояния таблицы Conntrack на узлах;
- подов с некорректным состоянием (как возможное следствие проблем с kubelet) и др.

## Мониторинг Ingress

Реализован сбор статистики для [`ingress-nginx`](/modules/ingress-nginx/) в Prometheus с детальными метриками (время ответа, коды, география и др.), доступной в разных разрезах (namespace, vhost, ingress). Данные визуализированы в Grafana с интерактивными дашбордами.
Подробное описание - в разделе [мониторинг Ingress](../network/ingress/alb/nginx.html#мониторинг-и-статистика).

## Мониторинг control plane

Мониторинг control plane осуществляется с помощью [модуля `monitoring-kubernetes-control-plane`](/modules/monitoring-kubernetes-control-plane/), который организует безопасный сбор метрик и предоставляет базовый набор правил мониторинга следующих компонентов кластера:
* kube-apiserver;
* kube-controller-manager;
* kube-scheduler;
* kube-etcd.

## Мониторинг приложения

Этот мониторинг предназначен для автоматического сбора метрик с пользовательских приложений в Kubernetes-кластере через Prometheus. Достаточно включить [модуль `monitoring-custom`](/modules/monitoring-custom/), добавить лейбл `prometheus.deckhouse.io/custom-target` на Service или Pod и указать порт (например, `http-metrics`), чтобы метрики начали собираться без ручной настройки Prometheus.

Система поддерживает гибкие настройки: HTTPS, кастомные пути, параметры запроса, работу с Istio (mTLS) и защиту от перегрузки (лимит метрик).
Это позволяет интегрировать приложения в общий мониторинг кластера, отслеживать их состояние и производительность.

## Мониторинг кластера

DKP безопасно собирает метрики мониторинга и настраивает правила.

Возможности мониторинга DKP:
- мониторинг текущей версии container runtime (containerd) на узле и ее соответствия версиям, разрешенным для использования в DKP;
- мониторинг работоспособности подсистемы мониторинга кластера (Dead man's switch);
- мониторинг доступных файловых дескрипторов, сокетов, свободного места и inode;
- мониторинг состояния узлов кластера (NotReady, drain, cordon);
- работы `kube-state-metrics`, `node-exporter`, `kube-dns`;
- мониторинг состояния синхронизации времени на узлах;
- мониторинг случаев продолжительного превышения CPU steal;
- мониторинг состояния таблицы Conntrack на узлах;
- мониторинг подов с некорректным состоянием (как возможное следствие проблем с kubelet);
- мониторинг компонентов control plane (реализуется модулем `monitoring-kubernetes-control-plane`);

## Режим расширенного мониторинга

В DKP возможно использование режима расширенного мониторинга, который предоставляет алерты по дополнительным метрикам:

- свободному месту и inode на дисках узлов,
- утилизации узлов,
- доступности подов и образов контейнеров,
- истечении действия сертификатов,
- другим событиям кластера.

Также он позволяет настроить:

- мониторинг секретов в Кластере (объекты Secret) и срока действия TLS-сертификатов в них (реализуется модулем `extended-monitoring`);
- сбор событий в кластере Kubernetes в виде метрик (реализуется модулем `extended-monitoring`);
- мониторинг доступности образов контейнеров в registry, используемых контроллерах (Deployments, StatefulSets, DaemonSets, CronJobs) (реализуется модулем `extended-monitoring`);
- мониторинг объектов в пространствах имен, у которых есть лейбл `extended-monitoring.deckhouse.io/enabled=""` (реализуется модулем `extended-monitoring`).

### Алертинг в режиме расширенного мониторинга

DKP предоставляет возможность гибкой настройки алертинга для каждого пространства имён и указания различной степени критичности в зависимости от порога. Можно определить множество порогов для отправки предупреждений в различные пространства имён, например, для следующих параметров:

- значения свободного места и inodes на диске;
- утилизация CPU узлов и контейнера;
- процент ошибок с кодом `5xx` на `nginx-ingress`;
- количество возможных недоступных подов в `Deployment`, `StatefulSet`, `DaemonSet`.

## Алерты

Мониторинг в составе DKP включает уведомления о событиях. Стандартная поставка включает набор базовых предупреждений, охватывающих состояние кластера и его компоненты. Также остается возможность добавлять кастомные алерты.

Список всех доступных алертов системы мониторинга DKP приведён на [отдельной странице документации](../../../reference/alerts.html).

### Отправка алертов во внешние системы

DKP поддерживает отправку алертов с помощью `Alertmanager`:

- по протоколу SMTP;
- в PagerDuty;
- в Slack;
- в Telegram;
- посредством Webhook;
- по любым другим каналам, поддерживаемым в Alertmanager.

## Мониторинг SLA кластера

Оценка доступности в DKP осуществляется [модулем `upmeter`](/modules/upmeter/).

Состав модуля `upmeter`:

- **agent** — работает на master-узлах и делает пробы доступности, отправляет результаты на сервер.
- **upmeter** — собирает результаты и поддерживает API-сервер для их извлечения.
- **front**:
  - **status** — показывает уровень доступности за последние 10 минут (требует авторизации, но ее можно отключить).
  - **webui** — показывает дашборд со статистикой по пробам и группам доступности (требует авторизации).
- **smoke-mini** — поддерживает постоянное *smoke-тестирование* с помощью StatefulSet.

Модуль отправляет около 100 показаний метрик каждые 5 минут. Это значение зависит от количества включенных модулей Deckhouse Kubernetes Platform.
