---
title: Обновление control plane
permalink: ru/admin/configuration/update/control-plane-update.html
lang: ru
---

В Deckhouse Kubernetes Platform (DKP) процесс обновления control plane максимально автоматизирован и безопасен как для single-master-, так и для multi-master-кластеров. При этом могут возникать кратковременные перерывы в доступности API-сервера, однако на работу приложений внутри кластера обновление control plane не влияет. Дополнительное окно для регламентных работ, как правило, не требуется.

## Поддерживаемые версии Kubernetes и режимы обновления

В DKP поддерживаются последние пять минорных версий Kubernetes. Полный список актуальных версий доступен на отдельной странице в документации (#TODO).

### Обновление патч-версий

Обновление патч-версий (например, с `1.27.3` на `1.27.5`) происходит автоматически вместе с обновлением версии DKP.
Управлять таким обновлением невозможно.

### Обновление минорных версий

Обновить минорную версию (например, с `1.26.*` на `1.28.*`) можно несколькими способами:

- C помощью параметра `kubernetesVersion` в ресурсе ClusterConfiguration (#TODO):
  - Чтобы обновлять control plane **в автоматическом режиме**, укажите параметр `kubernetesVersion: Automatic`.
    При этом для обновления будет использоваться минорная версия Kubernetes, используемая в DKP по умолчанию на момент обновления (#TODO).
  - Чтобы обновить control plane **вручную**, явно укажите необходимую версию в параметре. Например, `kubernetesVersion: 1.30`.
- С помощью команды редактирования ресурса ClusterConfiguration:
  
  ```shell
  sudo -i d8 k -n d8-system exec -it svc/deckhouse-leader -c deckhouse -- deckhouse-controller edit cluster-configuration
  ```

  Команда запускает обновление до минорной версии Kubernetes, используемой в DKP по умолчанию на момент обновления (#TODO).
  
  Чтобы отследить ход обновления, ориентируйтесь на версию Kubernetes, указанную в выводе команды описания узлов:

  ```shell
  sudo -i d8 k get nodes
  ```
  
## Процесс обновления

### Этап обновления компонентов control plane

1. Модуль `control-plane-manager` вносит изменения в манифесты основных компонентов (`apiserver`, `controller-manager`, `scheduler` и др.).
2. Обновлённые компоненты разворачиваются на всех master-узлах.

При обновлении до новой минорной версии (**upgrade**):

- Если нужно поднять версию сразу на несколько минорных релизов (например, с `1.26` до `1.28`), обновление происходит поэтапно: с `1.26` до `1.27` и затем с `1.27` до `1.28`.
- На каждом этапе сначала обновляется control plane, а затем выполняется обновление kubelet на узлах.

При откате до предыдущей версии (**downgrade**):

- Гарантируется успешный откат только на одну минорную версию назад от максимальной версии, когда-либо использовавшейся в кластере.
- Откат происходит в обратном порядке. Сначала откатываются компоненты kubelet на узлах, затем — компоненты control plane.

### Этап обновления рабочих узлов (kubelet)

После обновления control plane начинается обновление узлов кластера:

1. Bashible API Server меняет версию kubelet в скриптах для всех групп узлов (NodeGroup).
1. Обновление узлов в разных NodeGroup идёт параллельно, однако внутри каждой NodeGroup узлы обновляются последовательно, по одному.
1. Для каждой NodeGroup учитываются её настройки:
   - ручной или автоматический режим обновления;
   - наличие окон обновлений;
   - требуется ли удалять поды с узла перед обновлением и др.
1. Выбирается один (или несколько) узлов-кандидатов, удовлетворяющих всем условиям обновления, после чего выполняется их обновление.
1. Процесс повторяется, пока не обновятся все узлы во всех группах.
1. Когда обновлены все узлы во всех группах, процесс обновления завершается.
