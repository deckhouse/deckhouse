---
title: Настройка обновлений
permalink: ru/admin/configuration/update/configuration.html
lang: ru
---

Deckhouse Kubernetes Platform (DKP) поддерживает гибкий механизм обновлений,
позволяя настроить автоматическую или ручную установку,
а также задать окна обновлений, в которые разрешено устанавливать новые версии.
Вместе эти возможности позволяют избежать обновлений в неподходящее время и контролировать переход на новые релизы.

## Режимы обновления

DKP поддерживает три режима обновления, которые определяют порядок перехода на новую версию:

- **Автоматический режим (без окон обновлений)** — кластер обновляется сразу после появления новой версии
  [на используемом канале обновлений](release-channels.html#проверка-текущего-канала-обновлений).
- **Автоматический режим (с окнами обновлений)** — кластер обновляется в ближайшее доступное окно
  после появления новой версии на канале обновлений.
- **Ручной режим** — для применения обновления его необходимо подтвердить вручную.

### Проверка текущего режима обновления

Чтобы узнать, какой режим обновления используется в кластере,
проверьте конфигурацию модуля `deckhouse` с помощью следующей команды:

```shell
sudo -i d8 k get mc deckhouse -o yaml
```

Пример вывода:

```console
...
spec:
  settings:
    releaseChannel: Stable
    update:
      windows:
      - days:
        - Mon
        from: "19:00"
        to: "20:00"
...
```

### Автоматическое обновление

Автоматический режим активируется при указании параметра `releaseChannel` в конфигурации модуля `deckhouse` (#TODO).
При выполнении этого условия:

1. DKP раз в минуту проверяет канал обновлений на наличие нового релиза.
1. При появлении нового релиза DKP скачивает его в кластер и создает кастомный ресурс DeckhouseRelease(#TODO).
1. После появления кастомного ресурса DeckhouseRelease в кластере
   DKP выполняет обновление на соответствующую версию согласно установленным параметрам обновления
   (по умолчанию — автоматически, в любое время).

Чтобы посмотреть список и состояние всех релизов в кластере, воспользуйтесь командной:

```shell
sudo -i d8 k get deckhousereleases
```

{% alert level="info" %}
Обновление патч-версий (например, с `1.30.1` на `1.30.2`) происходит без учета режима и окон обновлений.
Новый патч-релиз будет автоматически установлен, когда он появится на используемом канале обновлений.
{% endalert %}

#### Отключение автоматического обновления

{% alert level="danger" %}
Крайне не рекомендуется отключать автоматическое обновление!
Это заблокирует установку патч-релизов, которые могут содержать исправления критических уязвимостей и ошибок.
{% endalert %}

Чтобы полностью отключить автоматическое обновление DKP,
удалите параметр `releaseChannel` в конфигурации модуля `deckhouse`(#TODO).

### Ручное подтверждение обновлений

Ручное подтверждение обновления версии DKP предусмотрено в следующих случаях:

- Включен режим подтверждения обновлений DKP.

  Это значит, что для параметра `settings.update.mode` модуля `deckhouse`(#TODO) задано значение `Manual`
  (подтверждение как патч-версии, так и минорной версии DKP) или `AutoPatch` (подтверждение минорной версии DKP).

  Для подтверждения обновления выполните следующую команду, указав необходимую версию DKP вместо `<DECKHOUSE-VERSION>`:

  ```shell
  sudo -i d8 k patch DeckhouseRelease <DECKHOUSE-VERSION> --type=merge -p='{"approved": true}'
  ```

- Включено подтверждение потенциально опасных disruptive-обновлений.

  Это значит, что для параметра `update.disruptionApprovalMode` модуля `deckhouse`(#TODO) задано значение `Manual`.
  Чтобы установить этот параметр в `Manual`, используйте следующую команду:

  ```shell
  sudo -i d8 k patch mc deckhouse --type=merge -p='{"spec":{"update":{"disruptionApprovalMode":"Manual"}}}'
  ```

  Для подтверждения потенциально опасного обновления
  установите аннотацию `release.deckhouse.io/disruption-approved=true` на соответствующем ресурсе DeckhouseRelease(#TODO):

  ```shell
  sudo -i d8 k annotate DeckhouseRelease <DECKHOUSE-VERSION> release.deckhouse.io/disruption-approved=true
  ```

- Если для какой-либо группы узлов отключено автоматическое применение потенциально опасных обновлений.

  Это значит,
  что для параметра `spec.disruptions.approvalMode`(#TODO) у соответствующего ресурса NodeGroup задано значение `Manual`.

  Для обновления узлов в такой группе установите аннотацию `update.node.deckhouse.io/disruption-approved=` на каждый узел.

  Пример:

  ```shell
  sudo -i d8 k annotate node ${NODE_1} update.node.deckhouse.io/disruption-approved=
  ```

## Окна обновлений

DKP позволяет задавать *окна обновлений* — временные интервалы,
в которые будет выполняться установка обновлений в автоматическом режиме.
Используя окна обновлений,
вы исключаете вероятность установки нового релиза в неподходящее время или в периоды высокой нагрузки на кластер.

### Установка обновлений при настроенных окнах обновлений

- Если окна обновлений настроены, DKP будет устанавливать новые версии только в указанные временные интервалы.
- Если окна обновлений не настроены, установка начнется сразу после появления новой версии в настроенном канале обновлений.

### Настройка окон обновлений

Управлять окнами обновлений DKP можно следующими способами:

- **для общего управления обновлениями** используйте параметр `update.windows` модуля `deckhouse`(#TODO);
- **для управления потенциально опасными обновлениями (disruptive updates)** используйте параметры `disruptions.automatic.windows`(#TODO) и `disruptions.rollingUpdate.windows`(#TODO) ресурса NodeGroup.

#### Примеры конфигурации

- Два ежедневных окна обновлений с 8:00 до 10:00 и c 20:00 до 22:00 (UTC):

  ```yaml
  apiVersion: deckhouse.io/v1alpha1
  kind: ModuleConfig
  metadata:
    name: deckhouse
  spec:
    version: 1
    settings:
      releaseChannel: EarlyAccess
      update:
        windows: 
          - from: "8:00"
            to: "10:00"
          - from: "20:00"
            to: "22:00"
  ```

- Окна обновлений по вторникам и субботам с 18:00 до 19:30 (UTC):

  ```yaml
  apiVersion: deckhouse.io/v1alpha1
  kind: ModuleConfig
  metadata:
    name: deckhouse
  spec:
    version: 1
    settings:
      releaseChannel: Stable
      update:
        windows: 
          - from: "18:00"
            to: "19:30"
            days:
              - Tue
              - Sat
  ```
