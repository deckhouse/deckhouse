---
title: "Масштабирование по метрикам"
permalink: ru/admin/configuration/app-scaling/scaling-by-metrics.html
lang: ru
---

## Масштабирование по метрикам

Масштабирование по метрикам — это процесс автоматического или ручного изменения ресурсов (например, количества реплик подов, выделенных CPU/памяти) на основе определённых метрик. Метрики могут быть как стандартными (использование CPU или памяти), так и дополнительными (например, количество запросов в секунду или размер очереди сообщений).

### Доступные метрики для масштабирования

Масштабирование выполняется на основе как базовых показателей ресурсоёмкости приложений, так и произвольных метрик из Prometheus и запросов на основе PromQL. Например:

- CPU (пода) — текущее использование процессора.
- Память (пода) — текущее использование оперативной памяти.
- RPS (Ingress) — количество запросов в секунду за 1, 5, 15 минут (rps_1m, rps_5m, rps_15m).
- Среднее потребление CPU (пода) — за 1, 5, 15 минут (cpu_1m, cpu_5m, cpu_15m).
- Среднее потребление памяти (пода) — за 1, 5, 15 минут (memory_1m, memory_5m, memory_15m).

### Как использовать метрики

Для использования метрик:

- Включите модуль `prometheus-metrics-adapter`, который позволяет создавать кастомные ресурсы, описывающие, как извлекать метрику из Prometheus;
- Определите PromQL-запрос, который будет описывать нужную метрику (например, скорость запросов к приложению или загрузку CPU за определённое время). Этот запрос регистрируется в кластере как метрика для HPA.
- Настройте HPA, указав в нём имя метрики и пороговое значение. Kubernetes будет опрашивать результат вашего PromQL-запроса и сравнивать с заданным порогом, добавляя или убавляя реплики (см. раздел [Настройка HPA](http://deckhouse.ru/products/kubernetes-platform/documentation/v1/admin/configuration/app-scaling/hpa.html#настройка-hpa)).

Пример запроса PromQL:

```yaml
query: sum(rate(ingress_nginx_detail_requests_total{<<.LabelMatchers>>}[2m])) by (<<.GroupBy>>) OR on() vector(0)
```

В данном примере:

- `ingress_nginx_detail_requests_total` — базовая метрика (счётчик запросов, например от контроллера Ingress NGINX);
- `rate(...[2m])` — вычисляет скорость увеличения счётчика за последние 2 минуты (requests per second);
- `sum(...) by (<<.GroupBy>>)` — суммирует результат по некоторому набору меток (например, по имени Ingress, пространству имён и т. д.);
- `OR on() vector(0)` — значение для PromQL, позволяющий вернуть «0», когда нет данных (иначе результат мог бы быть пустым и не учитываться).

Таким образом, этот PromQL-запрос даёт «число текущих запросов в секунду» по указанным меткам (Ingress, namespace и т. д.).

Когда у администратора есть метрика, описанная через PromQL-запрос (например, в объекте `IngressMetric` или аналогичном механизме), её можно указать в HorizontalPodAutoscaler (HPA) например так:

```yaml
apiVersion: deckhouse.io/v1beta1
kind: IngressMetric
metadata:
  name: mymetric
  namespace: mynamespace
spec:
  query: sum(rate(ingress_nginx_detail_requests_total{<<.LabelMatchers>>}[2m])) by (<<.GroupBy>>) OR on() vector(0)
---
kind: HorizontalPodAutoscaler
apiVersion: autoscaling/v2
metadata:
  name: myhpa
  namespace: mynamespace
spec:
  # Указывается контроллер, который нужно масштабировать (ссылка на deployment или statefulset).
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: myapp
  minReplicas: 1
  maxReplicas: 2
  # Метрики, используемые для масштабирования.
  # Пример использования дополнительных метрик.
  metrics:
  - type: Object
    object:
      # Объект, который обладает метриками в Prometheus.
      describedObject:
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        name: myingress
      metric:
        # Метрика, зарегистрированная с помощью custom resource IngressMetric или ClusterIngressMetric.
        # Можно использовать rps_1m, rps_5m или rps_15m которые поставляются с модулем prometheus-metrics-adapter.
        name: mymetric
      target:
        # Для метрик типа Object можно использовать `Value` или `AverageValue`.
        type: AverageValue
        # Масштабирование происходит, если среднее значение дополнительной метрики для всех подов в Deployment сильно отличается от 10.
        averageValue: 10
```

При превышении (или падении ниже) заданного порога `averageValue: 10` система изменит число реплик `myapp` в диапазоне от 1 до 2

### Как включить prometheus-metrics-adapter

Включить `prometheus-metrics-adapter` можно следующими способами:

1. Через ресурс ModuleConfig (например, ModuleConfig/prometheus-metrics-adapter). Установите параметр `spec.enabled` в значение `true` или `false`:

   ```yaml
   apiVersion: deckhouse.io/v1alpha1
   kind: ModuleConfig
   metadata:
     name: prometheus-metrics-adapter
   spec:
     enabled: true
   ```

1. Через команду deckhouse-controller (в поде `d8-system/deckhouse`):

   ```console
   kubectl -ti -n d8-system exec svc/deckhouse-leader -c deckhouse -- deckhouse-controller module enable prometheus-metrics-adapter
   ```

1. Через [веб-интерфейс DKP](https://deckhouse.ru/products/kubernetes-platform/modules/console/stable/):

   - Перейдите в раздел «Deckhouse - «Модули»;
   - Найдите модуль `prometheus-metrics-adapter` и нажмите на него;
   - Включите тумблер «Модуль включен».

### Пример настройки метрик через CustomPrometheusRules

Если вы хотите объявить собственную метрику без прямого изменения `prometheus-metrics-adapter`, можно воспользоваться ресурсом CustomPrometheusRules, где нужный PromQL-запрос записывается в виде правила:

```yaml
apiVersion: deckhouse.io/v1
kind: CustomPrometheusRules
metadata:
  # Рекомендованный шаблон для названия ваших CustomPrometheusRules.
  name: prometheus-metrics-adapter-mymetric
spec:
  groups:
  # Рекомендованный шаблон.
  - name: prometheus-metrics-adapter.mymetric
    rules:
    # Название вашей новой метрики.
    # Важно! Префикс 'kube_adapter_metric_' обязателен.
    - record: kube_adapter_metric_mymetric
      # Запрос, результаты которого попадут в итоговую метрику, нет смысла тащить в нее лишние лейблы.
      expr: sum(ingress_nginx_detail_sent_bytes_sum) by (namespace,ingress)
```

> Все метрики с префиксом `kube_adapter_metric_` автоматически регистрируются в Kubernetes API без необходимости создания CustomPrometheusRules. Это позволяет использовать уже существующие Prometheus-метрики для масштабирования без дополнительных конфигураций.

### Оптимизация работы с нестабильными метриками

При работе с нестабильными метриками (например, если метрика колеблется и вызывает избыточное масштабирование) рекомендуется:

- Использовать агрегирующие функции PromQL. Например, `avg_over_time()` усредняет значение метрики за заданный промежуток времени, что помогает избежать резких скачков:

  ```yaml
  apiVersion: deckhouse.io/v1beta1
  kind: ServiceMetric
  metadata:
    name: rmq-queue-forum-messages
    namespace: mynamespace
  spec:
    query: sum (avg_over_time(rabbitmq_queue_messages{<<.LabelMatchers>>,queue=~"send_forum_message",vhost="/"}[5m])) by (<<.GroupBy>>)
  ```

- Настроить стабилизацию в поведении автоскейлера. Время стабилизации масштабирования можно увеличить, чтобы решения о добавлении или удалении реплик принимались на основе более устойчивых данных.

### Получение значений метрик

Для получения списка дополнительных метрик используйте команду:

```console
kubectl get --raw /apis/custom.metrics.k8s.io/v1beta1/
```

Для получения значений метрик, привязанных к объектам используйте команду:

```console
kubectl get --raw /apis/custom.metrics.k8s.io/v1beta1/namespaces/my-namespace/services/*/my-service-metric
```

Для получения значений метрик, созданных через `NamespaceMetric` используйте команду:

```console
kubectl get --raw /apis/custom.metrics.k8s.io/v1beta1/namespaces/my-namespace/metrics/my-ns-metric
```

Для получения внешних (external) метрик используйте команду:

```console
kubectl get --raw /apis/external.metrics.k8s.io/v1beta1
```

### Настройка автомасштабирования в веб-интерфейсе DKP

В Deckhouse Kubernetes Platform можно настраивать параметры автомасштабирования узлов через [веб-интерфейс DKP](https://deckhouse.ru/products/kubernetes-platform/modules/console/stable/). Это позволяет динамически изменять количество узлов в зависимости от нагрузки.

Чтобы настроить автомасштабирование в веб-интерфейсе:

- Откройте Консоль;
- В левом меню перейдите в раздел «Узлы» → «Группы узлов»;
- Выберите нужную группу узлов;
- В разделе «Параметры автомасштабирования» отобразятся текущие настройки.

В веб-интерфейсе DKP доступны следующие настройки:

- Параметр «Узлов на зону» – задаёт минимальное и максимальное количество узлов, которые могут быть запущены в одной зоне.
- Параметр «Необходимо» – текущее количество узлов, необходимых для работы.
- Параметр «Заказано» – текущее количество узлов, запланированное для запуска.
- Параметр «Резерв» – дополнительный запас узлов.

Чтобы изменить параметры автомасштабирования:

- Нажмите на значок редактирования рядом с параметром «Узлов на зону».
- В появившемся окне укажите минимальное и максимальное количество узлов.
- Нажмите «Применить», чтобы сохранить изменения, или «Отменить», чтобы сбросить редактирование.

При нажатии «Создать на основании» в веб-интерфейсе открывается форма настройки параметров автомасштабирования:

1. Основные параметры:
   - Зоны – выбор зон, в которых будут создаваться машины. Позволяет распределять узлы между разными зонами доступности. Значение по умолчанию зависит от выбранного облачного провайдера и обычно соответствует всем зонам используемого региона
   - Приоритет масштабирования – используется, если в кластере есть несколько групп узлов с одинаковым приоритетом. Если приоритет не указан, то система случайным образом выбирает группу для добавления новых узлов.
   - Количество одновременно создаваемых машин при масштабировании вверх – определяет, сколько машин может быть добавлено одновременно при масштабировании вверх. Например, если значение 1, то узлы добавляются по одному.
   - Недоступное количество инстансов при RollingUpdate – количество узлов, которые могут быть недоступны во время обновления (RollingUpdate). Значение 0 означает, что обновление будет проходить поочерёдно, без временного снижения числа работающих узлов.

1. Резервные узлы и ресурсы:
   - Число резервных узлов от общего количества узлов – можно указать конкретное число узлов (например, 2-6) или процент от общего числа узлов (например, 15%). Резервный узел — это узел кластера, на котором резервируются ресурсы, доступные в любой момент для масштабирования. Наличие такого узла позволяет автоскейлеру кластера не ждать инициализации узла, а сразу размещать на нем нагрузку. Это позволяет ускорить масштабирование вверх на несколько минут.
   - Ресурсы, занимаемые на резервных узлах, % – процент ресурсов, который выделяется на резервных узлах. Допустимые значения: от 1% до 80%. Например, если указать 50%, то половина ресурсов узла будет зарезервирована.

1. Дополнительные параметры:
   - Quick Shutdown (Быстрое выключение) – включает ускоренное отключение узлов, снижая время ожидания drain'а до 5 минут.
