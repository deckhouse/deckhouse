---
title: "Настройка внутренней сети"
permalink: ru/admin/configuration/network/internal/configuration.html
lang: ru
---

В Deckhouse Kubernetes Platform для настройки сети используются CNI-плагины.
Рекомендуемый и подходящий для большинства случаев CNI — Cilium.
Также поддерживаются CNI Flannel и Simple Bridge (используется для облачных провайдеров).

Настройки сети выполняются при развертывании кластера Deckhouse Kubernetes Platform.
При развертывании задаются адресные пространства для подов и сервисов кластера и указывается режим работы сети для Cilium (его можно изменить в процессе эксплуатации кластера).

## Режимы работы внутренней сети

Режим работы сети устанавливается в настройках модуля [cni-cilium](../../reference/mc/cni-cilium/) (параметр `tunnelMode`).
Поддерживается два режима: классический и с использованием VXLAN-туннеля.

Выбор подходящего варианта зависит от особенностей сети кластера.

Если узлы кластера находятся в разных сетях, VXLAN позволяет создать виртуальную сеть поверх существующей инфраструктуры. При этом обеспечивается изоляция трафика и возможность работы с различными сетевыми сегментами.

Если узлы кластера находятся в одной сети, могут быть использованы оба варианта.
При этом нужно учитывать, что инкапсуляция VXLAN-пакетов приводит к уменьшению minimal transmission unit (MTU), а использование маршрутизации добавляет промежуточный узел на пути пакета.
На практике разница в скорости при использовании обоих вариантов настолько мала, что ей можно пренебречь.

Чтобы изменить режим работы туннеля, задайте требуемое значение параметра `tunnelMode` в настройках модуля cni-cilium.

Для настройки модуля используйте ресурс `ModuleConfig` с именем `cni-cilium`.

Пример ресурса `ModuleConfig/cni-cilium` для настройки режима работы внутренней сети:

```yaml
apiVersion: deckhouse.io/v1alpha1
kind: ModuleConfig
metadata:
  name: cni-cilium
spec:
  version: 1
  enabled: true
  settings:
    tunnelMode: VXLAN
```

[Подробнее о настройках](../../reference/mc/cni-cilium/) модуля `cni-cilium`.

> После смены режима работы cilium перезагрузите все узлы, иначе возможны проблемы с доступностью подов.

## Сервисы

Сервисы реализуются средствами выбранного CNI, либо через kube-proxy.

Сервисы позволяют предоставлять доступ к группам подов, выполняющих одинаковые функции, и реализовать балансировку трафика между ними.
Каждый объект Service определяет логический набор конечных точек (подов), а также политику того, как сделать эти поды доступными.

Deckhouse Kubernetes Platform поддерживает следующие типы сервисов:

* ClusterIP. Создаёт внутренний IP-адрес, который выбирается из сети сервисов. Весь трафик с этого IP перенаправляется на поды, указанные в селекторе. Тем самым обеспечивается балансировка.
В этом типе сервиса можно отказаться от назначения IP-адреса. В таком случае адрес из сети сервисов не будет назначаться, а сам сервис при обращении будет резолвиться в IP-адреса подов. Балансировка будет работать на round-robin DNS.
* NodePort. Открывает порт на каждом узле кластера и перенаправляет трафик, который приходит на этот порт, в поды, указанные в селекторе.
Из соображений безопасности в Deckhouse порт слушается только на внутреннем IP узлов. Это поведение можно изменить, если добавить аннотацию `node.deckhouse.io/nodeport-bind-internal-ip: "false"` на группу узлов.
* LoadBalancer. Это специальный тип сервисов. Он создаётся в облачном провайдере, на котором установлена Deckhouse Kubernetes Platform, и позволяет принимать трафик извне кластера. Для bare-metal-кластеров поддержку таких сервисов можно добавить с помощью модуля MetalLB.
* ExternalName. По сути, это просто CNAME DNS-запись, созданная в кластерном DNS.

### Настройка сети сервисов с помощью kube-proxy

<!-- Перенесено с минимальными изменениями из https://deckhouse.ru/products/kubernetes-platform/documentation/latest/modules/kube-proxy/ -->

В случае, если не используется Cilium, для реализации сервисов и настройки их сети в Deckhouse Kubernetes Platform можно использовать модуль `kube-proxy` (используется совместно с [cni-flannel](../../reference/mc/cni-flannel/) и [cni-simple-bridge](../../reference/mc/cni-simple-bridge/)).
Он удаляет весь комплект kube-proxy (`DaemonSet`, `ConfigMap`, `RBAC`) от `kubeadm` и устанавливает свой.

По умолчанию в целях безопасности при использовании сервисов с типом NodePort подключения принимаются только на InternalIP узлов. Для снятия данного ограничения предусмотрена аннотация на узел — `node.deckhouse.io/nodeport-bind-internal-ip: "false"`.

Пример аннотации для NodeGroup:

```yaml
apiVersion: deckhouse.io/v1
kind: NodeGroup
metadata:
  name: myng
spec:
  nodeTemplate:
    annotations:
      node.deckhouse.io/nodeport-bind-internal-ip: "false"
...
```

> После добавления, удаления или изменения значения аннотации необходимо самостоятельно выполнить рестарт подов kube-proxy.
>
> Модуль kube-proxy автоматически отключается при включении модуля [cni-cilium](../../reference/mc/cni-cilium/).
