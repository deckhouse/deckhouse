---
title: "Настройка внутренней сети"
permalink: ru/admin/network-configuration.html
lang: ru
---

## Настройка сети подов

В Deckhouse Kubernetes Platform для настройки сети подов используются CNI-плагины.
Сеть может быть настроена по одному из вариантов:

* C использованием VXLAN-туннеля.
* С использованием маршрутизации.

Выбор подходящего варианта зависит от особенностей сети кластера.

Если кластер построен на основе маршрутизируемой сети (узлы кластера в разных сетях), внутренняя сеть настраивается с использованием VXLAN.

Если узлы кластера находятся в одной сети, могут быть использованы оба варианта.
При этом нужно учитывать, что инкапсуляция VXLAN-пакетов приводит к уменьшению minimal transmission unit (MTU), а использование маршрутизации добавляет промежуточный узел на пути пакета.
На практике разница в скорости при использовании обоих вариантов настолько мала, что ей можно пренебречь.

> В DKP во всех инсталляциях рекомендуется использовать [Cilium](/#), т.к. он наиболее гибкий и имеет широкие возможности по настройке.
> Также этот плагин использует технологию ядра Linux eBPF, что обеспечивает эффективное использование ресурсов.

Для специфических задач можно использовать CNI-плагины Flannel и Simple Bridge, которые также поддерживаются Deckhouse Kubernetes Platform.

### Выбор режима работы туннеля в Cilium

Режим работы устанавливается в настройках модуля cni-cilium (параметр `tunnelMode`).

<!-- перенесено с изменениями из https://deckhouse.ru/products/kubernetes-platform/documentation/latest/modules/cni-cilium/#%D1%81%D0%BC%D0%B5%D0%BD%D0%B0-%D1%80%D0%B5%D0%B6%D0%B8%D0%BC%D0%B0-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%8B-cilium -->

> После смены режима работы Cilium перезагрузите все узлы, иначе возможны проблемы с доступностью подов.

Чтобы изменить режим работы туннеля, задайте требуемое значение параметра `tunnelMode` в настройках модуля cni-cilium.

Для настройки модуля используйте ресурс `ModuleConfig` с именем `cni-cilium`.

Пример ресурса `ModuleConfig/cni-cilium` для настройки модуля (изменение режима работы туннеля):

```yaml
apiVersion: deckhouse.io/v1alpha1
kind: ModuleConfig
metadata:
  name: cni-cilium
spec:
  version: 1
  enabled: true
  settings:
    tunnelMode: VXLAN
```

[Подробнее о настройках](/#) модуля `cni-cilium`.

## Настройка сети сервисов

Сервисы позволяют предоставлять доступ к группам подов, выполняющих одинаковые функции, и реализовать балансировку трафика между ними.
Каждый объект Service определяет логический набор конечных точек (подов), а также политику того, как сделать эти поды доступными.

Deckhouse Kubernetes Platform поддерживает следующие типы сервисов:

<!-- информация из обучающих материалов -->

* ClusterIP. Создаёт внутренний IP-адрес, который выбирается из сети сервисов. Весь трафик с этого IP перенаправляется на поды, указанные в селекторе. Тем самым обеспечивается балансировка.
В этом типе сервиса можно отказаться от назначения IP-адреса. В таком случае адрес из сети сервисов не будет назначаться, а сам сервис при обращении будет резолвиться в IP-адреса подов. Балансировка будет работать на round-robin DNS.
* NodePort. Открывает порт на каждом узле кластера и перенаправляет трафик, который приходит на этот порт, в поды, указанные в селекторе.
Из соображений безопасности в Deckhouse порт слушается только на внутреннем IP узлов. Это поведение можно изменить, если добавить аннотацию `node.deckhouse.io/nodeport-bind-internal-ip: "false"` на группу узлов.
* LoadBalancer. Это специальный тип сервисов. Он создаётся в облачном провайдере, на котором установлена Deckhouse Kubernetes Platform, и позволяет принимать трафик извне кластера. Для bare-metal-кластеров поддержку таких сервисов можно добавить с помощью модуля MetalLB.
* ExternalName. По сути, это просто CNAME DNS-запись, созданная в кластерном DNS.

Пример настроек сервиса ClusterIP:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-app-service  # Имя сервиса
  namespace: default    # Namespace, в котором создается сервис
  labels:
    app: my-app         # Метка для связи с подами
spec:
  type: ClusterIP       # Тип сервиса — ClusterIP
  selector:
    app: my-app         # Селектор для выбора подов, которые будут частью сервиса
  ports:
    - protocol: TCP     # Протокол (TCP или UDP)
      port: 80          # Порт, на котором сервис будет доступен внутри кластера
      targetPort: 8080  # Порт, на котором работает приложение в подах
  selector:
    app: my-app         # Селектор для выбора подов с меткой app=my-app
```
