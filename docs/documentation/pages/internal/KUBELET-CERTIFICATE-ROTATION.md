---
title: "Ротация сертификатов kubelet"
description: "Описание процесса ротации сертификатов kubelet"
---

Перед чтением данного документа желательно ознакомиться с официальной [документацией](https://kubernetes.io/docs/tasks/tls/certificate-rotation/) по ротации сертификатов kubelet.

В файле `/var/lib/kubelet/config.yaml` хранится конфигурация kubelet, в этом файле может быть указан путь к сертификату(`tlsCertFile`) и закрытому ключу(`tlsPrivateKeyFile`).

В kubelet реализована следующая логика работы с серверными сертификатами:
* Если `tlsCertFile` и `tlsPrivateKeyFile` не пустые, то kubelet будет использовать их как сертификат и ключ по умолчанию. 
    - Если клиент делает запрос в kubelet API с указанием IP адреса(например https://10.1.1.2:10250/), то для установления соединения по TLS протоколу будет использован закрытый ключ по умолчанию(`tlsPrivateKeyFile`). В данном случае ротация сертификатов не будет работать.
    - Если клиент делает запрос в kubelet API с указанием названия хоста(например https://k8s-node:10250/), то для установления соединения по TLS протоколу будет использован динамически сгенерированный закрытый ключ из директории `/var/lib/kubelet/pki/`. В данном случае ротация сертификатов будет работать.

* Если `tlsCertFile` и `tlsPrivateKeyFile` пустые, то для установления соединения по TLS протоколу будет использован динамически сгенерированный закрытый ключ из директории `/var/lib/kubelet/pki/`. В данном случае ротация сертификатов будет работать.

Поскольку в Deckhouse platform для запросов в kubelet API используются IP адреса, то в конфигурации kubelet поля `tlsCertFile` и `tlsPrivateKeyFile` не используются, а используется динамический сертификат, который kubelet генерирует самостоятельно. Также в модуле `operator-trivy` отключены проверки CIS benchmark `AVD-KCV-0088` и `AVD-KCV-0089` которые проверяют были ли переданы аргументы `--tls-cert-file` и `--tls-private-key-file` для kubelet.

Kubelet использует клиентский TLS сертификат(`/var/lib/kubelet/pki/kubelet-client-current.pem`) при помощи которого kubelet может запросить у kube-apiserver новый клиентский сертификат или новый серверный сертификат(`/var/lib/kubelet/pki/kubelet-server-current.pem`).

Когда до истечения времени жизни сертификата остается 5-10%(случайное значение из диапазона) времени, то kubelet запрашивает у kube-apiserver новый сертификат([описание алгоритма](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-tls-bootstrapping/#bootstrap-initialization)).

Не рекомендуется устанавливать слишком маленькое время жизни сертификатов(рекомендуемое значение не меньше 1 часа), так как kubelet может не успеть обновить сертификат до его истечения. Время жизни сертификатов можно установить с помощью cli аргумента `--cluster-signing-duration` в манифесте `/etc/kubernetes/manifests/kube-controller-manager.yaml`. По умолчанию это значение равно 1 году.

Если истекло время жизни клиентского сертификата, то kubelet не сможет делать запросы к kube-apiserver и не сможет обновить сертификаты. В данном случае узел(Node) будет помечен как `NotReady` и пересоздан.
