---
title: Каналы обновлений
permalink: ru/architecture/updating.html
lang: ru
---

## Каналы обновлений

{% capture asset_url %}{%- css_asset_tag releases %}[_assets/css/releases.css]{% endcss_asset_tag %}{% endcapture %}
<link rel="stylesheet" type="text/css" href='{{ asset_url | strip_newlines  | true_relative_url }}' />

{%- assign releases = site.data.releases.channels | sort: "stability" -%}

{% alert level="info" %}
Актуальная информация о версиях DKP на разных каналах обновлений доступна на сайте [releases.deckhouse.ru](https://releases.deckhouse.ru).
{% endalert %}

Deckhouse Kubernetes Platform (DKP) использует **пять каналов обновлений**, обеспечивающих поэтапное развертывание новых версий.
Каждая новая версия DKP сначала публикуется в канале **Alpha** и постепенно продвигается к **Rock Solid**.
Обновления из менее стабильных каналов доступны небольшому числу пользователей, что позволяет выявлять и устранять потенциальные проблемы, прежде чем они затронут production-среды.

<div id="releases__stale__block" class="releases__info releases__stale__warning" >
  <strong>Внимание!</strong> В этом кластере не используется какой-либо канал обновлений.
</div>

{%- assign channels_sorted = site.data.releases.channels | sort: "stability" %}
{%- assign channels_sorted_reverse = site.data.releases.channels | sort: "stability" | reverse  %}

<div class="page__container page_releases" markdown="0">
<div class="releases__menu">
{%- for channel in channels_sorted_reverse %}
    <div class="releases__menu-item releases__menu--channel--{{ channel.name }}">
        <div class="releases__menu-item-header">
            <div class="releases__menu-item-title releases__menu--channel--{{ channel.name }}">
                {{ channel.title }}
            </div>
        </div>
        <div class="releases__menu-item-description">
            {{ channel.description[page.lang] }}
        </div>
    </div>
{%- endfor %}
</div>
</div>

## Процесс переключения на более стабильный канал

При переключении на более стабильный канал (например, с `Alpha` на `EarlyAccess`):

1. DKP скачивает данные о релизах из канала `EarlyAccess`.
1. Сравнивает их с данными из существующих в кластере кастомных ресурсов DeckhouseRelease.
   - Если в кластере есть более поздние релизы со статусом `Pending` (ещё не применены), они будут **удалены**, поскольку они отсутствуют на новом канале.
   - Если более поздние релизы уже перешли в статус `Deployed` (успешно установлены), переход на новый релиз произойдёт не сразу. DKP останется на текущем релизе до тех пор, пока на канале `EarlyAccess` не выйдет более поздняя версия, которую можно будет установить.

### Процесс переключения на менее стабильный канал

При переключении на менее стабильный канал (например, с `EarlyAccess` на `Alpha`):

1. DKP скачивает данные о релизах из канала `Alpha`.
1. Сравнивает их с данными из существующих в кластере кастомных ресурсов DeckhouseRelease.
1. Выполняет обновление в соответствии [с настроенными параметрами обновления](configuration.html).


## Обновление control plane

В Deckhouse Kubernetes Platform (DKP) процесс обновления control plane максимально автоматизирован и безопасен как для single-master-, так и для multi-master-кластеров. При этом могут возникать кратковременные перерывы в доступности API-сервера, однако на работу приложений внутри кластера обновление control plane не влияет. Дополнительное окно для регламентных работ, как правило, не требуется.

В DKP поддерживаются последние пять минорных версий Kubernetes. Полный список актуальных версий доступен [в разделе справки](#TODO).

### Обновление патч-версий

Обновление патч-версий (например, с `1.27.3` на `1.27.5`) происходит автоматически вместе с обновлением версии DKP.
Управлять таким обновлением невозможно.

### Обновление минорных версий

Обновить минорную версию (например, с `1.26.*` на `1.28.*`) можно несколькими способами:

- C помощью параметра `kubernetesVersion` в ресурсе ClusterConfiguration (#TODO):
  - Чтобы обновлять control plane **в автоматическом режиме**, укажите параметр `kubernetesVersion: Automatic`.
    При этом для обновления будет использоваться минорная версия Kubernetes, используемая в DKP по умолчанию на момент обновления (#TODO).
  - Чтобы обновить control plane **вручную**, явно укажите необходимую версию в параметре. Например, `kubernetesVersion: 1.30`.
- С помощью команды редактирования ресурса ClusterConfiguration:
  
  ```shell
  sudo -i d8 k -n d8-system exec -it svc/deckhouse-leader -c deckhouse -- deckhouse-controller edit cluster-configuration
  ```

  Команда запускает обновление до минорной версии Kubernetes, используемой в DKP по умолчанию на момент обновления (#TODO).
  
  Чтобы отследить ход обновления, ориентируйтесь на версию Kubernetes, указанную в выводе команды описания узлов:

  ```shell
  sudo -i d8 k get nodes
  ```
  
### Процесс обновления компонентов control plane

1. Модуль `control-plane-manager` вносит изменения в манифесты основных компонентов (`apiserver`, `controller-manager`, `scheduler` и др.).
2. Обновлённые компоненты разворачиваются на всех master-узлах.

При обновлении до новой минорной версии (**upgrade**):

- Если нужно поднять версию сразу на несколько минорных релизов (например, с `1.26` до `1.28`), обновление происходит поэтапно: с `1.26` до `1.27` и затем с `1.27` до `1.28`.
- На каждом этапе сначала обновляется control plane, а затем выполняется обновление kubelet на узлах.

При откате до предыдущей версии (**downgrade**):

- Гарантируется успешный откат только на одну минорную версию назад от максимальной версии, когда-либо использовавшейся в кластере.
- Откат происходит в обратном порядке. Сначала откатываются компоненты kubelet на узлах, затем — компоненты control plane.

После обновления control plane начинается обновление узлов кластера:

1. Bashible API Server меняет версию kubelet в скриптах для всех групп узлов (NodeGroup).
1. Обновление узлов в разных NodeGroup идёт параллельно, однако внутри каждой NodeGroup узлы обновляются последовательно, по одному.
1. Для каждой NodeGroup учитываются её настройки:
   - ручной или автоматический режим обновления;
   - наличие окон обновлений;
   - требуется ли удалять поды с узла перед обновлением и др.
1. Выбирается один (или несколько) узлов-кандидатов, удовлетворяющих всем условиям обновления, после чего выполняется их обновление.
1. Процесс повторяется, пока не обновятся все узлы во всех группах.
1. Когда обновлены все узлы во всех группах, процесс обновления завершается.


## Получение истории изменений (changelog)


При каждом выпуске новой версии Deckhouse Kubernetes Platform (DKP) формируется *changelog* — подробный список изменений, включающий новые возможности, исправления ошибок, обновления компонентов, а также важные замечания по совместимости.

Changelog для конкретной версии DKP можно найти [в общем списке релизов проекта Deckhouse на GitHub](https://github.com/deckhouse/deckhouse/releases).

Сводная информация о ключевых изменениях, обновлениях версий компонентов, а также о том, какие компоненты в кластере будут перезапущены в процессе обновления, доступна в описании нулевой патч-версии релиза: [пример для релиза DKP v1.68](https://github.com/deckhouse/deckhouse/releases/tag/v1.68.0).

## Содержимое changelog

Changelog содержит четыре раздела:

- **Know before update (важно знать перед обновлением)** — важная информация, которую необходимо учесть перед обновлением. Включает сведения о требованиях к совместимости, необходимых действиях перед обновлением и возможных последствиях для кластера.
- **Features (новые возможности)** — описание ключевых улучшений и новых функций, добавленных в релизе.
- **Fixes (исправления)** — описание незначительных изменений, обновлений безопасности или улучшения производительности.
- **Chore (сервисные изменения)** — перечисление технических изменений, которые включают обновления зависимостей, рефакторинг, исправления в процессах сборки и тестирования, а также устранение уязвимостей.

## Минорные версии и нулевая патч-версия

Вся ключевая информация о крупных изменениях добавляется в **нулевую патч-версию** релиза (например, `v1.68.0` для релиза `v1.68`). Перед обновлением до новой минорной версии (например, `v1.68`):

1. Изучите changelog соответствующей версии.
1. Проверьте, затрагивают ли изменения вашу инфраструктуру.
1. При необходимости внести корректировки в конфигурацию кластера перед обновлением.


