---
title: "Архитектура режимов работы с хранилищем образов"
permalink: ru/architecture/registry-modes.html
lang: ru
---

Deckhouse Kubernetes Platform поддерживает несколько режимов работы с хранилищем образов контейнеров.

## Архитектура режима Direct

В режиме `Direct` запросы к хранилищу образов контейнеров обрабатываются напрямую, без промежуточного кеширования.

Запросы к хранилищу образов от CRI перенаправляются при помощи его настроек, которые указываются в конфигурации `containerd`.

В случае таких компонентов, как [operator-trivy](/modules/operator-trivy/), `image-availability-exporter`, `deckhouse-controller` и ряда других, обращающихся к хранилищу образов напрямую, запросы будут идти через in-cluster proxy, расположенный на master-узлах.

<!--- Source: mermaid code from docs/internal/DIRECT.md --->
![direct](../images/registry-module/direct-ru.png)

Подробнее о режиме `Direct` — в разделе [«Работа с хранилищами образов контейнеров и редакциями»](../admin/configuration/registry/internal.html).

## Архитектура режима Proxy

{% alert level="warning" %}
Рекомендуется использовать разные диски для хранения данных хранилища образов контейнеров (`/opt/deckhouse/registry`) и etcd. Использование одного диска может привести к деградации производительности etcd при одновременных операциях с хранилищем образов контейнеров.
{% endalert %}

`Proxy` режим позволяет хранилищу образов выступать в качестве промежуточного прокси-сервера между клиентом и удалённым хранилищем.

Кеширующее proxy хранилище образов запускается в виде статических подов на узлах control-plane (master). Кешируемые данные хранятся на control-plane (master) узлах в директории `/opt/deckhouse/registry`.

Для обеспечения высокой доступности к кеширующему proxy хранилищу образов используется балансировщик, установленный на каждый узел кластера. CRI обращается к proxy хранилищу образов через балансировщик. Настройки для обращения к балансировщику указываются в конфигурации `containerd`.

В случае таких компонентов, как `operator-trivy`, `image-availability-exporter`, `deckhouse-controller` и ряда других, обращающихся к хранилищу образов напрямую, запросы будут идти через кеширующее proxy хранилище образов.

<!--- Source: mermaid code from docs/internal/PROXY.md --->
![proxy](../images/registry-module/proxy-ru.png)

Подробнее о режиме `Proxy` — в разделе [«Работа с хранилищами образов контейнеров и редакциями»](../admin/configuration/registry/internal.html).

## Архитектура режима Local

{% alert level="warning" %}
Рекомендуется использовать разные диски для хранения данных хранилища образов контейнеров (`/opt/deckhouse/registry`) и etcd. Использование одного диска может привести к деградации производительности etcd при одновременных операциях с хранилищем образов контейнеров.
{% endalert %}

`Local` режим позволяет создавать локальную копию хранилища образов внутри кластера. Образы из удалённого хранилища полностью скопированы в локальное хранилище и синхронизированы между репликами локального хранилища образов.

Работа локального хранилища образов идентична работе кеширующего proxy хранилища. Локальное хранилища образов запускается в виде статических подов на узлах control-plane (master). Данные хранилища образов хранятся на control-plane (master) узлах в директории `/opt/deckhouse/registry`.

Для обеспечения высокой доступности к локальному хранилищу образов используется балансировщик, установленный на каждый узел кластера. CRI обращается к локальному хранилищу образов через балансировщик. Настройки для обращения к балансировщику указываются в конфигурации `containerd`.

В случае таких компонентов, как `operator-trivy`, `image-availability-exporter`, `deckhouse-controller` и ряда других, обращающихся к хранилищу образов напрямую, запросы будут идти в локальное хранилище.

Локальное хранилище образов наполняется с помощью инструмента [`d8`](/products/kubernetes-platform/documentation/v1/cli/d8/) (команды `d8 mirror push/pull`). Подробнее — в разделе [«Модуль registry: примеры использования»](/modules/registry/examples.html).

<!--- Source: mermaid code from docs/internal/LOCAL.md --->
![local](../images/registry-module/local-ru.png)

Подробнее о режиме `Local` — в разделе [«Работа с хранилищами образов контейнеров и редакциями»](../admin/configuration/registry/internal.html).
