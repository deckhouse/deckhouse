---
title: "Версионирование модуля"
permalink: ru/module-development/versioning/
lang: ru
---

Для версионирования модулей используется [семантическое версионирование](https://semver.org/lang/ru/). Какую версию поднимать, выбирается следующим образом:

**Patch-версия** — исправление дефекта.

**Minor-версия** — добавление новой функции.

**Major-версия** — добавление функции, которая кардинально меняет возможности модуля. Масштабное изменение интерфейса или завершение крупного этапа работы.

Перед номером версии в теге git и контейнере registry всегда добавляется буква "v". Примеры: `v0.0.73`, `v1.0.0`.

<!-- Максим сказал убрать ## Changelog

Для добавления информации об изменениях в релиз модуля, необходимо создать файл `changelog.yaml` в образ релиза. Данные в этом файле должны быть в формате `map[string]any`.

Например:

```yaml
features:
    - point A
    - point B
    - point C
fixes:
    - fix 1
    - fix 2
chore:
    some information that you need to know
```

Вложенная информация будет доступна в объекте *ModuleRelease* в кластере. -->

## Каналы стабильности

Выпущенная версия модуля перемещается по [каналам стабильности](../../deckhouse-release-channels.html), от менее стабильных к более стабильным: `Alpha`, `Beta`, `EarlyAccess`, `Stable`, `RockSolid`.

Каналы стабильности позволяют опубликовать только что выпущенную версию для ограниченного числа пользователей и получить обратную связь на раннем этапе. Выбор канала стабильности остается за пользователем.

Важно понимать, что выбор канала не определяет, насколько стабилен модуль и на какой стадии жизненного цикла он находится. Каналы являются инструментом доставки и определяют степень стабильности конкретного релиза.

## Стадия жизненного цикла модуля

Во время разработки модуль может находиться на следующих стадиях:

**Sandbox** – это начальная стадия для каждого нового модуля. На этом этапе модуль можно включить и использовать, но у него еще нет большого количества установок.

**Incubating** – на этой стадии у модуля уже есть достаточное количество установок и отзывов, чтобы убедиться в его работоспособности для большинства пользователей.

**Graduated** – эта стадия является финальной и стабильной. На ней модуль считается достаточно стабильным для массового использования.

**Deprecated** – этот статус присваивается модулям, которые объявлены устаревшими. Они не будут получать обновлений и будут выведены из обращения после определенного периода времени. Пользователи будут уведомлены о всех таких модулях, включенных в кластер.

## Как понять, насколько модуль стабилен?

В зависимости от этапа жизненного цикла модуля и канала обновлений, из которого была установлена версия модуля, общая стабильность может быть определена в соответствии со следующей таблицей:

![Module_Stability](../../images/module-development/module_stability.png)

Выводы:
- Модуль на стадии `Sandbox` в канале `Stable` не рекомендуется использовать в production-средах.
- Модуль на стадии `Graduated` в канале `Alpha`, также не рекомендуется использовать в production-средах.
- Для production-сред подходят только модули находящиеся на стадии `Graduated`, установленные из каналов `EarlyAccess`, `Stable`, или `RockSolid`.
- Модули находящиеся на стадии `Deprecated` рекомендуется заменить согласно рекомендациям в документации.

## Стадии отдельных возможностей модуля

Ресурс *ModuleConfig* позволяет управлять дополнительными возможностями модуля. Эти опции могут быть помечены как `Sandbox`, `Incubating`, `Graduated` или `Deprecated` в параметре `x-feature-stage` в схеме OpenAPI `x-feature-stage: Sandbox|Incubating|Graduated|Deprecated` (значение по умолчанию — `Stable`).

При включении функций на стадии, отличной от `Graduated`, выдается предупреждение.

В настройках Deckhouse Kubernetes Platform (DKP) можно задать глобальные правила, определяющие, какие функции и на каком этапе могут быть включены в кластере. Это помогает предотвратить случайное использование Sandbox функций в рабочих средах.

## Версионирование API

Модули в DKP используют кастомные ресурсы для взаимодействия с пользователями. Параметр `apiVersion` с версией API этих ресурсов обновляется в соответствии со следующими правилами:

- `v1alphaX` — только что опубликованный API. Нужно проверить, насколько он удобен и понятен для пользователей, а также насколько корректны и логичны его настройки.
- `v1betaX` — API прошел первичное тестирование. Продолжается его логическое развитие и доработка.
- `v1stableX` — стабильный API. С этого момента его поля не удаляются из спецификации и правила валидации не меняются в сторону большей строгости.

Можно выпустить новую версию API v2, которая проходит те же этапы, но с префиксом `v2`. Важно помнить, что после выпуска версии `v1stableX`, Kubernetes будет считать её более приоритетной, чем `alpha` или `beta` версии, до выпуска новой стабильной версии `v2stableX`. При выполнении команд `kubectl apply` и `kubectl edit`, будет использоваться именно `v1stableX`.

Причины для выпуска новой версии:
* поменять структуру;
* обновить устаревшие параметры.

Добавлять новые параметры можно без изменения версии.

При выходе новой версии *CustomResourceDefinition* (CRD):
* Предыдущим версиям проставляется параметр [`deprecated: true`][crd-deprecation].
* [Storage-версия][crd-storage-version] (версия, в которой данные хранятся внутри etcd) меняется не ранее, чем через два месяца после выхода новой версии.

---
[crd-deprecation]: https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/#version-deprecation
[crd-storage-version]: https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/#upgrade-existing-objects-to-a-new-stored-version
[semver]: https://semver.org/
