{%- assign moduleName = page['module-kebab-name'] %}

{%- assign moduleMetadata = site.data.modules.metadata.modules[moduleName] %}
{%- if moduleMetadata %}
  {%- assign moduleRequirements = moduleMetadata['requirements'] %}
{%- endif %}

{%- comment -%}
Show module requirements.
{%- endcomment -%}
{%- if moduleRequirements and moduleRequirements.size > 0 %}
## {{ site.data.i18n.common.requirements_title[page.lang] }}
<div markdown="0">
  {%- if moduleRequirements.kubernetes %}
    {%- capture formattedVersion -%}
      {%- include format-version-requirement.liquid version=moduleRequirements.kubernetes -%}
    {%- endcapture -%}
    <p>{{ site.data.i18n.common.requirements_kubernetes_title[page.lang] }}: {{ formattedVersion | strip }}.</p>
  {%- endif %}

  {%- if moduleRequirements.deckhouse %}
    {%- capture formattedVersion -%}
      {%- include format-version-requirement.liquid version=moduleRequirements.deckhouse -%}
    {%- endcapture -%}
    <p>{{ site.data.i18n.common.requirements_deckhouse_title[page.lang] }}: {{ formattedVersion | strip }}.</p>
  {%- endif %}

  {%- if moduleRequirements.modules and moduleRequirements.modules.size > 0 %}
  <p>{{ site.data.i18n.common.requirements_modules_title[page.lang] }}:
    <ul>
      {%- for moduleReq in moduleRequirements.modules %}
        {%- assign moduleName = moduleReq[0] %}
        {%- assign moduleVersion = moduleReq[1] %}
        {%- if moduleVersion == ">= 0.0.0" %}
          {%- assign formattedValue = site.data.i18n.common.requirements_modules_any_version[page.lang] | append: "." %}
        {%- else %}
          {%- capture formattedValue -%}
            {%- include format-version-requirement.liquid version=moduleVersion -%}
          {%- endcapture -%}
          {%- assign formattedValue = formattedValue | strip | append: "." %}
        {%- endif %}
        <li class="module-requirements__item">
          <code>{{ moduleName }}</code>: {{ formattedValue }}
        </li>
      {%- endfor %}
    </ul>
  </p>
  {%- endif %}
</div>

{%- endif %}

{%- comment -%}
Show module conversions.

Use conversions from docs/documentation/_data/conversions.yml, which is generated by tools/helm_generate/runners/conversion/conversion.go (make generate)
{%- endcomment -%}
{%- if site.data.conversions[moduleName].size > 0 %}

{%- assign moduleConversions = site.data.conversions[moduleName] %}

## {{ site.data.i18n.common.conversions[page.lang] }}

{% if moduleName == "global" %}
{{ site.data.i18n.common.conversion_global_action_message[page.lang] }}:
{% else %}
{{ site.data.i18n.common.conversion_action_message[page.lang] }}:
{% endif %}

<div markdown="0">
<ul>
{%- for conversion in moduleConversions %}

{%- assign conversionVersion =  conversion.version %}
{%- assign conversionVersionPrev =  conversionVersion | minus: 1 %}

<li>{{ site.data.i18n.common.conversion_from_version[page.lang] | capitalize }} <strong>{{ conversionVersionPrev }}</strong> {{ site.data.i18n.common.conversion_to[page.lang] }} <strong>{{ conversionVersion }}</strong>:
  {% if conversion.description[page.lang] %}{{ conversion.description[page.lang] | strip_html | markdownify }}
    {% else %}{{ site.data.i18n.common.conversion_missing_description[page.lang] | append: '.' | strip_html | markdownify }}

  {% if conversion.conversions.size > 0 %}
    <div class="details" markdown="0">
      <p class="details__lnk">
        <a href="javascript:void(0)" class="details__summary">
          {{ site.data.i18n.common.conversion_expressions[page.lang] }}...
        </a>
      </p>
      <div class="details__content" markdown="0">
        <div class="expand" markdown="0">
          <ul>
            {% for conversionRule in conversion.conversions %}
              <li>
                {{ conversionRule |  prepend: '`' | append: '`' | escape | strip_html | markdownify }}
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  {% endif %}
  {% endif %}
</li>
{%- endfor %}
</ul>
</div>
{%- endif %}

