---
image: {{ $.ModuleName }}/{{ $.ImageName }}
fromImage: common/distroless
import:
- artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact
  add: /go/bin/yandex-csi-driver
  to: /bin/yandex-csi-driver
  before: setup
- artifact: {{ $.ModuleName }}/{{ $.ImageName }}-builder-artifact
  add: /builds/busybox-1.36.1/busybox
  to: /bin/busybox
  before: setup
- artifact: {{ $.ModuleName }}/{{ $.ImageName }}-util-linux-builder-artifact
  add: /builds/binaries
  to: /bin
  before: setup
  # includePaths:
  # - findfs
  # - findmnt
shell:
  setup:
    - /bin/busybox --install -s
docker:
  ENTRYPOINT: ["/bin/yandex-csi-driver"]
---
artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact
from: {{ $.Images.BASE_GOLANG_20_ALPINE }}
git:
- url: https://github.com/deckhouse/yandex-csi-driver
  to: /go/src/app
  tag: v0.10.0
  # stageDependencies:
  #   install:
  #   - '**/*'
mount:
- fromPath: ~/go-pkg-cache
  to: /go/pkg
shell:
  beforeInstall:
  - apk add --no-cache ca-certificates e2fsprogs findmnt xfsprogs blkid e2fsprogs-extra
  install:
  - cd /go/src/app
  - |
    VERSION=$(cat VERSION)
    CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a \
    -ldflags '-X github.com/deckhouse/yandex-csi-driver/driver.version=${VERSION}' \
    -o /go/bin/yandex-csi-driver \
    github.com/deckhouse/yandex-csi-driver/cmd/yandex-csi-driver
  # - chown 64535:64535 /go/bin/yandex-csi-driver
  # - chmod 0755 /go/bin/yandex-csi-driver
---
artifact: {{ $.ModuleName }}/{{ $.ImageName }}-builder-artifact
from: {{ $.Images.BASE_UBUNTU }}
shell:
  beforeInstall:
    - apt update
    - apt install -y wget bzip2 curl tar gcc make
  install:
    - mkdir /builds
    - cd /builds
    - wget -cO- https://busybox.net/downloads/busybox-1.36.1.tar.bz2 | tar -xjv 
    - cd busybox-1.36.1
    - make defconfig
    - sed 's/^.*CONFIG_STATIC .*$/CONFIG_STATIC=y/g' -i .config
    - make -j8
---
artifact: {{ $.ModuleName }}/{{ $.ImageName }}-util-linux-builder-artifact
from: {{ $.Images.BASE_UBUNTU }}
shell:
  beforeInstall:
    - apt update
    - |
      apt install -y wget bzip2 curl tar \
        gcc make automake autopoint \
        gettext pkg-config bison gettext \
        libtool libexpat1 libexpat1-dev libblkid-dev libsmartcols-dev libutempter-dev \
        build-essential
  install:
    - mkdir /builds
    - cd /builds
    - wget -qO- https://git.kernel.org/pub/scm/utils/util-linux/util-linux.git/snapshot/util-linux-2.39.2.tar.gz | tar -xzv --strip-components=1
    - export LDFLAGS="-Wl,-z,now -Wl,-z,relro -static -s"
    - export CFLAGS="-fPIC -pie -fstack-protector-all -O2 -D_FORTIFY_SOURCE=2 -static -s"
    - export SUID_CFLAGS=-static
    - export SUID_LDFLAGS=-static
    - export CPPFLAGS=-static
    - ./autogen.sh
    - autoconf
    - |
      ./configure \
        --enable-static \
        --enable-static-programs=fdisk,sfdisk,findmnt \
        --disable-pylibmount \
        --without-python
    - make LDFLAGS="--static" -j4 fdisk.static sfdisk.static findmnt
    - mkdir -p binaries
    - mv fdisk.static binaries/fdisk
    - mv sfdisk.static binaries/sfdisk
    - mv findmnt binaries/findmnt
