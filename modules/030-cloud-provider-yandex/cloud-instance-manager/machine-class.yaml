apiVersion: machine.sapcloud.io/v1alpha1
kind: YandexMachineClass
metadata:
  name: {{ .nodeGroup.name }}-{{ printf "%v%v" .Values.global.discovery.clusterUUID .zoneName | sha256sum | trunc 8 }}
  namespace: d8-cloud-instance-manager
{{ include "helm_lib_module_labels" (list .) | indent 2 }}
spec:
  regionID: {{ .Values.nodeManager.internal.cloudProvider.yandex.region }}
  zoneID: {{ .zoneName }}
  platformID: {{ .nodeGroup.instanceClass.platformID }}
  resourcesSpec:
    cores: {{ .nodeGroup.instanceClass.cores }}
    coreFraction: {{ .nodeGroup.instanceClass.coreFraction | default 100 }}
    memory: {{ mul .nodeGroup.instanceClass.memory 1024 1024 }}
    gpus: {{ .nodeGroup.instanceClass.gpus | default 0 }}
  bootDiskSpec:
    autoDelete: true
    typeID: {{ .nodeGroup.instanceClass.diskType }}
    size: {{ mul (.nodeGroup.instanceClass.diskSizeGB | default 50) 1024 1024 1024 }}
    imageID: {{ .nodeGroup.instanceClass.imageID }}
  networkInterfaceSpecs:
{{- if .nodeGroup.instanceClass.mainSubnet }}
  - subnetID: {{ .nodeGroup.instanceClass.mainSubnet }}
{{- else}}
  - subnetID: {{ index .Values.nodeManager.internal.cloudProvider.yandex.zoneToSubnetIdMap .zoneName }}
{{- end }}
{{- if hasKey .nodeGroup.instanceClass "assignPublicIPAddress" }}
    assignPublicIPAddress: {{ .nodeGroup.instanceClass.assignPublicIPAddress }}
{{- else }}
    assignPublicIPAddress: {{ .Values.nodeManager.internal.cloudProvider.yandex.shouldAssignPublicIPAddress }}
{{- end }}
{{- range .nodeGroup.instanceClass.additionalSubnets }}
  - subnetID: {{ . | quote }}
{{- end }}
{{- if .nodeGroup.instanceClass.preemptible }}
  schedulingPolicy:
    preemptible: true
{{- end }}
  labels:
  # These tags are mandatory as the safety controller uses them to identify VMs created by this controller.
    kubernetes-io-cluster-deckhouse-{{ .Values.global.discovery.clusterUUID | sha256sum | trunc 30 }}: "1"
    kubernetes-io-role-deckhouse-{{ .nodeGroup.name }}-{{ .zoneName }}: "1"
{{- $effectiveLabels := .Values.nodeManager.internal.cloudProvider.yandex.labels }}
{{- if hasKey .nodeGroup.instanceClass "additionalLabels" }}
  {{- $effectiveLabels = merge .nodeGroup.instanceClass.additionalLabels $effectiveLabels }}
{{- end }}
{{- range $k, $v := $effectiveLabels }}
    {{ $k }}: {{ $v }}
{{- end }}
  metadata:
    ssh-keys: "user:{{ .Values.nodeManager.internal.cloudProvider.yandex.sshKey }}"
  secretRef:
    namespace: d8-cloud-instance-manager
    name: {{ .nodeGroup.name }}-{{ printf "%v%v" .Values.global.discovery.clusterUUID .zoneName | sha256sum | trunc 8 }}
