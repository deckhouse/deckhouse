---
artifact: {{ .ModuleName }}/build-artifact
from: {{ .Images.BASE_GOLANG_20_BULLSEYE }}
mount:
- fromPath: ~/go-pkg-cache
  to: /go/pkg
shell:
  install:
  - apt-get update
  - apt-get install -y --no-install-recommends libelf-dev
  - |
    mkdir /build && \
    git clone --branch v1.2.0 --single-branch --depth 1 {{ $.SOURCE_REPO }}/libbpf/libbpf.git /build/libbpf && \
    make -j $(nproc) -C /build/libbpf/src BUILD_STATIC_ONLY=y LIBSUBDIR=lib install install_uapi_headers && \
    tar -czf /build/libbpf.tar.gz \
        /usr/lib/libbpf.a \
        /usr/lib/pkgconfig/libbpf.pc \
        /usr/include/bpf \
        /usr/include/linux/bpf.h \
        /usr/include/linux/bpf_common.h \
        /usr/include/linux/btf.h
  - git clone -b v2.2.0 --single-branch --depth 1 {{ $.SOURCE_REPO }}/cloudflare/ebpf_exporter.git /build/ebpf-exporter
  - cd /build/ebpf-exporter
  - CGO_LDFLAGS="-l bpf" GOPROXY={{ $.GOPROXY }} CGO_ENABLED=1 GOOS=linux GOARCH=amd64 go build -o ebpf_exporter -tags netgo -v -ldflags="-extldflags "-static" -X github.com/prometheus/common/version.Version=v2.2.0 -X github.com/prometheus/common/version.Branch=HEAD -X github.com/prometheus/common/version.Revision=92f7021 -X github.com/prometheus/common/version.BuildUser=root@a080aa47fbb1 -X github.com/prometheus/common/version.BuildDate=2023-10-18T20:41:37+00:00" ./cmd/ebpf_exporter
  - chown -R 64535:64535 ebpf_exporter
  - chmod 0700 ebpf_exporter
---
image: {{ .ModuleName }}/{{ .ImageName }}
fromImage: common/distroless
import:
- artifact: {{ .ModuleName }}/build-artifact
  add: /build/ebpf_exporter/ebpf_exporter
  to: /ebpf_exporter
  before: setup
docker:
  ENTRYPOINT: ["/ebpf_exporter"]

