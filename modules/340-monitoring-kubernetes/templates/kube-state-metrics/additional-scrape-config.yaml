---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: kube-state-metrics-main
  namespace: d8-monitoring
  {{- include "helm_lib_module_labels" (list . (dict "app" "kube-state-metrics" "prometheus" "main")) | nindent 2 }}
spec:
  attachMetadata:
    node: true
  endpoints:
    - port: https-metrics
      scheme: https
      bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
      tlsConfig:
        insecureSkipVerify: true
      honorLabels: true
      path: /main/metrics
      metricRelabelings:
        - sourceLabels: [__name__]
          targetLabel: __name__
          regex: kube_verticalpodautoscaler_labels_info
          replacement: kube_verticalpodautoscaler_labels
        - sourceLabels: [__name__]
          targetLabel: name
          regex: kube_verticalpodautoscaler_labels
          replacement: ''
        - action: labeldrop
          regex: customresource_version|customresource_kind|customresource_group
      relabelings:
        - regex: endpoint|namespace|pod|service
          action: labeldrop
        - targetLabel: scrape_endpoint
          replacement: main
        - targetLabel: job
          replacement: kube-state-metrics
        - sourceLabels: [__meta_kubernetes_node_label_node_deckhouse_io_group]
          targetLabel: node_group
  selector:
    matchLabels:
      app: kube-state-metrics
  namespaceSelector:
    matchNames:
      - d8-monitoring
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: kube-state-metrics-self
  namespace: d8-monitoring
  {{- include "helm_lib_module_labels" (list . (dict "app" "kube-state-metrics" "prometheus" "main")) | nindent 2 }}
spec:
  endpoints:
    - port: https-metrics
      scheme: https
      bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
      tlsConfig:
        insecureSkipVerify: true
      honorLabels: true
      path: /self/metrics
      relabelings:
        - regex: endpoint|namespace|pod|service
          action: labeldrop
        - targetLabel: scrape_endpoint
          replacement: main
        - targetLabel: job
          replacement: kube-state-metrics
  selector:
    matchLabels:
      app: kube-state-metrics
  namespaceSelector:
    matchNames:
      - d8-monitoring
