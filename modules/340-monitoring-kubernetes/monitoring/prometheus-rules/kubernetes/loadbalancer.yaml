- name: kubernetes.node
  rules:
    - alert: LoadBalancerServiceWithoutExternalIP
      expr: sum(kube_service_status_load_balancer_ingress or vector(0)) < sum(kube_service_spec_type{type="LoadBalancer"})
      for: 30m
      labels:
        severity_level: "4"
        tier: cluster
      annotations:
        plk_protocol_version: "1"
        plk_create_group_if_not_exists__cluster_has_node_alerts: "LoadBalancerServiceWithoutExternalIP,tier=cluster,prometheus=deckhouse,kubernetes=~kubernetes"
        plk_grouped_by__cluster_has_node_alerts: "LoadBalancerServiceWithoutExternalIP,tier=cluster,prometheus=deckhouse,kubernetes=~kubernetes"
        description: |-
          Checks whether the Load Balancer service has been started.

          On some cloud providers sometimes can't create node for LoadBalancer service.

          You can check services LoadBalancer status with command:
          kubectl get svc -A -o json | jq -r '.items[] | select(.spec.allocateLoadBalancerNodePorts == true) | "name: \(.metadata.name), ip: \(.status.loadBalancer.ingress[0].ip)"'
          For more information about not started LoadBalancer you can watch logs of cloud-controller-manager
        summary: Load balancer does not starts
