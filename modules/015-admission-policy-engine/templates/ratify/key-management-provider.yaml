{{- if and (.Values.admissionPolicyEngine.internal.bootstrapped) (.Values.admissionPolicyEngine.internal.ratify.enabled) }}
{{- $context := . }}
{{- range $sp := .Values.admissionPolicyEngine.internal.securityPolicies }}
{{- if $sp.spec.policies.verifyImageSignatures }}
{{- $spName := $sp.metadata.name }}
{{- range $id, $key := $sp.spec.policies.verifyImageSignatures.publicKeys }}
---
apiVersion: config.ratify.deislabs.io/v1beta1
kind: KeyManagementProvider
metadata:
  {{- include "helm_lib_module_labels" (list $context (dict "app" "ratify" "app.kubernetes.io/part-of" "gatekeeper")) | nindent 2 }}
  name: {{ printf "ratify-cosign-inline-key-%s-%d" $spName $id }}
spec:
  refreshInterval: ""
  type: inline
  parameters:
    contentType: key
    value: |
{{ $key | indent 6 }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
