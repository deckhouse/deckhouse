{{- if and (.Values.admissionPolicyEngine.internal.bootstrapped) (.Values.admissionPolicyEngine.internal.ratify.enabled) }}
---
apiVersion: config.ratify.deislabs.io/v1beta1
kind: Verifier
metadata:
  name: verifier-cosign
  {{- include "helm_lib_module_labels" (list . (dict "app" "ratify" "app.kubernetes.io/part-of" "gatekeeper")) | nindent 2 }}
spec:
  name: cosign
  artifactTypes: application/vnd.dev.cosign.artifact.sig.v1+json
  parameters:
    trustPolicies:
{{- range $sp := .Values.admissionPolicyEngine.internal.securityPolicies }}
{{- if $sp.spec.policies.verifyImageSignatures }}
{{- $spName := $sp.metadata.name }}
    - name: {{ printf "security-policy-%s" $spName }}
      version: 1.0.0
      scopes:
{{- range $ref := $sp.spec.policies.verifyImageSignatures.imageReferences }}
      - {{ $ref | quote }}
{{- end }}
      keys:
{{- range $id, $key := $sp.spec.policies.verifyImageSignatures.publicKeys }}
      - provider: {{ printf "ratify-cosign-inline-key-%s-%d" $spName $id }}
{{- end }}
      tLogVerify: false
{{- end }}
{{- end }}
{{- end }}
