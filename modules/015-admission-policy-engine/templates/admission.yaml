---
apiVersion: {{ include "helm_lib_get_api_version_by_kind" (list . "ValidatingAdmissionPolicy") }}
kind: ValidatingAdmissionPolicy
metadata:
  name: "deny-pods-with-skip-pss-label"
  {{- include "helm_lib_module_labels" (list . (dict "app" "gatekeeper")) | nindent 2 }}
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
      - apiGroups: [""]
        apiVersions: ["v1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["pods"]
  matchConditions:
    - name: 'exclude-virtualization'
      expression: '!(request.userInfo.groups.exists(e, (e == "system:serviceaccounts:d8-virtualization")))'
    - name: exclude-existing-label
      expression: >
        (
          (has(object.metadata) && has(object.metadata.labels) && 'security.deckhouse.io/skip-pss-check' in object.metadata.labels
            ? object.metadata.labels['security.deckhouse.io/skip-pss-check']
            : ''
          )
          !=
          (has(oldObject.metadata) && has(oldObject.metadata.labels) && 'security.deckhouse.io/skip-pss-check' in oldObject.metadata.labels
            ? oldObject.metadata.labels['security.deckhouse.io/skip-pss-check']
            : ''
          )
        )
  validations:
    - expression: >-
        (!has(object.metadata.labels) ||
         !('security.deckhouse.io/skip-pss-check' in object.metadata.labels) ||
         object.metadata.labels['security.deckhouse.io/skip-pss-check'] != 'true')
      message: "Pods with label 'security.deckhouse.io/skip-pss-check=true' are not allowed"
---
apiVersion: {{ include "helm_lib_get_api_version_by_kind" (list . "ValidatingAdmissionPolicyBinding") }}
kind: ValidatingAdmissionPolicyBinding
metadata:
  name: "deny-skip-pss-label-binding"
  {{- include "helm_lib_module_labels" (list . (dict "app" "gatekeeper")) | nindent 2 }}
spec:
  policyName: "deny-pods-with-skip-pss-label"
  matchResources:
    namespaceSelector: {}  # Applies to all namespaces
  validationActions: [Deny]

---
apiVersion: {{ include "helm_lib_get_api_version_by_kind" (list . "ValidatingAdmissionPolicy") }}
kind: ValidatingAdmissionPolicy
metadata:
  name: "deny-gatekeeper-webhook-operation-label"
  {{- include "helm_lib_module_labels" (list . (dict "app" "gatekeeper")) | nindent 2 }}
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
      - apiGroups: [""]
        apiVersions: ["v1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["pods"]
  validations:
    - expression: >-
        !(
          has(object.metadata)
          && has(object.metadata.labels)
          && "gatekeeper.sh/operation" in object.metadata.labels
          && object.metadata.labels["gatekeeper.sh/operation"] == "webhook"
        )
        || request.userInfo.username.startsWith("system:serviceaccount:d8-")
        || request.userInfo.username.startsWith("system:serviceaccount:kube-")
      reason: Forbidden
      message: "Pods with label 'gatekeeper.sh/operation=webhook' are not allowed" 
---
apiVersion: {{ include "helm_lib_get_api_version_by_kind" (list . "ValidatingAdmissionPolicyBinding") }}
kind: ValidatingAdmissionPolicyBinding
metadata:
  name: "deny-gatekeeper-webhook-operation-label-binding"
  {{- include "helm_lib_module_labels" (list . (dict "app" "gatekeeper")) | nindent 2 }}
spec:
  policyName: "deny-gatekeeper-webhook-operation-label"
  validationActions: [Deny]
---
apiVersion: {{ include "helm_lib_get_api_version_by_kind" (list . "ValidatingAdmissionPolicy") }}
kind: ValidatingAdmissionPolicy
metadata:
  name: "deny-gatekeeper-webhook-operation-label-controllers"
  {{- include "helm_lib_module_labels" (list . (dict "app" "gatekeeper")) | nindent 2 }}
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
      - apiGroups: ["apps"]
        apiVersions: ["v1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["deployments", "replicasets", "statefulsets", "daemonsets"]
        scope: "*"
      - apiGroups: ["batch"]
        apiVersions: ["v1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["jobs"]
        scope: "*"
  validations:
    - expression: |-
        !(has(object.spec.template.metadata.labels) &&
          object.spec.template.metadata.labels['gatekeeper.sh/operation'] == 'webhook')
        || request.userInfo.username.startsWith("system:serviceaccount:d8-")
        || request.userInfo.username.startsWith("system:serviceaccount:kube-")
      message: Setting gatekeeper.sh/operation=webhook in pod template is forbidden
---
apiVersion: {{ include "helm_lib_get_api_version_by_kind" (list . "ValidatingAdmissionPolicyBinding") }}
kind: ValidatingAdmissionPolicyBinding
metadata:
  name: "deny-gatekeeper-webhook-operation-label-controllers-binding"
  {{- include "helm_lib_module_labels" (list . (dict "app" "gatekeeper")) | nindent 2 }}
spec:
  policyName: deny-gatekeeper-webhook-operation-label-controllers
  validationActions: [Deny]
---
apiVersion: {{ include "helm_lib_get_api_version_by_kind" (list . "ValidatingAdmissionPolicy") }}
kind: ValidatingAdmissionPolicy
metadata:
  name: deny-gatekeeper-webhook-operation-label-controllers-cronjobs
  {{- include "helm_lib_module_labels" (list . (dict "app" "gatekeeper")) | nindent 2 }}
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
      - apiGroups: ["batch"]
        apiVersions: ["v1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["cronjobs"]
        scope: "*"
  validations:
    - expression: |-
        !(has(object.spec.jobTemplate.spec.template.metadata.labels) &&
          object.spec.jobTemplate.spec.template.metadata.labels['gatekeeper.sh/operation'] == 'webhook')
        || request.userInfo.username.startsWith("system:serviceaccount:d8-")
        || request.userInfo.username.startsWith("system:serviceaccount:kube-")
      message: Setting gatekeeper.sh/operation=webhook in CronJob pod template is forbidden
---
apiVersion: {{ include "helm_lib_get_api_version_by_kind" (list . "ValidatingAdmissionPolicyBinding") }}
kind: ValidatingAdmissionPolicyBinding
metadata:
  name: "deny-gatekeeper-webhook-operation-label-controllers-cronjobs-binding"
  {{- include "helm_lib_module_labels" (list . (dict "app" "gatekeeper")) | nindent 2 }}
spec:
  policyName: deny-gatekeeper-webhook-operation-label-controllers-cronjobs
  validationActions: [Deny]
