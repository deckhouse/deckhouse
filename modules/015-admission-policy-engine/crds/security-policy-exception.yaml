apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: securitypolicyexceptions.deckhouse.io
  labels:
    heritage: deckhouse
    module: admission-policy-engine
    backup.deckhouse.io/cluster-config: "true"
spec:
  group: deckhouse.io
  scope: Namespaced
  names:
    plural: securitypolicyexceptions
    singular: securitypolicyexception
    kind: SecurityPolicyException
  preserveUnknownFields: false
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          required: ["spec"]
          description: |
            Describes exceptions to the cluster's security policies.
            Each SecurityPolicyException resource defines a set of specific allowances.
          properties:
            status:
              type: object
              properties:
                deckhouse:
                  type: object
                  properties:
                    synced:
                      type: string
                      description: True if last observed version of the resource was successfully applied in the cluster.
                    observed:
                      type: object
                      description: Contains last timestamp when the resource change was noted by the operator and its checksum.
                      properties:
                        lastTimestamp:
                          type: string
                          description: A timestamp of when the operator last noted a change to the resource.
                        checkSum:
                          type: string
                          description: The checksum of last observed resource.
                    processed:
                      type: object
                      description: Contains last timestamp when the resource was applied in the cluster by the operator and its checksum.
                      properties:
                        lastTimestamp:
                          type: string
                          description: A timestamp of when the resource was last applied in the cluster.
                        checkSum:
                          type: string
                          description: The checksum of last applied resource.
            spec:
              type: object
              properties:
                securityContext:
                  type: object
                  description: Exceptions for parameters in the `securityContext` section.
                  properties:
                    readOnlyRootFilesystem:
                      type: object
                      description: Exceptions for the `readOnlyRootFilesystem` parameter.
                      required: ["allowedValue"]
                      properties:
                        allowedValue:
                          type: boolean
                          default: false
                          description: Allowed value for `readOnlyRootFilesystem`.
                        metadata:
                          type: object
                          description: Metadata related to the exception.
                          additionalProperties: true
                    allowPrivilegeEscalation:
                      type: object
                      description: Exceptions for the `allowPrivilegeEscalation` parameter.
                      properties:
                        allowedValue:
                          type: boolean
                          default: false
                          description: Allowed value for `allowPrivilegeEscalation`.
                        metadata:
                          type: object
                          description: Metadata related to the exception.
                          additionalProperties: true                          
                      required: ["allowedValue"]
                    capabilities:
                      type: object
                      description: Exceptions for the `capabilities` parameter.
                      properties:
                        allowedValues:
                          type: object
                          description: Allowed values for adding or dropping Linux capabilities.
                          properties:
                            drop:
                              type: array
                              description: List of capabilities that are allowed to be dropped from the container.
                              default: ["all"]
                              items:
                                type: string
                            add:
                              type: array
                              description: List of capabilities that are allowed to be added to the container.
                              default: []
                              items:
                                type: string
                        metadata:
                          type: object
                          description: Metadata related to the exception.
                          additionalProperties: true
                      required: ["allowedValues"]
                    runAsUser:
                      type: object
                      description: Exceptions for the `runAsUser` parameter.
                      properties:
                        allowedValues:
                          type: array
                          description: List of allowed user IDs (UIDs).
                          items:
                            type: integer
                        metadata:
                          type: object
                          description: Metadata related to the exception.
                          additionalProperties: true                          
                      required: ["allowedValues"]
                    runAsNonRoot:
                      type: object
                      description: Exceptions for the `runAsNonRoot` parameter.
                      properties:
                        allowedValue:
                          type: boolean
                          default: true
                          description: Allowed value for `runAsNonRoot`.
                        metadata:
                          type: object
                          description: Metadata related to the exception.
                          additionalProperties: true                          
                      required: ["allowedValue"]
                    seccompProfile:
                      type: object
                      description: Exceptions for the `seccompProfile` parameter.
                      properties:
                        allowedValues:
                          type: array
                          description: List of allowed seccomp profiles.
                          items:
                            type: string
                        metadata:
                          type: object
                          description: Metadata related to the exception.
                          additionalProperties: true                          
                      required: ["allowedValues"]
                    appArmorProfile:
                      type: object
                      description: |
                        List of allowed AppArmor profile values for pods and containers.

                        Supported formats:

                        - Via annotations: `runtime/default`, `docker/default`, `unconfined`, `localhost/some-profile.json`.
                          `localhost/*` allows any local profile.
                        - Via `securityContext`: `RuntimeDefault`, `Unconfined`, `Localhost`.
                          For `Localhost`, specify allowed profiles using the `allowedLocalhostFiles` parameter.

                        Profile types:

                        - `Unconfined`: No restrictions (not recommended for security reasons).
                        - `RuntimeDefault`: The default profile provided by the container runtime (such as Docker or CRI-O).
                        - `Localhost`: A custom profile defined on the host and tailored for the application.

                        Using `*` allows all profiles. It's not necessary to specify both formats as they are automatically mapped to each other.
                      properties:
                        allowedValues:
                          type: array
                          description: |
                            Allowed values:

                            - `runtime/default`
                            - `unconfined`
                            - `localhost/*` (where `*` may be a profile name or a wildcard)
                          items:
                            type: string
                            pattern: '^(runtime\/default|unconfined|localhost\/.+)$'
                        metadata:
                          type: object
                          description: Metadata related to the exception.
                          additionalProperties: true                          
                      required: ["allowedValues"]
                    seLinuxOptions:
                      type: object
                      description: Exceptions for the `seLinuxOptions` parameter.
                      properties:
                        allowedValues:
                          type: array
                          description: List of allowed SELinux configurations.
                          items:
                            type: object
                            properties:
                              user:
                                type: string
                                description: SELinux user label.
                              role:
                                type: string
                                description: SELinux role label.
                              type:
                                type: string
                                description: SELinux type label.
                              level:
                                type: string
                                description: SELinux level label.
                        metadata:
                          type: object
                          description: Metadata related to the exception.
                          additionalProperties: true                          
                      required: ["allowedValues"]
                    privileged:
                      type: object
                      description: Exceptions for the `privileged` parameter.
                      properties:
                        allowedValue:
                          type: boolean
                          default: false
                          description: Allowed value for `privileged`.
                        metadata:
                          type: object
                          description: Metadata related to the exception.
                          additionalProperties: true                          
                      required: ["allowedValue"]
                    procMount:
                      type: object
                      description: Exceptions for the `procMount` parameter.
                      properties:
                        allowedValues:
                          type: array
                          description: List of allowed `procMount` values.
                          items:
                            type: string
                            enum: ["Default", "Unmasked"]
                        metadata:
                          type: object
                          description: Metadata related to the exception.
                          additionalProperties: true                          
                      required: ["allowedValues"]
                    sysctls:
                      type: object
                      description: Exceptions for the `sysctls` parameter.
                      properties:
                        allowedValues:
                          type: array
                          description: List of allowed `sysctl` settings.
                          items:
                            type: object
                            properties:
                              name:
                                type: string
                                description: Name of the `sysctl` parameter.
                              value:
                                type: string
                                description: Allowed value for the specified `sysctl` parameter.
                        metadata:
                          type: object
                          description: Metadata related to the exception.
                          additionalProperties: true                          
                      required: ["allowedValues"]
                network:
                  type: object
                  description: Exceptions for network-related parameters.
                  properties:
                    hostPorts:
                      type: array
                      description: Exceptions for host ports.
                      items:
                        type: object
                        properties:
                          port:
                            type: integer
                            description: Allowed host port.
                          protocol:
                            type: string
                            description: Protocol for the host port.
                            enum:
                              - TCP
                              - UDP
                          metadata:
                            type: object
                            description: Metadata related to the exception.
                            additionalProperties: true                           
                      required: ["port", "protocol"]
                    hostNetwork:
                      type: object
                      description: |
                        Exceptions for the `hostNetwork` parameter.
                        For pods with `hostNetwork: true`, an additional exception is performed on the ports specified in `containerPort`.
                      properties:
                        allowedValue:
                          type: boolean
                          default: false
                          description: Allowed value for `hostNetwork`.
                        metadata:
                          type: object
                          description: Metadata related to the exception.
                          additionalProperties: true                          
                      required: ["allowedValue"]
                    hostPID:
                      type: object
                      description: Exceptions for the `hostPID` parameter.
                      properties:
                        allowedValue:
                          type: boolean
                          default: false
                          description: Allowed value for `hostPID`.
                        metadata:
                          type: object
                          description: Metadata related to the exception.
                          additionalProperties: true                          
                      required: ["allowedValue"]
                    hostIPC:
                      type: object
                      description: Exceptions for the `hostIPC` parameter.
                      properties:
                        allowedValue:
                          type: boolean
                          default: false
                          description: Allowed value for `hostIPC`.
                        metadata:
                          type: object
                          description: Metadata related to the exception.
                          additionalProperties: true                          
                      required: ["allowedValue"]
                volumes:
                  type: object
                  description: Exceptions for volume-related parameters.
                  properties:
                    types:
                      type: object
                      description: Exceptions for volume types.
                      properties:
                        allowedValues:
                          type: array
                          description: List of allowed volume types.
                          items:
                            type: string
                        metadata:
                          type: object
                          description: Metadata related to the exception.
                          additionalProperties: true                          
                      required: ["allowedValues"]
                    hostPath:
                      type: object
                      description: Exceptions for `hostPath` volumes.
                      properties:
                        allowedValues:
                          type: array
                          description: List of allowed `hostPath` configurations.
                          items:
                            type: object
                            properties:
                              path:
                                type: string
                                description: Allowed `hostPath`.
                              readOnly: 
                                type: boolean
                                default: false
                                description: A `readOnly` value for the `hostPath`.
                              metadata:
                                type: object
                                description: Metadata related to the exception.
                                properties:
                                  description:
                                    type: string
                                    description: Description of the exception.                                
                      required: ["allowedValues"]
