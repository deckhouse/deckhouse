apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: securitypolicies.deckhouse.io
  labels:
    heritage: deckhouse
    module: admission-policy-engine
spec:
  group: deckhouse.io
  scope: Cluster
  names:
    plural: securitypolicies
    singular: securitypolicy
    kind: SecurityPolicy
  preserveUnknownFields: false
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          required: ["spec"]
          description: |
            Describes a security policy for a cluster.

            Each CustomResource `SecurityPolicy` describes rules for objects in a cluster.
          properties:
            spec:
              type: object
              required: ["match", "policies"]
              properties:
                enforcementAction:
                  type: string
                  default: "Deny"
                  description: |
                    The enforcement action to control what to do with the result of the constraint.
                    - Deny — Deny action.
                    - Dryrun — No action. It is used when debugging. Information about the event can be viewed in Grafana or in the console via kubectl.
                    - Warn — Same as `Dryrun`. In addition to the event information, it provides some info on why that constraint would have been denied if you had set `Deny` instead of `Warn`.
                  enum:
                    - Warn
                    - Deny
                    - Dryrun
                policies:
                  type: object
                  properties:
                    allowedHostPaths:
                      type: array
                      description: "The list of allowed hostpath prefixes. An empty list means any path can be used."
                      default: []
                      example: [{"pathPrefix":"/dev", "readOnly": true}]
                      items:
                        type: object
                        required: ["pathPrefix"]
                        properties:
                          pathPrefix:
                            type: string
                            description: |
                              pathPrefix is the path prefix that the host volume must match. It does not support *. Trailing slashes are trimmed when validating the path prefix with a host path.
                              Examples - /foo would allow /foo, /foo/ and /foo/bar /foo would not allow /food or /etc/foo
                          readOnly:
                            type: boolean
                            default: false
                            description: "When set to true, will allow host volumes matching the pathPrefix only if all volume mounts are readOnly."
                    allowHostIPC:
                      type: boolean
                      description: "Allows sharing the host's IPC namespace with containers."
                      default: false
                    allowHostNetwork:
                      type: boolean
                      description: "Allows containers to use the host's network."
                      default: false
                    allowHostPorts:
                      type: boolean
                      description: "Allows containers' ports to be exposed to the host's external network."
                      default: false
                    allowHostPID:
                      type: boolean
                      description: "Allows sharing the host's PID namespace with containers."
                      default: false
                    allowPrivileged:
                      type: boolean
                      description: "Allows almost completely unrestricted access to the host from the container."
                      default: false
                    allowPrivilegeEscalation:
                      type: boolean
                      description: "Allows container processes to gain more privileges than its parent process." 
                      default: false
                    allowedCapabilities:
                      type: array
                      description: "List of capabilities that containers are able to use. To allow all capabilities you may use '*'."
                      default: []
                      example: ["SETGID", "SETUID", "NET_BIND_SERVICE"]
                      items:
                        type: string
                        description: "Allowed linux capabilities."
                        enum: &caps
                          - ALL
                          - SETPCAP
                          - SYS_MODULE
                          - SYS_RAWIO
                          - SYS_PACCT
                          - SYS_ADMIN
                          - SYS_NICE
                          - SYS_RESOURCE
                          - SYS_TIME
                          - SYS_TTY_CONFIG
                          - MKNOD
                          - AUDIT_WRITE
                          - AUDIT_CONTROL
                          - MAC_OVERRIDE
                          - MAC_ADMIN
                          - NET_ADMIN
                          - SYSLOG
                          - CHOWN
                          - NET_RAW
                          - DAC_OVERRIDE
                          - FOWNER
                          - DAC_READ_SEARCH
                          - FSETID
                          - KILL
                          - SETGID
                          - SETUID
                          - LINUX_IMMUTABLE
                          - NET_BIND_SERVICE
                          - NET_BROADCAST
                          - IPC_LOCK
                          - IPC_OWNER
                          - SYS_CHROOT
                          - SYS_PTRACE
                          - SYS_BOOT
                          - LEASE
                          - SETFCAP
                          - WAKE_ALARM
                          - BLOCK_SUSPEND
                    allowedFlexVolumes:
                      type: array
                      description: "Whitelist of allowed Flex Volume drivers."
                      default: []
                      items:
                        type: object
                        properties:
                          driver:
                            type: string
                            default: ""
                            description: "A driver name."
                    allowedUnsafeSysctls:
                      type: array
                      description: "List of explicitly allowed unsafe sysctls. To allow all unsafe sysctls you may use '*'."
                      default: []
                      example: ["kernel.msg*", "net.core.somaxconn"]
                      items:
                        type: string
                    defaultAddCapabilities:
                      type: array
                      description: "Set of capabilities that will be added to containers."
                      default: []
                      example: ["SETGID", "SETUID", "NET_BIND_SERVICE"]
                      items:
                        type: string
                        description: "Specifies linux capabilities to add."
                        enum: *caps
                    forbiddenSysctls:
                      type: array
                      description: "List of forbidden sysctls."
                      default: ["*"]
                      example: ["SETGID", "SETUID", "NET_BIND_SERVICE"]
                      items:
                        type: string
                    fsGroup:
                      type: object
                      description: "Specifies what fs group is used by the security context."
                      required: ["type"]
                      properties:
                        type:
                          type: string
                          description: "Specifes the strategy of the fs group selection."
                          enum:
                            - MustRunAs
                            - MustRunAsRange
                            - RunAsAny
                          default: "MustRunAs"
                        id:
                          type: integer
                          description: "Specifies fs group ID to use with MustRunAs strategy."
                        ranges:
                          type: array
                          description: "List of acceptable ranges for the fs group ID to use with MustRunAsRange."
                          items:
                            type: object
                            properties:
                              min:
                                type: integer
                                description: "Min ID value."
                              max:
                                type: integer
                                description: "Max ID value."
                    readOnlyRootFilesystem:
                      type: boolean
                      description: "Defines if it's possible to run the container with non-read only file system."
                      default: false
                    requiredDropCapabilities:
                      type: array
                      description: "The set of capabilities that have to be dropped from the container."
                      default: ["ALL"]
                      example: ["SETGID", "SETUID", "NET_BIND_SERVICE"]
                      items:
                        type: string
                        description: "Linux capabilities to drop from the pod spec."
                        enum: *caps
                    runAsUser:
                      type: object
                      description: "Specifies what runAsUser value is used by the security context."
                      required: ["type"]
                      properties:
                        type:
                          type: string
                          description: "Specifies the strategy of the user ID selection."
                          enum:
                            - MustRunAs
                            - MustRunAsRange
                            - MustRunAsNonRoot
                            - RunAsAny
                          default: "MustRunAsNonRoot"
                        id:
                          type: integer
                          description: "Specifies user ID to use with MustRunAs strategy."
                        ranges:
                          type: array
                          description: "List of acceptable ranges for the user ID to use with MustRunAsRange."
                          items:
                            type: object
                            properties:
                              min:
                                type: integer
                                description: "Min ID value."
                              max:
                                type: integer
                                description: "Max ID value."
                    seccompProfiles:
                      type: array
                      description: "The list of allowed profiles that may be set for the pod or container’s seccomp annotations."
                      default: []
                      example: ["docker/default"]
                      items:
                        type: string
                    seLinuxContext:
                      type: object
                      description: "Specifies what SElinux labels to set in the security context."
                      required: ["type"]
                      properties:
                        type:
                          type: string
                          description: "Specifes the strategy of the SElinux labels selection."
                          enum:
                            - MustRunAs
                            - RunAsAny
                          default: "RunAsAny"
                    supplementalGroups:
                      type: object
                      description: "Specifies what supplemental group is used by the security context."
                      required: ["type"]
                      properties:
                        type:
                          type: string
                          description: "Specifies the strategy of the supplemental group ID selection."
                          enum:
                            - MustRunAs
                            - MustRunAsRange
                            - RunAsAny
                          default: "MustRunAs"
                        id:
                          type: integer
                          description: "Specifies supplemental group ID to use with MustRunAs strategy."
                        ranges:
                          type: array
                          description: "List of acceptable ranges for the supplemental group ID to use with MustRunAsRange."
                          items:
                            type: object
                            properties:
                              min:
                                type: integer
                                description: "Min ID value."
                              max:
                                type: integer
                                description: "Max ID value."
                    allowedVolumes:
                      type: array
                      description: "The set of volume plugins allowed to use."
                      default: ["*"]
                      example: ["hostPath", "persistentVolumeClaim"]
                      items:
                        type: string
                        enum:
                          - '*'
                          - none
                          - awsElasticBlockStore
                          - azureDisk
                          - azureFile
                          - cephFS
                          - cinder
                          - configMap
                          - csi
                          - downwardAPI
                          - emptyDir
                          - fc
                          - flexVolume
                          - flocker
                          - gcePersistentDisk
                          - gitRepo
                          - glusterfs
                          - hostPath
                          - iscsi
                          - nfs
                          - persistentVolumeClaim
                          - photonPersistentDisk
                          - portworxVolume
                          - projected
                          - quobyte
                          - rbd
                          - scaleIO
                          - secret
                          - storageos
                          - vsphereVolume
                match:
                  type: object
                  required: ["namespaceSelector"]
                  properties:
                    namespaceSelector:
                      oneOf:
                        - required: [matchNames]
                        - required: [excludeNames]
                        - required: [labelSelector]
                      type: object
                      description: Specifies the Namespace selector to filter objects with.
                      properties:
                        matchNames:
                          type: array
                          description: "Include only a particular set of namespaces. Supports glob pattern."
                          items:
                            type: string
                        excludeNames:
                          type: array
                          description: "Include all namespaces except a particular set. Support glob pattern."
                          items:
                            type: string
                        labelSelector:
                          type: object
                          description: |
                            Specifies the label selector to filter namespaces.

                            You can get more info in [the documentation](https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/).
                          anyOf:
                            - required: [ matchLabels ]
                            - required: [ matchExpressions ]
                          properties:
                            matchLabels:
                              type: object
                              description: List of labels which a namespace should have.
                              example: { "foo": "bar", "baz": "who" }
                              additionalProperties:
                                type: string
                            matchExpressions:
                              type: array
                              description: List of label expressions for namespaces.
                              example: |
                                ```yaml
                                matchExpressions:
                                - key: tier
                                  operator: In
                                  values:
                                  - production
                                  - staging
                                ```
                              items:
                                type: object
                                required:
                                  - key
                                  - operator
                                properties:
                                  key:
                                    type: string
                                  operator:
                                    type: string
                                    enum:
                                      - In
                                      - NotIn
                                      - Exists
                                      - DoesNotExist
                                  values:
                                    type: array
                                    items:
                                      type: string
                    labelSelector:
                      type: object
                      description: |
                        Specifies the label selector to filter Pods with.

                        You can get more into [here](https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/).
                      anyOf:
                        - required:
                            - matchLabels
                        - required:
                            - matchExpressions
                      properties:
                        matchLabels:
                          type: object
                          description: List of labels which Pod should have.
                          example: { "foo": "bar", "baz": "who" }
                          additionalProperties:
                            type: string
                        matchExpressions:
                          type: array
                          description: List of label expressions for Pods.
                          example: |
                            ```yaml
                            matchExpressions:
                            - key: tier
                              operator: In
                              values:
                              - production
                              - staging
                            ```
                          items:
                            type: object
                            required:
                              - key
                              - operator
                            properties:
                              key:
                                type: string
                              operator:
                                type: string
                                enum:
                                  - In
                                  - NotIn
                                  - Exists
                                  - DoesNotExist
                              values:
                                type: array
                                items:
                                  type: string
