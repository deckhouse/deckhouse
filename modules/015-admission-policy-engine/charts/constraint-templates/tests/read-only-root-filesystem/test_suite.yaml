kind: Suite
apiVersion: test.gatekeeper.sh/v1alpha1
metadata:
  name: d8-read-only-root-filesystem
tests:
  - name: security-policy
    template: ../../templates/security/read-only-root-filesystem.yaml
    constraint: constraint_security_policy.yaml
    cases:
      - name: allowed-readOnlyRootFilesystem-true-container
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/allowed-readOnlyRootFilesystem-true-container.yaml
        assertions:
          - violations: no

      - name: disallowed-readOnlyRootFilesystem-true-pod-only
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/disallowed-readOnlyRootFilesystem-true-pod-only.yaml
        assertions:
          - violations: yes

      - name: allowed-multiple-containers-both-readonly
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/allowed-multiple-containers-both-readonly.yaml
        assertions:
          - violations: no

      - name: allowed-init-container-readonly
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/allowed-init-container-readonly.yaml
        assertions:
          - violations: no

      - name: disallowed-readOnlyRootFilesystem-false-container
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/disallowed-readOnlyRootFilesystem-false-container.yaml
        assertions:
          - violations: yes

      - name: disallowed-no-readOnlyRootFilesystem-container
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/disallowed-no-readOnlyRootFilesystem-container.yaml
        assertions:
          - violations: yes

      - name: disallowed-multiple-containers-one-not-readonly
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/disallowed-multiple-containers-one-not-readonly.yaml
        assertions:
          - violations: yes

      - name: disallowed-init-container-not-readonly
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/disallowed-init-container-not-readonly.yaml
        assertions:
          - violations: yes

  - name: security-policy-with-exception
    template: ../../templates/security/read-only-root-filesystem.yaml
    constraint: constraint_security_policy.yaml
    cases:
      - name: allowed-by-exception-readOnlyRootFilesystem-false
        inventory:
          - ../common/test_samples/ns.yaml
          - test_samples/security_policy_exceptions/allow-writable-root-filesystem.yaml
        object: test_samples/security_policy_exceptions/allowed-by-exception-readOnlyRootFilesystem-false.yaml
        assertions:
          - violations: no

      - name: allowed-by-exception-no-readOnlyRootFilesystem
        inventory:
          - ../common/test_samples/ns.yaml
          - test_samples/security_policy_exceptions/allow-writable-root-filesystem.yaml
        object: test_samples/security_policy_exceptions/allowed-by-exception-no-readOnlyRootFilesystem.yaml
        assertions:
          - violations: no

      - name: allowed-by-exception-readOnlyRootFilesystem-mismatch-but-constraint-allows
        inventory:
          - ../common/test_samples/ns.yaml
          - test_samples/security_policy_exceptions/allow-writable-root-filesystem.yaml
        object: test_samples/security_policy_exceptions/allowed-by-exception-readOnlyRootFilesystem-mismatch-but-constraint-allows.yaml
        assertions:
          - violations: no

      - name: disallowed-no-exception-label
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/security_policy_exceptions/disallowed-no-exception-label.yaml
        assertions:
          - violations: yes

      - name: allowed-by-exception-mismatch-but-constraint-allows
        inventory:
          - ../common/test_samples/ns.yaml
          - test_samples/security_policy_exceptions/allow-writable-root-filesystem.yaml
        object: test_samples/security_policy_exceptions/allowed-by-exception-mismatch-but-constraint-allows.yaml
        assertions:
          - violations: no

      - name: allowed-by-exception-multiple-containers-all-allowed-via-constraint-or-exception
        inventory:
          - ../common/test_samples/ns.yaml
          - test_samples/security_policy_exceptions/allow-writable-root-filesystem.yaml
        object: test_samples/security_policy_exceptions/allowed-by-exception-multiple-containers-all-allowed-via-constraint-or-exception.yaml
        assertions:
          - violations: no

      - name: allowed-by-exception-multiple-containers-all-allowed
        inventory:
          - ../common/test_samples/ns.yaml
          - test_samples/security_policy_exceptions/allow-writable-root-filesystem.yaml
        object: test_samples/security_policy_exceptions/allowed-by-exception-multiple-containers-all-allowed.yaml
        assertions:
          - violations: no

