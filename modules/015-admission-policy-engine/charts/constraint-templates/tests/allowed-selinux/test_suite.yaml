kind: Suite
apiVersion: test.gatekeeper.sh/v1alpha1
metadata:
  name: d8-allowed-selinux
tests:
  - name: pss-baseline
    template: ../../templates/security/allowed-selinux.yaml
    constraint: constraint_pss_baseline.yaml
    cases:
      - name: allowed-no-selinux-options
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/allowed-no-selinux-options.yaml
        assertions:
          - violations: no

      - name: allowed-empty-type-securityContext-pod
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/allowed-empty-type-securityContext-pod.yaml
        assertions:
          - violations: no

      - name: allowed-container-t-securityContext-container
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/allowed-container-t-securityContext-container.yaml
        assertions:
          - violations: no

      - name: allowed-container-init-t-securityContext-container
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/allowed-container-init-t-securityContext-container.yaml
        assertions:
          - violations: no

      - name: allowed-container-kvm-t-securityContext-container
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/allowed-container-kvm-t-securityContext-container.yaml
        assertions:
          - violations: no

      - name: allowed-container-engine-t-securityContext-container
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/allowed-container-engine-t-securityContext-container.yaml
        assertions:
          - violations: no

      - name: disallowed-wrong-type-securityContext-container
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/disallowed-wrong-type-securityContext-container.yaml
        assertions:
          - violations: yes

      - name: disallowed-wrong-type-securityContext-pod
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/disallowed-wrong-type-securityContext-pod.yaml
        assertions:
          - violations: yes

      - name: disallowed-multiple-containers-one-wrong-type
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/disallowed-multiple-containers-one-wrong-type.yaml
        assertions:
          - violations: yes

      - name: allowed-deployment-no-selinux
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/allowed-deployment-no-selinux.yaml
        assertions:
          - violations: no

      - name: disallowed-deployment-custom-selinux-options-container
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/disallowed-deployment-custom-selinux-options-container.yaml
        assertions:
          - violations: no

      - name: allowed-daemonset-no-selinux
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/allowed-daemonset-no-selinux.yaml
        assertions:
          - violations: no

      - name: disallowed-daemonset-custom-selinux-options-container
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/disallowed-daemonset-custom-selinux-options-container.yaml
        assertions:
          - violations: no

  - name: security-policy
    template: ../../templates/security/allowed-selinux.yaml
    constraint: constraint_security_policy.yaml
    cases:
      - name: allowed-no-selinux-options
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/allowed-no-selinux-options.yaml
        assertions:
          - violations: no

      - name: allowed-exact-match-securityContext-container
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/allowed-exact-match-securityContext-container.yaml
        assertions:
          - violations: no

      - name: allowed-exact-match-securityContext-pod
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/allowed-exact-match-securityContext-pod.yaml
        assertions:
          - violations: no

      - name: disallowed-wrong-type-securityContext-container
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/disallowed-wrong-type-securityContext-container.yaml
        assertions:
          - violations: yes

      - name: disallowed-wrong-level-securityContext-container
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/disallowed-wrong-level-securityContext-container.yaml
        assertions:
          - violations: yes

      - name: disallowed-wrong-role-securityContext-container
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/disallowed-wrong-role-securityContext-container.yaml
        assertions:
          - violations: yes

      - name: disallowed-wrong-user-securityContext-container
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/disallowed-wrong-user-securityContext-container.yaml
        assertions:
          - violations: yes

      - name: disallowed-multiple-containers-one-wrong
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/disallowed-multiple-containers-one-wrong.yaml
        assertions:
          - violations: yes

      - name: allowed-deployment-spc-t-container
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/allowed-deployment-spc-t-container.yaml
        assertions:
          - violations: no

      - name: disallowed-deployment-custom-selinux-options-container
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/disallowed-deployment-custom-selinux-options-container.yaml
        assertions:
          - violations: no

      - name: allowed-daemonset-spc-t-container
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/allowed-daemonset-spc-t-container.yaml
        assertions:
          - violations: no

      - name: disallowed-daemonset-custom-selinux-options-container
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/disallowed-daemonset-custom-selinux-options-container.yaml
        assertions:
          - violations: no

  - name: pss-baseline-with-exception
    template: ../../templates/security/allowed-selinux.yaml
    constraint: constraint_pss_baseline.yaml
    cases:
      - name: allowed-by-exception-spc-t-container
        inventory:
          - ../common/test_samples/ns.yaml
          - test_samples/security_policy_exceptions/exceptions/allow-spc-t.yaml
        object: test_samples/security_policy_exceptions/pods/allowed-by-exception-spc-t-container.yaml
        assertions:
          - violations: no

      - name: allowed-by-exception-custom-selinux-options-container
        inventory:
          - ../common/test_samples/ns.yaml
          - test_samples/security_policy_exceptions/exceptions/allow-custom-selinux-options.yaml
        object: test_samples/security_policy_exceptions/pods/allowed-by-exception-custom-selinux-options-container.yaml
        assertions:
          - violations: no

      - name: disallowed-by-exception-type-mismatch
        inventory:
          - ../common/test_samples/ns.yaml
          - test_samples/security_policy_exceptions/exceptions/allow-spc-t.yaml
        object: test_samples/security_policy_exceptions/pods/disallowed-by-exception-type-mismatch.yaml
        assertions:
          - violations: yes

      - name: disallowed-by-exception-level-mismatch
        inventory:
          - ../common/test_samples/ns.yaml
          - test_samples/security_policy_exceptions/exceptions/allow-custom-selinux-options.yaml
        object: test_samples/security_policy_exceptions/pods/disallowed-by-exception-level-mismatch.yaml
        assertions:
          - violations: yes

      - name: disallowed-no-exception-label
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/security_policy_exceptions/pods/disallowed-no-exception-label.yaml
        assertions:
          - violations: yes

      - name: allowed-by-exception-mismatch-but-constraint-allows
        inventory:
          - ../common/test_samples/ns.yaml
          - test_samples/security_policy_exceptions/exceptions/allow-spc-t.yaml
        object: test_samples/security_policy_exceptions/pods/allowed-by-exception-mismatch-but-constraint-allows.yaml
        assertions:
          - violations: no

      - name: disallowed-by-exception-multiple-containers-one-mismatch
        inventory:
          - ../common/test_samples/ns.yaml
          - test_samples/security_policy_exceptions/exceptions/allow-spc-t.yaml
        object: test_samples/security_policy_exceptions/pods/disallowed-by-exception-multiple-containers-one-mismatch.yaml
        assertions:
          - violations: yes

