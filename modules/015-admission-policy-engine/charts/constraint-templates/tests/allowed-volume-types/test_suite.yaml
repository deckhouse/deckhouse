kind: Suite
apiVersion: test.gatekeeper.sh/v1alpha1
metadata:
  name: d8-allowed-volume-types
tests:
  - name: pss-restricted
    template: ../../templates/security/allowed-volume-types.yaml
    constraint: constraint_pss_restricted.yaml
    cases:
      - name: allowed-no-volumes
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_restricted/allowed-no-volumes.yaml
        assertions:
          - violations: no

      - name: allowed-configmap-volume
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_restricted/allowed-configmap-volume.yaml
        assertions:
          - violations: no

      - name: allowed-secret-volume
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_restricted/allowed-secret-volume.yaml
        assertions:
          - violations: no

      - name: allowed-emptyDir-volume
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_restricted/allowed-emptyDir-volume.yaml
        assertions:
          - violations: no

      - name: allowed-persistentVolumeClaim-volume
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_restricted/allowed-persistentVolumeClaim-volume.yaml
        assertions:
          - violations: no

      - name: allowed-downwardAPI-volume
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_restricted/allowed-downwardAPI-volume.yaml
        assertions:
          - violations: no

      - name: allowed-projected-volume
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_restricted/allowed-projected-volume.yaml
        assertions:
          - violations: no

      - name: allowed-csi-volume
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_restricted/allowed-csi-volume.yaml
        assertions:
          - violations: no

      - name: allowed-ephemeral-volume
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_restricted/allowed-ephemeral-volume.yaml
        assertions:
          - violations: no

      - name: allowed-multiple-volumes
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_restricted/allowed-multiple-volumes.yaml
        assertions:
          - violations: no

      - name: disallowed-hostPath-volume
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_restricted/disallowed-hostPath-volume.yaml
        assertions:
          - violations: yes

      - name: disallowed-nfs-volume
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_restricted/disallowed-nfs-volume.yaml
        assertions:
          - violations: yes

      - name: disallowed-multiple-volumes-one-disallowed
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_restricted/disallowed-multiple-volumes-one-disallowed.yaml
        assertions:
          - violations: yes

      - name: allowed-deployment-no-volumes
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_restricted/allowed-deployment-no-volumes.yaml
        assertions:
          - violations: no

      - name: disallowed-deployment-hostPath-volume
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_restricted/disallowed-deployment-hostPath-volume.yaml
        assertions:
          - violations: no

      - name: allowed-daemonset-no-volumes
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_restricted/allowed-daemonset-no-volumes.yaml
        assertions:
          - violations: no

      - name: disallowed-daemonset-hostPath-volume
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_restricted/disallowed-daemonset-hostPath-volume.yaml
        assertions:
          - violations: no

  - name: security-policy
    template: ../../templates/security/allowed-volume-types.yaml
    constraint: constraint_security_policy.yaml
    cases:
      - name: allowed-no-volumes
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/allowed-no-volumes.yaml
        assertions:
          - violations: no

      - name: allowed-hostPath-volume
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/allowed-hostPath-volume.yaml
        assertions:
          - violations: no

      - name: allowed-nfs-volume
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/allowed-nfs-volume.yaml
        assertions:
          - violations: no

      - name: allowed-configmap-volume
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/allowed-configmap-volume.yaml
        assertions:
          - violations: no

      - name: allowed-multiple-volumes
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/allowed-multiple-volumes.yaml
        assertions:
          - violations: no

      - name: allowed-deployment-no-volumes
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/allowed-deployment-no-volumes.yaml
        assertions:
          - violations: no

      - name: allowed-deployment-hostPath-volume
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/allowed-deployment-hostPath-volume.yaml
        assertions:
          - violations: no

      - name: allowed-daemonset-no-volumes
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/allowed-daemonset-no-volumes.yaml
        assertions:
          - violations: no

      - name: allowed-daemonset-hostPath-volume
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/allowed-daemonset-hostPath-volume.yaml
        assertions:
          - violations: no

  - name: pss-restricted-with-exception
    template: ../../templates/security/allowed-volume-types.yaml
    constraint: constraint_pss_restricted.yaml
    cases:
      - name: allowed-by-exception-hostPath-volume
        inventory:
          - ../common/test_samples/ns.yaml
          - test_samples/security_policy_exceptions/exceptions/allow-hostPath-volume.yaml
        object: test_samples/security_policy_exceptions/pods/allowed-by-exception-hostPath-volume.yaml
        assertions:
          - violations: no

      - name: allowed-by-exception-multiple-volume-types
        inventory:
          - ../common/test_samples/ns.yaml
          - test_samples/security_policy_exceptions/exceptions/allow-multiple-volume-types.yaml
        object: test_samples/security_policy_exceptions/pods/allowed-by-exception-multiple-volume-types.yaml
        assertions:
          - violations: no

      - name: disallowed-by-exception-volume-type-mismatch
        inventory:
          - ../common/test_samples/ns.yaml
          - test_samples/security_policy_exceptions/exceptions/allow-hostPath-volume.yaml
        object: test_samples/security_policy_exceptions/pods/disallowed-by-exception-volume-type-mismatch.yaml
        assertions:
          - violations: yes

      - name: disallowed-no-exception-label
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/security_policy_exceptions/pods/disallowed-no-exception-label.yaml
        assertions:
          - violations: yes

      - name: allowed-by-exception-mismatch-but-constraint-allows
        inventory:
          - ../common/test_samples/ns.yaml
          - test_samples/security_policy_exceptions/exceptions/allow-hostPath-volume.yaml
        object: test_samples/security_policy_exceptions/pods/allowed-by-exception-mismatch-but-constraint-allows.yaml
        assertions:
          - violations: no

      - name: disallowed-by-exception-multiple-volumes-one-mismatch
        inventory:
          - ../common/test_samples/ns.yaml
          - test_samples/security_policy_exceptions/exceptions/allow-hostPath-volume.yaml
        object: test_samples/security_policy_exceptions/pods/disallowed-by-exception-multiple-volumes-one-mismatch.yaml
        assertions:
          - violations: yes

