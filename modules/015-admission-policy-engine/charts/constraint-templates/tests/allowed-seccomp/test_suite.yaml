kind: Suite
apiVersion: test.gatekeeper.sh/v1alpha1
metadata:
  name: d8-allowed-seccomp-profiles
tests:
  - name: pss-baseline
    template: ../../templates/security/allowed-seccomp.yaml
    constraint: constraint_pss_baseline.yaml
    cases:
      - name: allowed-no-seccomp-profile
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/allowed-no-seccomp-profile.yaml
        assertions:
          - violations: no

      - name: allowed-runtime-default-securityContext-container
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/allowed-runtime-default-securityContext-container.yaml
        assertions:
          - violations: no

      - name: allowed-runtime-default-securityContext-pod
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/allowed-runtime-default-securityContext-pod.yaml
        assertions:
          - violations: no

      - name: allowed-runtime-default-annotation
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/allowed-runtime-default-annotation.yaml
        assertions:
          - violations: no

      - name: allowed-localhost-profile-securityContext
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/allowed-localhost-profile-securityContext.yaml
        assertions:
          - violations: no

      - name: allowed-localhost-profile-annotation
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/allowed-localhost-profile-annotation.yaml
        assertions:
          - violations: no

      - name: disallowed-unconfined-securityContext
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/disallowed-unconfined-securityContext.yaml
        assertions:
          - violations: yes

      - name: disallowed-unconfined-annotation
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/disallowed-unconfined-annotation.yaml
        assertions:
          - violations: yes

      - name: disallowed-multiple-containers-one-unconfined
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/disallowed-multiple-containers-one-unconfined.yaml
        assertions:
          - violations: yes

      - name: allowed-deployment-runtime-default-securityContext-container
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/allowed-deployment-runtime-default-securityContext-container.yaml
        assertions:
          - violations: no

      - name: disallowed-deployment-unconfined-securityContext
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/disallowed-deployment-unconfined-securityContext.yaml
        assertions:
          - violations: no

      - name: allowed-daemonset-runtime-default-securityContext-container
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/allowed-daemonset-runtime-default-securityContext-container.yaml
        assertions:
          - violations: no

      - name: disallowed-daemonset-unconfined-securityContext
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_baseline/disallowed-daemonset-unconfined-securityContext.yaml
        assertions:
          - violations: no

  - name: pss-restricted
    template: ../../templates/security/allowed-seccomp.yaml
    constraint: constraint_pss_restricted.yaml
    cases:
      - name: disallowed-no-seccomp-profile
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_restricted/disallowed-no-seccomp-profile.yaml
        assertions:
          - violations: yes

      - name: allowed-runtime-default-securityContext
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_restricted/allowed-runtime-default-securityContext.yaml
        assertions:
          - violations: no

      - name: allowed-localhost-profile-securityContext
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_restricted/allowed-localhost-profile-securityContext.yaml
        assertions:
          - violations: no

      - name: allowed-localhost-profile-annotation
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_restricted/allowed-localhost-profile-annotation.yaml
        assertions:
          - violations: no

      - name: disallowed-unconfined-securityContext
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/pss_restricted/disallowed-unconfined-securityContext.yaml
        assertions:
          - violations: yes

  - name: security-policy
    template: ../../templates/security/allowed-seccomp.yaml
    constraint: constraint_security_policy.yaml
    cases:
      - name: allowed-localhost-verySpecialFile-securityContext
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/allowed-localhost-verySpecialFile-securityContext.yaml
        assertions:
          - violations: no

      - name: allowed-localhost-verySpecialFile-annotation
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/allowed-localhost-verySpecialFile-annotation.yaml
        assertions:
          - violations: no

      - name: disallowed-no-seccomp-profile
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/disallowed-no-seccomp-profile.yaml
        assertions:
          - violations: yes

      - name: disallowed-runtime-default-securityContext
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/disallowed-runtime-default-securityContext.yaml
        assertions:
          - violations: yes

      - name: disallowed-localhost-wrong-file-securityContext
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/disallowed-localhost-wrong-file-securityContext.yaml
        assertions:
          - violations: yes

      - name: disallowed-unconfined-securityContext
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/disallowed-unconfined-securityContext.yaml
        assertions:
          - violations: yes

      - name: disallowed-multiple-containers-one-disallowed
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/disallowed-multiple-containers-one-disallowed.yaml
        assertions:
          - violations: yes

      - name: allowed-deployment-localhost-verySpecialFile-securityContext
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/allowed-deployment-localhost-verySpecialFile-securityContext.yaml
        assertions:
          - violations: no

      - name: disallowed-deployment-unconfined-securityContext
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/disallowed-deployment-unconfined-securityContext.yaml
        assertions:
          - violations: no

      - name: allowed-daemonset-localhost-verySpecialFile-securityContext
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/allowed-daemonset-localhost-verySpecialFile-securityContext.yaml
        assertions:
          - violations: no

      - name: disallowed-daemonset-unconfined-securityContext
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/constraint_templates/security_policy/disallowed-daemonset-unconfined-securityContext.yaml
        assertions:
          - violations: no

  - name: pss-baseline-with-exception
    template: ../../templates/security/allowed-seccomp.yaml
    constraint: constraint_pss_baseline.yaml
    cases:
      - name: allowed-by-exception-unconfined
        inventory:
          - ../common/test_samples/ns.yaml
          - test_samples/security_policy_exceptions/exceptions/allow-unconfined.yaml
        object: test_samples/security_policy_exceptions/pods/allowed-by-exception-unconfined.yaml
        assertions:
          - violations: no

      - name: allowed-by-exception-localhost-profile
        inventory:
          - ../common/test_samples/ns.yaml
          - test_samples/security_policy_exceptions/exceptions/allow-localhost-profile.yaml
        object: test_samples/security_policy_exceptions/pods/allowed-by-exception-localhost-profile.yaml
        assertions:
          - violations: no

      - name: allowed-by-exception-mismatch-but-constraint-allows
        inventory:
          - ../common/test_samples/ns.yaml
          - test_samples/security_policy_exceptions/exceptions/allow-unconfined.yaml
        object: test_samples/security_policy_exceptions/pods/allowed-by-exception-mismatch-but-constraint-allows.yaml
        assertions:
          - violations: no

      - name: disallowed-no-exception-label
        inventory:
          - ../common/test_samples/ns.yaml
        object: test_samples/security_policy_exceptions/pods/disallowed-no-exception-label.yaml
        assertions:
          - violations: yes

