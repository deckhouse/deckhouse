apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: d8allowrbacwildcards
  annotations:
    description: Prohibits the use of wildcards in RBAC RoleBindings and ClusterRoleBindings if the corresponding policy is disabled.
spec:
  crd:
    spec:
      names:
        kind: D8AllowRbacWildcards
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package d8.security_policies

        violation[{"msg": msg}] {
          is_binding(input.review.kind.kind)
          binding := input.review.object
          ref_name := binding.roleRef.name
          contains(ref_name, "*")
          msg := sprintf("Wildcard is forbidden in roleRef.name of %v '%v': '%v'", [input.review.kind.kind, binding.metadata.name, ref_name])
        }

        violation[{"msg": msg}] {
          is_binding(input.review.kind.kind)
          binding := input.review.object
          subject := binding.subjects[_]
          contains(subject.name, "*")
          msg := sprintf("Wildcard is forbidden in subjects of %v '%v': subject '%v' of kind '%v'", [input.review.kind.kind, binding.metadata.name, subject.name, subject.kind])
        }

        is_binding(kind) {
          kind == "RoleBinding"
        }
        is_binding(kind) {
          kind == "ClusterRoleBinding"
        }
