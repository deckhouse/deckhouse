apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: d8denyexecheritage
  labels:
    heritage: deckhouse
    module: admission-policy-engine
    security.deckhouse.io: security-policy
  annotations:
    metadata.gatekeeper.sh/title: "Deny Exec in Heritage Pods"
    metadata.gatekeeper.sh/version: 1.0.0
    description: >-
      Deny CONNECT requests to pods/exec and pods/attach for Pods with
      label `heritage: deckhouse`, except selected service accounts and users.
spec:
  crd:
    spec:
      names:
        kind: D8DenyExecHeritage
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package d8.security_policies

        is_connect {
          input.review.operation == "CONNECT"
        }

        is_pod_exec_or_attach {
          input.review.resource.resource == "pods/exec"
        }

        is_pod_exec_or_attach {
          input.review.resource.resource == "pods/attach"
        }

        # Check if the target pod has heritage: deckhouse label
        # For CONNECT requests, object contains the PodExecOptions/PodAttachOptions,
        # but we need to check the pod being accessed. The pod name is in input.review.name
        # and we rely on the webhook's objectSelector to only send heritage pods.
        is_heritage_pod {
          # The webhook objectSelector ensures only heritage: deckhouse pods reach this policy
          true
        }

        # allow-list
        is_allowed_user {
          input.review.userInfo.username == "system:sudouser"
        }

        is_allowed_user {
          startswith(input.review.userInfo.username, "system:serviceaccount:d8-")
        }

        is_allowed_user {
          startswith(input.review.userInfo.username, "system:serviceaccount:kube-")
        }

        violation[{"msg": msg}] {
          is_connect
          is_pod_exec_or_attach
          is_heritage_pod
          not is_allowed_user
          pod  := input.review.name
          ns   := input.review.namespace
          user := input.review.userInfo.username
          msg  := sprintf("Exec/attach to Pod %q in namespace %q with label 'heritage: deckhouse' is forbidden for user %q", [pod, ns, user])
        }

