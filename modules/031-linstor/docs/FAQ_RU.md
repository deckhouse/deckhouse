---
title: "Модуль linstor: FAQ"
---

## Когда следует использовать LVM, а когда LVMThin?

Если кратко то:
- LVM проще и обладает производительностью сравнимой с нативными накопителями.
- LVMThin позволяет использовать снапшоты и оверпровиженинг, но медленнее в два раза.

Подробности смотрите в следующем разделе

## Производительность и надёжность LINSTOR, а также сравнение с Ceph.

Мы придерживаемся практического взгляда на вопрос. Разница в несколько десятков процентов — на практике никогда не имеет значения. Имеет значение разница в несколько раз и более.

- Sequential read и write не имеют никакого значения, потому что на любой технологии они всегда упираются в сеть (что 10 Гбит/с, что 1 Гбит/с). С практической точки зрения этот показатель можно полностью игнорировать.
- Random read и write (что на 1Гбит/с, что на 10Гбит/с)
  - на практике выглядят следующим образом:
    - drbd+lvm в 5 раз лучше (latency — в 5 раз меньше, iops — в 5 раз больше) ceph-rbd
    - drbd+lvm в 2 раза лучше drbd+lvmthin
  - если одна из реплик локально
    - read — на скорости устройства
  - если нет локальных реплик
    - write — ограничен половиной пропускной способности сети (при двух репликах, или ⅓ пропускной способности сети при трех репликах)
  - при большом количестве клиентов (больше 10, при iodepth 64), ceph начинает отставать сильнее (до 10 раз) и потреблять значительно больше CPU.

В сухом остатке на практике не важно какие крутилки крутить, есть всего три значимых фактора:
- **локальность чтения** — если все чтение производится локально, то оно работает со скоростью (throughput, iops, latency) локального диска (разница практически незначима) 
- **1 сетевой хоп при записи** — в drbd репликацией занимается “клиент”, а в ceph’е “сервер”, поэтому у ceph latency на запись всегда минимум x2 от drbd
- **сложность кода** — latency вычислений на datapath (сколько ассемблера выполняется на каждую io операцию), drbd+lvm проще чем drbd+lvmthin, и сильно проще чем ceph-rbd.

## Что использовать в какой ситуации?

- По умолчанию используем 2 реплики (третья для кворума, diskless, создается автоматом), это гарантирует защиту от split brain и достаточный уровень надежности хранения.
  - Нужно понимать, что в момент недоступности одной из реплик (реплика A) данные записываются только в единственную реплику (реплика B). Это означает, что:
     1. если в этот момент отключится и вторая реплика (реплика B) — запись и чтение будут недоступны,
     1. если при этом вторая реплика (реплика B) утеряна безвозвратно, то данные будут частично потеряны (есть только старая, outdated реплика A),
     1. если старая реплика (реплика A) была тоже утеряна безвозвратно, данные будут потеряны полностью.
  - Кроме этого, при отключении второй реплики, чтобы включиться обратно (без вмешательства оператора) требуется доступность обоих реплик (чтобы корректно отработать split-brain).
  - Включение третьей реплики решает обе проблемы (в любой момент времени минимум 2 копии данных), но увеличивает накладные расходы (сеть, диск).

- Категорически рекомендуется иметь одну реплику локально. Это x2 пропускной способности на запись (при 2 репликах) и бесплатное чтение.
  - Но если это не так, то все равно все продолжает нормально работать (но чтение по сети, и x2 утилизация сети на запись).
- В зависимости от задачи нужно выбрать одно из:
  - drbd+lvm — быстрей (x2) и надежней (lvm проще),
  - drbd+lvmthin — поддержка снэпшотов и возможность оверкоммита.

## Как добавить существуюший LVM или LVMThin пул?

Очень просто:

- LVM:
  ```
  linstor storage-pool create lvm node01 lvmthin linstor_data
  ```
  
- LVMThin:
  ```
  linstor storage-pool create lvmthin node01 lvmthin linstor_data/data
  ```

Можно добавлять и пулы, в которых уже созданы какие-то тома. LINSTOR просто будет создавать рядом новые.

## Как настроить Prometheus на использование хранилища LINSTOR?

Настроить пулы хранения и StorageClass, как показано в [примерах использования](usage.html)

Добавить в конфигурацию Deckhouse (configMap `d8-system/deckhouse`):
```yaml
prometheus: |
  longtermStorageClass: linstor-r2
  storageClass: linstor-r2
```

Дождаться переката Pod'ов Prometheus.
