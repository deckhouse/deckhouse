---
title: "Модуль registry"
description: "Управление конфигурацией registry компонентов DKP и организация внутреннего хранилища образов контейнеров (container registry, registry)."
---

## Описание

Модуль отвечает за управление конфигурацией registry компонентов Deckhouse и предоставляет внутреннее хранилище образов контейнеров (container registry, registry).

Внутренний registry оптимизирует загрузку и хранение образов, а также повышает высокую доступность и отказоустойчивость Deckhouse Kubernetes Platform.

Модуль работает в следующих режимах:

- `Direct` — использование внутреннего registry. Обращение к внутреннему registry выполняется по фиксированному адресу `registry.d8-system.svc:5001/system/deckhouse`. Фиксированный адрес, при изменении параметров registry, позволяет избежать повторного скачивания образов и перезапуска компонентов. Переключение между режимами и registry выполняется через ModuleConfig `deckhouse`. Переключение выполняется автоматически (ознакомьтесь с [примерами использования](examples.html)).

- `Proxy` - использование внутреннего кеширующего прокси registry, с запуском registry на control-plane (master) узлах. Режим позволяет сократить количество запросов к внешнему registry за счёт кэширования образов. Хранение хешируемых данных выполняется на control-plane (master) узлах. Обращение к внутреннему registry выполняется по фиксированному адресу `registry.d8-system.svc:5001/system/deckhouse` аналогично `Direct` режиму. Переключение между режимами и registry выполняется через ModuleConfig `deckhouse`. Переключение выполняется автоматически (ознакомьтесь с [примерами использования](examples.html)).

- `Local` - использование локального внутреннего registry, с запуском registry на control-plane (master) узлах. Режим позволяет кластеру работать в изолированной среде. Хранение данных выполняется на control-plane (master) узлах. Обращение к внутреннему registry выполняется по фиксированному адресу `registry.d8-system.svc:5001/system/deckhouse` аналогично `Direct` и `Proxy` режимам. Переключение между режимами и registry выполняется через ModuleConfig `deckhouse`. Переключение выполняется автоматически (ознакомьтесь с [примерами использования](examples.html)).

- `Unmanaged` — работа без использования внутреннего registry. Обращение внутри кластера выполняется напрямую к внешнему registry.
  Существует 2 вида режима `Unmanaged`:
  - Конфигурируемый - режим, управляемый с помощью модуля `registry`. Переключение между режимами и registry выполняется через ModuleConfig `deckhouse`. Переключение выполняется автоматически (ознакомьтесь с [примерами использования](examples.html)).
  - Неконфигурируемый (deprecated) - режим используемый по умолчанию. Параметры конфигурации задаются [при установке кластера](/products/kubernetes-platform/documentation/v1/reference/api/cr.html#initconfiguration-deckhouse-imagesrepo), или при [изменении в развёрнутом кластере](/products/kubernetes-platform/documentation/v1/admin/configuration/registry/third-party.html) с помощью утилиты `helper change registry` (deprecated).

## Ограничения и особенности использования модуля

Модуль `registry` имеет ряд ограничений и особенностей, касающихся установки, условий работы и переключения режимов.

### Ограничения при установке кластера

- Bootstrap кластера DKP поддерживается только в `Direct` и `Unmanaged` режимах (`Local` и `Proxy` режимы не поддерживаются). Настройки реестра во время установки кластера осуществляются через moduleConfig [`deckhouse`](../deckhouse/configuration.html#parameters-registry).
- Для запуска кластера в неконфигурируемом `Unmanaged` режиме (Legacy), необходимо указать параметры registry в [initConfiguration](/products/kubernetes-platform/documentation/v1/reference/api/cr.html#initconfiguration-deckhouse-imagesrepo).

### Ограничения по условиям работы

Модуль работает при соблюдении следующих условий:

- Если на узлах кластера используется CRI containerd или containerd v2. Для настройки CRI ознакомьтесь с конфигурацией [`ClusterConfiguration`](/products/kubernetes-platform/documentation/v1/reference/api/cr.html#clusterconfiguration-defaultcri).
- Кластер полностью управляется DKP. В Managed Kubernetes кластерах он работать не будет.
- Работа режимов `Local` и `Proxy` поддерживаются только на статичных кластерах.

### Ограничения по переключению режимов

Ограничения по переключению режимов следующие:

- Изменение параметров registry и переключение режимов доступны только после полного завершения этапа bootstrap.
- При первом переключении необходимо выполнить миграцию пользовательских конфигураций реестра. Подробнее — в разделе [«Модуль registry: FAQ»](./faq.html).
- Переключение в неконфигурируемый `Unmanaged` режим доступно только из `Unmanaged` режима. Подробнее — в разделе [«Модуль registry: FAQ»](./faq.html).
- Переключение между режимами `Local` и `Proxy` возможно только через промежуточные режимы `Direct` или `Unmanaged`. Пример последовательности переключения: `Local` → `Direct` → `Proxy`.

## Архитектура режима Direct

В режиме `Direct` запросы к registry обрабатываются напрямую, без промежуточного кэширования.

Перенаправление запросов к registry от CRI осуществляется при помощи его настроек, которые указываются в конфигурации `containerd`.

В случае таких компонентов, как `operator-trivy`, `image-availability-exporter`, `deckhouse-controller` и ряда других, обращающихся к registry напрямую, запросы будут идти через in-cluster proxy, расположенный на master-узлах.

<!--- Source: mermaid code from docs/internal/DIRECT.md --->
![direct](images/direct-ru.png)

## Архитектура режима Proxy

`Proxy` режим позволяет registry выступать в качестве промежуточного прокси-сервера между клиентом и удалённым реестром.

Запуск кеширующего proxy реестра осуществляется в виде статических подов на узлах control-plane (master). Хранение кешируемых данных выполняется на control-plane (master) узлах в директории `/opt/deckhouse/registry`.

Для обеспечения высокой доступности к кеширующему proxy реестру используется балансировщик, установленный на каждый узел кластера. Обращение к proxy реестру от CRI осуществляется через балансировщик. Настройки для обращения к балансировщику прописываются в конфигурации `containerd`.

В случае таких компонентов, как `operator-trivy`, `image-availability-exporter`, `deckhouse-controller` и ряда других, обращающихся к registry напрямую, запросы будут идти через кеширующий proxy реестр.

<!--- Source: mermaid code from docs/internal/PROXY.md --->
![direct](images/proxy-en.png)

## Архитектура режима Local

`Local` режим позволяет создавать локальную копию registry внутри кластера. Образы из удалённого реестра полностью скопированы в локальное хранилище и синхронизированны между репликами локального registry.

Работа локального registry идентична работе кеширующего proxy реестра. Запуск локального реестра осуществляется в виде статических подов на узлах control-plane (master). Хранение данных реестра выполняется на control-plane (master) узлах в директории `/opt/deckhouse/registry`.

Для обеспечения высокой доступности к локальному реестру используется балансировщик, установленный на каждый узел кластера. Обращение к локальному реестру от CRI осуществляется через балансировщик. Настройки для обращения к балансировщику прописываются в конфигурации `containerd`.

В случае таких компонентов, как `operator-trivy`, `image-availability-exporter`, `deckhouse-controller` и ряда других, обращающихся к registry напрямую, запросы будут идти в локальный реестр.

Наполнение локального реестра осуществляется через инструмент `d8`, команды `d8 mirror push/pull`. Подробнее — в разделе [«Модуль registry: пример использования»](examples.html)

<!--- Source: mermaid code from docs/internal/LOCAL.md --->
![direct](images/local-en.png)
