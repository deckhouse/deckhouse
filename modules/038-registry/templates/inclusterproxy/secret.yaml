{{- define "registry_incluster_proxy_auth_config_template" -}}
server:
  addr: ":5051"
  real_ip_header: "X-Forwarded-For"
  certificate: "/config/auth.crt"
  key: "/config/auth.key"
token:
  issuer: "Registry server"
  expiration: 900
  certificate: "/config/token.crt"
  key: "/config/token.key"
users:
  {{ .upstream.user.name | quote }}:
    password: {{ .upstream.user.password_hash | quote }}
acl:
  - match: { account: {{ .upstream.user.name | quote }} }
    actions: ["pull"]
{{- end -}}

{{- define "registry_incluster_proxy_distribution_config_template" -}}
version: 0.1
log:
  level: info
storage:
  filesystem:
    rootdirectory: /data
  # disable deletion of image blobs and manifests by digest
  delete:
    enabled: true
  redirect:
    disable: true
  maintenance:
    # stop uploadpurging background process
    uploadpurging:
      enabled: false
      age: 168h
      interval: 24h
      dryrun: false
    # not allowed to write to the registry
    readonly:
      enabled: true
http:
  addr: ":5001"
  prefix: /
  secret: {{ .http_secret | quote }}
  debug:
    addr: ":5002"
    prometheus:
      enabled: true
      path: /metrics
  tls:
    certificate: "/config/distribution.crt"
    key: "/config/distribution.key"
proxy:
  remoteurl: "{{ .upstream.scheme }}://{{ .upstream.host }}"
  {{- if (.upstream.user).name }}
  username: {{ .upstream.user.name | quote }}
  password: {{ .upstream.user.password | quote }}
  {{- end }}
  remotepathonly: {{ .upstream.path | quote }}
  localpathalias: "/system/deckhouse"
  {{- with .upstream.ca }}
  ca: "/config/upstream-registry-ca.crt"
  {{- end }}
  nocache: true
  {{- if (.upstream.user).name }}
auth:
  token:
    realm: "https://127.0.0.1:5051/auth"
    service: "Deckhouse registry"
    issuer: "Registry server"
    rootcertbundle: "/config/token.crt"
    autoredirect: true
    proxy:
      url: "https://127.0.0.1:5051/auth"
      ca: "/config/ca.crt"
  {{- end }}
{{- end -}}

{{- with $.Values.registry.internal.orchestrator }}
{{- with ((.state).in_cluster_proxy).config }}
{{- $version := .version }}
{{- with .config }}
---
apiVersion: v1
kind: Secret
metadata:
  name: registry-incluster-proxy-config
  namespace: d8-system
  {{- include "helm_lib_module_labels" (list $ (dict "app" "registry" "name" "registry-incluster-proxy-config")) | nindent 2 }}
  annotations:
    registry.deckhouse.io/version: {{ $version | quote }}
type: registry/incluster-proxy-config
data:
  distribution_config.yaml: {{ (include "registry_incluster_proxy_distribution_config_template" . ) | b64enc | quote }}
  distribution.crt:         {{ .distribution_cert | b64enc | quote }}
  distribution.key:         {{ .distribution_key | b64enc | quote }}
  ca.crt:                   {{ .ca | b64enc | quote }}
  {{- if (.upstream.user).name }}
  auth_config.yaml:         {{ (include "registry_incluster_proxy_auth_config_template" . ) | b64enc | quote }}
  auth.crt:                 {{ .auth_cert | b64enc | quote }}
  auth.key:                 {{ .auth_key | b64enc | quote }}
  token.crt:                {{ .token_cert | b64enc | quote }}
  token.key:                {{ .token_key | b64enc | quote }}
  {{- end }}
  {{- with .upstream.ca }}
  upstream-registry-ca.crt: {{ . | b64enc | quote }}
  {{- end }}

{{- end }}
{{- end }}
{{- end }}
