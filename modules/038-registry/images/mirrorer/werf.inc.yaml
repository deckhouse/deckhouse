{{ $appRelPath := printf "%s/modules/038-%s/images/%s/app" $.ModulePath $.ModuleName $.ImageName }}
{{ $appAbsPath := printf "/deckhouse/modules/038-%s/images/%s/app" $.ModuleName $.ImageName }}
---
image: "{{ $.ModuleName }}/{{ $.ImageName }}"
fromImage: common/distroless
import:
  - image: "{{ $.ModuleName }}/{{ $.ImageName }}-artifact"
    add: /tmp-tmp
    to: /tmp
    before: setup
  - image: "{{ $.ModuleName }}/{{ $.ImageName }}-artifact"
    add: "/mirrorer"
    to: /mirrorer
    before: setup
  - image: common/pause
    add: /pause
    to: /pause
    before: setup
imageSpec:
  config:
    entrypoint: ["/mirrorer"]
---
image: "{{ $.ModuleName }}/{{ $.ImageName }}-artifact"
fromImage: builder/golang-alpine
final: false
shell:
  beforeInstall:
    - mkdir -m 1777 /tmp-tmp
  install:
    - export GOPROXY={{ $.GOPROXY }}
    - cd {{ $appAbsPath }}
    - go mod download
  setup:
    - cd {{ $appAbsPath }}
    - GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go test ./...
    - GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags="-s -w" -o /mirrorer ./cmd/mirrorer
    - chown 64535:64535 /mirrorer
    - chmod 0755 /mirrorer
git:
  - add: /{{ $appRelPath }}
    to:  {{ $appAbsPath }}
    stageDependencies:
      install:
        - '**/*.mod'
        - '**/*.sum'
      setup:
        - "**/*"
mount:
  - fromPath: ~/go-pkg-cache
    to: /go/pkg
