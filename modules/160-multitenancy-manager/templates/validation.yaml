{{- if and (include "helm_lib_kind_exists" (list . "ValidatingAdmissionPolicy")) (include "helm_lib_kind_exists" (list . "ValidatingAdmissionPolicyBinding")) }}
{{- $policyName := "d8-multitenancy-manager" }}
---
apiVersion: {{ include "helm_lib_get_api_version_by_kind" (list . "ValidatingAdmissionPolicy") }}
kind: ValidatingAdmissionPolicy
metadata:
  name: {{ $policyName }}
  {{- include "helm_lib_module_labels" (list . (dict "app" "multitenancy-manager") ) | nindent 2 }}
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
      - apiGroups:   ["*"]
        apiVersions: ["*"]
        operations:  ["UPDATE", "DELETE"]
        resources:   ["*"]
        scope: "*"
  matchConditions:
    - name: 'exclude-groups'
      expression: '!(["system:nodes", "system:serviceaccounts:kube-system", "system:serviceaccounts:d8-system"].exists(e, (e in request.userInfo.groups)))'
    - name: 'exclude-users'
      expression: '!(["system:sudouser", "system:apiserver", "system:kube-controller-manager", "system:kube-scheduler", "system:volume-scheduler", "dhctl", "observability"].exists(e, (e == request.userInfo.username)))'
    - name: 'exclude-restartedAt'
      expression: '!((has(object.spec) && has(object.spec.template) && has(object.spec.template.metadata)
          && has(oldObject.spec) && has(oldObject.spec.template) && has(oldObject.spec.template.metadata))
          && ((!has(oldObject.spec.template.metadata.annotations) && has(object.spec.template.metadata.annotations)
          && "kubectl.kubernetes.io/restartedAt" in object.spec.template.metadata.annotations)
          || (has(oldObject.spec.template.metadata.annotations) && has(object.spec.template.metadata.annotations)
          && !("kubectl.kubernetes.io/restartedAt" in oldObject.spec.template.metadata.annotations)
          && "kubectl.kubernetes.io/restartedAt" in object.spec.template.metadata.annotations)
          || (has(oldObject.spec.template.metadata.annotations) && has(object.spec.template.metadata.annotations)
          && "kubectl.kubernetes.io/restartedAt" in oldObject.spec.template.metadata.annotations
          && "kubectl.kubernetes.io/restartedAt" in object.spec.template.metadata.annotations
          && oldObject.spec.template.metadata.annotations["kubectl.kubernetes.io/restartedAt"]
          != object.spec.template.metadata.annotations["kubectl.kubernetes.io/restartedAt"])))'
  validations:
    - expression: 'request.userInfo.username == "system:serviceaccount:d8-multitenancy-manager:multitenancy-manager"'
      reason: Forbidden
      messageExpression: 'object.kind == ''Namespace'' ? ''This resource is managed
            by '' + object.metadata.name + '' Project. Manual modification is forbidden.''
            : ''This resource is managed by '' + object.metadata.namespace + '' Project. Manual modification is forbidden.'''
---
apiVersion: {{ include "helm_lib_get_api_version_by_kind" (list . "ValidatingAdmissionPolicyBinding") }}
kind: ValidatingAdmissionPolicyBinding
metadata:
  name: {{ $policyName }}
  {{- include "helm_lib_module_labels" (list . (dict "app" "multitenancy-manager") ) | nindent 2 }}
spec:
  policyName: {{ $policyName }}
  validationActions: [Deny, Audit]
  matchResources:
    namespaceSelector:
      matchLabels:
        heritage: multitenancy-manager
    objectSelector:
      matchLabels:
        heritage: multitenancy-manager
{{- end }}
