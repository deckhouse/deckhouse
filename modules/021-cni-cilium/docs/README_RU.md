---
title: "Модуль cni-cilium"
description: Модуль cni-cilium Deckhouse обеспечивает работу сети в кластере Kubernetes с помощью Cilium.
---

Обеспечивает работу сети в кластере с помощью модуля [cilium](https://cilium.io/).

## Ограничения

1. Сервисы с типом `NodePort` и `LoadBalancer` не работают с hostNetwork-эндпоинтами в LB-режиме `DSR`. Переключитесь на режим `SNAT`, если это требуется.
2. `HostPort` поды биндятся только [к одному IP](https://github.com/deckhouse/deckhouse/issues/3035). Если в ОС есть несколько интерфейсов/IP, Cilium выберет один из них, предпочитая «серые» IP-адреса «белым».
3. Требования к ядру:
   * Для работы модуля `cni-cilium` необходимо ядро Linux версии >= `5.7`.
   * Для работы модуля `cni-cilium` совместно с модулем [istio](../110-istio/), [openvpn](../500-openvpn/) или [node-local-dns]({% if site.d8Revision == 'CE' %}{{ site.urls.ru}}/products/kubernetes-platform/documentation/v1/modules/{% else %}..{% endif %}/350-node-local-dns/) необходимо ядро Linux версии >= `5.7`.
4. Проблемы совместимости с ОС:
   * Ubuntu:
     * не работоспособно на 18.04
     * для работы на 20.04 необходима установка ядра HWE
   * Astra Linux:
     * не работоспособно на издании "Смоленск"
   * CentOS:
     * 7 (необходимо новое ядро из [репозитория](http://elrepo.org))
     * 8 (необходимо новое ядро из [репозитория](http://elrepo.org))

## Заметка об обработке внешнего трафика в разных режимах работы `bpfLB` (замена kube-proxy от cilium)

* `SNAT` (Source Network Address Translation) - это один из подвидов NAT при котором для каждого исходящего пакета происходит трансляция IP-адреса источника в IP-адрес шлюза из целевой подсети, а входящие пакеты, проходящие через шлюз, транслируются обратно на основе таблицы трансляций.
* Обычно используются схемы где трафик приходит на балансировщик, который распределяет его между многими терминирующими серверами. При этом и входящий и исходящий трафик проходят через балансировщик. Таким образом общая пропускная способность ограничена ресурсами и шириной канала балансировщика. Для оптимизации трафика и разгрузки балансировщика придуман механизм `DSR` (Direct Server Return), в котором входящие пакеты проходят через балансировщик, а исходящие идут напрямую с терминирующих серверов. Так как обычно ответы имеют много больший размер чем запросы, то такой подход позволяет значительно увеличить общую пропускную способность схемы  
В модуле возможен [выбор режима работы](./configuration.html#parameters-bpflbmode), влияющий на поведение `Service` с типом `NodePort` и `LoadBalancer`:

* `SNAT` (Source Network Address Translation) - в данном режиме `bpfLB` полностью повторяет логику работы `kube-proxy`: 
  * если в `Service` указан `externalTrafficPolicy: Local`, то трафик будет передаваться и балансироваться только в те целевые поды, которые запущены на том же узле, на который этот трафик пришел. Если целевой под не запущен на этом узле, то трафик будет отброшен.
  * если в `Service` указан `externalTrafficPolicy: Cluster`, то трафик будет передаваться и балансироваться во все целевые поды в кластере. 
    * при этом если целевые поды находятся на других узлах, то при передаче трафика на них будет произведен SNAT (IP-адрес источника будет заменен на InternalIP узла).
* `DSR` (Direct Server Return) - в данном режиме при пересылке трафика на другую ноду вместо SNAT используется механизм DSR, при котором входящий и исходящий трафик идут асимметричными путями:
  * если в `Service` указан `externalTrafficPolicy: Local`, то поведение абсолютно аналогично `kube-proxy` и `bpfLB` в режиме SNAT
  * если в `Service` указан `externalTrafficPolicy: Cluster`, то трафик так же будет передаваться и балансироваться во все целевые поды в кластере. При этом
    * если целевые поды находятся на других узлах, то при передаче на них входящего трафика будет сохранен IP-адрес источника
    * исходящий трафик пойдет прямо с узла, на котором был запущен целевой под
    * IP-адрес источника при этом будет заменен на внешний IP-адрес ноды, на которую изначально пришел входящий запрос. 
    * Cетевое окружение должно быть готово к такому поведению: отключены или настроены соответствующим образом средства антиспуфинга IP адресов (uRPF, sourceGuard и тп).
* `Hybrid` - в данном режиме TCP трафик обрабатывается в режиме `DSR`, а UDP - в режиме `SNAT`.


## Заметка о CiliumClusterwideNetworkPolicies

1. Убедитесь, что вы применили первичный набор объектов `CiliumClusterwideNetworkPolicy`, поставив конфигурационную опцию `policyAuditMode` в `true`.
   Отсутствие опции может привести к некорректной работе control plane или потере доступа ко всем узлам кластера по SSH.
   Вы можете удалить опцию после применения всех `CiliumClusterwideNetworkPolicy`-объектов и проверки корректности их работы в Hubble UI.
2. Убедитесь, что вы применили следующее правило. В противном случае control plane может некорректно работать до одной минуты во время перезагрузки `cilium-agent`-подов. Это происходит из-за [сброса conntrack таблицы](https://github.com/cilium/cilium/issues/19367). Привязка к entity `kube-apiserver` позволяет обойти баг.

   ```yaml
   apiVersion: "cilium.io/v2"
   kind: CiliumClusterwideNetworkPolicy
   metadata:
     name: "allow-control-plane-connectivity"
   spec:
     ingress:
     - fromEntities:
       - kube-apiserver
     nodeSelector:
       matchLabels:
         node-role.kubernetes.io/control-plane: ""
   ```

## Заметка о смене режима работы Cilium

При смене режима работы Cilium (параметр [tunnelMode](configuration.html#parameters-tunnelmode)) c `Disabled` на `VXLAN` или обратно необходимо перезагрузить все узлы, иначе возможны проблемы с доступностью подов.

## Заметка о выключении модуля kube-proxy

Cilium полностью заменяет собой функционал модуля kube-proxy, поэтому тот автоматически отключается при включении модуля cni-cilium.

## Заметка об отказоустойчивом Egress Gateway

{% alert level="warning" %} Функция доступна только в Enterprise Edition {% endalert %}

### Базовый режим

Используются предварительно настроенные IP-адреса на egress-узлах.

<div data-presentation="../../presentations/021-cni-cilium/egressgateway_base_ru.pdf"></div>
<!--- Source: https://docs.google.com/presentation/d/12l4w9ZS3Hpax1B7eOptm2dQX55VVAFzRTtyihw4Ie0c/ --->

### Режим с Virtual IP

Позволяет динамически назначать дополнительные IP-адреса узлам.

<div data-presentation="../../presentations/021-cni-cilium/egressgateway_virtualip_ru.pdf"></div>
<!--- Source: https://docs.google.com/presentation/d/1tmhbydjpCwhNVist9RT6jzO1CMpc-G1I7rczmdLzV8E/ --->
