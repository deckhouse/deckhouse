# #####################################################################
# Runtime artifact (based on Ubuntu)
# Based on https://github.com/cilium/cilium/blob/v1.14.5/images/runtime/Dockerfile
# and https://github.com/cilium/cilium/blob/v1.14.5/images/runtime/install-runtime-deps.sh
---
image: {{ $.ModuleName }}/runtime-artifact
from: {{ $.Images.BASE_UBUNTU }}
import:
- artifact: {{ $.ModuleName }}/llvm-artifact
  add: /usr/local/bin/
  to: /usr/local/bin
  before: install
  includePaths:
  - clang
  - llc
- artifact: {{ $.ModuleName }}/bpftool-artifact
  add: /usr/local/bin/bpftool
  to: /usr/local/bin/bpftool
  before: install
- artifact: {{ $.ModuleName }}/cni-plugins-artifact
  add: /out/linux/amd64/bin/loopback
  to: /cni/loopback
  before: install
- artifact: {{ $.ModuleName }}/gops-artifact
  add: /out/linux/amd64/bin/gops
  to: /bin/gops
  before: install
- artifact: {{ $.ModuleName }}/iptables-artifact
  add: /iptables
  to: /iptables
  before: install
- artifact: {{ $.ModuleName }}/cilium-src
  add: /go/src/github.com/cilium/cilium/images/runtime/
  to: /go/src/github.com/cilium/cilium/images/runtime
  before: install
  includePaths:
  - iptables-wrapper-installer.sh
shell:
  beforeInstall:
  - apt-get update
  - apt-get upgrade -y
  - apt-get install -y jq curl tzdata strace
  install:
  - chmod +x /go/src/github.com/cilium/cilium/images/runtime/*.sh
  - cd /go/src/github.com/cilium/cilium/images/runtime
  - export DEBIAN_FRONTEND=noninteractive
  - apt-get update
  - ln -fs /usr/share/zoneinfo/UTC /etc/localtime
  - apt-get install -y --no-install-recommends bash-completion iproute2 iptables ipset kmod ca-certificates
  - apt-get purge --auto-remove
  - apt-get clean
  - rm -rf /var/lib/apt/lists/*
  - dpkg -i /iptables/*.deb
  - rm -rf /iptables
  - ./iptables-wrapper-installer.sh --no-sanity-check
---
