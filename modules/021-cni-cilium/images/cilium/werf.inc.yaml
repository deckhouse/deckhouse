{{- $protocVersion := "22.3" }}
{{- $ciliumVersion := "1.14.5" }}
---
artifact: {{ $.ModuleName }}/golang-artifact
from: {{ $.Images.BASE_GOLANG_20_BULLSEYE }}
---
# #####################################################################
# Artifact with src from repo cilium/cilium
---
artifact: {{ $.ModuleName }}/cilium-src
from: {{ $.Images.BASE_ALPINE }}
shell:
  beforeInstall:
  - apk add --no-cache git
  install:
  - mkdir -p /go/src/github.com/cilium/cilium
  - git clone --depth 1 --branch v{{ $ciliumVersion }} {{ $.SOURCE_REPO }}/cilium/cilium.git /go/src/github.com/cilium/cilium
---
# #####################################################################
# Runtime+Build artifact for build cilium-agent binaries (based on Ubuntu)
# Based on https://github.com/cilium/cilium/blob/v1.14.5/images/runtime/Dockerfile
# and https://github.com/cilium/cilium/blob/v1.14.5/images/runtime/install-runtime-deps.sh
# and https://github.com/cilium/cilium/blob/v1.14.5/images/builder/Dockerfile
---
image: {{ $.ModuleName }}/cilium-builder-artifact
from: {{ $.Images.BASE_UBUNTU }}
import:
- artifact: {{ $.ModuleName }}/llvm-artifact
  add: /usr/local/bin/
  to: /usr/local/bin
  before: install
  includePaths:
  - clang
  - llc
  - llvm-objcopy
- artifact: {{ $.ModuleName }}/bpftool-artifact
  add: /usr/local/bin/bpftool
  to: /usr/local/bin/bpftool
  before: install
- artifact: {{ $.ModuleName }}/cni-plugins-artifact
  add: /out/linux/amd64/bin/loopback
  to: /cni/loopback
  before: install
- artifact: {{ $.ModuleName }}/gops-artifact
  add: /out/linux/amd64/bin/gops
  to: /bin/gops
  before: install
- artifact: {{ $.ModuleName }}/iptables-artifact
  add: /iptables
  to: /iptables
  before: install
- artifact: {{ $.ModuleName }}/cilium-src
  add: /go/src/github.com/cilium/cilium/images/runtime/
  to: /go/src/github.com/cilium/cilium/images/runtime
  before: install
  includePaths:
  - iptables-wrapper-installer.sh
- artifact: {{ $.ModuleName }}/golang-artifact
  add: /usr/local/go
  to: /usr/local/go
  before: install
mount:
- fromPath: ~/go-pkg-cache
  to: /go/pkg
shell:
  beforeInstall:
  - export DEBIAN_FRONTEND=noninteractive
  - export TZ=Etc/UTC
  - ln -snf /usr/share/zoneinfo/${TZ} /etc/localtime && echo ${TZ} > /etc/timezone
  - apt-get update && apt-get upgrade -y --no-install-recommends
  - apt-get install -y --no-install-recommends jq curl tzdata strace
  - apt-get install -y --no-install-recommends bash-completion iproute2 iptables ipset kmod ca-certificates
  - |
    apt-get install -y --no-install-recommends \
    gcc-x86-64-linux-gnu g++-x86-64-linux-gnu libc6-dev-amd64-cross binutils-x86-64-linux-gnu \
    gcc libc6-dev binutils coreutils curl git make patch unzip
  - apt-get purge --auto-remove && apt-get clean
  - rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
  install:
  - dpkg -i /iptables/*.deb
  - rm -rf /iptables
  - chmod +x /go/src/github.com/cilium/cilium/images/runtime/*.sh
  - cd /go/src/github.com/cilium/cilium/images/runtime
  - ./iptables-wrapper-installer.sh --no-sanity-check
  #
  - export GOROOT=/usr/local/go GOPATH=/go
  - export PATH=${GOROOT}/bin:${GOPATH}/bin:${PATH}
  - export GO_VERSION=${GOLANG_VERSION} GOPROXY={{ $.GOPROXY }}
  - export GOOS=linux GOARCH=amd64 CGO_ENABLED=0
  - curl --fail --show-error --silent --location "https://github.com/protocolbuffers/protobuf/releases/download/v{{ $protocVersion }}/protoc-{{ $protocVersion }}-linux-x86_64.zip" --output /tmp/protoc.zip
  - unzip /tmp/protoc.zip -x readme.txt -d /usr/local
  - chmod o+rx /usr/local/bin/protoc
  - chmod o+rX -R /usr/local/include/google/
  # 8ba23be9613c672d40ae261d2a1335d639bdd59b == tag: cmd/protoc-gen-go-grpc/v1.3.0
  - go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@8ba23be9613c672d40ae261d2a1335d639bdd59b
  - go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.30.0
  - go install github.com/mitchellh/protoc-gen-go-json@v1.1.0
  - go install github.com/pseudomuto/protoc-gen-doc/cmd/protoc-gen-doc@v1.5.1
---
# #####################################################################
# Build cilium-agent binaries
# Based on https://github.com/cilium/cilium/blob/v1.14.5/images/cilium/Dockerfile (builder stage)
---
artifact: {{ $.ModuleName }}/cilium-artifact
fromImage: {{ $.ModuleName }}/cilium-builder-artifact
git:
- add: /{{ $.ModulePath }}modules/021-{{ $.ModuleName }}/images/cilium/patches
  to: /patches
  stageDependencies:
    install:
      - '**/*'
import:
- artifact: {{ $.ModuleName }}/cilium-src
  add: /go/src/github.com/cilium/cilium
  to: /go/src/github.com/cilium/cilium
  before: install
mount:
- fromPath: ~/go-pkg-cache
  to: /go/pkg
shell:
  install:
  - export PATH=$PATH:/usr/local/go/bin
  - cd /go/src/github.com/cilium/cilium
  - find /patches -name '*.patch' -exec git apply {} \;
  - make PKG_BUILD=1 SKIP_DOCS=true DESTDIR=/tmp/install build-container install-container-binary
  - make PKG_BUILD=1 SKIP_DOCS=true DESTDIR=/tmp/install install-bash-completion licenses-all
  - mv LICENSE.all /tmp/install/LICENSE.all
  - cp -t /tmp/install images/cilium/init-container.sh plugins/cilium-cni/install-plugin.sh plugins/cilium-cni/cni-uninstall.sh
---
