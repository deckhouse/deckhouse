# https://github.com/cilium/cilium/blob/v1.11.14/images/runtime/Dockerfile#L7-L12
{{- $golangImage := "docker.io/library/golang:1.17.13@sha256:87262e4a4c7db56158a80a18fefdc4fee5accc41b59cde821e691d05541bbb18" }}
{{- $ubuntuImage := "docker.io/library/ubuntu:20.04@sha256:4a45212e9518f35983a976eead0de5eecc555a2f047134e9dd2cfc589076a00d" }}
{{- $ciliumLLVMImage := "quay.io/cilium/cilium-llvm:0147a23fdada32bd51b4f313c645bcb5fbe188d6@sha256:24fd3ad32471d0e45844c856c38f1b2d4ac8bd0a2d4edf64cffaaa3fd0b21202" }}
{{- $ciliumBPFToolImage := "quay.io/cilium/cilium-bpftool:7a5420acb4a0fa276a549eb4674515eadb2821d7@sha256:3e204885a1b9ec2a5b593584608664721ef0bd221d3920c091c2e77eb259090c" }}
{{- $ciliumIPRoute2Image := "quay.io/cilium/cilium-iproute2:824df0c341c724f4b12cc48762f80aa3d698b589@sha256:0af5e059b2a43c6383a3daa293182b50cb88f7761f543dacf43c1c3f8f79030c" }}

# https://github.com/cilium/cilium/blob/v1.11.14/images/cilium/Dockerfile#L6
{{- $ciliumBuilderImage := "quay.io/cilium/cilium-builder:a453bffcfd267482d51a71cd3b9a969c5dcfb596@sha256:57067753e56813d481da260cd2b592e1368f35fdff51a1259f0bb0818fd7dc49" }}

---
artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact-gops-cni-builder
from: {{ $golangImage }}
git:
  - add: /modules/021-{{ $.ModuleName }}/images/{{ $.ImageName }}
    to: /go/src/github.com/cilium/cilium/images/runtime
    stageDependencies:
      setup:
      - '**/*'
    includePaths:
    - build-gops.sh
    - download-cni.sh
    - cni-version.sh
shell:
  setup:
  - apt-get update
  - apt-get install -y binutils-aarch64-linux-gnu binutils-x86-64-linux-gnu
  - cd /go/src/github.com/cilium/cilium/images/runtime
  - ./download-cni.sh
---
artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact-llvm-dist
from: {{ $ciliumLLVMImage }}
---
artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact-bpftool-dist
from: {{ $ciliumBPFToolImage }}
---
artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact-iproute2-dist
from: {{ $ciliumIPRoute2Image }}
---
artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact-rootfs
from: {{ $golangImage }}
shell:
  setup:
  # Update ubuntu packages to the most recent versions
  - apt-get update
  - apt-get upgrade -y
  - cd /go/src/github.com/cilium/cilium/images/runtime
  - ./install-runtime-deps.sh
  - ./iptables-wrapper-installer.sh
import:
  - artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact-llvm-dist
    add: /usr/local/bin
    to: /bin
    includePaths:
      - clang
      - llc
    before: setup
  - artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact-bpftool-dist
    add: /usr
    to: /usr
    includePaths:
      - local
    before: setup
  - artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact-iproute2-dist
    add: /usr/lib
    to: /usr/lib
    includePaths:
      - libbpf*
    before: setup
  - artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact-iproute2-dist
    add: /usr
    to: /usr
    includePaths:
      - local
    before: setup
git:
  - add: /modules/021-{{ $.ModuleName }}/images/{{ $.ImageName }}
    to: /go/src/github.com/cilium/cilium/images/runtime
    stageDependencies:
      setup:
      - '**/*'
    includePaths:
    - install-runtime-deps.sh
    - iptables-wrapper-installer.sh
---
# cilium-envoy from github.com/cilium/proxy
#
# https://github.com/cilium/cilium/blob/v1.11.14/images/cilium/Dockerfile#L11
artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact-cilium-envoy
from: quay.io/cilium/cilium-envoy:d59b7f950565d4ccad5c9e30f725740271b7f1c2@sha256:a9c20ee37fe8b280606b096f34f074fed02a347381ded71f1853a214a324a9ef
---
#
# Cilium builder image with tools and source code
#
artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact-cilium-builder
from: {{ $ciliumBuilderImage }}
shell:
  setup:
  - apt-get update
  - apt-get install patch curl -y
  - mkdir /tmp/cilium-repo
  - curl -sSL https://github.com/cilium/cilium/archive/refs/tags/v1.11.14.tar.gz | tar xvz -C /tmp/cilium-repo
---
#
# Hubble CLI
#
artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact-hubble
from: {{ $.ModuleName }}/{{ $.ImageName }}-artifact-cilium-builder
shell:
  setup:
  - bash /tmp/cilium-repo/cilium-1.11.14/images/cilium/download-hubble.sh
  - /out/linux/amd64/bin/hubble completion bash > /out/linux/bash_completion
---
artifact: {{ $.ModuleName }}/{{ $.ImageName }}-builder
from: {{ $.ModuleName }}/{{ $.ImageName }}-artifact-cilium-builder
git:
  - add: /modules/021-{{ $.ModuleName }}/images/{{ $.ImageName }}/patches
    to: /
    stageDependencies:
      setup:
      - '**/*'
    includePaths:
    - *.patch
shell:
  setup:
  - cd /tmp/cilium-repo/cilium-1.11.14
  - patch -p1 < /001-request-ip.patch
  - patch -p1 < /002-stable-mac.patch
  - patch -p1 < /003-mtu.patch
  - make PKG_BUILD=1 SKIP_DOCS=true DESTDIR=/tmp/install build-container install-container-binary
  - make PKG_BUILD=1 SKIP_DOCS=true DESTDIR=/tmp/install install-bash-completion licenses-all
  - mv LICENSE.all /tmp/install/LICENSE.all
  - cp -t /tmp/install images/cilium/init-container.sh plugins/cilium-cni/cni-install.sh plugins/cilium-cni/cni-uninstall.sh
---
#
# Cilium runtime install.
#
# cilium-runtime tag is a date on which the compatible runtime base
# was pushed.  If a new version of the runtime is needed, it needs to
# be tagged with a new date and this file must be changed accordingly.
# Keeping the old runtimes available will allow older versions to be
# built while allowing the new versions to make changes that are not
# backwards compatible.
#
image: {{ $.ModuleName }}/{{ $.ImageName }}
from: {{ $.ModuleName }}/{{ $.ImageName }}-artifact-rootfs
shell:
  setup:
  - groupadd -f cilium
  - echo ". /etc/profile.d/bash_completion.sh" >> /etc/bash.bashrc
import:
  - artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact-cilium-envoy
    add: /
    to: /
    includePaths:
      - '**/*'
    before: setup
  - artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact-hubble
    add: /out/linux/amd64/bin
    to: /usr/bin
    includePaths:
      - hubble
  - artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact-hubble
    add: /out/linux/
    to: /etc/bash_completion.d
    includePaths:
      - bash_completion
    before: setup
  - artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact-cilium-builder
    add: /tmp/install
    to: /
    includePaths:
      - '**/*'
    before: setup
docker:
  WORKDIR: /home/cilium
  ENV:
  - INITSYSTEM: "SYSTEMD"
  CMD: ["/usr/bin/cilium"] 
