---
# #####################################################################
# Build cilium-agent binaries
---
artifact: {{ $.ModuleName }}/{{ $.ImageName }}-builder-artifact
fromImage: {{ $.ModuleName }}/builder-artifact
git:
- add: /{{ $.ModulePath }}modules/021-{{ $.ModuleName }}/images/{{ $.ImageName }}/patches
  to: /patches
  stageDependencies:
    install:
      - '**/*'
import:
- artifact: {{ $.ModuleName }}/builder-src
  add: /go/src/github.com/cilium/cilium
  to: /go/src/github.com/cilium/cilium
  before: install
mount:
- fromPath: ~/go-pkg-cache
  to: /go/pkg
shell:
  install:
  - export PATH=$PATH:/usr/local/go/bin
  - cd /go/src/github.com/cilium/cilium
  - find /patches -name '*.patch' -exec git apply {} \;
  - make PKG_BUILD=1 SKIP_DOCS=true DESTDIR=/tmp/install build-container install-container-binary
  - make PKG_BUILD=1 SKIP_DOCS=true DESTDIR=/tmp/install install-bash-completion licenses-all
  - mv LICENSE.all /tmp/install/LICENSE.all
  - cp -t /tmp/install images/cilium/init-container.sh plugins/cilium-cni/install-plugin.sh plugins/cilium-cni/cni-uninstall.sh
---
# #####################################################################
# Old Main Image
---
image: {{ $.ModuleName }}/{{ $.ImageName }}
fromImage: {{ $.ModuleName }}/builder-runtime-artifact
import:
- artifact: {{ $.ModuleName }}/{{ $.ImageName }}-builder-artifact
  add: /tmp/install
  to: /
  before: install
- artifact: {{ $.ModuleName }}/builder-envoy-artifact
  add: /usr/bin/cilium-envoy
  to: /usr/bin/cilium-envoy
  before: install
- artifact: {{ $.ModuleName }}/builder-hubble-artifact
  add: /out/linux/amd64/bin/hubble
  to: /usr/bin/hubble
  before: install
- artifact: {{ $.ModuleName }}/builder-hubble-artifact
  add: /out/linux/bash_completion
  to: /etc/bash_completion.d/hubble
  before: install
- image: common/pause
  add: /pause
  to: /pause
  before: install
shell:
  install:
  - groupadd -f cilium
  - echo ". /etc/profile.d/bash_completion.sh" >> /etc/bash.bashrc
  - rm -rf /go
docker:
  ENV:
    HUBBLE_SERVER: "unix:///var/run/cilium/hubble.sock"
    INITSYSTEM: SYSTEMD
    HUBBLE_COMPAT: legacy-json-output
  WORKDIR: "/home/cilium"
  CMD: ["/usr/bin/cilium"]
---
# #####################################################################
# New Main Image (Distroless)
---
image: {{ $.ModuleName }}/{{ $.ImageName }}-distroless
fromImage: {{ $.ModuleName }}/builder-distroless-runtime-artifact
import:
- artifact: {{ $.ModuleName }}/{{ $.ImageName }}-builder-artifact
  add: /tmp/install
  to: /
  before: install
- artifact: {{ $.ModuleName }}/builder-envoy-artifact
  add: /usr/bin/cilium-envoy
  to: /usr/bin/cilium-envoy
  before: install
- artifact: {{ $.ModuleName }}/builder-hubble-artifact
  add: /out/linux/amd64/bin/hubble
  to: /usr/bin/hubble
  before: install
- artifact: {{ $.ModuleName }}/builder-hubble-artifact
  add: /out/linux/bash_completion
  to: /etc/bash_completion.d/hubble
  before: install
docker:
  ENV:
    HUBBLE_SERVER: "unix:///var/run/cilium/hubble.sock"
    INITSYSTEM: SYSTEMD
    HUBBLE_COMPAT: legacy-json-output
    PATH: "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  WORKDIR: "/home/cilium"
  CMD: ["/usr/bin/cilium"]
