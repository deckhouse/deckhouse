{{- $ciliumVersion := "1.14.5" }}
# Source repo  settings. Delete after clone repo to fox
{{- $_ := set . "SOURCE_REPO" "https://github.com" }}
---
# #####################################################################
# Artifact with repo cilium/cilium
---
artifact: {{ $.ModuleName }}/cilium-src
from: {{ $.Images.BASE_ALPINE }}
shell:
  beforeInstall:
  - apk add --no-cache git
  install:
  - mkdir -p /go/src/github.com/cilium/cilium
  - git clone --depth 1 --branch v{{ $ciliumVersion }} {{ $.SOURCE_REPO }}/cilium/cilium.git /go/src/github.com/cilium/cilium
---
# #####################################################################
# Build cilium-agent binaries
---
artifact: {{ $.ModuleName }}/cilium-builder-artifact
fromImage: {{ $.ModuleName }}/builder-artifact
git:
- add: /{{ $.ModulePath }}modules/021-{{ $.ModuleName }}/images/cilium/patches
  to: /patches
  stageDependencies:
    install:
      - '**/*'
import:
- artifact: {{ $.ModuleName }}/cilium-src
  add: /go/src/github.com/cilium/cilium
  to: /go/src/github.com/cilium/cilium
  before: install
mount:
- fromPath: ~/go-pkg-cache
  to: /go/pkg
shell:
  install:
  - export PATH=$PATH:/usr/local/go/bin
  - cd /go/src/github.com/cilium/cilium
  - find /patches -name '*.patch' -exec git apply {} \;
  - make PKG_BUILD=1 SKIP_DOCS=true DESTDIR=/tmp/install build-container install-container-binary
  - make PKG_BUILD=1 SKIP_DOCS=true DESTDIR=/tmp/install install-bash-completion licenses-all
  - mv LICENSE.all /tmp/install/LICENSE.all
  - cp -t /tmp/install images/cilium/init-container.sh plugins/cilium-cni/install-plugin.sh plugins/cilium-cni/cni-uninstall.sh
---
