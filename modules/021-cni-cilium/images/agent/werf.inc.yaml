{{- $fromCacheVersion := "19" }}
# #####################################################################
# Final image of cilium-agent (used in helm-templates)
# Based on https://github.com/cilium/cilium/blob/v1.14.5/images/runtime/Dockerfile
# and https://github.com/cilium/cilium/blob/v1.14.5/images/runtime/install-runtime-deps.sh
# and https://github.com/cilium/cilium/blob/v1.14.5/images/cilium/Dockerfile (release stage)
---
# #####################################################################
# List of binary files used by agent
# from base install script
## ln -snf /usr/share/zoneinfo/Etc/UTC /etc/localtime
{{ $binaries := "" }}
# iproute2 and dependencies
{{ $binaries := cat $binaries "/usr/sbin/arpd" }}
# clang and dependencies
{{ $binaries := cat $binaries "/usr/lib/x86_64-linux-gnu/libstdc++.so.6" }}
# bash-completion
{{ $binaries := cat $binaries "/etc/profile.d/bash_completion.sh" }}
# iptables and dependencies
{{ $binaries := cat $binaries "/usr/sbin/xtables* /usr/sbin/arptables* /usr/sbin/ebtables* /usr/sbin/ip6tables* /usr/sbin/iptables* /usr/sbin/ipset* /usr/bin/iptables-xml" }}
{{ $binaries := cat $binaries "/usr/sbin/nfnl_osf" }}
{{ $binaries := cat $binaries "/usr/lib/x86_64-linux-gnu/xtables/*" }}
# for debug
{{ $binaries := cat $binaries "/usr/bin/strace" }}
#
### binary files that can be copied from BASE_ALT_DEV
#
# from base install script
{{ $binaries := cat $binaries "/etc/localtime /usr/bin/jq" }}
# shell-scripts dependencies
{{ $binaries := cat $binaries "/bin/bash /bin/sh /bin/echo /bin/printf /bin/sed /bin/awk /bin/nsenter /bin/mount /bin/mkdir /bin/basename" }}
{{ $binaries := cat $binaries "/bin/cat /bin/head /bin/cut /bin/od /bin/grep /bin/cp /bin/mv /bin/rm /bin/ln /bin/wc /bin/find" }}
# kmod and dependencies
{{ $binaries := cat $binaries "/bin/kmod /bin/lsmod /sbin/depmod /sbin/insmod /sbin/lsmod /sbin/modinfo /sbin/modprobe /sbin/rmmod" }}
# iproute2 and dependencies
{{ $binaries := cat $binaries "/bin/ip /bin/ss /sbin/ip /sbin/bridge /sbin/dcb /sbin/devlink /sbin/rtacct /sbin/rtmon /sbin/tc /sbin/tipc /sbin/vdpa /usr/bin/lnstat" }}
{{ $binaries := cat $binaries "/usr/bin/nstat /usr/bin/rdma /usr/bin/routef /usr/bin/routel /usr/bin/ctstat /usr/bin/rtstat /usr/sbin/genl" }}
# bash-completion
{{ $binaries := cat $binaries "/usr/share/bash-completion/bash_completion" }}
# groups
{{ $binaries := cat $binaries "/usr/bin/groups" }}
# for prepull
{{ $binaries := cat $binaries "/usr/bin/true" }}
# for debug
{{ $binaries := cat $binaries "/usr/bin/sleep /bin/ls /usr/bin/curl /usr/bin/ldd" }}

#####################################################################
# from base install script
## ln -snf /usr/share/zoneinfo/Etc/UTC /etc/localtime
{{ $binariesFromALT := "/etc/localtime /usr/bin/jq" }}
# shell-scripts dependencies
{{ $binariesFromALT := cat $binariesFromALT "/bin/bash /bin/sh /bin/echo /usr/bin/printf /bin/sed /bin/awk /usr/bin/nsenter /bin/mount /bin/mkdir /bin/basename" }}
{{ $binariesFromALT := cat $binariesFromALT "/bin/cat /bin/head /bin/cut /usr/bin/od /bin/grep /bin/cp /bin/mv /bin/rm /bin/ln /bin/wc /bin/find" }}
# kmod and dependencies
{{ $binariesFromALT := cat $binariesFromALT "/bin/kmod /bin/lsmod /sbin/depmod /sbin/insmod /sbin/lsmod /sbin/modinfo /sbin/modprobe /sbin/rmmod" }}
# iproute2 and dependencies
{{ $binariesFromALT := cat $binariesFromALT "/sbin/ip /usr/sbin/ss /sbin/ip /usr/sbin/bridge /sbin/dcb /sbin/devlink /usr/sbin/rtacct /sbin/rtmon /sbin/tc /usr/sbin/tipc /sbin/vdpa /usr/bin/lnstat" }}
{{ $binariesFromALT := cat $binariesFromALT "/usr/bin/nstat /sbin/rdma /usr/sbin/routef /usr/sbin/routel /usr/sbin/ctstat /usr/sbin/rtstat /usr/sbin/genl" }}
# bash-completion
{{ $binariesFromALT := cat $binariesFromALT "/usr/share/bash-completion/bash_completion" }}
# groups
{{ $binariesFromALT := cat $binariesFromALT "/usr/bin/groups" }}
# for prepull
{{ $binariesFromALT := cat $binariesFromALT "/bin/true" }}
# for debug
{{ $binariesFromALT := cat $binariesFromALT "/bin/sleep /bin/ls /usr/bin/curl /usr/bin/ldd" }}
#####################################################################
{{ $selfBuildedBinaries := "" }}
# from llvm-artifact
{{ $selfBuildedBinaries := cat $selfBuildedBinaries "/usr/local/bin/clang /usr/local/bin/llc" }}
# from bpftool-artifact
{{ $selfBuildedBinaries := cat $selfBuildedBinaries "/usr/local/bin/bpftool" }}
# from cilium-envoy-artifact
{{ $selfBuildedBinaries := cat $selfBuildedBinaries "/usr/bin/cilium-envoy /usr/lib/libcilium.so" }}
# from cni-plugins-artifact
{{ $selfBuildedBinaries := cat $selfBuildedBinaries "/cni/loopback" }}
# from gops-artifact
{{ $selfBuildedBinaries := cat $selfBuildedBinaries "/bin/gops" }}
# from hubble-artifact
{{ $selfBuildedBinaries := cat $selfBuildedBinaries "/usr/bin/hubble /etc/bash_completion.d/hubble" }}
# from cilium-artifact
{{ $selfBuildedBinaries := cat $selfBuildedBinaries "/cni-uninstall.sh /init-container.sh /install-plugin.sh" }}
{{ $selfBuildedBinaries := cat $selfBuildedBinaries "/LICENSE.all /etc/bash_completion.d/cilium" }}
{{ $selfBuildedBinaries := cat $selfBuildedBinaries "/opt/cni/bin/cilium-cni /usr/bin/cilium*" }}
# from common/pause
{{ $selfBuildedBinaries := cat $selfBuildedBinaries "/pause" }}
# #####################################################################
---
artifact: {{ $.ModuleName }}/alt-binaries-artifact
from: {{ $.Images.BASE_ALT_DEV }}
fromCacheVersion: {{ $fromCacheVersion }}
git:
- add: /{{ $.ModulePath }}modules/{{ $.ModulePriority }}-{{ $.ModuleName }}/images/{{ $.ImageName }}
  to: /
  includePaths:
  - binary_replace.sh
  stageDependencies:
    install:
    - binary_replace.sh
shell:
  setup:
    - ln -snf /usr/share/zoneinfo/Etc/UTC /etc/localtime
    - mkdir -p /relocate
    - /binary_replace.sh -i "{{ $binariesFromALT }}" -o /relocate
---
# #####################################################################
# Binaries artifact for distroless agent (based on Ubuntu)
---
artifact: {{ $.ModuleName }}/agent-binaries-artifact
fromImage: {{ $.ModuleName }}/base-cilium-dev
fromCacheVersion: {{ $fromCacheVersion }}
git:
- add: /{{ $.ModulePath }}modules/{{ $.ModulePriority }}-{{ $.ModuleName }}/images/{{ $.ImageName }}
  to: /
  includePaths:
  - binary_replace.sh
  stageDependencies:
    install:
    - binary_replace.sh
import:
- artifact: {{ $.ModuleName }}/llvm-artifact
  add: /usr/local/bin/
  to: /usr/local/bin
  before: install
  includePaths:
  - clang
  - llc
- artifact: {{ $.ModuleName }}/bpftool-artifact
  add: /usr/local/bin/bpftool
  to: /usr/local/bin/bpftool
  before: install
- artifact: {{ $.ModuleName }}/cni-plugins-artifact
  add: /out/linux/amd64/bin/loopback
  to: /cni/loopback
  before: install
- artifact: {{ $.ModuleName }}/gops-artifact
  add: /out/linux/amd64/bin/gops
  to: /bin/gops
  before: install
- artifact: {{ $.ModuleName }}/iptables-artifact
  add: /iptables
  to: /iptables
  before: install
- artifact: {{ $.ModuleName }}/cilium-artifact
  add: /go/src/github.com/cilium/cilium/images/runtime/orig/
  to: /go/src/github.com/cilium/cilium/images/runtime
  before: install
  includePaths:
  - iptables-wrapper-installer.sh
- artifact: {{ $.ModuleName }}/cilium-artifact
  add: /tmp/install
  to: /
  before: install
  includePaths:
  - cni-uninstall.sh
  - init-container.sh
  - install-plugin.sh
  - LICENSE.all
  - etc/bash_completion.d/cilium
  - opt/cni/bin/cilium-cni
  - usr/bin/cilium*
  - var/lib/cilium/bpf
- artifact: {{ $.ModuleName }}/cilium-envoy-artifact
  add: /tmp/install/usr
  to: /usr
  before: install
  includePaths:
  - bin/cilium-envoy
  - lib/libcilium.so
- artifact: {{ $.ModuleName }}/hubble-artifact
  add: /hubble
  to: /usr/bin/hubble
  before: install
- artifact: {{ $.ModuleName }}/hubble-artifact
  add: /bash_completion
  to: /etc/bash_completion.d/hubble
  before: install
- artifact: {{ $.ModuleName }}/alt-binaries-artifact
  add: /relocate
  to: /relocateFromALT
  before: install
- image: common/pause
  add: /pause
  to: /pause
  before: install
- image: common/distroless
  add: /etc/group
  to: /from_common_distroless/group
  before: setup
shell:
  install:
  # from runtime
  - dpkg -i /iptables/*.deb
  - rm -rf /iptables
  - chmod +x /go/src/github.com/cilium/cilium/images/runtime/*.sh
  - cd /go/src/github.com/cilium/cilium/images/runtime
  - ./iptables-wrapper-installer.sh --no-sanity-check
  beforeSetup:
  # common relocate
  - chmod +x /binary_replace.sh
  - mkdir -p /relocate
  # copy base binaries and deps from ALT
  # - cp -a /relocateFromALT/* /relocate
  # copy base binaries and deps
  - /binary_replace.sh -i "{{ $binaries }}" -o /relocate
  # copy self builded binaries and deps
  - /binary_replace.sh -i "{{ $selfBuildedBinaries }}" -o /relocate
  # additional relocate from runtime
  - |
    for cmd in iptables iptables-save iptables-restore ip6tables ip6tables-save ip6tables-restore; do
      rm -f "/relocate/usr/sbin/${cmd}"
      ln -f -s /usr/sbin/iptables-wrapper "/relocate/usr/sbin/${cmd}"
    done
    # broken symlinks are not imported from the artifact
    touch /usr/sbin/iptables-wrapper
  # additional relocate from cilium
  - mkdir -p /relocate/var/lib/cilium
  - cp -a /var/lib/cilium/bpf /relocate/var/lib/cilium
  - echo ". /etc/profile.d/bash_completion.sh" >> /etc/bash.bashrc
  - cp -a /etc/bash.bashrc /relocate/etc
  setup:
  # prepare final fs
  - mkdir -p /relocate/usr/bin
  - cp -a /relocate/bin/* /relocate/usr/bin/ && rm -rf /relocate/bin
  - ln -f -s usr/bin "/relocate/bin"
  - mkdir -p /relocate/usr/lib
  - cp -a /relocate/lib/* /relocate/usr/lib/ && rm -rf /relocate/lib
  - ln -f -s usr/lib "/relocate/lib"
  - mkdir -p /relocate/usr/lib32
  - cp -a /relocate/lib32/* /relocate/usr/lib32/ && rm -rf /relocate/lib32
  - ln -f -s usr/lib32 "/relocate/lib32"
  - mkdir -p /relocate/usr/lib64
  - cp -a /relocate/lib64/* /relocate/usr/lib64/ && rm -rf /relocate/lib64
  - ln -f -s usr/lib64 "/relocate/lib64"
  - mkdir -p /relocate/usr/libx32
  - cp -a /relocate/libx32/* /relocate/usr/libx32/ && rm -rf /relocate/libx32
  - ln -f -s usr/libx32 "/relocate/libx32"
  # alt workaround
  # - for filename in relocate/lib64/*; do ln -snf /lib64/$(basename "$filename") relocate/lib/x86_64-linux-gnu/$(basename "$filename") || true; done
  #
  - mkdir -p /relocate/var /relocate/run /relocate/run/lock
  - ln -f -s /run "/relocate/var/run"
  - ln -f -s /run/lock "/relocate/var/lock"
  #
  - mkdir -p /relocate/home/cilium
  - mkdir -p /relocate/etc
  - cp -a /from_common_distroless/group /relocate/etc/group
  - echo "cilium:x:1000:" >> /relocate/etc/group
---
# #####################################################################
# New Main Agent Image (Distroless)
---
image: {{ $.ModuleName }}/agent-distroless
fromImage: common/distroless
fromCacheVersion: {{ $fromCacheVersion }}
import:
- artifact: {{ $.ModuleName }}/agent-binaries-artifact
  add: /relocate
  to: /
  before: install
docker:
  ENV:
    HUBBLE_SERVER: "unix:///var/run/cilium/hubble.sock"
    INITSYSTEM: SYSTEMD
    HUBBLE_COMPAT: legacy-json-output
    PATH: "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  WORKDIR: "/home/cilium"
  CMD: ["/usr/bin/cilium"]
