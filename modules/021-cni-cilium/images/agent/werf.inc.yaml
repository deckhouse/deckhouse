# #####################################################################
# Final image of cilium-agent (used in helm-templates)
# Based on https://github.com/cilium/cilium/blob/v1.14.5/images/cilium/Dockerfile (release stage)
---
# #####################################################################
# Old Main Image
---
image: {{ $.ModuleName }}/agent
fromImage: {{ $.ModuleName }}/runtime-artifact
import:
- artifact: {{ $.ModuleName }}/cilium-builder-artifact
  add: /tmp/install
  to: /
  before: install
- artifact: {{ $.ModuleName }}/cilium-envoy-artifact
  add: /usr/bin/cilium-envoy
  to: /usr/bin/cilium-envoy
  before: install
- artifact: {{ $.ModuleName }}/cilium-envoy-artifact
  add: /usr/lib/libcilium.so
  to: /usr/lib/libcilium.so
  before: install
- artifact: {{ $.ModuleName }}/hubble-artifact
  add: /hubble
  to: /usr/bin/hubble
  before: install
- artifact: {{ $.ModuleName }}/hubble-artifact
  add: /bash_completion
  to: /etc/bash_completion.d/hubble
  before: install
- image: common/pause
  add: /pause
  to: /pause
  before: install
shell:
  install:
  - groupadd -f cilium
  - echo ". /etc/profile.d/bash_completion.sh" >> /etc/bash.bashrc
  - rm -rf /go
docker:
  ENV:
    HUBBLE_SERVER: "unix:///var/run/cilium/hubble.sock"
    INITSYSTEM: SYSTEMD
    HUBBLE_COMPAT: legacy-json-output
  WORKDIR: "/home/cilium"
  CMD: ["/usr/bin/cilium"]
---
# #####################################################################
# Binaries artifact for distroless
---
# hubble and dependencies
{{ $binaries := "/usr/bin/hubble /etc/bash_completion.d/hubble" }}
# cilium-envoy and dependencies
{{ $binaries := cat $binaries "/usr/bin/cilium-envoy /usr/lib/libcilium.so" }}
# cilium and dependencies
{{ $binaries := cat $binaries "/cni-uninstall.sh /init-container.sh /install-plugin.sh" }}
{{ $binaries := cat $binaries "/LICENSE.all /etc/bash_completion.d/cilium" }}
{{ $binaries := cat $binaries "/opt/cni/bin/cilium-cni /usr/bin/cilium*" }}
# for prepull
{{ $binaries := cat $binaries "/pause /usr/bin/true" }}
---
artifact: {{ $.ModuleName }}/agent-binaries-artifact
fromImage: {{ $.ModuleName }}/agent
git:
- add: /{{ $.ModulePath }}modules/{{ $.ModulePriority }}-{{ $.ModuleName }}/images/{{ $.ImageName }}
  to: /
  includePaths:
  - binary_replace.sh
  stageDependencies:
    install:
    - binary_replace.sh
shell:
  install:
    - chmod +x /binary_replace.sh
    - mkdir -p /relocate
    - /binary_replace.sh -i "{{ $binaries }}" -o /relocate
    - mkdir -p /relocate/var/lib/cilium
    - cp -a /var/lib/cilium/bpf /relocate/var/lib/cilium
    - mkdir -p /relocate/home/cilium
    - cp -a /etc/bash.bashrc /relocate/etc
---
# #####################################################################
# New Main Image (Distroless)
---
image: {{ $.ModuleName }}/agent-distroless
fromImage: {{ $.ModuleName }}/runtime-distroless-artifact
import:
- artifact: {{ $.ModuleName }}/agent-binaries-artifact
  add: /relocate
  to: /
  before: install
docker:
  ENV:
    HUBBLE_SERVER: "unix:///var/run/cilium/hubble.sock"
    INITSYSTEM: SYSTEMD
    HUBBLE_COMPAT: legacy-json-output
    PATH: "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  WORKDIR: "/home/cilium"
  CMD: ["/usr/bin/cilium"]
