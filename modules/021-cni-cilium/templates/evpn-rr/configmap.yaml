{{- if and (.Values.cniCilium.evpn) (.Values.cniCilium.evpn.enabled) }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: evpn-rr-config
  namespace: d8-{{ .Chart.Name }}
  {{- include "helm_lib_module_labels" (list . (dict "app" "evpn-rr")) | nindent 2 }}
data:
  frr.conf.template: |
    frr version 10.5
    frr defaults traditional
    hostname POD_NAME_PLACEHOLDER
    log syslog informational
    service integrated-vtysh-config
    service password-encryption
    no ipv6 forwarding
    !
    router bgp {{ .Values.cniCilium.evpn.bgpAsn | default 65000 }}
      bgp router-id ROUTER_ID_PLACEHOLDER
      no bgp default ipv4-unicast
      bgp bestpath as-path multipath-relax
      bgp log-neighbor-changes
      bgp no-rib
      !
      neighbor EVPN_CLIENTS_NODES peer-group
      neighbor EVPN_CLIENTS_NODES remote-as {{ .Values.cniCilium.evpn.bgpAsn | default 65000 }}
      neighbor EVPN_CLIENTS_NODES password PassW0RD
      BGP_LISTEN_RANGE_PLACEHOLDER
      !
      neighbor EVPN_RR_PEER peer-group
      neighbor EVPN_RR_PEER remote-as {{ .Values.cniCilium.evpn.bgpAsn | default 65000 }}
      PEER_RR_NEIGHBORS_PLACEHOLDER
      !
      address-family l2vpn evpn
        neighbor EVPN_CLIENTS_NODES activate
        neighbor EVPN_CLIENTS_NODES route-reflector-client
        neighbor EVPN_RR_PEER activate
        PEER_RR_ACTIVATE_PLACEHOLDER
        advertise-all-vni
        advertise-default-gw
        retain route-target all
      exit-address-family
    !
    end
{{- end }}
