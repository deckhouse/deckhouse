apiVersion: deckhouse.io/v1alpha1
kind: NodeGroupConfiguration
metadata:
  name: cilium-1-17-migration.sh
  {{- include "helm_lib_module_labels" (list .) | nindent 2 }}
spec:
  weight: 72
  nodeGroups: ["*"]
  bundles: ["*"]
  content: |
    # Copyright 2025 Flant JSC
    #
    # Licensed under the Apache License, Version 2.0 (the "License");
    # you may not use this file except in compliance with the License.
    # You may obtain a copy of the License at
    #
    #     http://www.apache.org/licenses/LICENSE-2.0
    #
    # Unless required by applicable law or agreed to in writing, software
    # distributed under the License is distributed on an "AS IS" BASIS,
    # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    # See the License for the specific language governing permissions and
    # limitations under the License.

    # cilium-agent image hash: {{ include "helm_lib_module_image" (list . "agentDistroless") }}

    # If there is no kubelet.conf than node is not bootstrapped and there is nothing to do
    kubeconfig="/etc/kubernetes/kubelet.conf"
    if [ ! -f "$kubeconfig" ]; then
      exit 0
    fi

    if [[ "${FIRST_BASHIBLE_RUN}" == "yes" ]]; then
      exit 0
    fi

    if bb-kubectl --kubeconfig $kubeconfig get node $(bb-d8-node-name) -o json | \
          jq -e '.metadata.annotations | has("network.deckhouse.io/cilium-1-17-migration-succeeded")' >/dev/null; then
      exit 0
    fi

    until
      is_migration_required="$(bb-kubectl --kubeconfig $kubeconfig get node $(bb-d8-node-name) -o json | \
      jq -er '.metadata.annotations."network.deckhouse.io/cilium-1-17-migration-disruptive-update-required"')";
    do
      bb-log-info "Waiting until the safe-agent-updater calculates the need for an disruptive-update and annotates the node."
      sleep 10
    done

    if [[ "$is_migration_required" == "false" ]]; then
      exit 0
    fi

    bb-deckhouse-get-disruptive-update-approval

    until
      bb-kubectl --kubeconfig $kubeconfig get node $(bb-d8-node-name) -o json | \
      jq -e '.metadata.annotations | has("network.deckhouse.io/cilium-1-17-migration-succeeded")' >/dev/null;
    do
      bb-log-info "Waiting until the safe-agent-updater completes the disruptive-update on node."
      sleep 10
    done
