global
    maxconn                 4000
    log                     127.0.0.1 local0

defaults
    mode                    http
    log                     global
    option                  httplog
    option                  dontlognull
    option                  http-server-close
    option                  redispatch
    retries                 5
    timeout http-request    5m
    timeout queue           5m
    timeout connect         30s
    timeout client          5m
    timeout server          15m
    timeout http-keep-alive 30s
    timeout check           30s
    maxconn                 4000

frontend healthz
    bind 0.0.0.0:4248
    mode http
    monitor-uri /healthz

frontend kube_api_frontend
    bind 0.0.0.0:4249
    mode tcp
    option tcplog
    default_backend kube_api_backend

backend kube_api_backend
    mode tcp
    balance leastconn
    option tcp-check
    tcp-check connect port 6443
    tcp-check connect port 3990
    tcp-check send "GET /healthz HTTP/1.0\r\n\r\n"
    tcp-check expect rstring 200
    default-server inter 5s downinter 15s rise 2 fall 2 slowstart 60s maxconn 1000 maxqueue 256 weight 100
    option log-health-checks
    server kube1 10.241.44.17:6443 check
    server kube2 10.241.44.36:6443 check
    server kube3 10.241.44.5:6443 check