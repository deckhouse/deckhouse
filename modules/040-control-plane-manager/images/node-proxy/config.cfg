global
    maxconn                 4000
    log                     127.0.0.1 local0
    stats socket /tmp/haproxy.socket mode 660 level admin expose-fd listeners
    stats timeout 30s
    
defaults
    mode                    http
    log                     global
    option                  httplog
    option                  dontlognull
    option                  http-server-close
    option                  redispatch
    retries                 5
    timeout http-request    5m
    timeout queue           5m
    timeout connect         30s
    timeout client          5m
    timeout server          15m
    timeout http-keep-alive 30s
    timeout check           30s
    maxconn                 4000


listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 1s
    stats show-node


frontend healthz
    bind 127.0.0.1:4248
    mode http
    monitor-uri /healthz

frontend kube_api_frontend
    bind 127.0.0.1:4249
    mode tcp
    option tcplog
    default_backend kube_api_backend

backend kube_api_backend
    mode tcp
    balance leastconn

    option httpchk
    option log-health-checks
    http-check send meth GET uri /healthz ver HTTP/1.1 hdr Host kube-apiserver

    http-check expect status 200

    default-server inter 5s downinter 15s rise 2 fall 2 slowstart 60s maxconn 1000 maxqueue 256 weight 100 check-ssl verify none check ca-file /etc/kubernetes/node-proxy/ca.crt crl-file /etc/kubernetes/node-proxy/haproxy.pem crt /etc/kubernetes/node-proxy/haproxy.pem

    server kube1 10.241.44.17:6443
    server kube2 10.241.44.36:6443
    server kube3 10.241.44.5:6443