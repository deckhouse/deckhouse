{{- if and (include "helm_lib_kind_exists" (list . "ValidatingAdmissionPolicy")) (include "helm_lib_kind_exists" (list . "ValidatingAdmissionPolicyBinding")) }}
{{- $policyName := "etcd-arbiter-label.deckhouse.io" }}
---
apiVersion: {{ include "helm_lib_get_api_version_by_kind" (list . "ValidatingAdmissionPolicy") }}
kind: ValidatingAdmissionPolicy
metadata:
  name: {{ $policyName }}
  {{- include "helm_lib_module_labels" (list . (dict "app" "control-plane-manager") ) | nindent 2 }}
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
      - apiGroups:   [""]
        apiVersions: ["*"]
        operations:  ["UPDATE"]
        resources:   ["nodes"]
  validations:
    - expression: |
        request.userInfo.username.startsWith("system:serviceaccount:d8-")
        || ! has(object.metadata.labels)
        || ! has(oldObject.metadata.labels)
        || (("node.deckhouse.io/etcd-arbiter" in object.metadata.labels)
            && ("node.deckhouse.io/etcd-arbiter" in oldObject.metadata.labels)
            && object.metadata.labels["node.deckhouse.io/etcd-arbiter"]
               == oldObject.metadata.labels["node.deckhouse.io/etcd-arbiter"])
      reason: Forbidden
      messageExpression: "'Adding the `node.deckhouse.io/etcd-arbiter` label on nodes is forbidden'"
---
apiVersion: {{ include "helm_lib_get_api_version_by_kind" (list . "ValidatingAdmissionPolicyBinding") }}
kind: ValidatingAdmissionPolicyBinding
metadata:
  name: {{ $policyName }}
  {{- include "helm_lib_module_labels" (list . (dict "app" "control-plane-manager") ) | nindent 2 }}
spec:
  policyName: {{ $policyName }}
  validationActions: [Deny]
{{- end }}

