- name: d8.etcd-maintenance.defragmentation
  rules:
    - alert: D8EtcdDefragmentationTriggeredTooOften
      expr: max by (node) (increase(d8_etcd_defragmentation_success_total[5h]) >= 4)
      labels:
        tier: cluster
        d8_component: control-plane-manager
        d8_module: control-plane-manager
      annotations:
        plk_protocol_version: "1"
        plk_markup_format: "markdown"
        summary: Etcd defragmentation triggered too often
        description: |
          For etcd node {{ $labels.node }} defragmentation triggered more than 4 time for last 5 hours.

          Every hour deckhouse check etcd db size and trigger db defragmentation if etcd use more 90% of available size.

          Frequent triggering indicates that the defragmentation process is not effective and that it is necessary to increase `quota-backend-bytes`

    - alert: D8EtcdDefragmentationFailed
      expr: max by (node) (increase(d8_etcd_defragmentation_failed_total[3h]) >= 2)
      labels:
        tier: cluster
        d8_component: control-plane-manager
        d8_module: control-plane-manager
      annotations:
        plk_protocol_version: "1"
        plk_markup_format: "markdown"
        summary: Etcd defragmentation was failed
        description: |
          For etcd node {{ $labels.node }} last 2 defragmentation procedures over 3 hours was failed.

          Every hour deckhouse check etcd db size and trigger db defragmentation if etcd use more 90% of available size.

          Please check Deckhouse logs by running `kubectl -n d8-system logs -f -l app=deckhouse`.

- name: d8.etcd-maintenance.quota-backend-bytes
  rules:
    - alert: D8KubeEtcdDatabaseSizeCloseToTheLimit
      expr: max by (node) (etcd_mvcc_db_total_size_in_bytes{job="kube-etcd3"} >= max(d8_etcd_quota_backend_total))
      labels:
        severity_level: "6"
        tier: cluster
      annotations:
        plk_protocol_version: "1"
        plk_markup_format: "markdown"
        plk_pending_until_firing_for: "10m"
        plk_grouped_by__main: "KubeEtcdMalfunctioning,tier=cluster,prometheus=deckhouse"
        description: |
          The size of the etcd database on `{{ $labels.node }}` has almost exceeded .

          Possibly there are a lot of events (e.g. Pod evictions) or a high number of other resources are created in the cluster recently.
        summary: etcd db size is close to the limit
    - alert: D8EtcdCannotDecreaseQuotaBackendBytes
      expr: max(d8_etcd_quota_backend_should_decrease) > 0
      labels:
        tier: cluster
        d8_component: control-plane-manager
        d8_module: control-plane-manager
      annotations:
        plk_protocol_version: "1"
        plk_markup_format: "markdown"
        summary: Deckhouse considers that quote-backend-bytes should be reduced.
        description: |
          Deckhouse can increase `quote-backend-bytes` only.

          It happends when control-plane nodes memory was reduced.

          If is true, you should set quote-backend-bytes manually with `controlPlaneManager.etcd.maxDbSize` configuration parameter.

          Before set new value, please check current DB usage on every control-plane node:
          ```
          kubectl -n kube-system exec -ti etcd-MASTER_NODE_HERE -- /bin/sh -c 'ETCDCTL_API=3 /usr/bin/etcdctl --cacert /etc/kubernetes/pki/etcd/ca.crt --cert /etc/kubernetes/pki/etcd/ca.c/etc/kubernetes/pki/etcd/ca.key endpoint status -w json' | jq -r '.[0].Status.dbSize'
          ```
          Recommendations:
          - `controlPlaneManager.etcd.maxDbSize` maximum value is 8 GB.
          - If control-plane nodes have less than 24 GB, use 2 GB for `controlPlaneManager.etcd.maxDbSize`.
          - For >= 24GB increase value on 1GB every extra 8 GB.

