---
image: {{ .ModuleName }}/{{ .ImageName }}
fromImage: common/shell-operator
import:
- image: common/yq4-artifact
  add: /usr/local/bin/yq
  to: /usr/local/bin/yq
  before: install
- image: common/semver-artifact
  add: /usr/local/bin/semver
  to: /usr/local/bin/semver
  before: setup
- image: prometheus/prometheus
  add: /bin/promtool
  to: /usr/local/bin/promtool
  before: setup
- image: {{ $.ModuleName }}/{{ .ImageName }}-label-converter-artifact
  add: /label-converter
  to: /usr/local/bin/label-converter
  before: setup
- image: {{ $.ModuleName }}/{{ $.ImageName }}-binaries-artifact
  add: /usr
  to: /usr
  before: install
- image: {{ $.ModuleName }}/{{ $.ImageName }}-binaries-artifact
  add: /lib/ld-musl-x86_64.so.1
  to: /lib/ld-musl-x86_64.so.1
  before: install
git:
- add: /{{ .ModulePath }}
  to: /available_hooks
  includePaths:
  - 'modules/*/webhooks/'
  - 'ee/modules/*/webhooks/'
  - 'ee/se/modules/*/webhooks'
# - 'ee/fe/modules/*/webhooks/'
  excludePaths:
    - '**/*_test.py'
  stageDependencies:
    install:
      - '**/*'
- add: /{{ .ModulePath }}modules/002-deckhouse/images/webhook-handler/entrypoint.sh
  to: /entrypoint.sh
  stageDependencies:
    install:
      - '**/*'
- add: /{{ .ModulePath }}shell_lib/semver.sh
  to: /{{ .ModulePath }}frameworks/shell/semver.sh
  stageDependencies:
    install:
      - '**/*'
- add: /{{ .ModulePath }}python_lib
  to: /frameworks/python
  stageDependencies:
    install:
      - '**/*'
imageSpec:
  config:
    env: {"PYTHONPATH": "/frameworks/python"}
    entrypoint: ["/entrypoint.sh"]
---
image: {{ .ModuleName }}/{{ .ImageName }}-label-converter-src-artifact
final: false
fromImage: common/src-artifact
git:
- add: /{{ .ModulePath }}modules/{{ .ModulePriority }}-{{ .ModuleName }}/images/{{ .ImageName }}/label-converter
  to: /src
  includePaths:
  - '**/*.go'
  - '**/go.mod'
  - '**/go.sum'
  stageDependencies:
    install:
    - '**/*.go'
    - '**/go.mod'
    - '**/go.sum'
---
image: {{ .ModuleName }}/{{ .ImageName }}-label-converter-artifact
final: false
from: {{ $.Images.BASE_GOLANG_23_ALPINE }}
import:
- image: {{ .ModuleName }}/{{ .ImageName }}-label-converter-src-artifact
  add: /src
  to: /src
  before: install
shell:
  install:
    - export GOPROXY={{ .GOPROXY }}
    - cd /src
    - CGO_ENABLED=0 GOOS=linux go build -ldflags '-s -w -extldflags "-static"' -o /label-converter label_converter.go
    - chown 64535:64535 /label-converter
    - chmod 755 /label-converter
---
image: {{ $.ModuleName }}/{{ $.ImageName }}-binaries-artifact
final: false
fromImage: common/relocate-artifact

import:
- image: base/python
  add: /
  to: /
  before: install
  includePaths:
  - lib
  - usr
git:
- add: /{{ .ModulePath }}modules/002-deckhouse/images/webhook-handler/requirements.txt
  to: /requirements.txt
  stageDependencies:
    install:
    - '**/*'
shell:
  beforeInstall:
  - apt-get install -y git
  install:
    - git clone --depth 1 {{ $.SOURCE_REPO }}/python-modules/wheels /wheels
    - pip3 install -f file:///wheels --no-index -r /requirements.txt
    - rm -rf /wheels
