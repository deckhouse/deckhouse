---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.18.0
  name: validationwebhooks.deckhouse.io
  labels:
    heritage: deckhouse
    module: deckhouse
    app: webhook-handler
spec:
  group: deckhouse.io
  names:
    kind: ValidationWebhook
    listKind: ValidationWebhookList
    plural: validationwebhooks
    shortNames:
      - vwhc
    singular: validationwebhook
  scope: Cluster
  versions:
    - name: v1alpha1
      schema:
        openAPIV3Schema:
          description: ValidationWebhook is the Schema for the validationwebhooks API
          properties:
            apiVersion:
              description: |-
                APIVersion defines the versioned schema of this representation of an object.
                Servers should convert recognized schemas to the latest internal value, and
                may reject unrecognized values.
                More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
              type: string
            context:
              description: Run a hook on a Kubernetes object changes.
              items:
                properties:
                  kubernetes:
                    properties:
                      allowFailure:
                        description: |-
                          If `true`, Shell-operator skips the hook execution errors.
                          If `false` or the parameter is not set, the hook is restarted after a 5 seconds delay in case of an error.
                        type: boolean
                      apiVersion:
                        description: |-
                          Is an optional group and version of object API.
                          For example, it is v1 for core objects (Pod, etc.), `rbac.authorization.k8s.io/v1beta1` for ClusterRole and monitoring.coreos.com/v1 for prometheus-operator.
                        type: string
                      executeHookOnEvent:
                        description: |-
                          The list of events which led to a hookâ€™s execution.
                          By default, all events are used to execute a hook: "Added", "Modified" and "Deleted".
                        items:
                          type: string
                        type: array
                      executeHookOnSynchronization:
                        description: If `false`, Shell-operator skips the hook execution with Synchronization binding context.
                        type: boolean
                      fieldSelector:
                        properties:
                          matchExpressions:
                            items:
                              properties:
                                field:
                                  type: string
                                operator:
                                  type: string
                                value:
                                  type: string
                              required:
                                - field
                                - operator
                              type: object
                            type: array
                        required:
                          - matchExpressions
                        type: object
                      group:
                        description: A key to include snapshots from a group of schedule and kubernetes bindings.
                        type: string
                      includeSnapshotsFrom:
                        description: |-
                          An array of names of kubernetes bindings in a hook.
                          When specified, a list of monitored objects from that bindings
                          will be added to the binding context in a snapshots field. Self-include is also possible.
                        items:
                          type: string
                        type: array
                      jqFilter:
                        description: |-
                          An optional parameter that specifies event filtering using jq syntax.
                          The hook will be triggered on the "Modified" event only if the filter result is changed after the last event.
                        type: string
                      keepFullObjectsInMemory:
                        description: |-
                          If not set or `true`, dumps of Kubernetes resources are cached
                          for this binding, and the snapshot includes them as object fields.
                          Set to `false` if the hook does not rely on full objects to reduce the memory footprint.
                        type: boolean
                      kind:
                        description: Is the type of a monitored Kubernetes resource. This field is required.
                        type: string
                      labelSelector:
                        description: |-
                          A label selector is a label query over a set of resources. The result of matchLabels and
                          matchExpressions are ANDed. An empty label selector matches all objects. A null
                          label selector matches no objects.
                        properties:
                          matchExpressions:
                            description: |-
                              `matchExpressions` is a list of label selector requirements. The requirements are ANDed.
                            items:
                              description: |-
                                A label selector requirement is a selector that contains values, a key, and an operator that
                                relates the key and values.
                              properties:
                                key:
                                  description: |-
                                    `key` is the label key that the selector applies to.
                                  type: string
                                operator:
                                  description: |-
                                    `operator` represents a key's relationship to a set of values.
                                    Valid operators are In, NotIn, Exists and DoesNotExist.
                                  type: string
                                values:
                                  description: |-
                                    `values` is an array of string values. If the operator is In or NotIn,
                                    the values array must be non-empty. If the operator is Exists or DoesNotExist,
                                    the values array must be empty. This array is replaced during a strategic
                                    merge patch.
                                  items:
                                    type: string
                                  type: array
                                  x-kubernetes-list-type: atomic
                              required:
                                - key
                                - operator
                              type: object
                            type: array
                            x-kubernetes-list-type: atomic
                          matchLabels:
                            additionalProperties:
                              type: string
                            description: |-
                              `matchLabels` is a map of {key,value} pairs. A single {key,value} in the matchLabels
                              map is equivalent to an element of matchExpressions, whose key field is "key", the
                              operator is "In", and the values array contains only "value". The requirements are ANDed.
                            type: object
                        type: object
                        x-kubernetes-map-type: atomic
                      mode:
                        type: string
                      nameSelector:
                        properties:
                          matchNames:
                            items:
                              type: string
                            type: array
                        required:
                          - matchNames
                        type: object
                      namespace:
                        description: Filters to choose namespaces.
                        properties:
                          labelSelector:
                            description: |-
                              A label selector is a label query over a set of resources. The result of matchLabels and
                              matchExpressions are ANDed. An empty label selector matches all objects. A null
                              label selector matches no objects.
                            properties:
                              matchExpressions:
                                description: |-
                                  `matchExpressions` is a list of label selector requirements. The requirements are ANDed.
                                items:
                                  description: |-
                                    A label selector requirement is a selector that contains values, a key, and an operator that
                                    relates the key and values.
                                  properties:
                                    key:
                                      description: |-
                                        `key` is the label key that the selector applies to.
                                      type: string
                                    operator:
                                      description: |-
                                        `operator` represents a key's relationship to a set of values.
                                        Valid operators are In, NotIn, Exists and DoesNotExist.
                                      type: string
                                    values:
                                      description: |-
                                        `values` is an array of string values. If the operator is In or NotIn,
                                        the values array must be non-empty. If the operator is Exists or DoesNotExist,
                                        the values array must be empty. This array is replaced during a strategic
                                        merge patch.
                                      items:
                                        type: string
                                      type: array
                                      x-kubernetes-list-type: atomic
                                  required:
                                    - key
                                    - operator
                                  type: object
                                type: array
                                x-kubernetes-list-type: atomic
                              matchLabels:
                                additionalProperties:
                                  type: string
                                description: |-
                                  `matchLabels` is a map of {key,value} pairs. A single {key,value} in the matchLabels
                                  map is equivalent to an element of matchExpressions, whose key field is "key", the
                                  operator is "In", and the values array contains only "value". The requirements are ANDed.
                                type: object
                            type: object
                            x-kubernetes-map-type: atomic
                          nameSelector:
                            properties:
                              matchNames:
                                items:
                                  type: string
                                type: array
                            required:
                              - matchNames
                            type: object
                        type: object
                      queue:
                        description: A name of a separate queue. It can be used to execute long-running hooks in parallel with hooks in the "main" queue.
                        type: string
                      resynchronizationPeriod:
                        type: string
                      waitForSynchronization:
                        type: string
                      watchEvent:
                        items:
                          type: string
                        type: array
                    required:
                      - kind
                    type: object
                  name:
                    description: It is used to distinguish different bindings during runtime.
                    type: string
                required:
                  - name
                type: object
              type: array
            handler:
              description: Code of the ValidatingWebhook handler.
              properties:
                cel:
                  description: This is a cel rules handler for object.
                  type: string
                python:
                  description: This is a python script handler for object.
                  type: string
              type: object
            kind:
              description: |-
                Kind is a string value representing the REST resource this object represents.
                Servers may infer this from the endpoint the client submits requests to.
                Cannot be updated.
                In CamelCase.
                More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
              type: string
            metadata:
              type: object
            status:
              description: |-
                `status` defines the observed state of ValidationWebhook.
              type: object
            validationObject:
              description: ValidatingWebhook describes an webhook and the resources and operations it applies to.
              properties:
                failurePolicy:
                  description: Defines how errors from the hook are handled.
                  type: string
                group:
                  description: A key to include snapshots from a group of schedule and kubernetes bindings. See grouping.
                  type: string
                includeSnapshotsFrom:
                  description: An array of names of kubernetes bindings in a hook. When specified, a list of monitored objects from these bindings will be added to the binding context in the snapshots field.
                  items:
                    type: string
                  type: array
                labelSelector:
                  description: |-
                    A label selector is a label query over a set of resources. The result of matchLabels and
                    matchExpressions are ANDed. An empty label selector matches all objects. A null
                    label selector matches no objects.
                  properties:
                    matchExpressions:
                      description: |-
                        `matchExpressions` is a list of label selector requirements. The requirements are ANDed.
                      items:
                        description: |-
                          A label selector requirement is a selector that contains values, a key, and an operator that
                          relates the key and values.
                        properties:
                          key:
                            description: |-
                              `key` is the label key that the selector applies to.
                            type: string
                          operator:
                            description: |-
                              `operator` represents a key's relationship to a set of values.
                              Valid operators are In, NotIn, Exists and DoesNotExist.
                            type: string
                          values:
                            description: |-
                              `values` is an array of string values. If the operator is In or NotIn,
                              the values array must be non-empty. If the operator is Exists or DoesNotExist,
                              the values array must be empty. This array is replaced during a strategic
                              merge patch.
                            items:
                              type: string
                            type: array
                            x-kubernetes-list-type: atomic
                        required:
                          - key
                          - operator
                        type: object
                      type: array
                      x-kubernetes-list-type: atomic
                    matchLabels:
                      additionalProperties:
                        type: string
                      description: |-
                        `matchLabels` is a map of {key,value} pairs. A single {key,value} in the matchLabels
                        map is equivalent to an element of matchExpressions, whose key field is "key", the
                        operator is "In", and the values array contains only "value". The requirements are ANDed.
                      type: object
                  type: object
                  x-kubernetes-map-type: atomic
                matchConditions:
                  description: An optional list of match conditions for fine-grained request filtering. Available only since v1.27 of Kubernetes.
                  items:
                    description: MatchCondition represents a condition which must by fulfilled for a request to be sent to a webhook.
                    properties:
                      expression:
                        description: |-
                          Expression represents the expression which will be evaluated by CEL. Must evaluate to bool.
                          CEL expressions have access to the contents of the AdmissionRequest and Authorizer, organized into CEL variables:

                          - `object` - The object from the incoming request. The value is null for DELETE requests.
                          - `oldObject` - The existing object. The value is null for CREATE requests.
                          - `request` - Attributes of the admission request(/pkg/apis/admission/types.go#AdmissionRequest).
                          - `authorizer` - A CEL Authorizer. May be used to perform authorization checks for the principal (user or service account) of the request.
                            See https://pkg.go.dev/k8s.io/apiserver/pkg/cel/library#Authz
                          - `authorizer.requestResource` - A CEL ResourceCheck constructed from the `authorizer` and configured with the
                            request resource.
                          Documentation on CEL: https://kubernetes.io/docs/reference/using-api/cel/

                          Required.
                        type: string
                      name:
                        description: |-
                          Name is an identifier for this match condition, used for strategic merging of MatchConditions,
                          as well as providing an identifier for logging purposes. A good name should be descriptive of
                          the associated expression.
                          Name must be a qualified name consisting of alphanumeric characters, `-`, `_` or `.`, and
                          must start and end with an alphanumeric character (e.g. `MyName`,  or `my.name`,  or
                          `123-abc`, regex used for validation is '([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9]') with an
                          optional DNS subdomain prefix and `/` (e.g. `example.com/MyName`)

                          Required.
                        type: string
                    required:
                      - expression
                      - name
                    type: object
                  type: array
                name:
                  description: Should be a domain with at least three segments separated by dots.
                  type: string
                namespace:
                  properties:
                    labelSelector:
                      description: |-
                        A label selector is a label query over a set of resources. The result of matchLabels and
                        matchExpressions are ANDed. An empty label selector matches all objects. A null
                        label selector matches no objects.
                      properties:
                        matchExpressions:
                          description: matchExpressions is a list of label selector requirements. The requirements are ANDed.
                          items:
                            description: |-
                              A label selector requirement is a selector that contains values, a key, and an operator that
                              relates the key and values.
                            properties:
                              key:
                                description: |-
                                  `key` is the label key that the selector applies to.
                                type: string
                              operator:
                                description: |-
                                  `operator` represents a key's relationship to a set of values.
                                  Valid operators are In, NotIn, Exists and DoesNotExist.
                                type: string
                              values:
                                description: |-
                                  `values` is an array of string values. If the operator is In or NotIn,
                                  the values array must be non-empty. If the operator is Exists or DoesNotExist,
                                  the values array must be empty. This array is replaced during a strategic
                                  merge patch.
                                items:
                                  type: string
                                type: array
                                x-kubernetes-list-type: atomic
                            required:
                              - key
                              - operator
                            type: object
                          type: array
                          x-kubernetes-list-type: atomic
                        matchLabels:
                          additionalProperties:
                            type: string
                          description: |-
                            `matchLabels` is a map of {key,value} pairs. A single {key,value} in the matchLabels
                            map is equivalent to an element of matchExpressions, whose key field is "key", the
                            operator is "In", and the values array contains only "value". The requirements are ANDed.
                          type: object
                      type: object
                      x-kubernetes-map-type: atomic
                    nameSelector:
                      properties:
                        matchNames:
                          items:
                            type: string
                          type: array
                      required:
                        - matchNames
                      type: object
                  type: object
                rules:
                  description: A required list of rules used to determine if a request to the Kubernetes API server should be sent to the hook.
                  items:
                    description: |-
                      RuleWithOperations is a tuple of Operations and Resources. It is recommended to make
                      sure that all the tuple expansions are valid.
                    properties:
                      apiGroups:
                        description: |-
                          APIGroups is the API groups the resources belong to. `*` is all groups.
                          If `*` is present, the length of the slice must be one.
                          Required.
                        items:
                          type: string
                        type: array
                        x-kubernetes-list-type: atomic
                      apiVersions:
                        description: |-
                          APIVersions is the API versions the resources belong to. `*` is all versions.
                          If `*` is present, the length of the slice must be one.
                          Required.
                        items:
                          type: string
                        type: array
                        x-kubernetes-list-type: atomic
                      operations:
                        description: |-
                          Operations is the operations the admission hook cares about - CREATE, UPDATE, DELETE, CONNECT or *
                          for all of those operations and any future admission operations that are added.
                          If `*` is present, the length of the slice must be one.
                          Required.
                        items:
                          description: OperationType specifies an operation for a request.
                          type: string
                        type: array
                        x-kubernetes-list-type: atomic
                      resources:
                        description: |-
                          Resources is a list of resources this rule applies to.

                          For example:
                          - `pods` means pods.
                          - `pods/log` means the log subresource of pods.
                          - `*` means all resources, but not subresources.
                          - `pods/*` means all subresources of pods.
                          - `*/scale` means all scale subresources.
                          - `*/*` means all resources and their subresources.

                          If wildcard is present, the validation rule will ensure resources do not
                          overlap with each other.

                          Depending on the enclosing object, subresources might not be allowed.
                          Required.
                        items:
                          type: string
                        type: array
                        x-kubernetes-list-type: atomic
                      scope:
                        description: |-
                          `scope` specifies the scope of this rule.
                          Valid values are `Cluster`, `Namespaced`, and `*`.
                          `Cluster` means that only cluster-scoped resources will match this rule.
                          Namespace API objects are cluster-scoped.
                          `Namespaced` means that only namespaced resources will match this rule.
                          `*` means that there are no scope restrictions.
                          Subresources match the scope of their parent resource.
                          Default is `*`.
                        type: string
                    type: object
                  type: array
                sideEffects:
                  description: Determine whether the hook is dryRun-aware.
                  type: string
                timeoutSeconds:
                  description: A seconds API server should wait for a hook to respond before treating the call as a failure. Default is 10 (seconds).
                  format: int32
                  type: integer
              required:
                - name
              type: object
          required:
            - handler
            - validationObject
          type: object
      served: true
      storage: true
      subresources:
        status: {}
