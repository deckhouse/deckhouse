{{- if .Values.global.clusterIsBootstrapped }}
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: deckhouse-registry-webhook
  {{- include "helm_lib_module_labels" (list . (dict "app" "deckhouse-registry-webhook")) | nindent 2 }}
webhooks:
  - name: validate.deckhouse-registry-webhook.deckhouse.io
    namespaceSelector:
      matchExpressions:
        - key: "kubernetes.io/metadata.name"
          operator: "In"
          values:
            - "d8-system"
    objectSelector:
      matchLabels:
        app: registry
        heritage: deckhouse
        module: deckhouse
    rules:
      - operations: [ "CREATE", "UPDATE" ]
        apiGroups: [""]
        apiVersions: ["v1"]
        resources: ["secrets"]
    admissionReviewVersions: ["v1"]
    matchPolicy: Equivalent
    failurePolicy: Fail
    sideEffects: None
    clientConfig:
      caBundle: {{ .Values.deckhouse.internal.deckhouseRegistryWebhookCert.ca  | b64enc | quote }}
      service:
        name: deckhouse-registry-webhook
        namespace: d8-system
        path: /validate
{{- end }}
