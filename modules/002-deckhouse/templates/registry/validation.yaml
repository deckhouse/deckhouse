{{- if and (include "helm_lib_kind_exists" (list . "ValidatingAdmissionPolicy")) (include "helm_lib_kind_exists" (list . "ValidatingAdmissionPolicyBinding")) }}
{{- $policyName := "deckhouse-module-registry-validation" }}

{{- $moduleEnabled := .Values.global.enabledModules | has "registry" }}
{{- $clusterBootstraped := .Values.global.clusterIsBootstrapped | default false }}
{{- $staticCluster := eq (((.Values.global).clusterConfiguration).clusterType | default "" ) "Static" }}

{{- $isLocalMode := eq ((((.Values.deckhouse).internal).registry).mode | default "") "Local" }}
{{- $isProxyMode := eq ((((.Values.deckhouse).internal).registry).mode | default "") "Proxy" }}

{{- if or (not $moduleEnabled) (not $clusterBootstraped) (not $staticCluster) $isLocalMode $isProxyMode }}
---
apiVersion: {{ include "helm_lib_get_api_version_by_kind" (list . "ValidatingAdmissionPolicy") }}
kind: ValidatingAdmissionPolicy
metadata:
  name: {{ $policyName }}
  {{- include "helm_lib_module_labels" (list . (dict "app" "deckhouse")) | nindent 2 }}
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
    - apiGroups:   ["deckhouse.io"]
      apiVersions: ["v1alpha1"]
      operations:  ["UPDATE"]
      resources:   ["moduleconfigs"]
  matchConditions:
  - name: 'deckhouse-mc'
    expression: 'object.metadata.name == "deckhouse"'
  validations:
  {{- if not $moduleEnabled }}
  - expression: |
      !(
        object.?spec.?settings.?registry.orValue("") !=
        oldObject.?spec.?settings.?registry.orValue("")
      )
    message: >-
      "Changing, adding, or removing `spec.settings.registry`
      is forbidden when the registry module is disabled.
      Please enable the module to make changes."
  {{- end }}
  {{- if not $clusterBootstraped }}
  - expression: |
      !(
        object.?spec.?settings.?registry.orValue("") !=
        oldObject.?spec.?settings.?registry.orValue("")
      )
    message: >-
      "Changing, adding, or removing `spec.settings.registry`
      is forbidden during cluster bootstrap.
      Please wait until bootstrap is complete."
  {{- end }}
  {{- if not $staticCluster }}
  - expression: |
      !(
        has(object.?spec.?settings.?registry.mode) && 
        (
          object.spec.settings.registry.mode == "Proxy" ||
          object.spec.settings.registry.mode == "Local"
        )
      )
    message: >-
      "The field `spec.settings.registry.mode` cannot be set to Proxy or Local.
      Proxy and Local are unsupported for non-static clusters.
      Please use other available modes."
  {{- end }}
{{- if $isLocalMode }}
  - expression: |
      !(
        (
          has(object.?spec.?settings.?registry.mode) &&
          (
            object.spec.settings.registry.mode == "Proxy" ||
            (
              object.spec.settings.registry.mode == "Unmanaged" &&
              !has(object.?spec.?settings.?registry.unmanaged)
            )
          )
        ) ||
        !has(object.?spec.?settings.registry)
      )
    message: >-
      Switching `spec.settings.registry.mode` to Proxy or non-configurable Unmanaged mode
      is not supported when registry is running in "Local" mode.
      Please use a transition mode to switch to the desired mode, for example: Direct or configurable Unmanaged.
{{- end }}
{{- if $isProxyMode }}
  - expression: |
      !(
        has(object.?spec.?settings.?registry.mode) &&
        object.spec.settings.registry.mode == "Local"
      )
    message: >-
      Switching `spec.settings.registry.mode` to Local mode
      is not supported when registry is running in "Proxy" mode.
      Please use a transition mode to switch to the desired mode, for example: Direct or configurable Unmanaged.
{{- end }}
---
apiVersion: {{ include "helm_lib_get_api_version_by_kind" (list . "ValidatingAdmissionPolicyBinding") }}
kind: ValidatingAdmissionPolicyBinding
metadata:
  name: {{ $policyName }}
  {{- include "helm_lib_module_labels" (list . (dict "app" "deckhouse")) | nindent 2 }}
spec:
  policyName: {{ $policyName }}
  validationActions: [Deny]
{{- end }}
{{- end }}
