{{- if and (include "helm_lib_kind_exists" (list . "ValidatingAdmissionPolicy")) (include "helm_lib_kind_exists" (list . "ValidatingAdmissionPolicyBinding")) }}
{{- $policyName := "deckhouse-module-registry-validation" }}

{{- $moduleEnabled := .Values.global.enabledModules | has "registry" }}
{{- $clusterBootstraped := .Values.global.clusterIsBootstrapped | default false }}
{{- $staticCluster := and .Values.global.clusterConfiguration (eq .Values.global.clusterConfiguration.clusterType "Static") }}

{{- if or (not $moduleEnabled) (not $clusterBootstraped) (not $staticCluster) }}
---
apiVersion: {{ include "helm_lib_get_api_version_by_kind" (list . "ValidatingAdmissionPolicy") }}
kind: ValidatingAdmissionPolicy
metadata:
  name: {{ $policyName }}
  {{- include "helm_lib_module_labels" (list . (dict "app" "deckhouse")) | nindent 2 }}
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
    - apiGroups:   ["deckhouse.io"]
      apiVersions: ["v1alpha1"]
      operations:  ["UPDATE"]
      resources:   ["moduleconfigs"]
  matchConditions:
  - name: 'deckhouse-mc'
    expression: 'object.metadata.name == "deckhouse"'
  validations:
  {{- if not $moduleEnabled }}
  - expression: >-
      (
        has(object.spec.settings.registry) ==
        has(oldObject.spec.settings.registry)
      ) &&
      (
        !has(object.spec.settings.registry) || 
        (
          object.spec.settings.registry ==
          oldObject.spec.settings.registry
        )
      )
    message: >-
      "Changing, adding, or removing `spec.settings.registry`
      is forbidden when the registry module is disabled.
      Please enable the module to make changes."
  {{- end }}
  {{- if not $clusterBootstraped }}
  - expression: >-
      (
        has(object.spec.settings.registry) ==
        has(oldObject.spec.settings.registry)
      ) &&
      (
        !has(object.spec.settings.registry) || 
        (
          object.spec.settings.registry ==
          oldObject.spec.settings.registry
        )
      )
    message: >-
      "Changing, adding, or removing `spec.settings.registry`
      is forbidden during cluster bootstrap.
      Please wait until bootstrap is complete."
  {{- end }}
  {{- if not $staticCluster }}
  - expression: >-
      !(
        has(object.spec.settings.registry.mode) && 
        (
          object.spec.settings.registry.mode == "Proxy" ||
          object.spec.settings.registry.mode == "Local"
        )
      )
    message: >-
      "The field `spec.settings.registry.mode` cannot be set to Proxy or Local.
      Proxy and Local are unsupported for non-static clusters.
      Please use other available modes."
  {{- end }}
---
apiVersion: {{ include "helm_lib_get_api_version_by_kind" (list . "ValidatingAdmissionPolicyBinding") }}
kind: ValidatingAdmissionPolicyBinding
metadata:
  name: {{ $policyName }}
  {{- include "helm_lib_module_labels" (list . (dict "app" "deckhouse")) | nindent 2 }}
spec:
  policyName: {{ $policyName }}
  validationActions: [Deny]
{{- end }}
{{- end }}
