---
artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact-artifact
from: quay.io/cilium/hubble-relay:v1.14.5@sha256:faf8e9c24b94fd5c4e0e52bd72bae30913dd92cd2271bf4db5c974e56e405a1d
---
artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact
from: {{ $.Images.BASE_ALPINE }}
import:
- artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact-artifact
  add: /usr/bin/hubble-relay
  to: /usr/local/bin/hubble-relay
  before: install
shell:
  install:
  - chown 64535:64535 /usr/local/bin/hubble-relay
  - chmod 0700 /usr/local/bin/hubble-relay
---
artifact: {{ $.ModuleName }}/{{ $.ImageName }}-cert-artifact
from: {{ $.Images.BASE_ALPINE }}
shell:
  beforeInstall:
    - apk add --no-cache ca-certificates
---
image: {{ $.ModuleName }}/{{ $.ImageName }}-v1
fromCacheVersion: {{ div .Commit.Date.Unix (mul 60 60 24 30) }}
from: {{ $.Images.BASE_ALPINE }}
import:
- artifact: {{ $.ModuleName }}/{{ $.ImageName }}-cert-artifact
  add: /etc/ssl/certs/ca-certificates.crt
  to: /etc/ssl/certs/ca-certificates.crt
  before: install
- artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact-artifact
  add: /usr/bin/hubble-relay
  to: /usr/local/bin/hubble-relay
  before: install
shell:
  install:
  - chown nobody /usr/local/bin/hubble-relay
  - chmod +x /usr/local/bin/hubble-relay
docker:
  USER: nobody
  ENTRYPOINT: ["hubble-relay", "serve"]
---
image: {{ $.ModuleName }}/{{ $.ImageName }}-finish
from: {{ $.Images.BASE_ALPINE }}
import:
- artifact: {{ $.ModuleName }}/{{ $.ImageName }}-cert-artifact
  add: /etc/ssl/certs/ca-certificates.crt
  to: /etc/ssl/certs/ca-certificates.crt
  before: install
- artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact
  add: /usr/local/bin/hubble-relay
  to: /usr/local/bin/hubble-relay
  before: install
docker:
  USER: 64535
  ENTRYPOINT: ["hubble-relay", "serve"]
---
image: {{ $.ModuleName }}/{{ $.ImageName }}-distroless
fromImage: common/distroless
import:
- artifact: {{ $.ModuleName }}/{{ $.ImageName }}-cert-artifact
  add: /etc/ssl/certs/ca-certificates.crt
  to: /etc/ssl/certs/ca-certificates.crt
  before: install
- artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact
  add: /usr/local/bin/hubble-relay
  to: /usr/local/bin/hubble-relay
  before: install
docker:
  USER: 64535
  ENTRYPOINT: ["hubble-relay", "serve"]
