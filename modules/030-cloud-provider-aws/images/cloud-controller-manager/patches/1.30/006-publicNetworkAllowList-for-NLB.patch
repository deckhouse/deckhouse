From 19085753f2fcb4f144816eaf466cf9bbf7cb98c4 Mon Sep 17 00:00:00 2001
From: Vladislav Denisov <vlad144denisov@gmail.com>
Date: Fri, 5 Dec 2025 16:24:23 +0300
Subject: [PATCH] Feature: add publicNetworkAllowList for NLB

---
 pkg/providers/v1/aws.go              | 19 ++++++++++++++++++-
 pkg/providers/v1/aws_loadbalancer.go |  4 ++++
 pkg/providers/v1/config/config.go    |  3 ++-
 3 files changed, 24 insertions(+), 2 deletions(-)

diff --git a/pkg/providers/v1/aws.go b/pkg/providers/v1/aws.go
index 89b1d742..8e4a66e2 100644
--- a/pkg/providers/v1/aws.go
+++ b/pkg/providers/v1/aws.go
@@ -404,7 +404,8 @@ type Cloud struct {
 	region   string
 	vpcID    string
 
-	tagging awsTagging
+	defaultNLBClientCIDRs []string
+	tagging               awsTagging
 
 	// The AWS instance that we are running on
 	// Note that we cache some state in awsInstance (mountpoints), so we must preserve the instance
@@ -615,6 +616,22 @@ func newAWSCloud2(cfg config.CloudConfig, awsServices Services, provider config.
 		deleteTagsBatcher:       newDeleteTagsBatcher(ctx, ec2),
 		describeInstanceBatcher: newdescribeInstanceBatcher(ctx, ec2),
 	}
+
+	if s := cfg.Global.PublicNetworkAllowList; s != "" {
+		parts := strings.Split(s, ",")
+		cidrs := make([]string, 0, len(parts))
+		for _, p := range parts {
+			p = strings.TrimSpace(p)
+			if p != "" {
+				cidrs = append(cidrs, p)
+			}
+		}
+		if len(cidrs) > 0 {
+			awsCloud.defaultNLBClientCIDRs = cidrs
+			klog.Infof("Using publicNetworkAllowList for NLB client CIDRs: %v", cidrs)
+		}
+	}
+
 	awsCloud.instanceCache.cloud = awsCloud
 	awsCloud.zoneCache.cloud = awsCloud
 	awsCloud.instanceTopologyManager = NewInstanceTopologyManager(ec2, &cfg)
diff --git a/pkg/providers/v1/aws_loadbalancer.go b/pkg/providers/v1/aws_loadbalancer.go
index f9dd5984..199488e1 100644
--- a/pkg/providers/v1/aws_loadbalancer.go
+++ b/pkg/providers/v1/aws_loadbalancer.go
@@ -959,6 +959,10 @@ func (c *Cloud) updateInstanceSecurityGroupsForNLB(ctx context.Context, lbName s
 		return nil
 	}
 
+	if (len(clientCIDRs) == 0 || (len(clientCIDRs) == 1 && clientCIDRs[0] == "0.0.0.0/0")) && len(c.defaultNLBClientCIDRs) > 0 {
+		clientCIDRs = c.defaultNLBClientCIDRs
+	}
+
 	clusterSGs, err := c.getTaggedSecurityGroups(ctx)
 	if err != nil {
 		return fmt.Errorf("error querying for tagged security groups: %q", err)
diff --git a/pkg/providers/v1/config/config.go b/pkg/providers/v1/config/config.go
index 557a125a..d940ef93 100644
--- a/pkg/providers/v1/config/config.go
+++ b/pkg/providers/v1/config/config.go
@@ -108,7 +108,8 @@ type CloudConfig struct {
 
 		// NLBSecurityGroupMode determines if the controller manages, creates, and attaches the security group when a service of type LoadBalancer (NLB) is created.
 		// Supported value is `Managed`.
-		NLBSecurityGroupMode string `json:"nlbSecurityGroupMode,omitempty" yaml:"nlbSecurityGroupMode,omitempty"`
+		NLBSecurityGroupMode   string `json:"nlbSecurityGroupMode,omitempty" yaml:"nlbSecurityGroupMode,omitempty"`
+		PublicNetworkAllowList string `json:"publicNetworkAllowList,omitempty" yaml:"publicNetworkAllowList,omitempty"`
 	}
 	// [ServiceOverride "1"]
 	//  Service = s3
-- 
2.48.1

