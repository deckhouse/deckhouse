- name: d8.deckhouse.availability
  rules:
  - alert: D8DeckhouseSelfTargetDown
    expr: max by (job) (up{job="deckhouse", scrape_source="self"} == 0)
    labels:
      severity_level: "4"
      tier: cluster
      d8_module: deckhouse
      d8_component: deckhouse
    annotations:
      d8_ignore_on_update: "true"
      plk_protocol_version: "1"
      plk_markup_format: "markdown"
      plk_pending_until_firing_for: "2m"
      plk_grouped_by__main: "D8DeckhouseUnavailable,tier=cluster,prometheus=deckhouse"
      plk_labels_as_annotations: "instance,pod"
      plk_ignore_labels: "job"
      summary: Prometheus is unable to scrape Deckhouse metrics.

  - alert: D8DeckhouseCustomTargetDown
    expr: max by (job) (up{job="deckhouse", scrape_source="custom"} == 0)
    labels:
      severity_level: "4"
      tier: cluster
      d8_module: deckhouse
      d8_component: deckhouse
    annotations:
      d8_ignore_on_update: "true"
      plk_protocol_version: "1"
      plk_markup_format: "markdown"
      plk_pending_until_firing_for: "10m"
      plk_grouped_by__main: "D8DeckhouseUnavailable,tier=cluster,prometheus=deckhouse"
      plk_labels_as_annotations: "instance,pod"
      plk_ignore_labels: "job"
      summary: Prometheus is unable to scrape custom metrics generated by Deckhouse hooks.

  - alert: D8DeckhouseSelfTargetAbsent
    expr: absent(up{job="deckhouse", scrape_source="self"}) == 1
    labels:
      severity_level: "4"
      tier: cluster
      d8_module: deckhouse
      d8_component: deckhouse
    annotations:
      d8_ignore_on_update: "true"
      plk_protocol_version: "1"
      plk_markup_format: "markdown"
      plk_pending_until_firing_for: "2m"
      plk_grouped_by__main: "D8DeckhouseUnavailable,tier=cluster,prometheus=deckhouse"
      summary: There is no Deckhouse target in Prometheus.

  - alert: D8DeckhousePodIsNotReady
    expr: |
      min by (pod) (
        kube_controller_pod{namespace="d8-system", controller_type="Deployment", controller_name="deckhouse"}
        * on (pod) group_right() kube_pod_status_ready{condition="true", namespace="d8-system"}
      ) != 1
    labels:
      severity_level: "4"
      tier: cluster
      d8_module: deckhouse
      d8_component: deckhouse
    annotations:
      d8_ignore_on_update: "true"
      plk_protocol_version: "1"
      plk_markup_format: "markdown"
      plk_pending_until_firing_for: "10m"
      plk_grouped_by__main: "D8DeckhouseUnavailable,tier=cluster,prometheus=deckhouse"
      plk_labels_as_annotations: "pod"
      summary: The Deckhouse Pod is NOT Ready.

  - alert: D8DeckhousePodIsNotRunning
    expr: |
      absent(
        kube_controller_pod{namespace="d8-system", controller_type="Deployment", controller_name="deckhouse"}
        * on (pod) group_right() kube_pod_status_phase{namespace="d8-system",phase="Running"}
      )
    labels:
      severity_level: "4"
      tier: cluster
      d8_module: deckhouse
      d8_component: deckhouse
    annotations:
      d8_ignore_on_update: "true"
      plk_protocol_version: "1"
      plk_markup_format: "markdown"
      plk_pending_until_firing_for: "2m"
      plk_grouped_by__main: "D8DeckhouseUnavailable,tier=cluster,prometheus=deckhouse"
      summary: The Deckhouse Pod is NOT Running.

  - alert: D8DeckhouseIsHung
    expr: max without (container, job) (increase(deckhouse_live_ticks[__SCRAPE_INTERVAL_X_4__])) < 1
    labels:
      severity_level: "4"
      tier: cluster
      d8_module: deckhouse
      d8_component: deckhouse
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: "markdown"
      plk_grouped_by__main: "D8DeckhouseUnavailable,tier=cluster,prometheus=deckhouse"
      plk_labels_as_annotations: "instance,pod"
      summary: Deckhouse is down.
      description: |
        Deckhouse is probably down since the `deckhouse_live_ticks` metric in Prometheus is no longer increasing (it is supposed to increment every 10 seconds).

  - alert: D8DeckhouseUnavailable
    expr: count(ALERTS{alertname=~"D8DeckhouseTargetDown|D8DeckhouseTargetAbsent|D8DeckhousePodIsNotReady|D8DeckhousePodIsNotRunning|D8DeckhouseIsHung",job="deckhouse", alertstate="firing"}) > 0
    labels:
      tier: cluster
      d8_module: deckhouse
      d8_component: deckhouse
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: "markdown"
      plk_alert_type: "group"
      summary: Deckhouse is down.
      description: |
        Deckhouse is down.

        You can find out the exact problem in the relevant alerts.

- name: d8.deckhouse.malfunctioning
  rules:
  - alert: D8DeckhousePodIsRestartingTooOften
    expr: |
      max by (pod) (
        kube_controller_pod{namespace="d8-system", controller_type="Deployment", controller_name="deckhouse"}
        * on (pod) group_right() increase(kube_pod_container_status_restarts_total{namespace="d8-system"}[1h])
        and
        kube_controller_pod{namespace="d8-system", controller_type="Deployment", controller_name="deckhouse"}
        * on (pod) group_right() kube_pod_container_status_restarts_total{namespace="d8-system"}
      ) > 3
    labels:
      severity_level: "9"
      tier: cluster
      d8_module: deckhouse
      d8_component: deckhouse
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: "markdown"
      plk_grouped_by__main: "D8DeckhouseMalfunctioning,tier=cluster,prometheus=deckhouse"
      plk_labels_as_annotations: "pod"
      summary: Excessive Deckhouse restarts detected.
      description: |
        The number of restarts in the last hour: {{ $value }}.

        Excessive Deckhouse restarts indicate that something is wrong. Normally, Deckhouse should be up and running all the time.

        Please, refer to the corresponding logs: `kubectl -n d8-system logs -f -l app=deckhouse`.

  - alert: D8DeckhouseHasNoAccessToRegistry
    expr: max by (pod, instance) (increase(deckhouse_registry_errors[__SCRAPE_INTERVAL_X_4__])) > 0
    for: 1h
    labels:
      severity_level: "7"
      tier: cluster
      d8_module: deckhouse
      d8_component: deckhouse
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: "markdown"
      plk_pending_until_firing_for: "1h"
      plk_grouped_by__main: "D8DeckhouseMalfunctioning,tier=cluster,prometheus=deckhouse"
      plk_labels_as_annotations: "instance,pod"
      summary: Deckhouse is unable to connect to the registry.
      description: |
        Deckhouse is unable to connect to the registry (registry.deckhouse.io in most cases) to check for a new Docker image (checks are performed every 15 seconds). Deckhouse does not have access to the registry; automatic updates are not available.

        Usually, this alert means that the Deckhouse Pod is having difficulties with connecting to the Internet.

  - alert: D8DeckhouseQueueIsHung
    expr: max by (pod, instance, queue) (min_over_time(deckhouse_tasks_queue_length{queue!~"main-subqueue-kubernetes-.*|/modules/upmeter/update_selector.*|/modules/secret-copier"}[__SCRAPE_INTERVAL_X_3__])) != 0
    for: 20m
    labels:
      severity_level: "7"
      tier: cluster
      d8_module: deckhouse
      d8_component: deckhouse
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: "markdown"
      plk_pending_until_firing_for: "10m"
      plk_grouped_by__main: "D8DeckhouseMalfunctioning,tier=cluster,prometheus=deckhouse"
      plk_labels_as_annotations: "instance,pod"
      summary: The {{ $labels.queue }} Deckhouse queue has hung; there are {{ $value }} task(s) in the queue.
      description: |
        Deckhouse cannot finish processing of the {{ $labels.queue }} queue with {{ $value }} tasks piled up.

        Please, refer to the corresponding logs: `kubectl -n d8-system logs -f -l app=deckhouse`.

  - alert: D8DeckhouseGlobalHookFailsTooOften
    expr: max(increase({job="deckhouse", __name__=~"deckhouse_global_hook_errors_total"}[__SCRAPE_INTERVAL_X_4__])) by (pod, instance, module, hook) > 1 or max(increase({job="deckhouse", __name__=~"deckhouse_global_hook_allowed_errors_total"}[__SCRAPE_INTERVAL_X_4__])) by (pod, instance, module, hook) > 1
    labels:
      severity_level: "9"
      tier: cluster
      d8_module: deckhouse
      d8_component: deckhouse
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: "markdown"
      plk_pending_until_firing_for: "10m"
      plk_grouped_by__main: "D8DeckhouseMalfunctioning,tier=cluster,prometheus=deckhouse"
      plk_labels_as_annotations: "instance,pod"
      summary: The {{ $labels.hook }} Deckhouse global hook crashes way too often.
      description: |
        The {{ $labels.hook }} has failed in the last `__SCRAPE_INTERVAL_X_4__`.

        Please, refer to the corresponding logs: `kubectl -n d8-system logs -f -l app=deckhouse`.

  - alert: D8DeckhouseModuleHookFailsTooOften
    expr: max(increase({job="deckhouse", __name__=~"deckhouse_module_hook_errors_total"}[__SCRAPE_INTERVAL_X_4__])) by (pod, instance, module, hook) > 1 or max(increase({job="deckhouse", __name__=~"deckhouse_module_hook_allowed_errors_total"}[__SCRAPE_INTERVAL_X_4__])) by (pod, instance, module, hook) > 1
    labels:
      severity_level: "9"
      tier: cluster
      d8_module: deckhouse
      d8_component: deckhouse
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: "markdown"
      plk_pending_until_firing_for: "10m"
      plk_grouped_by__main: "D8DeckhouseMalfunctioning,tier=cluster,prometheus=deckhouse"
      plk_labels_as_annotations: "instance,pod"
      summary: The {{ $labels.module }}/{{ $labels.hook }} Deckhouse hook crashes way too often.
      description: |
        The {{ $labels.hook }} hook of the {{ $labels.module }} module has failed in the last `__SCRAPE_INTERVAL_X_4__`.

        Please, refer to the corresponding logs: `kubectl -n d8-system logs -f -l app=deckhouse`.

  - alert: D8DeckhouseCouldNotDiscoverModules
    expr: max by (pod, instance) (increase(deckhouse_modules_discover_errors_total[__SCRAPE_INTERVAL_X_4__])) > 1
    labels:
      severity_level: "4"
      tier: cluster
      d8_module: deckhouse
      d8_component: deckhouse
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: "markdown"
      plk_pending_until_firing_for: "3m"
      plk_grouped_by__main: "D8DeckhouseMalfunctioning,tier=cluster,prometheus=deckhouse"
      plk_labels_as_annotations: "instance,pod"
      summary: Deckhouse is unable to discover modules.
      description: |
        Please, refer to the corresponding logs: `kubectl -n d8-system logs -f -l app=deckhouse`.

  - alert: D8DeckhouseCouldNotRunModule
    expr: max(increase(deckhouse_module_run_errors_total[__SCRAPE_INTERVAL_X_4__])) by (pod, instance, module) > 1
    labels:
      severity_level: "4"
      tier: cluster
      d8_module: deckhouse
      d8_component: deckhouse
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: "markdown"
      plk_pending_until_firing_for: "3m"
      plk_grouped_by__main: "D8DeckhouseMalfunctioning,tier=cluster,prometheus=deckhouse"
      plk_labels_as_annotations: "instance,pod"
      summary: Deckhouse is unable to start the {{ $labels.module }} module.
      description: |
        Please, refer to the corresponding logs: `kubectl -n d8-system logs -f -l app=deckhouse`.

  - alert: D8DeckhouseCouldNotDeleteModule
    expr: max(increase(deckhouse_module_delete_errors_total[__SCRAPE_INTERVAL_X_4__])) by (pod, instance, module) > 1
    labels:
      severity_level: "4"
      tier: cluster
      d8_module: deckhouse
      d8_component: deckhouse
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: "markdown"
      plk_pending_until_firing_for: "3m"
      plk_grouped_by__main: "D8DeckhouseMalfunctioning,tier=cluster,prometheus=deckhouse"
      plk_labels_as_annotations: "instance,pod"
      summary: Deckhouse is unable to delete the {{ $labels.module }} module.
      description: |
        Please, refer to the corresponding logs: `kubectl -n d8-system logs -f -l app=deckhouse`.

  - alert: D8DeckhouseCouldNotRunGlobalHook
    expr: max(increase(deckhouse_global_hook_errors_total[__SCRAPE_INTERVAL_X_4__])) by (pod, instance, hook) > 1
    labels:
      severity_level: "5"
      tier: cluster
      d8_module: deckhouse
      d8_component: deckhouse
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: "markdown"
      plk_pending_until_firing_for: "3m"
      plk_grouped_by__main: "D8DeckhouseMalfunctioning,tier=cluster,prometheus=deckhouse"
      plk_labels_as_annotations: "instance,pod"
      summary: Deckhouse is unable to run the {{ $labels.hook }} global hook.
      description: |
        Please, refer to the corresponding logs: `kubectl -n d8-system logs -f -l app=deckhouse`.

  - alert: D8DeckhouseCouldNotRunModuleHook
    expr: max(increase(deckhouse_module_hook_errors_total[__SCRAPE_INTERVAL_X_4__])) by (pod, instance, module, hook) > 1
    labels:
      severity_level: "7"
      tier: cluster
      d8_module: deckhouse
      d8_component: deckhouse
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: "markdown"
      plk_pending_until_firing_for: "3m"
      plk_grouped_by__main: "D8DeckhouseMalfunctioning,tier=cluster,prometheus=deckhouse"
      plk_labels_as_annotations: "instance,pod"
      summary: Deckhouse is unable to run the {{ $labels.module }}/{{ $labels.hook }} module hook.
      description: |
        Please, refer to the corresponding logs: `kubectl -n d8-system logs -f -l app=deckhouse`.

  - alert: D8DeckhouseMalfunctioning
    expr: count(ALERTS{alertname=~"D8DeckhousePodIsRestartingTooOften|D8DeckhouseCouldNotDiscoverModules|D8DeckhouseCouldNotRunGlobalHook|D8DeckhouseCouldNotRunModuleHook|D8DeckhouseCouldNotRunModule|D8DeckhouseCouldNotDeleteModule|D8DeckhouseQueueIsHung|D8DeckhouseGlobalHookFailsTooOften|D8DeckhouseModuleHookFailsTooOften", alertstate="firing"}) > 0
    labels:
      tier: cluster
      d8_module: deckhouse
      d8_component: deckhouse
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: "markdown"
      plk_alert_type: "group"
      summary: Deckhouse does not work as expected.
      description: |
        Deckhouse does not work as expected.

        You can find out the exact problem in the relevant alerts.

  - alert: D8DeckhouseConfigInvalid
    expr: increase(deckhouse_config_values_errors_total[__SCRAPE_INTERVAL_X_2__]) > 0
    for: 1m
    labels:
      severity_level: "5"
      d8_module: deckhouse
      d8_component: deckhouse
      tier: cluster
    annotations:
      plk_markup_format: "markdown"
      plk_protocol_version: "1"
      plk_grouped_by__main: "D8DeckhouseMalfunctioning,tier=cluster,prometheus=deckhouse"
      description: |
        Deckhouse config contains errors.

        Please check Deckhouse logs by running `kubectl -n d8-system logs -f -l app=deckhouse`.
        Edit Deckhouse config by running: `kubectl -n d8-system edit cm deckhouse`.
      summary: |
        Deckhouse config is invalid.

  - alert: DeckhouseUpdating
    expr: max (d8_is_updating) == 1
    labels:
      severity_level: "5"
      tier: cluster
      d8_module: deckhouse
      d8_component: deckhouse
    annotations:
      plk_protocol_version: "1"
      plk_markup_format: "markdown"
      summary: Deckhouse is being updated.
