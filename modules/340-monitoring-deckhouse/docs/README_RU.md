---
title: "Модуль monitoring-deckhouse"
description: "Мониторинг компонентов и сервисов Deckhouse Kubernetes Platform."
---

## Описание

Модуль `monitoring-deckhouse` предоставляет комплексный мониторинг, оповещения и наблюдаемость самой платформы Deckhouse Kubernetes Platform. Он отслеживает состояние, производительность и правильную работу основных компонентов Deckhouse для обеспечения стабильности и надежности платформы.

Этот модуль является критически важным компонентом наблюдаемости, который работает совместно с модулем [prometheus](/modules/prometheus/) для предоставления информации о рабочем состоянии Deckhouse.

## Как это работает

Модуль развертывает ресурсы мониторинга, которые:

- **Собирают метрики Deckhouse** - Скрапит метрики из пода Deckhouse с использованием PodMonitor ресурсов, включая:
  - Сам метрики на порту `4222` через endpoint `/metrics`
  - Пользовательские метрики, генерируемые хуками, через `/metrics/hooks`
  - Метрики выполнения модулей, хуков и системного здоровья

- **Определяют правила оповещений** - Предоставляет комплексные правила оповещений Prometheus, организованные по категориям:
  - **Доступность Deckhouse** - Мониторинг здоровья подов, готовности и времени работы
  - **Неисправности Deckhouse** - Обнаружение чрезмерных перезапусков, проблем доступа к реестру, зависших процессов
  - **Управление релизами** - Отслеживание подписок на каналы релизов, ожидающих обновлений и ручных подтверждений
  - **Управление модулями** - Мониторинг состояния модулей, ошибок валидации и устаревших конфигураций
  - **Проверки CNI** - Обнаружение нескольких конфигураций CNI и их некорректности
  - **Требования ОС** - Идентификация узлов с устаревшими версиями операционной системы

- **Предоставляет дашборды Grafana** - Включает предварительно созданные дашборды Grafana для визуализации:
  - Метрик производительности Deckhouse
  - Статистики выполнения модулей
  - Времени выполнения хуков и использования ресурсов
  - Обработки очередей и статуса конвергенции

### Сбор метрик

Модуль настраивает PodMonitor, который скрапит два endpoint'а из пода Deckhouse:

1. **Сам метрики** (`/metrics`) - Основные операционные метрики Deckhouse:
   - `deckhouse_live_ticks` - Индикатор здоровья, увеличивающийся каждые 10 секунд
   - `deckhouse_registry_errors` - Проблемы подключения к реестру
   - `deckhouse_module_hook_run_seconds` - Время выполнения хуков модулей
   - `deckhouse_tasks_queue_action_duration_seconds` - Время обработки очередей задач
   - И многие другие операционные метрики

2. **Метрики хуков** (`/metrics/hooks`) - Пользовательские метрики, генерируемые хуками Deckhouse с `honorLabels: true` для сохранения меток, специфичных для хуков

### Категории оповещений

#### Оповещения о доступности
- **D8DeckhousePodIsNotReady** - Под Deckhouse не в состоянии Ready более 10 минут
- **D8DeckhousePodIsNotRunning** - Под Deckhouse не в состоянии Running более 2 минут
- **D8DeckhouseIsHung** - Процесс Deckhouse кажется зависшим (остановились live ticks)
- **D8DeckhouseSelfTargetDown/Absent** - Prometheus не может скрапить метрики Deckhouse
- **D8DeckhouseCustomTargetDown** - Prometheus не может скрапить пользовательские метрики хуков

#### Оповещения о неисправностях
- **D8DeckhousePodIsRestartingTooOften** - Более 3 перезапусков за последний час
- **D8DeckhouseHasNoAccessToRegistry** - Невозможно подключиться к реестру контейнеров более 1 часа
- **D8DeckhouseQueueIsHung** - Обработка очереди задач зависла
- **D8DeckhouseCouldNotRunModuleHook** - Хуки модулей не могут выполняться
- **D8DeckhouseCouldNotDeleteModule/DiscoverModules** - Проблемы управления модулями

#### Оповещения об управлении релизами
- **D8DeckhouseIsNotOnReleaseChannel** - Не подписан ни на один регулярный канал релизов
- **DeckhouseReleaseIsWaitingManualApproval** - Новый релиз ожидает ручного подтверждения
- **DeckhouseReleaseIsBlocked** - Релиз заблокирован из-за невыполненных требований
- **DeckhouseReleaseIsOutdated** - Установленная версия устарела

#### Оповещения CNI и ОС
- **D8CNIEnabledMoreThanOne** - Включено более одного CNI одновременно
- **D8CNIMisconfigured** - ModuleConfig CNI не соответствует фактической конфигурации кластера
- **D8NodeHasDeprecatedOSVersion** - Узлы с устаревшими версиями ОС (Ubuntu 18.04, Debian 10, CentOS 7)

### Интеграция с модулем Observability

При включении модуля [observability](/modules/observability/stable/) этот модуль автоматически создает:
- Ресурсы `ClusterObservabilityMetricsRulesGroup` для правил Prometheus
- Ресурсы `ClusterObservabilityDashboard` для дашбордов Grafana

Это обеспечивает централизованное управление и поддержку мультиарендности для ресурсов мониторинга.

## Требования

- Модуль **prometheus** должен быть включен (автоматическая зависимость)
- Модуль **operator-prometheus** должен быть включен для поддержки PodMonitor

## Ограничения

- Конфигурационные параметры недоступны - модуль работает "из коробки"
- Все оповещения определены с предустановленными уровнями серьезности и порогами
- Дашборды Grafana доступны только для чтения и управляются модулем