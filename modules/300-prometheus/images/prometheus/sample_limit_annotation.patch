Subject: [PATCH] +
---
Index: discovery/kubernetes/pod.go
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/discovery/kubernetes/pod.go b/discovery/kubernetes/pod.go
--- a/discovery/kubernetes/pod.go	(revision 3d6b7e665928a78c4a18675802436fe92f3f4e04)
+++ b/discovery/kubernetes/pod.go	(date 1708969586167)
@@ -299,6 +299,7 @@
 			// The user has to add a port manually.
 			tg.Targets = append(tg.Targets, model.LabelSet{
 				model.AddressLabel:     lv(pod.Status.PodIP),
+				"__sample_limit__":     lv(""),
 				podContainerNameLabel:  lv(c.Name),
 				podContainerIDLabel:    lv(cID),
 				podContainerImageLabel: lv(c.Image),
@@ -313,6 +314,7 @@

 			tg.Targets = append(tg.Targets, model.LabelSet{
 				model.AddressLabel:            lv(addr),
+				"__sample_limit__":            lv(""),
 				podContainerNameLabel:         lv(c.Name),
 				podContainerIDLabel:           lv(cID),
 				podContainerImageLabel:        lv(c.Image),
Index: scrape/target.go
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/scrape/target.go b/scrape/target.go
--- a/scrape/target.go	(revision 3d6b7e665928a78c4a18675802436fe92f3f4e04)
+++ b/scrape/target.go	(date 1708969158549)
@@ -18,6 +18,7 @@
 	"hash/fnv"
 	"net"
 	"net/url"
+	"strconv"
 	"strings"
 	"sync"
 	"time"
@@ -546,3 +547,15 @@
 	}
 	return targets, failures
 }
+
+func (t *Target) SampleLimit() int {
+	limit := t.labels.Get("__sample_limit__")
+	if limit == "" {
+		return 0
+	}
+	convertedLimit, err := strconv.Atoi(limit)
+	if err != nil {
+		return 0
+	}
+	return convertedLimit
+}
Index: discovery/kubernetes/service.go
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/discovery/kubernetes/service.go b/discovery/kubernetes/service.go
--- a/discovery/kubernetes/service.go	(revision 3d6b7e665928a78c4a18675802436fe92f3f4e04)
+++ b/discovery/kubernetes/service.go	(date 1708969340212)
@@ -193,6 +193,7 @@

 		labelSet := model.LabelSet{
 			model.AddressLabel:       lv(addr),
+			"__sample_limit__":       lv(""),
 			servicePortNameLabel:     lv(port.Name),
 			servicePortNumberLabel:   lv(strconv.FormatInt(int64(port.Port), 10)),
 			servicePortProtocolLabel: lv(string(port.Protocol)),
Index: scrape/scrape.go
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/scrape/scrape.go b/scrape/scrape.go
--- a/scrape/scrape.go	(revision 3d6b7e665928a78c4a18675802436fe92f3f4e04)
+++ b/scrape/scrape.go	(date 1708969586163)
@@ -314,6 +314,11 @@
 		}
 		opts.target.SetMetadataStore(cache)

+		limit := opts.target.SampleLimit()
+		if limit == 0 {
+			limit = opts.sampleLimit
+		}
+
 		return newScrapeLoop(
 			ctx,
 			opts.scraper,
@@ -327,7 +332,7 @@
 			cache,
 			offsetSeed,
 			opts.honorTimestamps,
-			opts.sampleLimit,
+			limit,
 			opts.bucketLimit,
 			opts.labelLimits,
 			opts.interval,
