---
{{ $grafanaVersion := "10.4.9" }}
{{ $bundledPlugins := "petrslavotinek-carpetplot-panel,vonage-status-panel,btplc-status-dot-panel,natel-plotly-panel,savantly-heatmap-panel,grafana-piechart-panel,grafana-worldmap-panel" }}
---
artifact: {{ .ModuleName }}/{{ .ImageName }}-src-artifact
fromArtifact: src-artifact
git:
- add: /{{ .ModulePath }}modules/{{ .ModulePriority }}-{{ .ModuleName }}/images/{{ .ImageName }}/entrypoint
  to: /src/entrypoint
  includePaths:
  - '**/*.go'
  - '**/*.mod'
  - '**/*.sum'
  - '**/*.txt'
  stageDependencies:
    install:
    - '**/*.go'
    - 'go.mod'
    - 'go.sum'
- add: /{{ .ModulePath }}modules/{{ .ModulePriority }}-{{ .ModuleName }}/images/{{ .ImageName }}/grafana_home_dashboard.json
  to: /src/grafana_home_dashboard.json
  stageDependencies:
    install:
    - '**/*'
- add: /{{ .ModulePath }}modules/{{ .ModulePriority }}-{{ .ModuleName }}/images/{{ .ImageName }}/web
  to: /src/img
  stageDependencies:
    install:
    - '**/*'
shell:
  install:
  - git clone --depth 1 --branch v{{ $grafanaVersion }} {{ .SOURCE_REPO }}/grafana/grafana.git /src/grafana
  # we cannot fully implement yarn deps downloading thru proxy, so we need to use prebuild deps repo
  - git clone --depth 1 --branch v{{ $grafanaVersion }} {{ .SOURCE_REPO }}/grafana/grafana-deps.git /src/grafana-deps
  - cd /src/grafana
  - rm -rf .yarn package.json yarn.lock
  - mv /src/grafana-deps/.yarn .
  - mv /src/grafana-deps/package.json .
  - mv /src/grafana-deps/yarn.lock .
  - rm -rf /src/grafana-deps
  # this directory contains very long filename tests files and source extractor cannot create file
  - rm -rf pkg/tsdb/azuremonitor/testdata/azuremonitor
  - git clone --depth 1 {{ .SOURCE_REPO }}/grafana/grafana-plugins.git /src/grafana-plugins
---
artifact: {{ .ModuleName }}/{{ .ImageName }}-js-builder
from: {{ .Images.BASE_NODE_18_ALPINE }}
import:
- artifact: {{ .ModuleName }}/{{ .ImageName }}-src-artifact
  add: /src/grafana
  to: /src
  before: install
shell:
  install:
  - cd /src
  - export NODE_ENV=production NODE_OPTIONS="--max_old_space_size=8000"
  - yarn build
---
artifact: {{ .ModuleName }}/{{ .ImageName }}-go-builder
from: {{ .Images.BASE_GOLANG_22_BULLSEYE }}
mount:
- fromPath: ~/go-pkg-cache
  to: /go/pkg
import:
- artifact: {{ .ModuleName }}/{{ .ImageName }}-src-artifact
  add: /src/grafana
  to: /usr/src/app
  before: install
shell:
  beforeInstall:
  {{- include "debian packages proxy" . | nindent 2 }}
  - apt-get -y --no-install-recommends install gcc musl musl-tools
  - export GOPROXY={{ .GOPROXY }} CGO_ENABLED=1 GOOS=linux GOARCH=amd64 CC=/usr/bin/musl-gcc
  - go install github.com/google/wire/cmd/wire@v0.6.0
  install:
  - export GOPROXY={{ .GOPROXY }} CGO_ENABLED=1 GOOS=linux GOARCH=amd64 CC=/usr/bin/musl-gcc
  - cd /usr/src/app
  - /go/bin/wire gen -tags oss ./pkg/server
  - go build -ldflags -w -ldflags "-X main.version={{ $grafanaVersion }} -linkmode external -extldflags -static" -tags netgo -o ./bin/linux-amd64/grafana ./pkg/cmd/grafana
---
artifact: {{ .ModuleName }}/{{ .ImageName }}-entrypoint
from: {{ .Images.BASE_GOLANG_23_ALPINE }}
mount:
- fromPath: ~/go-pkg-cache
  to: /go/pkg
import:
- artifact: {{ .ModuleName }}/{{ .ImageName }}-src-artifact
  add: /src/entrypoint
  to: /app
  before: install
shell:
  install:
  - cd /app
  - export GOPROXY={{ .GOPROXY }} CGO_ENABLED=0 GOOS=linux GOARCH=amd64
  - go mod tidy
  - go test ./... -v
  - go build -ldflags="-s -w" -o entrypoint main.go
  - chown -R 64535:64535 /app/
  - chmod 0700 /app/entrypoint
---
artifact: {{ .ModuleName }}/{{ .ImageName }}-grafana-distr
from: {{ .Images.BASE_ALT_P11 }}
import:
- artifact: {{ .ModuleName }}/{{ .ImageName }}-go-builder
  add: /usr/src/app/bin/linux-amd64/grafana
  to: /usr/share/grafana/bin/grafana
  before: install
- artifact: {{ .ModuleName }}/{{ .ImageName }}-js-builder
  add: /src/public
  to: /usr/share/grafana/public
  before: install
- artifact: {{ .ModuleName }}/{{ .ImageName }}-js-builder
  add: /src/tools
  to: /usr/share/grafana/tools
  before: install
- artifact: {{ .ModuleName }}/{{ .ImageName }}-src-artifact
  add: /src/grafana/conf
  to: /usr/share/grafana/conf
  before: install
- artifact: {{ .ModuleName }}/{{ .ImageName }}-src-artifact
  add: /src/grafana_home_dashboard.json
  to: /usr/share/grafana/public/dashboards/grafana_home_dashboard.json
  before: install
- artifact: {{ .ModuleName }}/{{ .ImageName }}-src-artifact
  add: /src/img
  to: /img
  before: install
- artifact: {{ .ModuleName }}/{{ .ImageName }}-src-artifact
  add: /src/grafana-plugins
  to: /grafana-plugins
  before: install
shell:
  install:
  - |
    export PATH="/usr/share/grafana/bin:$PATH" \
    GF_PATHS_CONFIG="/etc/grafana/grafana.ini" \
    GF_PATHS_DATA="/var/lib/grafana" \
    GF_PATHS_HOME="/usr/share/grafana" \
    GF_PATHS_LOGS="/var/log/grafana" \
    GF_PATHS_PLUGINS="/usr/share/grafana/plugins-bundled" \
    GF_PATHS_PROVISIONING="/etc/grafana/provisioning"
  - cd $GF_PATHS_HOME
  - |
    mkdir -p "$GF_PATHS_HOME/.aws" \
             "$GF_PATHS_PROVISIONING/datasources" \
             "$GF_PATHS_PROVISIONING/dashboards" \
             "$GF_PATHS_PROVISIONING/notifiers" \
             "$GF_PATHS_PROVISIONING/plugins" \
             "$GF_PATHS_PROVISIONING/access-control" \
             "$GF_PATHS_LOGS" \
             "$GF_PATHS_PLUGINS" \
             "$GF_PATHS_DATA"
  - cp "$GF_PATHS_HOME/conf/sample.ini" "$GF_PATHS_CONFIG"
  - cp "$GF_PATHS_HOME/conf/ldap.toml" /etc/grafana/ldap.toml
  - cp /img/* "$GF_PATHS_HOME/public/img"
  - chmod -R 777 "$GF_PATHS_DATA" "$GF_PATHS_HOME/.aws" "$GF_PATHS_LOGS" "$GF_PATHS_PLUGINS" "$GF_PATHS_PROVISIONING" "$GF_PATHS_HOME"
  - |
    IFS="," && \
    BUNDLED_PLUGINS={{ $bundledPlugins }} && \
    for plugin in ${BUNDLED_PLUGINS}; do \
      plugin_path="$(find /grafana-plugins -type f -name "${plugin}*")"
      grafana cli --pluginsDir "${GF_PATHS_PLUGINS}" --pluginUrl ${plugin_path} plugins install ${plugin}; \
    done
  - chmod +r /etc/grafana/grafana.ini
  - export BUNDLED_PLUGINS_PATH="${GF_PATHS_PLUGINS}"
  - chown -R 64535:64535 /usr/share/grafana
  - chown -R 64535:64535 /etc/grafana
  - chown -R 64535:64535 /var/lib/grafana
  - chown -R 64535:64535 /var/log/grafana
  - chmod 0700 ./bin/grafana
---
artifact: {{ .ModuleName }}/{{ .ImageName }}-binaries-artifact
from: {{ .Images.BASE_ALT_P11 }}
---
image: {{ .ModuleName }}/{{ .ImageName }}
fromImage: common/distroless
import:
- artifact: {{ .ModuleName }}/{{ .ImageName }}-binaries-artifact
  add: /
  to: /
  includePaths:
  - usr/lib
  - usr/lib64
  before: install
- artifact: {{ .ModuleName }}/{{ .ImageName }}-entrypoint
  add: /app/entrypoint
  to: /usr/local/bin/entrypoint
  before: install
- artifact: {{ .ModuleName }}/{{ .ImageName }}-grafana-distr
  add: /usr/share/grafana/
  to: /usr/share/grafana
  before: install
- artifact: {{ .ModuleName }}/{{ .ImageName }}-grafana-distr
  add: /etc/grafana/
  to: /etc/grafana
  before: install
- artifact: {{ .ModuleName }}/{{ .ImageName }}-grafana-distr
  add: /var/lib/grafana/
  to: /var/lib/grafana
  before: install
- artifact: {{ .ModuleName }}/{{ .ImageName }}-grafana-distr
  add: /var/log/grafana/
  to: /var/log/grafana
  before: install
docker:
  ENV:
    PATH: "/usr/share/grafana/bin:$PATH"
    GF_PATHS_CONFIG: "/etc/grafana/grafana.ini"
    GF_PATHS_DATA: "/var/lib/grafana"
    GF_PATHS_HOME: "/usr/share/grafana"
    GF_PATHS_LOGS: "/var/log/grafana"
    GF_PATHS_PLUGINS: "/usr/share/grafana/plugins-bundled"
    GF_PATHS_PROVISIONING: "/etc/grafana/provisioning"
    BUNDLED_PLUGINS_PATH: "${GF_PATHS_PLUGINS}"
  WORKDIR: $GF_PATHS_HOME
  EXPOSE:
  - "3000"
  ENTRYPOINT:
  - "entrypoint"
