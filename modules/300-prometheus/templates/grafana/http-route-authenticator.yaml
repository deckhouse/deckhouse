{{- if and .Values.prometheus.internal.grafana.enabled .Values.global.modules.publicDomainTemplate (hasKey .Values.global.modules "gatewayClass") .Values.global.modules.gatewayClass .Values.prometheus.internal.deployDexAuthenticator }}
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: grafana-dex-authenticator
  namespace: d8-monitoring
  {{- include "helm_lib_module_labels" (list . (dict "app" "dex-authenticator" "name" "grafana")) | nindent 2 }}
spec:
  parentRefs:
  {{- if and (hasKey .Values.prometheus "gatewayHTTPRoute") (hasKey .Values.prometheus.gatewayHTTPRoute "parentRefs") }}
  {{- range .Values.prometheus.gatewayHTTPRoute.parentRefs }}
    - name: {{ .name }}
      {{- if .namespace }}
      namespace: {{ .namespace }}
      {{- end }}
      {{- if .group }}
      group: {{ .group }}
      {{- end }}
      {{- if .kind }}
      kind: {{ .kind }}
      {{- end }}
      {{- if .sectionName }}
      sectionName: {{ .sectionName }}
      {{- end }}
  {{- end }}
  {{- else }}
    - name: dex-grafana
      namespace: d8-ingress-istio
      kind: Gateway
  {{- end }}
  hostnames:
    - {{ include "helm_lib_module_public_domain" (list . "grafana") }}
    - {{ include "helm_lib_module_public_domain" (list . "prometheus") }}
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /dex-authenticator
      backendRefs:
        - name: grafana-dex-authenticator
          port: 443
    - matches:
        - path:
            type: PathPrefix
            value: /logout
      filters:
        - type: URLRewrite
          urlRewrite:
            pathPrefix: /dex-authenticator/sign_out
      backendRefs:
        - name: grafana-dex-authenticator
          port: 443
{{- end }}
