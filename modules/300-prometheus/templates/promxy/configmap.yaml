---
apiVersion: v1
kind: ConfigMap
metadata:
  name: promxy-config
  namespace: d8-monitoring
  {{- include "helm_lib_module_labels" (list . (dict "app" "promxy")) | nindent 2 }}
data:
  config.yaml: |
      promxy:
        server_groups:
          - static_configs:
              - targets:
                {{- if (include "helm_lib_ha_enabled" .) }}
                - prometheus-main-0.d8-monitoring.svc.{{ .Values.global.discovery.clusterDomain }}.:9090
                - prometheus-main-1.d8-monitoring.svc.{{ .Values.global.discovery.clusterDomain }}.:9090
                {{- else }}
                - prometheus.d8-monitoring.svc.{{ .Values.global.discovery.clusterDomain }}.:9090
                {{- end }}
            ignore_error: true
            anti_affinity: 30s
            timeout: 5s
            remote_read: false
            prefer_max: true
            scheme: https
            http_client:
              dial_timeout: 1s
              bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
              tls_config:
                insecure_skip_verify: true
          {{- if ne (int .Values.prometheus.longtermRetentionDays) 0 }}
          - static_configs:
              - targets:
                - prometheus-longterm.d8-monitoring.svc.{{ .Values.global.discovery.clusterDomain }}.:9090
            ignore_error: true
            anti_affinity: 300s
            timeout: 5s
            remote_read: false
            prefer_max: true
            scheme: https
            http_client:
              dial_timeout: 1s
              bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
              tls_config:
                insecure_skip_verify: true
          {{- end }}
