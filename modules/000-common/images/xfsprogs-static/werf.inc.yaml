artifact: {{ $.ModuleName }}/xfsprogs-builder-artifact
from: {{ $.Images.BASE_UBUNTU }}
shell:
  beforeInstall:
    - apt update
    - |
      apt install --no-install-recommends -y wget git bzip2 curl tar \
        gcc make automake autopoint \
        gettext pkg-config bison gettext asciidoctor po4a \
        libblkid-dev zlib1g zlib1g-dev \
        uuid-dev libcap-ng-utils libcap-ng-dev libtool \
        libncurses5-dev libncursesw5-dev build-essential libinih-dev scrub liburcu-dev libicu-dev \
        libdevmapper-dev libattr1-dev libunistring-dev dh-python \
        debhelper
  install:
  - mkdir -p /build
  - cd /build
  - wget -qO- https://git.kernel.org/pub/scm/fs/xfs/xfsprogs-dev.git/snapshot/xfsprogs-dev-6.5.0.tar.gz | tar -xzv --strip-components=1
  - export LDFLAGS="-Wl,-z,now -Wl,-z,relro -static -s"
  - export CFLAGS="-fPIC -pie -fstack-protector-all -O2 -D_FORTIFY_SOURCE=2 -static -s -flto=auto"
  - export SUID_CFLAGS=-static
  - export SUID_LDFLAGS=-static
  - export CPPFLAGS=-static
  - make
  - |
    ./configure \
        --prefix="/build/staticbin" \
        --enable-static
  - make install
---
image: {{ $.ModuleName }}/{{ $.ImageName }}
fromImage: common/distroless
import:
- artifact: {{ $.ModuleName }}/xfsprogs-builder-artifact
  add: /build/staticbin
  to: /build/staticbin
  before: setup