{{- $istioVersion := "1.28.1" }}
{{- $istioProxyBranch := "release-1.28.1-patch" }}
{{- $istioProxySha := "94128943ceb0ab63e46e56e4987e2780cf0bb6f5" }}
{{- $bazelVersion := "7.6.2" }}
{{- $source := "https://github.com" }}
{{- $sourceraw := "https://raw.githubusercontent.com" }}
{{- if $.DistroPackagesProxy }}
  {{- $source = printf "http://%s/repository/github-com" $.DistroPackagesProxy }}
  {{- $sourceraw = printf "http://%s/repository/githubusercontent" $.DistroPackagesProxy }}
{{- end }}
---
image: {{ .ModuleName }}/{{ .ImageName }}
fromImage: common/alt-p11
import:
- image: {{ .ModuleName }}/{{ .ImageName }}-artifact
  add: /src/proxy/bin/envoy
  to: /usr/local/bin/envoy
  before: install
shell:
  beforeInstall:
  {{- include "alt packages proxy" . | nindent 2 }}
  - apt-get update
  - apt-get install -y ca-certificates
  - update-ca-trust
  - apt-get clean
  - rm -rf /var/log/*log /var/lib/apt/lists/* /var/log/apt/* /var/lib/dpkg/*-old /var/cache/debconf/*-old
  install:
  - chmod 0555 /usr/local/bin/envoy
imageSpec:
  config:
    user: "64535:64535"
    entrypoint: ["/usr/local/bin/envoy"]
---
image: {{ .ModuleName }}/{{ .ImageName }}-src-artifact
fromImage: common/src-artifact
final: false
secrets:
- id: SOURCE_REPO
  value: {{ .SOURCE_REPO }}
shell:
  install:
  - git clone --depth 1 --branch {{ $istioProxyBranch }} $(cat /run/secrets/SOURCE_REPO)/istio/proxy.git /src/proxy
  - cd /src/proxy
---
image: {{ .ModuleName }}/{{ .ImageName }}-build-image-artifact
fromImage: builder/golang-bookworm
final: false
mount:
{{ include "mount points for golang builds" . }}
secrets:
- id: GOPROXY
  value: {{ .GOPROXY }}
shell:
  beforeInstall:
  {{- include "debian packages proxy" . | nindent 2 }}
  - export DEBIAN_FRONTEND=noninteractive TZ=Etc/UTC
  - ln -snf /usr/share/zoneinfo/${TZ} /etc/localtime && echo ${TZ} > /etc/timezone
  - |
    apt-get update && apt-get install -y \
      ca-certificates \
      clang-16 lld-16 \
      git git-lfs \
      cmake ninja-build \
      libtool automake autoconf make \
      curl gnupg lsb-release \
      python3 python3-pip python3-venv \
      libc++-16-dev libc++abi-16-dev \
      libssl-dev libz-dev libunwind-16-dev \
      unzip binutils
  - apt-get autoclean && apt-get clean
  install:
  - ln -s -f /usr/lib/llvm-16/bin/clang /usr/bin/clang
  - ln -s -f /usr/lib/llvm-16/bin/clang++ /usr/bin/clang++
  - export GOROOT=/usr/local/go GOPATH=/go
  - export PATH=${PATH}:${GOROOT}/bin:${GOPATH}/bin
  - export GOOS=linux GOARCH=amd64 CGO_ENABLED=0
  - export GOPROXY=$(cat /run/secrets/GOPROXY)
  - go version
  # Install Bazel wrapper + pinned Bazel version.
  - |
    bazel_version="{{ $bazelVersion }}"
    curl --fail --show-error --silent --location "{{ $sourceraw }}/bazelbuild/bazel/refs/tags/${bazel_version}/scripts/packages/bazel.sh" --output /usr/local/bin/bazel
    chmod +x /usr/local/bin/bazel
    long_binary_name="bazel-${bazel_version}-linux-x86_64"
    curl --fail --show-error --silent --location "{{ $source }}/bazelbuild/bazel/releases/download/${bazel_version}/${long_binary_name}" --output "/usr/local/bin/${long_binary_name}"
    chmod +x "/usr/local/bin/${long_binary_name}"
    USE_BAZEL_VERSION="${bazel_version}" bazel version
---
image: {{ .ModuleName }}/{{ .ImageName }}-artifact
fromImage: {{ .ModuleName }}/{{ .ImageName }}-build-image-artifact
final: false
import:
- image: {{ .ModuleName }}/{{ .ImageName }}-src-artifact
  add: /src/proxy
  to: /src/proxy
  before: install
mount:
{{ include "mount points for golang builds" . }}
secrets:
- id: GOPROXY
  value: {{ .GOPROXY }}
shell:
  install:
  - export GOROOT=/usr/local/go GOPATH=/go
  - export PATH=${PATH}:${GOROOT}/bin:${GOPATH}/bin
  - export GOPROXY=$(cat /run/secrets/GOPROXY)
  - export CC=clang CXX=clang++

  - cd /src/proxy
  - export USE_BAZEL_VERSION="$(cat .bazelversion)"
  - export BAZEL_VERSION="${USE_BAZEL_VERSION}"

  # Build in C++20 mode (required by newer Envoy deps) and disable WASM/V8 to speed up the initial build.
  - bazel build --disk_cache=/tmp/bazel-cache --nostamp --define wasm=disabled --config=release --cxxopt=-std=c++20 --host_cxxopt=-std=c++20 //:envoy
  - mkdir -p /src/proxy/bin
  - cp -f bazel-bin/envoy /src/proxy/bin/envoy
  - strip /src/proxy/bin/envoy || true
  - chmod 0555 /src/proxy/bin/envoy
  - rm -rf /src/proxy/.git
