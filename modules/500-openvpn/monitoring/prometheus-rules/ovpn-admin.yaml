- name: openvpn.admin.info
  rules:
    - alert: OpenVPNClientCertificateExpired
      expr: ovpn_client_cert_expire <= 0
      for: 1m
      labels:
        severity_level: "4"
      annotations:
        plk_markup_format: "markdown"
        plk_protocol_version: "1"
        summary: "OpenVPN client certificate expired for {{ $labels.client }}"
        description: |-
          The OpenVPN client certificate for **{{ $labels.client }}** has expired.

          Check the certificate information and make sure it actually expires.
          ```shell
          kubectl -n d8-openvpn get secrets -l name="{{ $labels.client }}"  -o jsonpath='{.items[0].data.tls\.crt}' | base64 -d | openssl x509 -text -noout
          ```

          Renew or delete the expired certificate.
          Check [documentation](https://deckhouse.io/products/kubernetes-platform/documentation/v1/modules/openvpn/faq.html#how-to-revoke-rotate-or-delete-a-user-certificate) for details.

    - alert: OpenVPNClientCertificateExpired
      expr: ovpn_client_cert_expire < 30
      for: 1h
      labels:
        severity_level: "5"
      annotations:
        plk_markup_format: "markdown"
        plk_protocol_version: "1"
        summary: OpenVPN client certificate expires for {{ $labels.client }} in less than 30 days.
        description: |-
          The OpenVPN client certificate for **{{ $labels.client }}** is set to expire in {{ $value }} days.

          Renewal of certificate required.
          Check [documentation](https://deckhouse.io/products/kubernetes-platform/documentation/v1/modules/openvpn/faq.html#how-to-revoke-rotate-or-delete-a-user-certificate) for details.

          View certificate details to display the exact expiration date.
          ```shell
          kubectl -n d8-openvpn get secrets -l name={{ $labels.client }}  -o jsonpath='{.items[0].data.tls\.crt}' | base64 -d | openssl x509 -text -noout
          ```

    - alert: OpenVPNClientCertificateExpired
      expr: ovpn_client_cert_expire < 7
      for: 1h
      labels:
        severity_level: "5"
      annotations:
        plk_markup_format: "markdown"
        plk_protocol_version: "1"
        summary: OpenVPN client certificate expires for {{ $labels.client }} in less than 7 days.
        description: |-
          The OpenVPN client certificate for **{{ $labels.client }}** is set to expire in {{ $value }} days.

          Renewal of certificate required.
          Check [documentation](https://deckhouse.io/products/kubernetes-platform/documentation/v1/modules/openvpn/faq.html#how-to-revoke-rotate-or-delete-a-user-certificate) for details.

          View certificate details to display the exact expiration date.
          ```shell
          kubectl -n d8-openvpn get secrets -l name={{ $labels.client }}  -o jsonpath='{.items[0].data.tls\.crt}' | base64 -d | openssl x509 -text -noout
          ```

    - alert: OpenVPNServerCertificateExpiringInAWeek
      expr: ovpn_server_cert_expire < 7
      for: 1h
      labels:
        severity_level: "5"
      annotations:
        plk_markup_format: "markdown"
        plk_protocol_version: "1"
        summary: OpenVPN server certificate expires in less than 7 days.
        description: |-
          The OpenVPN server certificate is set to expire in {{ $value }} days.

          OpenVPN server certificate renews automatically X days before expiration.  
          Automatic rotation did not work.  
          Check the module status or perform [manual rotation](https://deckhouse.io/products/kubernetes-platform/documentation/v1/modules/openvpn/faq.html#how-to-rotate-a-server-certificate).

          Check the certificate information and make sure it actually expires.
          ```shell
          kubectl -n d8-openvpn get secrets -l name=server  -o jsonpath='{.items[0].data.tls\.crt}' | base64 -d | openssl x509 -text -noout
          ```          

    - alert: OpenVPNServerCertificateExpired
      expr: ovpn_server_cert_expire == 0
      for: 1m
      labels:
        severity_level: "4"
      annotations:
        plk_markup_format: "markdown"
        plk_protocol_version: "1"
        summary: OpenVPN server certificate has expired.
        description: |-
          The OpenVPN server certificate has expired.

          OpenVPN server certificate renews automatically X days before expiration.  
          Automatic rotation did not work.  
          Check the module status or perform [manual rotation](https://deckhouse.io/products/kubernetes-platform/documentation/v1/modules/openvpn/faq.html#how-to-rotate-a-server-certificate).

          Check the certificate information and make sure it actually expires.
          ```shell
          kubectl -n d8-openvpn get secrets -l name=server  -o jsonpath='{.items[0].data.tls\.crt}' | base64 -d | openssl x509 -text -noout
          ```          

    - alert: OpenVPNServerCACertificateExpiringSoon
      expr: ovpn_server_ca_cert_expire < 30
      for: 1h
      labels:
        severity_level: "5"
      annotations:
        plk_markup_format: "markdown"
        plk_protocol_version: "1"
        summary: OpenVPN CA certificate expires in less than 30 days.
        description: |-
          The OpenVPN CA certificate is set to expire in {{ $value }} days.

          Renew the CA certificate if necessary.
          After renewing the certificate, **you will need to reissue all client and server certificates**.
          Check [documentation](https://deckhouse.io/products/kubernetes-platform/documentation/v1/modules/openvpn/faq.html#how-to-rotate-a-root-certificate-ca) for details.

          View certificate details to display the exact expiration date.
          ```shell
          kubectl -n d8-openvpn get secrets -l name=server  -o jsonpath='{.items[0].data.tls\.crt}' | base64 -d | openssl x509 -text -noout
          ```                              

    - alert: OpenVPNServerCACertificateExpiringInAWeek
      expr: ovpn_server_ca_cert_expire < 7
      for: 1h
      labels:
        severity_level: "5"
      annotations:
        plk_markup_format: "markdown"
        plk_protocol_version: "1"
        summary: OpenVPN CA certificate expires in less than 7 days.
        description: |-
          The OpenVPN CA certificate will expire in less than 7 days.

          Immediate renewal is recommended.

    - alert: OpenVPNServerCACertificateExpired
      expr: ovpn_server_ca_cert_expire == 0
      for: 1m
      labels:
        severity_level: "4"
      annotations:
        plk_markup_format: "markdown"
        plk_protocol_version: "1"
        summary: OpenVPN CA certificate has expired.
        description: |-
          The OpenVPN CA certificate has expired.

          To restore VPN functionality, renew the expired certificate as soon as possible.

    - alert: OpenVPNClientsNeedRenewDueToNewCA
      expr: (ovpn_client_cert_expire <= 0) and ignoring(client) (ovpn_server_ca_cert_expire > 3650)
      for: 5m
      labels:
        severity_level: "5"
      annotations:
        plk_markup_format: "markdown"
        plk_protocol_version: "1"
        summary: "Expired OpenVPN client certificate detected after CA renewal for {{ $labels.client }}"
        description: |-
          The OpenVPN client certificate for **{{ $labels.client }}** has expired, while current CA is valid for more than 10 years.

          This likely indicates that the CA was recently rotated and client certificates need to be reissued.



          View certificate details to display the exact expiration date.
          ```shell
          kubectl -n d8-openvpn get secrets -l name=server  -o jsonpath='{.items[0].data.tls\.crt}' | base64 -d | openssl x509 -text -noout
          ```