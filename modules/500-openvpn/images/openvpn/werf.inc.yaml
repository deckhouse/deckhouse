---
artifact: {{ .ModuleName }}/openvpn-artifact
from: {{ .Images.BASE_ALPINE }}
shell:
  install:
    - apk add --no-cache curl git autoconf automake make libtool g++ linux-headers libnl3-dev libcap-ng-dev lz4-dev linux-pam-dev
    - mkdir -p /src
    - cd /src
    - git clone --depth 1 -b openssl-3.1.3 https://github.com/openssl/openssl.git
    - cd openssl
    - ./Configure gcc -static -no-shared
    - make -j4
    - make install
    - cd /src
    - mkdir lzo
    - cd lzo
    - curl -sL https://www.oberhumer.com/opensource/lzo/download/lzo-2.10.tar.gz | tar -xvz --strip-components=1
    - ./configure --enable-static --disable-debug
    - make -j4
    - make install
    - cd /src
    - git clone --depth 1 -b v2.5.6 https://github.com/OpenVPN/openvpn.git
    - cd openvpn
    - autoreconf -vi
    - ./configure --enable-static --disable-shared --disable-debug --disable-unit-tests --disable-lz4 --disable-plugin-auth-pam --disable-plugin-down-root
    - make LIBS="-all-static"
---
image: {{ .ModuleName }}/{{ .ImageName }}
fromImage: common/distroless
import:
- artifact: {{ .ModuleName }}/openvpn-artifact
  add: /src/openvpn/src/openvpn/openvpn
  to: /openvpn
  before: setup
docker:
  ENTRYPOINT: ["/openvpn"]
