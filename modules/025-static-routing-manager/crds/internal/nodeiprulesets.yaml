apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: nodeiprulesets.network.deckhouse.io
  labels:
    heritage: deckhouse
    module: static-routing-manager
spec:
  group: network.deckhouse.io
  scope: Cluster
  names:
    plural: nodeiprulesets
    singular: nodeipruleset
    kind: NodeIPRuleSet
  preserveUnknownFields: false
  versions:
  - name: v1alpha1
    served: true
    storage: true
    subresources:
      status: {}
    additionalPrinterColumns:
      - jsonPath: .status.conditions[?(@.type=="Ready")].status
        name: Ready
        type: string
      - jsonPath: .spec.nodeName
        name: nodeName
        type: string
      - jsonPath: .metadata.ownerReferences[?(@.kind=="IPRuleSet")].name
        name: ipRuleSetName
        type: string
      - jsonPath: .metadata.creationTimestamp
        name: Age
        type: date
    schema: &schema
      openAPIV3Schema:
        type: object
        description: |
          describe routingtables and routes on node
        required:
        - spec
        properties:
          spec:
            type: object
            required:
            - nodeName
            - rules
            properties:
              nodeName:
                type: string
                x-kubernetes-validations:
                  - message: nodeName is immutable field
                    rule: self == oldSelf
                description: |
                  The name of the node for which this CR is intended.
              rules:
                type: array
                minItems: 1
                description: |
                  ip rules declaration
                items:
                  type: object
                  required:
                    - selector
                    - action
                  properties:
                    priority:
                      type: integer
                      minimum: 0
                      maximum: 4294967295
                      description: |
                        priority of rule
                    selector:
                      type: object
                      required:
                        - from
                        - to
                      properties:
                        not:
                          type: bool
                          description: |
                            invert the selector match rule
                        from:
                          type: array
                          description: |
                            Array of source prefixes
                          items:
                            type: string
                            format: cidr
                            description: |
                              select the source prefix to match.
                        to:
                          type: array
                          description: |
                            Array of destination prefixes
                          items:
                            type: string
                            format: cidr
                            description: |
                              select the destination prefix to match.
                        tos:
                          type: integer
                          description: |
                            select the TOS (or diffserv/dscp) value to match.
                        fwmark:
                          type: integer
                          description: |
                            select the fwmark value to match.
                        iif:
                          type: string
                          description: |
                            select the incoming device to match.
                        oif:
                          type: string
                          description: |
                            select the outgoing device (interface) to match.
                        uidrange:
                          description: |
                            select the range of uid (UserID) values to match.
                          type: string
                          pattern: '^(429496729[0-5]|42949672[0-8][0-9]|4294967[0-1][0-9]{2}|429496[0-6][0-9]{3}|42949[0-5][0-9]{4}|4294[0-8][0-9]{5}|429[0-3][0-9]{6}|42[0-8][0-9]{7}|4[0-1][0-9]{8}|[0-3][0-9]{9}|[0-9]{1,9})-(429496729[0-5]|42949672[0-8][0-9]|4294967[0-1][0-9]{2}|429496[0-6][0-9]{3}|42949[0-5][0-9]{4}|4294[0-8][0-9]{5}|429[0-3][0-9]{6}|42[0-8][0-9]{7}|4[0-1][0-9]{8}|[0-3][0-9]{9}|[0-9]{1,9})$'
                        ipproto:
                          type: integer
                          description: |
                            select the ip protocol value to match.
                        sportrange:
                          description: |
                            select the range of source ports to match.
                          type: string
                          pattern: '^(6553[0-5]|655[0-2][0-9]|65[0-4][0-9]{2}|6[0-4][0-9]{3}|[1-5][0-9]{4}|[0-9]{1,4})$|^(6553[0-5]|655[0-2][0-9]|65[0-4][0-9]{2}|6[0-4][0-9]{3}|[1-5][0-9]{4}|[0-9]{1,4})-(6553[0-5]|655[0-2][0-9]|65[0-4][0-9]{2}|6[0-4][0-9]{3}|[1-5][0-9]{4}|[0-9]{1,4})$'
                        dportrange:
                          description: |
                            select the range of destination ports to match.
                          type: string
                          pattern: '^(6553[0-5]|655[0-2][0-9]|65[0-4][0-9]{2}|6[0-4][0-9]{3}|[1-5][0-9]{4}|[0-9]{1,4})$|^(6553[0-5]|655[0-2][0-9]|65[0-4][0-9]{2}|6[0-4][0-9]{3}|[1-5][0-9]{4}|[0-9]{1,4})-(6553[0-5]|655[0-2][0-9]|65[0-4][0-9]{2}|6[0-4][0-9]{3}|[1-5][0-9]{4}|[0-9]{1,4})$'
                        tun_id:
                          type: integer
                          description: |
                            select the virtual tunnel ID to match.
                    action:
                      type: object
                      required:
                        - lookup
                      properties:
                        lookup:
                          type: object
                          description: |
                            the routing table identifier to lookup if the rule selector matches.
                          properties:
                            ipRoutingTableID:
                              type: integer
                              minimum: 1
                              maximum: 4294967295
                              description: |
                                ID of routing table on node
          status:
            type: object
            properties:
              observedGeneration:
                description: ObservedGeneration is the latest generation observed
                    by the controller.
                format: int64
                type: integer
              appliedRules:
                type: array
                items:
                  type: object
                  required:
                    - selector
                    - action
                  properties:
                    priority:
                      type: integer
                      minimum: 0
                      maximum: 4294967295
                      description: |
                        priority of rule
                    selector:
                      type: object
                      required:
                        - from
                        - to
                      properties:
                        not:
                          type: bool
                          description: |
                            invert the selector match rule
                        from:
                          type: array
                          description: |
                            Array of source prefixes
                          items:
                            type: string
                            format: cidr
                            description: |
                              select the source prefix to match.
                        to:
                          type: array
                          description: |
                            Array of destination prefixes
                          items:
                            type: string
                            format: cidr
                            description: |
                              select the destination prefix to match.
                        tos:
                          type: integer
                          description: |
                            select the TOS (or diffserv/dscp) value to match.
                        fwmark:
                          type: integer
                          description: |
                            select the fwmark value to match.
                        iif:
                          type: string
                          description: |
                            select the incoming device to match.
                        oif:
                          type: string
                          description: |
                            select the outgoing device (interface) to match.
                        uidrange:
                          description: |
                            select the range of uid (UserID) values to match.
                          type: object
                          properties:
                            start:
                              type: integer
                              description: |
                                the beginning of the range.
                            end:
                              type: integer
                              description: |
                                end of the range.
                        ipproto:
                          type: integer
                          description: |
                            select the ip protocol value to match.
                        sportrange:
                          description: |
                            select the range of source ports to match.
                          type: object
                          properties:
                            start:
                              type: integer
                              description: |
                                the beginning of the range.
                            end:
                              type: integer
                              description: |
                                end of the range.
                        dportrange:
                          description: |
                            select the range of destination ports to match.
                          type: object
                          properties:
                            start:
                              type: integer
                              description: |
                                the beginning of the range.
                            end:
                              type: integer
                              description: |
                                end of the range.
                        tun_id:
                          type: integer
                          description: |
                            select the virtual tunnel ID to match.
                    action:
                      type: object
                      required:
                        - lookup
                      properties:
                        lookup:
                          type: object
                          description: |
                            the routing table identifier to lookup if the rule selector matches.
                          properties:
                            ipRoutingTableID:
                              type: integer
                              minimum: 1
                              maximum: 4294967295
                              description: |
                                ID of routing table on node
              conditions:
                type: array
                items:
                  type: object
                  required:
                    - type
                    - status
                    - reason
                  properties:
                    type:
                      description: Type of node group condition.
                      type: string
                    lastHeartbeatTime:
                      type: string
                      format: date-time
                      description: Last time the routes were checked.
                    status:
                      description: Status of the condition, one of True, False.
                      type: string
                    lastTransitionTime:
                      type: string
                      format: date-time
                      description: Last time the condition transit from one status to another.
                    reason:
                      description: The reason for the condition's last transition
                        in CamelCase.
                      type: string
                    message:
                      description: Human readable message indicating details about last transition.
                      type: string
