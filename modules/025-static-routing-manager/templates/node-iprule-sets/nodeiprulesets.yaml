{{- range $nirs := .Values.staticRoutingManager.internal.nodeIPRuleSets }}
---
apiVersion: network.deckhouse.io/v1alpha1
kind: NodeIPRuleSet
metadata:
  finalizers:
    - routing-tables-manager.network.deckhouse.io
  {{ include "helm_lib_module_labels" (list $ (dict "routing-manager.network.deckhouse.io/node-name" $nirs.nodeName)) | nindent 2 }}
  name: {{ $nirs.name }}
  ownerReferences:
    - apiVersion: NodeRoutingTable
      blockOwnerDeletion: true
      controller: true
      kind: IPRuleSet
      name: {{ $nirs.ownerRTName }}
      uid: {{ $nirs.ownerRTUID }}
spec:
  nodeName: {{ $nirs.nodeName }}
  rules:
  {{- range $rule := $nirs.rules }}
    - selector:
    {{- if $rule.selector.not }}
        not: {{ $rule.selector.not }}
    {{- end }}
    {{- if $rule.selector.from }}
        from:
      {{- range $prefix := $rule.selector.from }}
          - {{ $prefix | quote }}
      {{- end }}
    {{- end }}
    {{- if $rule.selector.to }}
        to:
      {{- range $prefix := $rule.selector.to }}
          - {{ $prefix | quote }}
      {{- end }}
    {{- end }}
    {{- if $rule.selector.iif }}
        iif: {{ $rule.selector.iif | quote }}
    {{- end }}
    {{- if $rule.selector.oif }}
        oif: {{ $rule.selector.oif | quote }}
    {{- end }}
    {{- if $rule.selector.uidrange }}
        uidrange: {{ $rule.selector.uidrange | quote }}
    {{- end }}
    {{- if $rule.selector.ipproto }}
        ipproto: {{ $rule.selector.ipproto }}
    {{- end }}
    {{- if $rule.selector.tos }}
        tos: {{ $rule.selector.tos | quote }}
    {{- end }}
    {{- if $rule.selector.fwmark }}
        fwmark: {{ $rule.selector.fwmark | quote }}
    {{- end }}
    {{- if $rule.selector.sport }}
        sport: {{ $rule.selector.sport | quote }}
    {{- end }}
    {{- if $rule.selector.dport }}
        dport: {{ $rule.selector.dport | quote }}
    {{- end }}
    {{- if $rule.selector.tun_id }}
        tun_id: {{ $rule.selector.tun_id }}
    {{- end }}
      action:
    {{- if $rule.action.lookup }}
        lookup:
      {{- if $rule.action.lookup.ipRouteTableID }}
          ipRouteTableID: {{ $rule.action.lookup.ipRouteTableID }}
      {{- end }}
    {{- end }}
    {{- if $rule.priority }}
      priority: {{ $rule.priority }}
    {{- end }}
  {{- end }}
{{- end }}
