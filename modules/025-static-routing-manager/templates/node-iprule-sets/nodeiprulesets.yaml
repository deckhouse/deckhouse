{{- range $nirs := .Values.staticRoutingManager.internal.nodeIPRuleSets }}
---
apiVersion: network.deckhouse.io/v1alpha1
kind: NodeIPRuleSet
metadata:
  finalizers:
    - routing-tables-manager.network.deckhouse.io
  {{ include "helm_lib_module_labels" (list $ (dict "routing-manager.network.deckhouse.io/node-name" $nirs.nodeName)) | nindent 2 }}
  name: {{ $nirs.name }}
  ownerReferences:
    - apiVersion: network.deckhouse.io/v1alpha1
      blockOwnerDeletion: true
      controller: true
      kind: IPRuleSet
      name: {{ $nirs.ownerIRSName }}
      uid: {{ $nirs.ownerIRSUID }}
spec:
  nodeName: {{ $nirs.nodeName }}
  rules:
  {{- range $rule := $nirs.rules }}
    - selectors:
    {{- if $rule.selectors.not }}
        not: {{ $rule.selectors.not }}
    {{- end }}
    {{- if $rule.selectors.from }}
        from:
      {{- range $prefix := $rule.selectors.from }}
          - {{ $prefix | quote }}
      {{- end }}
    {{- end }}
    {{- if $rule.selectors.to }}
        to:
      {{- range $prefix := $rule.selectors.to }}
          - {{ $prefix | quote }}
      {{- end }}
    {{- end }}
    {{- if $rule.selectors.iif }}
        iif: {{ $rule.selectors.iif | quote }}
    {{- end }}
    {{- if $rule.selectors.oif }}
        oif: {{ $rule.selectors.oif | quote }}
    {{- end }}
    {{- if $rule.selectors.uidrange }}
        uidrange: {{ $rule.selectors.uidrange | quote }}
    {{- end }}
    {{- if $rule.selectors.ipproto }}
        ipproto: {{ $rule.selectors.ipproto }}
    {{- end }}
    {{- if $rule.selectors.tos }}
        tos: {{ $rule.selectors.tos | quote }}
    {{- end }}
    {{- if $rule.selectors.fwmark }}
        fwmark: {{ $rule.selectors.fwmark | quote }}
    {{- end }}
    {{- if $rule.selectors.sport }}
        sport: {{ $rule.selectors.sport | quote }}
    {{- end }}
    {{- if $rule.selectors.dport }}
        dport: {{ $rule.selectors.dport | quote }}
    {{- end }}
      actions:
    {{- if $rule.actions.lookup }}
        lookup:
      {{- if $rule.actions.lookup.ipRoutingTableID }}
          ipRoutingTableID: {{ $rule.actions.lookup.ipRoutingTableID }}
      {{- end }}
    {{- end }}
    {{- if $rule.priority }}
      priority: {{ $rule.priority }}
    {{- end }}
  {{- end }}
{{- end }}
