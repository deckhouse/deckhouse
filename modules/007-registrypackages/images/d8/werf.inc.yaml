---
image: {{ $.ModuleName }}/{{ $.ImageName }}
from: {{ $.Images.BASE_SCRATCH }}
import:
- artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact
  add: /
  to: /
  includePaths:
  - d8
  - install
  - uninstall
  before: setup
docker:
  LABEL:
    distro: all
    version: all
    d8: {{ .CandiVersionMap.d8.d8CliVersion }}
---
artifact: {{ $.ModuleName }}/{{ $.ImageName }}-src-artifact
fromArtifact: src-artifact
git:
- add: /{{ $.ModulePath }}/modules/007-{{ $.ModuleName }}/images/{{ $.ImageName }}/scripts
  to: /src/scripts
  stageDependencies:
    install:
      - '**/*'
shell:
  install:
  - git clone --depth 1 --branch {{ .CandiVersionMap.d8.d8CliVersion }} {{ $.SOURCE_REPO }}/deckhouse/deckhouse-cli.git /src/deckhouse-cli
---
artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact
from: {{ $.Images.BASE_GOLANG_23_BULLSEYE }}
import:
- artifact: {{ $.ModuleName }}/{{ $.ImageName }}-src-artifact
  add: /src
  to: /src
  before: install
shell:
  beforeInstall:
  {{- include "debian packages proxy" . | nindent 2 }}
  - apt-get update && apt-get install libbtrfs-dev
  install:
  - export GOPROXY={{ $.GOPROXY }}
  - go install github.com/go-task/task/v3/cmd/task@v3.39.2
  - cd /src/deckhouse-cli
  - task build:dist:linux:amd64
  - mv ./dist/{{ .CandiVersionMap.d8.d8CliVersion }}/linux-amd64/d8 /d8
  - mv /src/scripts/* /
  - chmod +x /d8 /install /uninstall
