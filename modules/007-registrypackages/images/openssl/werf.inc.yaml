{{- $version := "3.3.2" }}
{{- $image_version := $version | replace "." "-" }}
---
image: {{ $.ModuleName }}/{{ $.ImageName }}-{{ $image_version }}
from: {{ $.Images.BASE_SCRATCH }}
import:
- artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact-{{ $image_version }}
  add: /
  to: /
  includePaths:
  - openssl
  - install
  - uninstall
  before: setup
docker:
  LABEL:
    distro: all
    version: all
    openssl: {{ $version }}
---
artifact: {{ $.ModuleName }}/{{ $.ImageName }}-src-artifact-{{ $image_version }}
fromArtifact: common/src-artifact
shell:
  install:
  - git clone -b openssl-{{ $version }} --single-branch --depth=1 {{ $.SOURCE_REPO }}/openssl/openssl.git /src && cd /src && rm -r .git
---
artifact: {{ $.ModuleName }}/{{ $.ImageName }}-artifact-{{ $image_version }}
from: {{ $.Images.BASE_UBUNTU }}
git:
- add: /{{ $.ModulePath }}modules/007-{{ $.ModuleName }}/images/{{ $.ImageName }}/scripts
  to: /
  stageDependencies:
    setup:
    - '**/*'
import:
- artifact: {{ $.ModuleName }}/{{ $.ImageName }}-src-artifact-{{ $image_version }}
  add: /src
  to: /src
  before: install
shell:
  beforeInstall:
  {{- include "ubuntu packages proxy" . | nindent 2 }}
  - apt-get install -y build-essential
  install:
  - cd /src
  - ./Configure linux-x86_64 no-shared no-threads -static --prefix=/opt/openssl-static
  - make -j4
  - make -j4 install
  - strip /opt/openssl-static/bin/openssl
  - mv /opt/openssl-static/bin/openssl /openssl
  - chmod +x /openssl
