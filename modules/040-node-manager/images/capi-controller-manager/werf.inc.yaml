{{- $version := "1.5.2" }}
---
image: {{ .ModuleName }}/capi-controller-manager
from: {{ .Images.BASE_SCRATCH }}
docker:
  ENV:
    WORKDIR: /
    ENTRYPOINT: "/capi-controller-manager"
import:
- artifact: {{ .ModuleName }}/capi-artifact
  add: /src/bin/manager
  to: /capi-controller-manager
  before: setup
---
artifact: {{ $.ModuleName }}/capi-artifact
from: {{ $.Images.BASE_GOLANG_20_ALPINE }}
mount:
- fromPath: ~/go-pkg-cache
  to: /go/pkg
shell:
  beforeInstall:
  - apk add --no-cache make bash git patch rsync gcc musl-dev
  install:
  - mkdir /src
  - wget https://github.com/kubernetes-sigs/cluster-api/archive/v{{ $version }}.tar.gz -O - | tar -xz --strip-components=1 -C /src/
  - cd /src
  - CGO_ENABLED=0 GOOS=linux GOARCH=amd64 make managers LDFLAGS="-s -w -extldflags \"-static\""
