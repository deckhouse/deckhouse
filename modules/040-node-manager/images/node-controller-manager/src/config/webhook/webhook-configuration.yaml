apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: node-controller-validating
  labels:
    app: node-controller
    heritage: deckhouse
    module: node-manager
  annotations:
    # cert-manager or Deckhouse will inject the CA bundle
    cert-manager.io/inject-ca-from: d8-cloud-instance-manager/node-controller-webhook-certs
webhooks:
  - name: vnodegroup.deckhouse.io
    admissionReviewVersions:
      - v1
    clientConfig:
      service:
        name: node-controller
        namespace: d8-cloud-instance-manager
        path: /validate-deckhouse-io-v1-nodegroup
        port: 443
    failurePolicy: Fail
    matchPolicy: Equivalent
    rules:
      - apiGroups:
          - deckhouse.io
        apiVersions:
          - v1
          - v1alpha1
          - v1alpha2
        operations:
          - CREATE
          - UPDATE
          - DELETE
        resources:
          - nodegroups
        scope: Cluster
    sideEffects: None
    timeoutSeconds: 10
---
# Conversion webhook is configured in the CRD itself
# This is just a reference for what needs to be added to the CRD:
#
# spec:
#   conversion:
#     strategy: Webhook
#     webhook:
#       clientConfig:
#         service:
#           name: node-controller
#           namespace: d8-cloud-instance-manager
#           path: /convert
#           port: 443
#       conversionReviewVersions:
#         - v1
