{{- $dcgm_version := "4.2.3" }}
---
image: {{ $.ModuleName }}/{{ $.ImageName }}-src-artifact
fromImage: common/src-artifact
final: false
secrets:
- id: SOURCE_REPO
  value: {{ $.SOURCE_REPO }}
shell:
  install:
  - git clone --depth 1 --branch v{{ $dcgm_version }} $(cat /run/secrets/SOURCE_REPO)/NVIDIA/DCGM.git /src/DCGM
  - cd /src/DCGM
  - rm -rf .git hack test
---
image: {{ .ModuleName }}/{{ .ImageName }}-crosstool-ng-artifact
final: false
fromImage: builder/golang-bookworm
import:
- image: {{ .ModuleName }}/{{ .ImageName }}-src-artifact
  add: /src
  before: install
shell:
  beforeInstall:
  - set -ex; \
    export DEBIAN_FRONTEND=noninteractive; \
    apt update; \
    apt full-upgrade --quiet --assume-yes; \
    apt install --quiet --assume-yes --no-install-recommends \
        autoconf \
        automake \
        bison \
        build-essential \
        curl \
        file \
        flex \
        gawk \
        git \
        gperf \
        help2man \
        libexpat1-dev \
        libncurses5-dev \
        libtool \
        libtool-bin \
        python3 \
        python3-dev \
        subversion \
        texinfo \
        unzip \
        wget; \
    apt install --reinstall --quiet --assume-yes ca-certificates; \
    update-ca-certificates -f; \
    apt autoremove --purge --quiet --assume-yes; \
    apt clean --quiet --assume-yes; \
    rm -rf /var/lib/apt/lists/*
  install:
  - export CROSSTOOL_SHA512SUM=45736acb5ead4e50b7565d328739108cd0200838b9d6e4437d1718ec93bc12c404a3c3780386a409a7 ebf4418c6c18844bd4bfd1ad17c9301533d5e89b1a50e2
  - export CROSSTOOL_URL=https://github.com/crosstool-ng/crosstool-ng/archive/ed12fa68402f58e171a6f79500f73f4781fdc9e5.tar.gz
  - cd /root; set -ex; \
    mkdir -p crosstool-ng; \
    wget $CROSSTOOL_URL -O crosstool-ng.tar.gz; \
    echo "$CROSSTOOL_SHA512SUM  crosstool-ng.tar.gz" | sha512sum -c -; \
    tar xf crosstool-ng.tar.gz -C crosstool-ng --strip-components=1; \
    cd crosstool-ng; \
    ./bootstrap; \
    ./configure --prefix=/opt/crosstool-ng; \
    make -j12; \
    make install; \
    rm -rf /root/crosstool-ng
  - useradd --create-home builder
  - mkdir /opt/cross
  - cp /src/DCGM/dcgmbuild/crosstool-ng/x86_64.config /home/builder/x86_64/.config && chown -R builder:builder /home/builder/
  - chown builder:builder /opt/cross
  - cd /home/builder/x86_64/
  - CT_PREFIX=/opt/cross /opt/crosstool-ng/bin/ct-ng build
---
image: {{ .ModuleName }}/{{ .ImageName }}-chs-artifact
final: false
fromImage: builder/golang-bookworm
import:
- image: {{ .ModuleName }}/{{ .ImageName }}-src-artifact
  add: /src
  before: install
- image: {{ .ModuleName }}/{{ .ImageName }}-crosstool-ng-artifact
  add: /opt/cross
  before: install
shell:
  beforeInstall:
  - export DEBIAN_FRONTEND=noninteractive; \
    apt update; \
    apt full-upgrade --quiet --assume-yes; \
    apt install --quiet --assume-yes --no-install-recommends \
        bzip2 \
        cpio \
        curl \
        dwz \
        elfutils \
        file \
        gcovr \
        gettext \
        graphviz \
        libedit-dev \
        make \
        ninja-build \
        patch \
        pkg-config \
        pylint \
        python3 \
        python3-dev \
        python3-distro \
        python3-requests \
        qemu-system-arm \
        qemu-user \
        rpm \
        software-properties-common \
        unzip \
        vim \
        wget \
        xz-utils \
        yq; \
    add-apt-repository ppa:git-core; \
    apt update; \
    apt install --quiet --assume-yes --no-install-recommends git; \
    apt autoremove --purge --quiet --assume-yes; \
    apt clean --quiet --assume-yes; \
    rm -rf /var/lib/apt/lists/*
  install:
  - cp -r /src/DCGM/dcgmbuild/scripts/host /tmp/scripts/host
  - set -ex; \
    find /tmp/scripts/host -name '*.sh' | sort | while read -r SCRIPT; \
    do $SCRIPT /tmp/scripts/host/urls.txt; \
    done;