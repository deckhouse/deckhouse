{{- if and (include "helm_lib_kind_exists" (list . "ValidatingAdmissionPolicy")) (include "helm_lib_kind_exists" (list . "ValidatingAdmissionPolicyBinding")) }}
{{- $policyName := "caps-controller-manager" }}
---
apiVersion: {{ include "helm_lib_get_api_version_by_kind" (list . "ValidatingAdmissionPolicy") }}
kind: ValidatingAdmissionPolicy
metadata:
  name: {{ $policyName }}
  {{- include "helm_lib_module_labels" (list . (dict "app" "caps-controller-manager") ) | nindent 2 }}
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
    - apiGroups: ["deckhouse.io"]
      apiVersions: ["v1alpha1", "v1alpha2"]
      operations: ["CREATE", "UPDATE"]
      resources: ["sshcredentials"]
  validations:
  - expression: |
      !(has(object.spec.privateSSHKeyPassphrase) && object.spec.privateSSHKeyPassphrase != "") ||
      (has(object.spec.privateSSHKey) && object.spec.privateSSHKey != "")
    message: "privateSSHKeyPassphrase can only be set if privateSSHKey is present."
---
apiVersion: {{ include "helm_lib_get_api_version_by_kind" (list . "ValidatingAdmissionPolicyBinding") }}
kind: ValidatingAdmissionPolicyBinding
metadata:
  name: {{ $policyName }}
  {{- include "helm_lib_module_labels" (list . (dict "app" "caps-controller-manager") ) | nindent 2 }}
spec:
  policyName: {{ $policyName }}
  validationActions: [Deny]
  matchResources:
    resourceRules:
    - apiGroups: ["deckhouse.io"]
      apiVersions: ["v1alpha1", "v1alpha2"]
      operations: ["CREATE", "UPDATE"]
      resources: ["sshcredentials"]
{{- end }}