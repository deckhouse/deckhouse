{{- define "fencing_agent_resources" }}
cpu: 10m
memory: 50Mi
{{- end }}

{{ $ctx := . }}
{{- range $ng := .Values.nodeManager.internal.nodeGroups }}
  {{ $mode := dig "fencing" "mode" "" $ng }}
  {{ if eq $mode "Watchdog" }}
      {{- if ($.Values.global.enabledModules | has "vertical-pod-autoscaler") }}
---
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: fencing-agent-{{ $ng.name }}
  namespace: d8-cloud-instance-manager
  {{- include "helm_lib_module_labels" (list $ctx (dict "app" "fencing-agent")) | nindent 2 }}
spec:
  targetRef:
    apiVersion: "apps/v1"
    kind: Daemonset
    name: fencing-agent-{{ $ng.name }}
  updatePolicy:
    updateMode: "Initial"
  resourcePolicy:
    containerPolicies:
      - containerName: "fencing-agent"
        minAllowed:
        {{- include "fencing_agent_resources" $ctx | nindent 10 }}
        maxAllowed:
          cpu: 20m
          memory: 70Mi
      {{- end }}
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fencing-agent-{{ $ng.name }}
  namespace: d8-cloud-instance-manager
  {{- include "helm_lib_module_labels" (list $ctx (dict "app" "fencing-agent")) | nindent 2 }}
spec:
  selector:
    matchLabels:
      app: fencing-agent
      node-group-name: {{ $ng.name }}
  template:
    metadata:
      labels:
        app: fencing-agent
        node-group-name: {{ $ng.name }}
      annotations:
        container.apparmor.security.beta.kubernetes.io/fencing-agent: "unconfined"
    spec:
      {{- include "helm_lib_priority_class" (tuple $ctx "system-cluster-critical") | nindent 6 }}
      {{- include "helm_lib_tolerations" (tuple $ctx "any-node") | nindent 6 }}
      {{- include "helm_lib_module_pod_security_context_run_as_user_deckhouse" . | nindent 6 }}
      nodeSelector:
        node.deckhouse.io/group: {{ $ng.name }}
      automountServiceAccountToken: true
      serviceAccountName: fencing-agent
      containers:
        - name: fencing-agent
          securityContext:
            privileged: true
            readOnlyRootFilesystem: true
            seLinuxOptions:
              level: 's0'
              type: 'spc_t'
            capabilities:
              add:
                - SYS_ADMIN
              drop:
                - ALL
          imagePullPolicy: IfNotPresent
          env:
            - name: GRPC_ADDRESS
              value: "/tmp/fencing-agent.sock"
            - name:  MEMBERLIST_BOOTSTRAP_DELAY
              value: "5s"
            - name: PROBE_INTERVAL
              value: "200ms"
            - name: PROBE_TIMEOUT
              value: "100ms"
            - name: SUSPICION_MULT
              value: "2"
            - name: INDIRECT_CHECKS
              value: "3"
            - name: GOSSIP_INTERVAL
              value: "100ms"
            - name: RETRANSMIT_MULT
              value: "4"
            - name: GOSSIP_TO_THE_DEAD_TIME
              value: "2s"
            - name: MIN_EVENT_INTERVAL_JOIN
              value: "200ms"
            - name: MIN_EVENT_INTERVAL_LEFT
              value: "600ms"
            - name: MEMBERLIST_PORT
              value: "8500"
            - name: NODE_GROUP
              value: {{ $ng.name }}
            - name: LOG_LEVEL
              value: debug
            - name: WATCHDOG_DEVICE
              value: /dev/watchdog
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
          ports:
            - name: memberlist-tcp
              containerPort: 8500
              hostPort: 8500
              protocol: TCP
            - name: memberlist-udp
              containerPort: 8500
              hostPort: 8500
              protocol: UDP
          image: {{ include "helm_lib_module_image" (list $ctx "fencingAgent") }}
          livenessProbe:
            httpGet:
              path: /healthz
              port:  8081
            initialDelaySeconds:  15
            periodSeconds:  20
            failureThreshold:  3
          resources:
            requests:
              {{- include "helm_lib_module_ephemeral_storage_only_logs" $ctx | nindent 14 }}
        {{- if not ( $ctx.Values.global.enabledModules | has "vertical-pod-autoscaler") }}
              {{- include "fencing_agent_resources" $ctx | nindent 14 }}
        {{- end }}
          volumeMounts:
            - name: watchdog
              mountPath: /dev/watchdog
            - name: socket
              mountPath: /tmp
      terminationGracePeriodSeconds: 10
      volumes:
        - name: watchdog
          hostPath:
            path: /dev/watchdog
            type: CharDevice
        - name: socket
          hostPath:
            path: /tmp
  {{- end }}
{{- end }}
