{{ $ctx := . }}
{{- range $ng := .Values.nodeManager.internal.nodeGroups }}
  {{- $mode := dig "fencing" "mode" "" $ng }}
  {{- if or (eq $mode "Watchdog") (eq $mode "Dryrun") }}
    {{- $timeout := dig "fencing" "watchdog" "timeout" 60 $ng }}
---
apiVersion: deckhouse.io/v1alpha1
kind: NodeGroupConfiguration
metadata:
  name: enable-watchdog-for-nodegroup-{{ $ng.name }}.sh
  labels:
    app: fencing-agent
spec:
  weight: 99
  nodeGroups: ["{{ $ng.name }}"]
  bundles: ["*"]
  content: |
    bb-sync-file /etc/udev/rules.d/60-watchdog.rules - <<"EOF"
    KERNEL=="watchdog*", OWNER="64535", GROUP="root", MODE="0660"
    EOF

    bb-event-on 'nodegroup-watchdog-service-changed' '_nodegroup_watchdog_service'
    function _nodegroup_watchdog_service() {
      systemctl daemon-reload
      systemctl restart nodegroup-watchdog.service
      systemctl enable --now nodegroup-watchdog.service
    }

    bb-sync-file /etc/systemd/system/nodegroup-watchdog.service - nodegroup-watchdog-service-changed <<"EOF"
    [Unit]
    Description=Nodegroup watchdog manager service
    After=multi-user.target

    [Service]
    Type=oneshot
    RemainAfterExit=yes
    ExecStart=/opt/deckhouse/bin/nodegroup-watchdog.sh start
    ExecStop=/opt/deckhouse/bin/nodegroup-watchdog.sh stop

    [Install]
    WantedBy=multi-user.target
    EOF

    bb-sync-file /opt/deckhouse/bin/nodegroup-watchdog.sh - nodegroup-watchdog-service-changed <<-"EOF"
    #!/bin/bash

    WD="/dev/watchdog"
    MODE="{{ $mode }}"

    start_wd() {
      if [ -e "${WD}" ]; then
        ls -lha /dev/watchdog* 2>/dev/null
        rm -rf "${WD}"
      fi

      if [ "${MODE}" = "Dryrun" ]; then
        echo "[DRYRUN] Would run: modprobe softdog soft_margin={{ $timeout }} soft_panic=1"
      else
        modprobe softdog soft_margin={{ $timeout }} soft_panic=1
      fi
    }

    stop_wd() {
      if [ "${MODE}" = "Dryrun" ]; then
        echo "[DRYRUN] Would run: rmmod softdog"
      else
        while [[ $(lsof "${WD}" 2>/dev/null | tail -n +2 | wc -l) -ge 1 ]]; do
          fuser "${WD}" -k -TERM
          sleep 1
        done
        rmmod softdog
      fi
    }


    case "$1" in
        start)
            start_wd
            ;;
        stop)
            stop_wd
            ;;
        *)
            echo "Usage: $0 [start|stop]"
            exit 1
            ;;
    esac
    EOF

    chmod +x /opt/deckhouse/bin/nodegroup-watchdog.sh
  {{- end }}
{{- end }}
