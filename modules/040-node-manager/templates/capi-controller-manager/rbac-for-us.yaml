{{- if include "capi_controller_manager_enabled" . }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  {{- include "helm_lib_module_labels" (list . (dict "app" "capi-controller-manager")) | nindent 2 }}
  name: capi-controller-manager
  namespace: d8-cloud-instance-manager
automountServiceAccountToken: false
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  {{- include "helm_lib_module_labels" (list . (dict "app" "capi-controller-manager")) | nindent 2 }}
  name: capi-controller-manager:leader-election-role
  namespace: d8-cloud-instance-manager
rules:
  - apiGroups:
      - ""
    resources:
      - events
    verbs:
      - create
  - apiGroups:
      - coordination.k8s.io
    resources:
      - leases
    verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  {{- include "helm_lib_module_labels" (list . (dict "app" "capi-controller-manager")) | nindent 2 }}
  name: d8:node-manager:capi-controller-manager:aggregated-manager-role
rules: []
aggregationRule:
  clusterRoleSelectors:
    - matchLabels:
        cluster.x-k8s.io/aggregate-to-manager: "true"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  {{- include "helm_lib_module_labels" (list . (dict "app" "capi-controller-manager")) | nindent 2 }}
  name: d8:node-manager:capi-controller-manager:manager-role
rules:
  ## cluster-api/config/rbac/role.yaml
  - apiGroups:
    - ""
    resources:
    - configmaps
    verbs:
    - get
    - list
    - patch
    - update
    - watch
  - apiGroups:
    - ""
    resources:
    - events
    verbs:
    - create
    - patch
  - apiGroups:
    - ""
    resources:
    - namespaces
    verbs:
    - get
    - list
    - watch
  - apiGroups:
    - ""
    resources:
    - secrets
    verbs:
    - create
    - delete
    - get
    - list
    - patch
    - update
    - watch
  - apiGroups:
    - addons.cluster.x-k8s.io
    resources:
    - clusterresourcesets/finalizers
    - clusterresourcesets/status
    verbs:
    - get
    - patch
    - update
  - apiGroups:
    - apiextensions.k8s.io
    resources:
    - customresourcedefinitions
    verbs:
    - get
    - list
    - watch
  - apiGroups:
    - apiextensions.k8s.io
    resourceNames:
    - clusterclasses.cluster.x-k8s.io
    - clusterresourcesetbindings.addons.cluster.x-k8s.io
    - clusterresourcesets.addons.cluster.x-k8s.io
    - clusters.cluster.x-k8s.io
    - extensionconfigs.runtime.cluster.x-k8s.io
    - ipaddressclaims.ipam.cluster.x-k8s.io
    - ipaddresses.ipam.cluster.x-k8s.io
    - machinedeployments.cluster.x-k8s.io
    - machinedrainrules.cluster.x-k8s.io
    - machinehealthchecks.cluster.x-k8s.io
    - machinepools.cluster.x-k8s.io
    - machines.cluster.x-k8s.io
    - machinesets.cluster.x-k8s.io
    resources:
    - customresourcedefinitions
    - customresourcedefinitions/status
    verbs:
    - patch
    - update
  - apiGroups:
    - authentication.k8s.io
    resources:
    - tokenreviews
    verbs:
    - create
  - apiGroups:
    - authorization.k8s.io
    resources:
    - subjectaccessreviews
    verbs:
    - create
  - apiGroups:
    - cluster.x-k8s.io
    resources:
    - clusterclasses
    - clusterclasses/status
    - clusters
    - clusters/finalizers
    - clusters/status
    - machinedrainrules
    - machinehealthchecks/finalizers
    - machinehealthchecks/status
    verbs:
    - get
    - list
    - patch
    - update
    - watch
  - apiGroups:
    - cluster.x-k8s.io
    resources:
    - machinedeployments
    - machinedeployments/finalizers
    - machinedeployments/status
    - machinehealthchecks
    - machinepools
    - machinepools/finalizers
    - machinepools/status
    - machines
    - machines/finalizers
    - machines/status
    - machinesets
    - machinesets/finalizers
    - machinesets/status
    verbs:
    - create
    - delete
    - get
    - list
    - patch
    - update
    - watch
  - apiGroups:
    - ipam.cluster.x-k8s.io
    resources:
    - ipaddressclaims
    - ipaddresses
    verbs:
    - get
    - list
    - patch
    - update
    - watch
  - apiGroups:
    - ipam.cluster.x-k8s.io
    resources:
    - ipaddressclaims/status
    verbs:
    - patch
    - update
  - apiGroups:
    - runtime.cluster.x-k8s.io
    resources:
    - extensionconfigs
    - extensionconfigs/status
    verbs:
    - get
    - list
    - patch
    - update
    - watch
  ## cluster-api/config/rbac/leader_election_role.yaml
  - apiGroups:
    - ""
    resources:
    - events
    verbs:
    - create
  - apiGroups:
    - "coordination.k8s.io"
    resources:
    - leases
    verbs:
    - get
    - list
    - watch
    - create
    - update
    - patch
    - delete
  ## storage
  - apiGroups:
      - "storage.k8s.io"
    resources:
      - volumeattachments
    verbs:
      - get
      - list
      - watch
  ## custom
  - apiGroups:
    - bootstrap.cluster.x-k8s.io
    - controlplane.cluster.x-k8s.io
    - infrastructure.cluster.x-k8s.io
    resources:
    - kubeadmconfigs
    - kubeadmconfigtemplates
    - kubeadmcontrolplanes
    - kubeadmcontrolplanetemplates
    - deckhousecontrolplanes
    - staticclusters
    - staticmachines
    - staticmachinetemplates
    - vcdclusters
    - vcdclustertemplates
    - vcdmachines
    - vcdmachinetemplates
    - zvirtclusters
    - zvirtmachines
    - zvirtmachinetemplates
    - dynamixclusters
    - dynamixmachines
    - dynamixmachinetemplates
    - huaweicloudclusters
    - huaweicloudmachines
    - huaweicloudmachinetemplates
    - deckhouseclusters
    - deckhousemachines
    - deckhousemachinetemplates
    verbs:
    - create
    - delete
    - get
    - list
    - patch
    - update
    - watch
  ## cluster access
  - apiGroups:
      - ""
    resources:
      - nodes
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch
  - apiGroups:
      - ""
    resources:
      - pods
    verbs:
      - delete
      - get
      - list
      - patch
      - update
      - watch
  - apiGroups:
      - ""
    resources:
      - pods/eviction
    verbs:
      - create
  - apiGroups:
      - apps
    resources:
      - daemonsets
    verbs:
      - get
  - nonResourceURLs:
    - /
    verbs:
    - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
    {{- include "helm_lib_module_labels" (list . (dict "app" "capi-controller-manager")) | nindent 2 }}
  name: capi-controller-manager:leader-election-rolebinding
  namespace: d8-cloud-instance-manager
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: capi-controller-manager:leader-election-role
subjects:
  - kind: ServiceAccount
    name: capi-controller-manager
    namespace: d8-cloud-instance-manager
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  {{- include "helm_lib_module_labels" (list . (dict "app" "capi-controller-manager")) | nindent 2 }}
  name: d8:node-manager:capi-controller-manager:aggregated-manager-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: d8:node-manager:capi-controller-manager:aggregated-manager-role
subjects:
  - kind: ServiceAccount
    name: capi-controller-manager
    namespace: d8-cloud-instance-manager
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  {{- include "helm_lib_module_labels" (list . (dict "app" "capi-controller-manager")) | nindent 2 }}
  name: d8:node-manager:capi-controller-manager:manager-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: d8:node-manager:capi-controller-manager:manager-role
subjects:
  - kind: ServiceAccount
    name: capi-controller-manager
    namespace: d8-cloud-instance-manager
  - kind: User
    name: capi-controller-manager
{{- end }}
