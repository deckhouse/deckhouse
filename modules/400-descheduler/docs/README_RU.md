---
title: "Модуль descheduler"
description: "Descheduler в Deckhouse Kubernetes Platform"
---

Модуль запускает в кластере [descheduler](https://github.com/kubernetes-sigs/descheduler) с набором [стратегий](#strategies), заданных в Custom Resources.

Модуль каждые 15 минут вытесняет поды, которые удовлетворяют включенным в Custom Resources стратегиям. Это приводит к принудительному запуску процесса шедулинга в отношении вытесненных подов.

## Особенности работы descheduler

* Descheduler не учитывает поды в пространствах имен `d8-*` и `kube-system`;
* Поды с включенным локальным хранилищем никогда не вытесняются;
* Поды, связанные с DaemonSet, никогда не вытесняются;
* Поды с установленным [priorityClassName](../001-priority-class/) значением `system-cluster-critical` или `system-node-critical` (*критические* поды) никогда не вытесняются;
* Descheduler учитывает класс приоритета при вытеснении подов с узла с высокой загрузкой (см. модуль [priority-class](../001-priority-class/));
* Поды с классом приоритета **Best effort** вытесняются раньше, чем поды с классами **Burstable** и **Guaranteed**;
* Descheduler учитывает [Pod Disruption Budget (PDB)](https://kubernetes.io/docs/concepts/workloads/pods/disruptions/): под не будет вытесняться, если descheduling нарушает PDB;
* Descheduler учитывает совместимость с узлом (node fitting). Если нет доступных узлов для запуска вытесненного пода, под не будет вытеснен.

Для ограничения подов по меткам используется параметр `podLabelSelector`. Параметр имеет такой же синтаксис, как и `labelSelector` в Kubernetes.

Для ограничения подов по пространствам имен используется параметр `namespaceLabelSelector`. Параметр имеет такой же синтаксис, как и `labelSelector` в Kubernetes.

Для настройки списка узлов, соответствующих условиям размещения, используется параметр `nodeLabelSelector`.
Параметр имеет такой же синтаксис, как и `labelSelector` в Kubernetes.

## Стратегии

### HighNodeUtilization

Эта стратегия находит недоиспользуемые узлы и высвобождает поды с этих узлов в надежде, что эти поды будут компактно размещены на меньшем количестве узлов. Используемая совместно с авто-масштабированием узлов, эта стратегия предназначена для помощи в уменьшении масштаба недоиспользуемых узлов. Она должна использоваться с стратегией оценки планировщика `MostAllocated`.

Недоиспользование узлов определяется с помощью настраиваемого порогового значения, называемого `thresholds`. Значения можно настроить для CPU, памяти, количества подов и расширенных ресурсов в процентах. Процент рассчитывается как соотношение текущих запрашиваемых ресурсов на узле к общему количеству доступных для выделения ресурсов. Для подов это означает количество подов на узле как долю от емкости подов, установленной для этого узла.

Если использование узла ниже порогового значения по всем параметрам (CPU, память, количество подов и расширенные ресурсы), узел считается недоиспользуемым. В настоящее время для вычисления использования ресурсов узла учитываются запрашиваемые ресурсы подов. Любой узел, использование которого выше порогового значения, считается правильно использованным и не подлежит вытеснению.

* Параметр `thresholds` можно настроить в соответствии с требованиями вашего кластера.
* Эта стратегия вытесняет поды с недоиспользуемых узлов (с использованием ниже порогового значения), чтобы они могли быть пересозданы на правильно использованных узлах.
* Стратегия будет прервана, если количество недоиспользуемых или правильно использованных узлов равно нулю.

> **Внимание.** Потребление ресурсов узла определяется запросами и лимитами подов, а не фактическим использованием. Этот подход выбран для поддержания согласованности с kube-scheduler, который использует ту же концепцию для размещения подов на узлах. Это означает, что использование ресурсов, отображаемое Kubelet (или командами вроде `kubectl top`), может отличаться от рассчитанного потребления, поскольку эти компоненты показывают фактические метрики использования.

### LowNodeUtilization

Эта стратегия находит узлы с перегрузкой и вытесняет поды с этих узлов предполагая, что пересоздание этих подов будет запланировано на недоиспользуемых узлах.

Перегрузка узлов определяется с помощью настраиваемого порогового значения, называемого `thresholds`. Значения можно настроить для CPU, памяти, количества подов и расширенных ресурсов в процентах. Процент рассчитывается как соотношение текущих запрашиваемых ресурсов на узле к общему количеству доступных для выделения ресурсов. Для подов это означает количество подов на узле как долю от ёмкости подов, установленной для этого узла.

Если использование узла выше порога по любому из параметров (CPU, память, количество подов или расширенные ресурсы), узел считается перегруженным. Узлы с использованием значений `thresholds` и `targetThresholds` считаются правильно использованными и не подлежат вытеснению.

* Параметр `thresholds` можно настроить в соответствии с требованиями вашего кластера.
* Существуют также параметры `targetThresholds`, которые используются для вычисления узлов, с которых поды могут быть вытеснены.
* Эта стратегия вытесняет поды с перегруженных узлов (с использованием порогового значения ниже `targetThresholds`) на недоиспользуемые узлы (с использованием порогового значения ниже`thresholds`).
* Стратегия будет прервана, если количество перегруженных или недоиспользуемых узлов равно нулю.

> **Внимание.** Потребление ресурсов узла определяется запросами и ограничениями подов, а не фактическим использованием. Этот подход выбран для поддержания согласованности с kube-scheduler, который использует тот же подход для планирования подов на узлы. Это означает, что использование ресурсов, отображаемое Kubelet (или командами вроде `kubectl top`), может отличаться от рассчитанного потребления, поскольку эти компоненты отображают фактические метрики использования.
