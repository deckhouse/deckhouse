{{- range $d := .Values.descheduler.internal.deschedulers }}
  {{- $deschedulerSpec := $d.spec }}
  {{- $commonParameters := $deschedulerSpec.commonParameters }}
  {{- $strategies := $deschedulerSpec.strategies }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: descheduler-policy-{{ $d.metadata.name }}
  namespace: d8-descheduler
  {{- include "helm_lib_module_labels" (list .) | nindent 2 }}
data:
  policy.yaml: |
    apiVersion: "descheduler/v1alpha1"
    kind: "DeschedulerPolicy"
    {{- if $strategies }}
    {{- $strategies | toYaml | nindent 4 }}
    {{- end }}
    strategies:
  {{- if hasKey $strategies "removeDuplicates" }}
      "RemoveDuplicates":
        enabled: true
    {{- if $strategies.removeDuplicates  }}
        params:
          {{- $strategies.removeDuplicates | toYaml | nindent 10 }}
    {{- end }}
  {{- else }}
      "RemoveDuplicates":
        enabled: false
  {{- end }}

  {{- if hasKey $strategies "removePodsViolatingNodeAffinity" }}
      "RemovePodsViolatingNodeAffinity":
        enabled: true
    {{- if $strategies.removePodsViolatingNodeAffinity  }}
        params:
          {{- $strategies.removePodsViolatingNodeAffinity | toYaml | nindent 10 }}
    {{- end }}
  {{- else }}
      "RemovePodsViolatingNodeAffinity":
        enabled: false
  {{- end }}

  {{- if hasKey $strategies "removePodsViolatingInterPodAntiAffinity" }}
      "RemovePodsViolatingInterPodAntiAffinity":
        enabled: true
    {{- if $strategies.removePodsViolatingInterPodAntiAffinity  }}
        params:
          {{- $strategies.removePodsViolatingInterPodAntiAffinity | toYaml | nindent 10 }}
    {{- end }}
  {{- else }}
      "RemovePodsViolatingInterPodAntiAffinity":
        enabled: false
  {{- end }}


  {{- if hasKey $strategies "lowNodeUtilization" }}
      "LowNodeUtilization":
        enabled: true
    {{- if $strategies.lowNodeUtilization  }}
        params:
          {{- $strategies.lowNodeUtilization | toYaml | nindent 10 }}
    {{- end }}
  {{- else }}
      "LowNodeUtilization":
        enabled: false
  {{- end }}

  {{- if hasKey $strategies "highNodeUtilization" }}
      "HighNodeUtilization":
        enabled: true
    {{- if $strategies.highNodeUtilization  }}
        params:
          {{- $strategies.highNodeUtilization | toYaml | nindent 10 }}
    {{- end }}
  {{- else }}
      "HighNodeUtilization":
        enabled: false
  {{- end }}

  {{- if hasKey $strategies "removePodsViolatingNodeTaints" }}
      "RemovePodsViolatingNodeTaints":
        enabled: true
    {{- if $strategies.removePodsViolatingNodeTaints  }}
        params:
          {{- $strategies.removePodsViolatingNodeTaints | toYaml | nindent 10 }}
    {{- end }}
  {{- else }}
      "RemovePodsViolatingNodeTaints":
        enabled: false
  {{- end }}

  {{- if hasKey $strategies "removePodsViolatingTopologySpreadConstraint" }}
      "RemovePodsViolatingTopologySpreadConstraint":
        enabled: true
    {{- if $strategies.removePodsViolatingTopologySpreadConstraint  }}
        params:
          {{- $strategies.removePodsViolatingTopologySpreadConstraint | toYaml | nindent 10 }}
    {{- end }}
  {{- else }}
      "RemovePodsViolatingTopologySpreadConstraint":
        enabled: false
  {{- end }}

  {{- if hasKey $strategies "removePodsHavingTooManyRestarts" }}
      "RemovePodsHavingTooManyRestarts":
        enabled: true
    {{- if $strategies.removePodsHavingTooManyRestarts  }}
        params:
          {{- $strategies.removePodsHavingTooManyRestarts | toYaml | nindent 10 }}
    {{- end }}
  {{- else }}
      "RemovePodsHavingTooManyRestarts":
        enabled: false
  {{- end }}

  {{- if hasKey $strategies "podLifeTime" }}
      "PodLifeTime":
        enabled: true
    {{- if $strategies.podLifeTime  }}
        params:
          {{- $strategies.podLifeTime | toYaml | nindent 10 }}
    {{- end }}
  {{- else }}
      "PodLifeTime":
        enabled: false
  {{- end }}
{{- end }}
