{{- if len .Values.descheduler.internal.deschedulers }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: descheduler-policy
  namespace: d8-descheduler
  {{- include "helm_lib_module_labels" (list $) | nindent 2 }}
data:
  policy.yaml: |
    apiVersion: "descheduler/v1alpha2"
    kind: "DeschedulerPolicy"
    nodeSelector: "! node-role.kubernetes.io/control-plane, ! node-role.deckhouse.io/system"
    profiles:
    {{- range $d := .Values.descheduler.internal.deschedulers }}
    - name: {{ $d.name }}
      pluginConfig:
      - name: "DefaultEvictor"
        args:
          {{- if $d.nodeSelector }}
          nodeSelector: {{ $d.nodeSelector }}
          {{- end }}
          evictLocalStoragePods: false
          evictSystemCriticalPods: false
          ignorePvcPods: false
          evictFailedBarePods: true
          nodeFit: true
          {{- if $d.labelSelector }}
          labelSelector:
            {{- $d.labelSelector | toYaml | nindent 12 }}
          {{- end }}
          {{- if $d.priorityThreshold }}
          priorityThreshold:
            {{- $d.priorityThreshold | toYaml | nindent 12 }}
          {{- end }}
      {{- if dig "strategies" "lowNodeUtilization" $d }}
      - name: "LowNodeUtilization"
        args:
          {{- $d.strategies.lowNodeUtilization | toYaml | nindent 10 }}
      {{- end }}
      {{- if dig "strategies" "highNodeUtilization" $d }}
      - name: "HighNodeUtilization"
        args:
          {{- $d.strategies.highNodeUtilization | toYaml | nindent 10 }}
      {{- end }}
      plugins:
        # DefaultEvictor is enabled for both `filter` and `preEvictionFilter`
        filter:
          enabled:
          - "DefaultEvictor"
        preEvictionFilter:
          enabled:
          - "DefaultEvictor"
        {{- if $d.strategies }}
        balance:
          enabled:
          {{- if dig "strategies" "highNodeUtilization" $d }}
          - name: "HighNodeUtilization"
          {{- end }}
          {{- if dig "strategies" "lowNodeUtilization" $d }}
          - name: "LowNodeUtilization"
          {{- end }}
        {{- end }}
    {{- end }}
{{- end }}
