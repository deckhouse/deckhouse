{{- range $d := .Values.descheduler.internal.deschedulers }}
  {{- $deschedulerSpec := $d.spec }}
  {{- $commonParameters := $deschedulerSpec.deschedulerPolicy.parameters }}
  {{- $strategies := $deschedulerSpec.deschedulerPolicy.strategies }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: descheduler-policy-{{ $d.metadata.name }}
  namespace: d8-descheduler
  {{- include "helm_lib_module_labels" (list $) | nindent 2 }}
data:
  policy.yaml: |
    apiVersion: "descheduler/v1alpha1"
    kind: "DeschedulerPolicy"
  {{- $commonParameters | toYaml | nindent 4 }}
    strategies:
  {{- if hasKey $strategies "removeDuplicates" }}
      "RemoveDuplicates":
        enabled: true
    {{- if $strategies.removeDuplicates.params }}
        params:
          {{- $strategies.removeDuplicates.params | toYaml | nindent 10 }}
    {{- end }}
  {{- else }}
      "RemoveDuplicates":
        enabled: false
  {{- end }}

  {{- if hasKey $strategies "removePodsViolatingNodeAffinity" }}
      "RemovePodsViolatingNodeAffinity":
        enabled: true
    {{- if $strategies.removePodsViolatingNodeAffinity.params  }}
        params:
          {{- $strategies.removePodsViolatingNodeAffinity.params | toYaml | nindent 10 }}
    {{- end }}
  {{- else }}
      "RemovePodsViolatingNodeAffinity":
        enabled: false
  {{- end }}

  {{- if hasKey $strategies "removePodsViolatingInterPodAntiAffinity" }}
      "RemovePodsViolatingInterPodAntiAffinity":
        enabled: true
    {{- if $strategies.removePodsViolatingInterPodAntiAffinity.params  }}
        params:
          {{- $strategies.removePodsViolatingInterPodAntiAffinity.params | toYaml | nindent 10 }}
    {{- end }}
  {{- else }}
      "RemovePodsViolatingInterPodAntiAffinity":
        enabled: false
  {{- end }}


  {{- if hasKey $strategies "lowNodeUtilization" }}
      "LowNodeUtilization":
        enabled: true
    {{- if $strategies.lowNodeUtilization.params  }}
        params:
          {{- $strategies.lowNodeUtilization.params | toYaml | nindent 10 }}
    {{- end }}
  {{- else }}
      "LowNodeUtilization":
        enabled: false
  {{- end }}

  {{- if hasKey $strategies "highNodeUtilization" }}
      "HighNodeUtilization":
        enabled: true
    {{- if $strategies.highNodeUtilization.params  }}
        params:
          {{- $strategies.highNodeUtilization.params | toYaml | nindent 10 }}
    {{- end }}
  {{- else }}
      "HighNodeUtilization":
        enabled: false
  {{- end }}

  {{- if hasKey $strategies "removePodsViolatingNodeTaints" }}
      "RemovePodsViolatingNodeTaints":
        enabled: true
    {{- if $strategies.removePodsViolatingNodeTaints.params  }}
        params:
          {{- $strategies.removePodsViolatingNodeTaints.params | toYaml | nindent 10 }}
    {{- end }}
  {{- else }}
      "RemovePodsViolatingNodeTaints":
        enabled: false
  {{- end }}

  {{- if hasKey $strategies "removePodsViolatingTopologySpreadConstraint" }}
      "RemovePodsViolatingTopologySpreadConstraint":
        enabled: true
    {{- if $strategies.removePodsViolatingTopologySpreadConstraint.params  }}
        params:
          {{- $strategies.removePodsViolatingTopologySpreadConstraint.params | toYaml | nindent 10 }}
    {{- end }}
  {{- else }}
      "RemovePodsViolatingTopologySpreadConstraint":
        enabled: false
  {{- end }}

  {{- if hasKey $strategies "removePodsHavingTooManyRestarts" }}
      "RemovePodsHavingTooManyRestarts":
        enabled: true
    {{- if $strategies.removePodsHavingTooManyRestarts.params  }}
        params:
          {{- $strategies.removePodsHavingTooManyRestarts.params | toYaml | nindent 10 }}
    {{- end }}
  {{- else }}
      "RemovePodsHavingTooManyRestarts":
        enabled: false
  {{- end }}

  {{- if hasKey $strategies "podLifeTime" }}
      "PodLifeTime":
        enabled: true
    {{- if $strategies.podLifeTime.params  }}
        params:
          {{- $strategies.podLifeTime.params | toYaml | nindent 10 }}
    {{- end }}
  {{- else }}
      "PodLifeTime":
        enabled: false
  {{- end }}
{{- end }}
