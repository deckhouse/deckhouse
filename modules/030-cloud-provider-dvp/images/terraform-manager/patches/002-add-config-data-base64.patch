Subject: [PATCH] add argument config_data_base64
---
Index: manifest/provider/configure.go
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/manifest/provider/configure.go b/manifest/provider/configure.go
--- a/manifest/provider/configure.go	(revision be88f44271050f69d52f410bca388834afedfe71)
+++ b/manifest/provider/configure.go	(date 1772208909371)
@@ -14,6 +14,8 @@
 	"strconv"
 	"strings"

+	"github.com/hashicorp/terraform-provider-kubernetes/util"
+
 	"github.com/hashicorp/terraform-plugin-go/tfprotov5"
 	"github.com/hashicorp/terraform-plugin-go/tftypes"
 	"github.com/mitchellh/go-homedir"
@@ -68,7 +70,7 @@
 	}

 	overrides := &clientcmd.ConfigOverrides{}
-	loader := &clientcmd.ClientConfigLoadingRules{}
+	fileLoader := &clientcmd.ClientConfigLoadingRules{}

 	// Handle 'config_path' attribute
 	//
@@ -101,8 +103,30 @@
 				Detail:   fmt.Sprintf("'config_path' refers to an invalid path: %q: %v", configPathAbs, err),
 			})
 		}
-		loader.ExplicitPath = configPathAbs
+		fileLoader.ExplicitPath = configPathAbs
 	}
+	// Handle 'config_data_base64' attribute
+	//
+	var configDataBase64 string
+
+	if !providerConfig["config_data_base64"].IsNull() && providerConfig["config_data_base64"].IsKnown() {
+
+		err = providerConfig["config_data_base64"].As(&configDataBase64)
+		if err != nil {
+			// invalid attribute - this shouldn't happen, bail out now
+			response.Diagnostics = append(response.Diagnostics, &tfprotov5.Diagnostic{
+				Severity: tfprotov5.DiagnosticSeverityError,
+				Summary:  "Provider configuration: failed to extract 'config_data_base64' value",
+				Detail:   err.Error(),
+			})
+			return response, nil
+		}
+	}
+	// check environment - this overrides any value found in provider configuration
+	if configBase64Env, ok := os.LookupEnv("KUBE_CONFIG_DATA_BASE64"); ok && configBase64Env != "" {
+		configDataBase64 = configBase64Env
+	}
+
 	// Handle 'config_paths' attribute
 	//
 	var precedence []string
@@ -143,7 +167,7 @@
 			}
 			precedence[i] = absPath
 		}
-		loader.Precedence = precedence
+		fileLoader.Precedence = precedence
 	}

 	// Handle 'client_certificate' attribute
@@ -589,7 +613,7 @@
 			overrides.AuthInfo.Exec = &execCfg
 		}
 	}
-
+	loader := util.NewConfigLoader(fileLoader, configDataBase64)
 	cc := clientcmd.NewNonInteractiveDeferredLoadingClientConfig(loader, overrides)
 	clientConfig, err := cc.ClientConfig()
 	if err != nil {
Index: kubernetes/provider.go
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/kubernetes/provider.go b/kubernetes/provider.go
--- a/kubernetes/provider.go	(revision be88f44271050f69d52f410bca388834afedfe71)
+++ b/kubernetes/provider.go	(date 1772209214006)
@@ -11,8 +11,14 @@
 	"net/http"
 	"os"
 	"path/filepath"
+	"reflect"
 	"strconv"

+	"github.com/hashicorp/terraform-provider-kubernetes/util"
+	"k8s.io/apimachinery/pkg/api/meta"
+	"k8s.io/client-go/discovery/cached/memory"
+	"k8s.io/client-go/restmapper"
+
 	"github.com/hashicorp/go-cty/cty"
 	gversion "github.com/hashicorp/go-version"
 	"github.com/mitchellh/go-homedir"
@@ -21,7 +27,6 @@
 	"github.com/hashicorp/terraform-plugin-sdk/v2/helper/logging"
 	"github.com/hashicorp/terraform-plugin-sdk/v2/helper/schema"
 	"github.com/hashicorp/terraform-plugin-sdk/v2/helper/validation"
-
 	"k8s.io/client-go/discovery"
 	"k8s.io/client-go/dynamic"
 	"k8s.io/client-go/kubernetes"
@@ -130,6 +135,13 @@
 				Description: "URL to the proxy to be used for all API requests",
 				DefaultFunc: schema.EnvDefaultFunc("KUBE_PROXY_URL", ""),
 			},
+			"config_data_base64": {
+				Type:          schema.TypeString,
+				Optional:      true,
+				Description:   "Kubeconfig content in base64 format",
+				DefaultFunc:   schema.EnvDefaultFunc("KUBE_CONFIG_DATA_BASE64", nil),
+				ConflictsWith: []string{"config_path", "config_paths"},
+			},
 			"exec": {
 				Type:     schema.TypeList,
 				Optional: true,
@@ -360,6 +372,9 @@

 			//node
 			"kubernetes_runtime_class_v1": resourceKubernetesRuntimeClassV1(),
+
+			// readiness
+			"kubernetes_resource_ready_v1": resourceKubernetesResourceReadyV1(),
 		},
 	}

@@ -380,6 +395,7 @@
 	AggregatorClientset() (*aggregator.Clientset, error)
 	DynamicClient() (dynamic.Interface, error)
 	DiscoveryClient() (discovery.DiscoveryInterface, error)
+	RESTMapper() (meta.RESTMapper, error)
 }

 type providerMetadata struct {
@@ -390,6 +406,7 @@
 	aggregatorClientset *aggregator.Clientset
 	dynamicClient       dynamic.Interface
 	discoveryClient     discovery.DiscoveryInterface
+	restMapper          meta.RESTMapper

 	IgnoreAnnotations []string
 	IgnoreLabels      []string
@@ -454,6 +471,22 @@
 	return k.discoveryClient, nil
 }

+func (k providerMetadata) RESTMapper() (meta.RESTMapper, error) {
+	if k.restMapper != nil && !reflect.ValueOf(k.restMapper).IsNil() {
+		return k.restMapper, nil
+	}
+
+	dc, err := k.DiscoveryClient()
+	if err != nil {
+		return nil, err
+	}
+
+	cacheClient := memory.NewMemCacheClient(dc)
+	k.restMapper = restmapper.NewDeferredDiscoveryRESTMapper(cacheClient)
+
+	return k.restMapper, nil
+}
+
 func providerConfigure(ctx context.Context, d *schema.ResourceData, terraformVersion string) (interface{}, diag.Diagnostics) {
 	// Config initialization
 	cfg, diags := initializeConfiguration(d)
@@ -500,9 +533,9 @@
 func initializeConfiguration(d *schema.ResourceData) (*restclient.Config, diag.Diagnostics) {
 	diags := make(diag.Diagnostics, 0)
 	overrides := &clientcmd.ConfigOverrides{}
-	loader := &clientcmd.ClientConfigLoadingRules{}
+	fileLoader := &clientcmd.ClientConfigLoadingRules{}

-	configPaths := []string{}
+	var configPaths []string

 	if v, ok := d.Get("config_path").(string); ok && v != "" {
 		configPaths = []string{v}
@@ -517,7 +550,7 @@
 	}

 	if len(configPaths) > 0 {
-		expandedPaths := []string{}
+		var expandedPaths []string
 		for _, p := range configPaths {
 			path, err := homedir.Expand(p)
 			if err != nil {
@@ -529,9 +562,9 @@
 		}

 		if len(expandedPaths) == 1 {
-			loader.ExplicitPath = expandedPaths[0]
+			fileLoader.ExplicitPath = expandedPaths[0]
 		} else {
-			loader.Precedence = expandedPaths
+			fileLoader.Precedence = expandedPaths
 		}

 		ctxSuffix := "; default context"
@@ -631,7 +664,14 @@
 		overrides.ClusterDefaults.ProxyURL = v.(string)
 	}

+	var configDataBase64 string
+	if v, ok := d.GetOk("config_data_base64"); ok {
+		configDataBase64 = v.(string)
+	}
+
+	loader := util.NewConfigLoader(fileLoader, configDataBase64)
 	cc := clientcmd.NewNonInteractiveDeferredLoadingClientConfig(loader, overrides)
+
 	cfg, err := cc.ClientConfig()
 	if err != nil {
 		nd := diag.Diagnostic{
Index: manifest/provider/provider_config.go
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/manifest/provider/provider_config.go b/manifest/provider/provider_config.go
--- a/manifest/provider/provider_config.go	(revision be88f44271050f69d52f410bca388834afedfe71)
+++ b/manifest/provider/provider_config.go	(date 1772208810025)
@@ -179,6 +179,17 @@
 				Deprecated:      false,
 			},
 			{
+				Name:            "config_data_base64",
+				Type:            tftypes.String,
+				Description:     "Kubeconfig content in base64 format",
+				Required:        false,
+				Optional:        true,
+				Computed:        false,
+				Sensitive:       false,
+				DescriptionKind: 0,
+				Deprecated:      false,
+			},
+			{
 				Name:            "ignore_annotations",
 				Type:            tftypes.List{ElementType: tftypes.String},
 				Description:     "List of Kubernetes metadata annotations to ignore across all resources handled by this provider for situations where external systems are managing certain resource annotations. Each item is a regular expression.",
Index: kubernetes/provider_test.go
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/kubernetes/provider_test.go b/kubernetes/provider_test.go
--- a/kubernetes/provider_test.go	(revision be88f44271050f69d52f410bca388834afedfe71)
+++ b/kubernetes/provider_test.go	(date 1772209356771)
@@ -5,6 +5,7 @@

 import (
 	"context"
+	"encoding/base64"
 	"errors"
 	"fmt"
 	"net/url"
@@ -106,6 +107,24 @@
 	}
 }

+func TestProvider_configure_config_data_base64(t *testing.T) {
+	ctx := context.TODO()
+	resetEnv := unsetEnv(t)
+	defer resetEnv()
+	data, err := os.ReadFile("test-fixtures/kube-config-sa-token.yaml")
+	if err != nil {
+		t.Fatal("Cannot read kubeconfig")
+	}
+	data64 := base64.StdEncoding.EncodeToString(data)
+	os.Setenv("KUBE_CONFIG_DATA_BASE64", data64)
+	rc := terraform.NewResourceConfigRaw(map[string]interface{}{})
+	p := Provider()
+	diags := p.Configure(ctx, rc)
+	if diags.HasError() {
+		t.Fatal(diags)
+	}
+}
+
 func unsetEnv(t *testing.T) func() {
 	e := getEnv()

@@ -124,6 +143,7 @@
 		"KUBE_INSECURE":             e.Insecure,
 		"KUBE_TLS_SERVER_NAME":      e.TLSServerName,
 		"KUBE_TOKEN":                e.Token,
+		"KUBE_CONFIG_DATA_BASE64":   e.ConfigDataBase64,
 	}

 	for k := range envVars {
@@ -162,11 +182,15 @@
 	if v := os.Getenv("KUBE_CONFIG_PATH"); v != "" {
 		e.ConfigPaths = filepath.SplitList(v)
 	}
+	if v := os.Getenv("KUBE_CONFIG_DATA_BASE64"); v != "" {
+		e.ConfigDataBase64 = v
+	}
 	return e
 }

 func testAccPreCheck(t *testing.T) {
 	ctx := context.TODO()
+	base64KubeConfig := getBase64KubeConfig()
 	hasFileCfg := (os.Getenv("KUBE_CTX_AUTH_INFO") != "" && os.Getenv("KUBE_CTX_CLUSTER") != "") ||
 		os.Getenv("KUBE_CTX") != "" ||
 		os.Getenv("KUBE_CONFIG_PATH") != ""
@@ -176,7 +200,7 @@
 		os.Getenv("KUBE_CLUSTER_CA_CERT_DATA") != "") &&
 		(hasUserCredentials || hasClientCert || os.Getenv("KUBE_TOKEN") != "")

-	if !hasFileCfg && !hasStaticCfg && !hasUserCredentials {
+	if base64KubeConfig == "" && !hasFileCfg && !hasStaticCfg && !hasUserCredentials {
 		t.Fatalf("File config (KUBE_CTX_AUTH_INFO and KUBE_CTX_CLUSTER) or static configuration"+
 			"(%s) or (%s) must be set for acceptance tests",
 			strings.Join([]string{
@@ -194,7 +218,15 @@
 		)
 	}

-	diags := testAccProvider.Configure(ctx, terraform.NewResourceConfigRaw(nil))
+	var data map[string]any
+
+	if base64KubeConfig != "" {
+		data = map[string]any{
+			"config_data_base64": base64KubeConfig,
+		}
+	}
+
+	diags := testAccProvider.Configure(ctx, terraform.NewResourceConfigRaw(data))
 	if diags.HasError() {
 		t.Fatal(diags[0].Summary)
 	}
@@ -485,6 +517,7 @@

 type currentEnv struct {
 	ConfigPath        string
+	ConfigDataBase64  string
 	ConfigPaths       []string
 	Ctx               string
 	CtxAuthInfo       string
@@ -499,3 +532,7 @@
 	TLSServerName     string
 	Token             string
 }
+
+func getBase64KubeConfig() string {
+	return os.Getenv("KUBE_CONFIG_DATA_BASE64")
+}
Index: internal/framework/provider/provider.go
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/internal/framework/provider/provider.go b/internal/framework/provider/provider.go
--- a/internal/framework/provider/provider.go	(revision be88f44271050f69d52f410bca388834afedfe71)
+++ b/internal/framework/provider/provider.go	(date 1772208809900)
@@ -59,6 +59,8 @@

 	ProxyURL types.String `tfsdk:"proxy_url"`

+	ConfigDataBase64 types.String `tfsdk:"config_data_base64"`
+
 	IgnoreAnnotations types.List `tfsdk:"ignore_annotations"`
 	IgnoreLabels      types.List `tfsdk:"ignore_labels"`

@@ -142,6 +144,10 @@
 			"proxy_url": schema.StringAttribute{
 				Description: "URL to the proxy to be used for all API requests",
 				Optional:    true,
+			},
+			"config_data_base64": schema.StringAttribute{
+				Description: "Kubeconfig content in base64 format",
+				Optional:    true,
 			},
 			"ignore_annotations": schema.ListAttribute{
 				ElementType: types.StringType,
Index: util/loader.go
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/util/loader.go b/util/loader.go
new file mode 100644
--- /dev/null	(date 1772208810040)
+++ b/util/loader.go	(date 1772208810040)
@@ -0,0 +1,38 @@
+package util
+
+import (
+	"encoding/base64"
+	"k8s.io/client-go/tools/clientcmd"
+	clientcmdapi "k8s.io/client-go/tools/clientcmd/api"
+)
+
+func NewConfigLoader(loader *clientcmd.ClientConfigLoadingRules, configBase64Data string) *ConfigLoader {
+	return &ConfigLoader{
+		ClientConfigLoadingRules: loader,
+		configBase64Data:         configBase64Data,
+	}
+}
+
+type ConfigLoader struct {
+	*clientcmd.ClientConfigLoadingRules
+	configBase64Data string
+}
+
+func (cl ConfigLoader) Load() (*clientcmdapi.Config, error) {
+	if cl.configBase64Data == "" {
+		return cl.ClientConfigLoadingRules.Load()
+	}
+	data, err := base64.StdEncoding.DecodeString(cl.configBase64Data)
+	if err != nil {
+		return nil, err
+	}
+	cc, err := clientcmd.NewClientConfigFromBytes(data)
+	if err != nil {
+		return nil, err
+	}
+	cfg, err := cc.RawConfig()
+	if err != nil {
+		return nil, err
+	}
+	return &cfg, nil
+}
Index: kubernetes/test-fixtures/kube-config-sa-token.yaml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/kubernetes/test-fixtures/kube-config-sa-token.yaml b/kubernetes/test-fixtures/kube-config-sa-token.yaml
new file mode 100644
--- /dev/null	(date 1772208809936)
+++ b/kubernetes/test-fixtures/kube-config-sa-token.yaml	(date 1772208809936)
@@ -0,0 +1,21 @@
+apiVersion: v1
+kind: Config
+preferences: {}
+clusters:
+  - cluster:
+      certificate-authority-data: ZHVtbXk=
+      server: https://127.0.0.1
+    name: dummy
+
+current-context: dummy
+
+contexts:
+  - context:
+      cluster: dummy
+      user: dummy
+    name: dummy
+
+users:
+  - name: dummy
+    user:
+      token: ZHVtbXk=
\ No newline at end of file
