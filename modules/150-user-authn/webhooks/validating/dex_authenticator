#!/usr/bin/env bash

# Copyright 2021 Flant JSC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

source /shell_lib.sh

function is_ipv4_address() {
  local ip="$1"

  [[ "$ip" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]] || return 1

  local IFS='.'
  local o1 o2 o3 o4
  read -r o1 o2 o3 o4 <<<"$ip"

  for o in "$o1" "$o2" "$o3" "$o4"; do
    [[ "$o" =~ ^[0-9]{1,3}$ ]] || return 1
    (( o >= 0 && o <= 255 )) || return 1
  done

  return 0
}

function is_ipv6_address() {
  local ip="$1"

  # DNS names must not contain ':'; presence of ':' strongly indicates IPv6 (or host:port),
  # both are invalid for Ingress host and therefore invalid for applicationDomain.
  [[ "$ip" == *:* ]] || return 1
  return 0
}

function __config__(){
  cat <<EOF
configVersion: v1
kubernetes:
  - name: dexauthenticators
    apiVersion: deckhouse.io/v1
    kind: DexAuthenticator
    queue: "dexauthenticators-list"
    group: main
    executeHookOnEvent: []
    executeHookOnSynchronization: false
    keepFullObjectsInMemory: false
    jqFilter: |
      {
        "name": .metadata.name,
        "namespace": .metadata.namespace,
        "applicationDomain": .spec.applicationDomain,
        "ingressClass": .spec.applicationIngressClassName,
        "additionalDomains": [
          .spec.additionalApplications[]? | [.domain, .ingressClassName]
        ]
      }
kubernetesValidating:
- name: dexauthenticators-unique.deckhouse.io
  group: main
  rules:
  - apiGroups:   ["deckhouse.io"]
    apiVersions: ["v1", "v1alpha1", "v2alpha1"]
    operations:  ["CREATE", "UPDATE"]
    resources:   ["dexauthenticators"]
    scope:       "Namespaced"
EOF
}

function __main__() {
  newAuthNamespace=$(context::jq -r '.review.request.object.metadata.namespace')
  newAuthName=$(context::jq -r '.review.request.object.metadata.name')
  apiVersion=$(context::jq -r '.review.request.object.apiVersion')
  

  domains_to_check=()
  
  if [[ "$apiVersion" == "deckhouse.io/v2alpha1" ]]; then

    while IFS=$'\t' read -r domain ingressClass fieldPath; do
      if [[ "$domain" != "null" && "$ingressClass" != "null" && "$fieldPath" != "null" ]]; then
        domains_to_check+=("$domain"$'\t'"$ingressClass"$'\t'"$fieldPath")
      fi
    done < <(context::jq -r '.review.request.object.spec.applications | to_entries[]? | "\(.value.domain)\t\(.value.ingressClassName)\t.spec.applications[\(.key)].domain"')
  else

    main_domain=$(context::jq -r '.review.request.object.spec.applicationDomain')
    main_ingress_class=$(context::jq -r '.review.request.object.spec.applicationIngressClassName')
    domains_to_check+=("$main_domain"$'\t'"$main_ingress_class"$'\t'".spec.applicationDomain")


    while IFS=$'\t' read -r domain ingressClass fieldPath; do
      if [[ "$domain" != "null" && "$ingressClass" != "null" && "$fieldPath" != "null" ]]; then
        domains_to_check+=("$domain"$'\t'"$ingressClass"$'\t'"$fieldPath")
      fi
    done < <(context::jq -r '.review.request.object.spec.additionalApplications | to_entries[]? | "\(.value.domain)\t\(.value.ingressClassName)\t.spec.additionalApplications[\(.key)].domain"')
  fi
  

  for domain_pair in "${domains_to_check[@]}"; do
    IFS=$'\t' read -r domain ingressClass fieldPath <<< "$domain_pair"

    if is_ipv4_address "$domain" || is_ipv6_address "$domain"; then
      msg="DexAuthenticator '$newAuthNamespace/$newAuthName' is invalid: '$fieldPath' must be a DNS name, not an IP address ('$domain')"
      jq -n --arg msg "$msg" '{allowed:false, message:$msg}' > "$VALIDATING_RESPONSE_PATH"
      return 0
    fi
    
    result=$(context::jq -r --arg domain "$domain" --arg class "$ingressClass" '
      .snapshots.dexauthenticators[].filterResult | 
      select(
        .applicationDomain == $domain and .ingressClass == $class or
        (.additionalDomains | arrays | any(.[0] == $domain and .[1] == $class))
      )
    ')
    
    if [ "$result" ]; then
      existingAuth=$(echo "$result" | jq -r '.namespace + "/" + .name')
      

      if [[ "$existingAuth" == "$newAuthNamespace/$newAuthName" ]]; then
        continue
      fi
      
      msg="Desired DexAuthenticator '$newAuthNamespace/$newAuthName' conflicts with the existing DexAuthenticator '$existingAuth' for domain '$domain'"
      jq -n --arg msg "$msg" '{allowed:false, message:$msg}' > "$VALIDATING_RESPONSE_PATH"
      return 0
    fi
  done
  
  jq -n '{allowed:true}' > "$VALIDATING_RESPONSE_PATH"
}

hook::run "$@"
