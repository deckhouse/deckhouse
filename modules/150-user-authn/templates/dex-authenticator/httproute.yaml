{{- if (.Values.global.enabledModules | has "alb-istio") }}
{{- $context := . }}
{{- $dexAuthenticatorNames := .Values.userAuthn.internal.dexAuthenticatorNames | default dict -}}
{{- range $crd := .Values.userAuthn.internal.dexAuthenticatorCRDs }}
  {{- if not .spec.applications }}
    {{- continue }}
  {{- end }}
  {{- range $idx, $app := $crd.spec.applications }}
  {{- $hashedDomain := sha256sum $app.domain | trunc 8 }}
  {{- $nameSuffix := "" }}
  {{- if ne $idx 0 }}
    {{- $nameSuffix = printf "-%s" $hashedDomain }}
  {{- end }}
  {{- $id := printf "%s@%s" $crd.name $crd.namespace }}
  {{- $info := index $dexAuthenticatorNames $id | default dict }}
  {{- $svcName := $info.name }}
  {{- $ingInfo := (index $info.ingressNames (printf "%d" $idx)) }}
  {{- $ingName := (default (printf "%s%s-dex-authenticator" $crd.name $nameSuffix) (index $ingInfo "name")) }}
  {{- $ingTruncated := (index $ingInfo "truncated") }}
  {{- $ingHash := (index $ingInfo "hash") }}
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  annotations:
    alb-istio.network.deckhouse.io/backend-tls-settings: '{"mode": "SIMPLE", "insecureSkipVerify": true}'
    alb-istio.network.deckhouse.io/tls-secrets: {{ $crd.namespace }}/{{ $app.ingressSecretName }}
    alb-istio.network.deckhouse.io/auto-create-xlistenerset: "true"
  name: {{ $ingName }}
  namespace: {{ $crd.namespace }}
  {{- $labels := dict "app" "dex-authenticator" "deckhouse.io/dex-authenticator-for" $crd.name }}
  {{- if $ingTruncated }}
  {{- $_ := set $labels "deckhouse.io/name-truncated" "true" }}
  {{- $_ := set $labels "deckhouse.io/name-hash" $ingHash }}
  {{- end }}
spec:
  hostnames:
  - {{ $app.domain }}
  parentRefs:
  - group: gateway.networking.x-k8s.io
    kind: XListenerSet
    name: d8-default-listener-set
    namespace: {{ $crd.namespace }}
    sectionName: {{ $crd.name }}
  rules:
  - backendRefs:
    - group: ""
      kind: Service
      name: {{ $svcName }}
      port: 443
      weight: 1
    matches:
    - path:
        type: PathPrefix
        value: /dex-authenticator
  {{- end }}
{{- end }}
{{- end }}
