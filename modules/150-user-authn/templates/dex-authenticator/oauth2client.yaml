{{- $context := . }}
{{- range $crd := $context.Values.userAuthn.internal.dexAuthenticatorCRDs }}
  {{- range $app := $crd.spec.applications }}
  {{- $hashedDomain := sha256sum $app.domain | trunc 8 }}
---
apiVersion: dex.coreos.com/v1
kind: OAuth2Client
metadata:
  name: {{ $crd.encodedName }}-{{ $hashedDomain }}
  namespace: d8-{{ $context.Chart.Name }}
  {{- include "helm_lib_module_labels" (list $context (dict "app" "dex")) | nindent 2 }}
id: {{ $crd.name }}-{{ $hashedDomain }}-{{ $crd.namespace }}-dex-authenticator
name: {{ $crd.name }}-{{ $hashedDomain }}-{{ $crd.namespace }}-dex-authenticator
secret: {{ $crd.credentials.appDexSecret }}
    {{- if $crd.spec.allowedGroups }}
allowedGroups:
{{- range $group := $crd.spec.allowedGroups }}
  - {{ $group }}
{{- end }}
    {{- end }}
redirectURIs:
- https://{{ $app.domain }}/dex-authenticator/callback
  {{- end }}
{{- end }}