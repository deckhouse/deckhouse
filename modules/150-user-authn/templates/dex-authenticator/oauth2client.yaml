{{- $context := . }}
{{- range $crd := $context.Values.userAuthn.internal.dexAuthenticatorCRDs }}
---
apiVersion: dex.coreos.com/v1
kind: OAuth2Client
metadata:
  name: {{ $crd.encodedName | quote }}
  namespace: d8-{{ $context.Chart.Name }}
  {{- include "helm_lib_module_labels" (list $context (dict "app" "dex")) | nindent 2 }}
id: {{ include "dex_authenticator_name_with_namespace" (list $context $crd.name $crd.namespace) }}
name: {{ include "dex_authenticator_name_with_namespace" (list $context $crd.name $crd.namespace) }}
secret: {{ $crd.credentials.appDexSecret }}
    {{- if $crd.spec.allowedEmails }}
allowedEmails:
{{- range $email := $crd.spec.allowedEmails }}
  - {{ $email }}
{{- end }}
    {{- end }}
    {{- if $crd.spec.allowedGroups }}
allowedGroups:
{{- range $group := $crd.spec.allowedGroups }}
  - {{ $group }}
{{- end }}
    {{- end }}
redirectURIs:
  {{- range $app := $crd.spec.applications }}
- https://{{ $app.domain }}/dex-authenticator/callback
{{- end }}
{{- end }}
