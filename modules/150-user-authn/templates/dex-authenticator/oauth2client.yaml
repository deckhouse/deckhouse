{{- $context := . }}
{{- range $crd := $context.Values.userAuthn.internal.dexAuthenticatorCRDs }}
---
apiVersion: dex.coreos.com/v1
kind: OAuth2Client
metadata:
  name: {{ $crd.encodedName }}
  namespace: d8-{{ $context.Chart.Name }}
  {{- include "helm_lib_module_labels" (list $context (dict "app" "dex")) | nindent 2 }}
id: {{ $crd.name }}-{{ $crd.namespace }}-dex-authenticator
name: {{ $crd.name }}-{{ $crd.namespace }}-dex-authenticator
secret: {{ $crd.credentials.appDexSecret }}
    {{- if $crd.spec.allowedGroups }}
allowedGroups:
{{- range $group := $crd.spec.allowedGroups }}
  - {{ $group }}
{{- end }}
    {{- end }}
redirectURIs:
  {{- range $app := $crd.spec.applications }}
- https://{{ $app.domainName }}/dex-authenticator/callback
{{- end }}
{{- end }}

customLdifFiles:
   00-root.ldif: |-
     # Root creation
     dn: dc=example,dc=org
     objectClass: dcObject
     objectClass: organization
     o: Example, Inc
   01-default-group.ldif: |-
     dn: cn=myGroup,dc=example,dc=org
     cn: myGroup
     gidnumber: 500
     objectclass: posixGroup
     objectclass: top
   02-default-user.ldif: |-
     dn: cn=Jean Dupond,dc=example,dc=org
     cn: Jean Dupond
     gidnumber: 500
     givenname: Jean
     homedirectory: /home/users/jdupond
     objectclass: inetOrgPerson
     objectclass: posixAccount
     objectclass: top
     userPrincipalName: jdupond@example.com
     mail: jdupond@example.com
     sn: Dupond
     uid: jdupond
     uidnumber: 1000
     userpassword: {MD5}KOULhzfBhPTq9k7a9XfCGw==