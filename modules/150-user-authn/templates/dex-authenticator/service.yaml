{{- $context := . }}
{{- range $crd := $context.Values.userAuthn.internal.dexAuthenticatorCRDs }}
{{- $id := printf "%s@%s" $crd.name $crd.namespace }}
{{- $info := (index $context.Values.userAuthn.internal.dexAuthenticatorNames $id) }}
{{- $svcName := (default (printf "%s-dex-authenticator" $crd.name) (index $info "name")) }}
{{- $truncated := (index $info "truncated") }}
{{- $hash := (index $info "hash") }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ $svcName }}
  namespace: {{ $crd.namespace }}
  {{- $labels := dict "app" "dex-authenticator" }}
  {{- if $truncated }}
  {{- $_ := set $labels "deckhouse.io/dex-authenticator-for" $crd.name }}
  {{- $_ := set $labels "deckhouse.io/name-truncated" "true" }}
  {{- $_ := set $labels "deckhouse.io/name-hash" $hash }}
  {{- end }}
  {{- include "helm_lib_module_labels" (list $context $labels) | nindent 2 }}
spec:
  ports:
  - name: https
    port: 443
    targetPort: dex-https
  selector:
    app: dex-authenticator
    name: {{ $crd.name }}
  {{- end }}
