---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kdc-config
  namespace: d8-user-authn
data:
  krb5.conf: |
    [libdefaults]
      default_realm = EXAMPLE.COM
      rdns = false
      dns_lookup_kdc = false
    [realms]
      EXAMPLE.COM = {
        kdc = kdc-0.kdc.d8-user-authn.svc.cluster.local
        admin_server = kdc-0.kdc.d8-user-authn.svc.cluster.local
      }
  kdc.conf: |
    [kdcdefaults]
      kdc_ports = 88
      kdc_tcp_ports = 88
    [realms]
      EXAMPLE.COM = {
        max_life = 10h 0m 0s
        max_renewable_life = 7d 0h 0m 0s
        supported_enctypes = aes256-cts:normal aes128-cts:normal
      }
  kadm5.acl: |
    */admin@EXAMPLE.COM *
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kdc
  namespace: d8-user-authn
spec:
  replicas: 1
  selector:
    matchLabels: { app: kdc }
  template:
    metadata:
      labels: { app: kdc }
    spec:
      containers:
      - name: kdc
        image: bitnami/krb5:1.19.4
        imagePullPolicy: IfNotPresent
        command: ["/bin/bash","-lc"]
        args:
          - |
            install -Dm0644 /config/krb5.conf /etc/krb5.conf;
            install -Dm0644 /config/kdc.conf /etc/krb5kdc/kdc.conf;
            install -Dm0644 /config/kadm5.acl /etc/krb5kdc/kadm5.acl;
            [ -f /var/lib/krb5kdc/principal ] || kdb5_util create -s -P changeme;
            krb5kdc -n &
            exec kadmind -nofork
        volumeMounts:
        - { name: kdc-config, mountPath: /config }
      volumes:
      - name: kdc-config
        configMap: { name: kdc-config }
---
apiVersion: v1
kind: Service
metadata:
  name: kdc
  namespace: d8-user-authn
spec:
  type: NodePort
  selector: { app: kdc }
  ports:
  - name: kdc-tcp
    port: 88
    targetPort: 88
    protocol: TCP
    nodePort: 30089
  - name: kdc-udp
    port: 88
    targetPort: 88
    protocol: UDP
  - name: kadm
    port: 749
    targetPort: 749
    protocol: TCP
    nodePort: 30749


