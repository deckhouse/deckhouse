---
title: "Модуль user-authn"
search: kube config generator
webIfaces:
- name: kubeconfig
  urlInfo: faq.html#как-я-могу-сгенерировать-kubeconfig-для-доступа-к-kubernetes-api
---

Модуль отвечает за единую систему аутентификации, интегрированную с Kubernetes и веб-интерфейсами, используемыми в других модулях (Grafana, Dashboard и др.).

Модуль состоит из следующих компонентов:
- [`dex`](https://github.com/dexidp/dex) — провайдер с федеративными функциями, поддерживающий работу со статическими пользователями и возможностью подключения к различным внешним провайдерам аутентификации, например, SAML, GitLab, GitHub.
- `kubeconfig-generator` ([dex-k8s-authenticator](https://github.com/mintel/dex-k8s-authenticator)) — веб-приложение, генерирующее команды для настройки локального kubectl после ваторизации в Dex;
- `dex-authenticator` (на самом деле [oauth2-proxy](https://github.com/oauth2-proxy/oauth2-proxy)) — приложение, получающее запросы от компонента NGINX Ingress (через модуль auth_request) и выполняющее их авторизацию с помощью сервиса Dex.

Управление статическими учетными записями пользователей осуществляется с помощью custom resource [`User`](cr.html#user), в котором хранится вся информация о пользователе и его пароль.

Поддерживаются следующие внешние провайдеры/протоколы аутентификации:
- Github;
- Gitlab;
- BitBucket Cloud;
- Crowd;
- LDAP;
- OIDC.

Одновременно можно подключить более одного внешнего провайдера аутентификации.

## Возможности интеграции

### Возможность аутентификации в API Kubernetes по логину и паролю

Аутентификация по логину и паролю в API Kubernetes на данный момент доступна только для поставщика Crowd, однако поддерживаются и другие внешние провайдеры, такие как GitHub, GitLab и другие. Учитывая, что аутентификация по логину и паролю через эти источники успешно функционирует, она также может быть использована в качестве внешнего источника учетных записей в DEX.
В ближайшее время ожидается появление поддержки этой возможности для статических пользователей и провайдеров с поддержкой LDAP.

### Интеграция с приложениями

Для обеспечения аутентификации в любом веб-приложении, работающем в Kubernetes, необходимо создать ресурс [`DexAuthenticator`](cr.html#dexauthenticator) в нужном пространстве имен (namespace) и добавить несколько аннотаций к ресурсу Ingress.
Это позволяет:
* ограничить список групп, которым разрешен доступ;
* ограничить список адресов, с которых разрешена аутентификация.
Если приложение поддерживает OIDC-аутентификацию, оно может интегрироваться с единой аутентификацией. Для этого в Kubernetes создается ресурс [`DexClient`](cr.html#dexclient) в необходимом namespace. В том же namespace создается секрет с данными для подключения в Dex по OIDC.

Возможности, которые открываются после такой интеграции:
* возможность ограничить перечень групп, которым разрешено подключаться;
* возможность указать перечень доверенных клиентов, OIDC-токенам которых можно доверять (`trustedPeers`).

### Веб-интерфейс для генерации готовых kubeconfig-файлов

Модуль позволяет автоматически создавать конфигурацию для kubectl или другой утилиты Kubernetes. Веб-интерфейс генератора kubeconfig после прохождения аутентификации предоставляет набор команд настройки kubectl для работы с кластером Kubernetes. Эти команды можно скопировать и вставить в консоль для использования kubectl.
Механизм аутентификации для kubeconfig использует OIDC-токен. OIDC-сессия может продлеваться автоматически, если использованный в Dex провайдер аутентификации поддерживает продление сессий. Для этого в kubeconfig указывается `refresh token`.

Дополнительно можно настроить несколько адресов `kube-apiserver` и сертификаты ЦС (CA) для каждого из них. Например, это может потребоваться, если доступ к кластеру Kubernetes осуществляется через VPN и прямым подключением.

## Публикация API kubernetes через Ingress

Компонент `kube-apiserver` без дополнительных настроек, по умолчанию доступен только во внутренней сети кластера. Этот модуль помогает решить проблему простого и безопасного доступа к API Kubernetes извне кластера. При этом `apiserver` публикуется на специальном домене ([подробнее см. раздел о служебных доменах в документации](../../deckhouse-configure-global.html)).

При настройке можно указать:
* перечень сетевых адресов, с которых разрешается подключение;
* перечень групп, которым разрешен доступ к `apiserver`;
* Ingress-контроллер, на котором производится аутентификация.

По умолчанию будет сгенерирован специальный сертификат ЦС (CA) и автоматически настроен генератор kubeconfig.

## Расширения от Фланта

Модуль использует модифицированную версию Dex, которая содержит следующие дополненные и исправленные функции:
* поддержку групп для статических учетных записей пользователей и провайдера `bitbucketCloud`;
* поддержку передачи параметра `group` клиентам;
* поддержку механизма `obsolete tokens`, который позволяет избежать состояния гонки при продлении токена OIDC-клиентом.

## Отказоустойчивый режим

Модуль также поддерживает режим высокой доступности `highAvailability`. При его включении аутентификаторы, отвечающие на `auth request`-запросы, развертываются с учетом требуемой избыточности для обеспечения непрерывной работы. В случае отказа любого из экземпляров аутентификаторов пользовательские аутентификационные сессии не прерываются.
